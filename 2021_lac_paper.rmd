---
title: "Laccase manuscript"
author: "Leonard Blaschek"
date: "01/02/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(baseline)
library(broom)
library(colorspace)
library(gganimate)
library(ggbeeswarm)
library(ggrepel)
library(ggridges)
library(ggtext)
library(glue)
library(jsonlite)
library(lubridate)
library(patchwork)
library(showtext)
library(slider)
library(tidyverse)
library(tukeygrps)
library(vroom)

## import Helvetica ####
font_add(
  "Helvetica",
  regular = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Lt.otf",
  italic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-LtIt.otf",
  bold = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Bd.otf",
  bolditalic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-BdIt.otf"
)
showtext_auto()

#### generating plot theme ####
theme_leo <- function(base_size = 6,
                      base_family = "Helvetica") {
  theme_minimal(
    base_size = base_size,
    base_family = base_family
  ) %+replace%
    theme(
      strip.text = element_text(hjust = 0, 
                                # face = "italic"
                                ),
      axis.ticks = element_line(
        size = 0.125,
        lineend = "square",
        color = "black"
      ),
      axis.text.x = element_text(
        size = 6,
        colour = "black",
        margin = margin(1, 1, 1, 1)
      ),
      axis.text.y = element_text(
        colour = "black",
        size = 6,
        angle = 0,
        vjust = 0.5,
        hjust = 1,
        margin = margin(1, 1, 1, 1)
      ),
      axis.title = element_text(
        colour = "black",
        size = 6
      ),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black", size = 0.25),
      panel.spacing = unit(1.5, "mm"),
      legend.position = "none",
      legend.text = element_text(size = 6),
      legend.key.height = unit(4, "mm"),
      plot.title = element_text(
        size = 6,
        hjust = 0
      ),
      complete = TRUE
    )
}

pal_ostwald_disc <- c(
  "#275d95",
  "#e8c245",
  "#d25952"
)

pal_ostwald_disc_long <- c(
  "#8fab1d",
  "#2d7d73",
  "#1d566f",
  "#275d95",
  "#e8c245",
  "#d25952"
)

pal_ostwald_cont <- c(
  "#155DA7",
  "#0A75B9",
  # "#0C89C9",
  "#FED32F",
  # "#F8A63A",
  "#EF663A",
  "#ED4137"
)

pal_pedersen_disc <- c(
  "#264653",
  "#2a9d8f",
  "#e9c46a",
  "#f4a261",
  "#e76f51"
)

ggtext_size <- 6 / (14 / 5)
cm_size <- function(x) x / 2.54
twocol <- 18 / 2.54
onehalfcol <- 14 / 2.54
onecol <- 9 / 2.54

#### machine dependent paths ####
## "/data/" in the office, "/home/leonard/Documents/Uni/" on my laptops
datapath <- ifelse(dir.exists("/data/"), "/data/", 
                   ifelse(dir.exists("/run/media/leonard/data/"),
                          "/run/media/leonard/data/","/home/leonard/Documents/Uni/")
)
```

# Phenotyping

## End point phenotyping

```{r message=FALSE}
siliques <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/2020-04-16_siliques.csv"
)) %>%
  bind_rows(read_csv(paste0(
    datapath, "PhD/Phenotyping/2020-09_lac_mutants/2020-11-05_siliques.csv"
  )) %>%
    select(-plant)) %>%
  mutate(rep = as.character(rep)) %>%
  pivot_longer(-c(genotype, rep), names_to = "sil", values_to = "length") %>%
  mutate(genotype = ordered(recode(genotype,
    "lac4/5/10/12/17" = "Q",
    "lac5/10/12/17" = "Q-4",
    "lac4/10/12/17" = "Q-5",
    "lac4/5/12/17" = "Q-10",
    "lac4/5/10/17" = "Q-12",
    "lac4/5/10/12" = "Q-17"
  ),
  levels = c("Col-0", "Q-4", "Q-5", "Q-10", "Q-12", "Q-17", "Q")
  ))

pheno_data <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/2020-04-16_harvesting.csv"
)) %>%
  rename("stem.weight" = stem.w) %>%
  bind_rows(read_csv(paste0(
    datapath, "PhD/Phenotyping/2020-09_lac_mutants/2020-11-05_harvesting.csv"
  )) %>%
    select(-plant)) %>%
  mutate(rep = as.character(rep)) %>%
  left_join(siliques %>%
    group_by(genotype, rep) %>%
    summarise(mean.sil.length = mean(length))) %>%
  mutate(genotype = ordered(recode(genotype,
    "Col-0" = "WT",
    "lac4/5/10/12/17" = "Q",
    "lac5/10/12/17" = "Q-4",
    "lac4/10/12/17" = "Q-5",
    "lac4/5/12/17" = "Q-10",
    "lac4/5/10/17" = "Q-12",
    "lac4/5/10/12" = "Q-17"
  ),
  levels = c("WT", "Q-4", "Q-5", "Q-10", "Q-12", "Q-17", "Q")
  )) %>%
  select(-mat.sil, -green.sil, -fl.stands) %>% 
  mutate(genotype = recode(genotype,
                           "Q-4" = "<i>Q-4</i>",
                           "Q-5" = "<i>Q-5</i>",
                           "Q-10" = "<i>Q-10</i>",
                           "Q-12" = "<i>Q-12</i>",
                           "Q-17" = "<i>Q-17</i>",
                           "Q" = "<i>Q</i>"))

ggplot(
  pheno_data,
  aes(
    y = genotype,
    x = stretched.height
  )
) +
  # geom_violin() +
  # ggbeeswarm::geom_quasirandom() +
  ggridges::geom_density_ridges_gradient(aes(fill = stat(x)),
    bandwidth = 2.5,
    quantile_lines = TRUE, quantiles = 2
  ) +
  scale_fill_gradientn(colours = wesanderson::wes_palette("Zissou1", n = 5)) +
  theme_leo()

ggplot(siliques) +
  # geom_violin() +
  # ggbeeswarm::geom_quasirandom(aes(x = genotype,
  #                                  y = length)) +
  ggridges::geom_density_ridges_gradient(aes(
    x = length,
    y = genotype,
    fill = stat(x)
  ),
  bandwidth = 0.05,
  quantile_lines = TRUE, quantiles = 2
  ) +
  scale_fill_gradientn(colours = wesanderson::wes_palette("Zissou1", n = 5)) +
  theme_leo()

letters <- letter_groups(pheno_data,
  stretched.height,
  genotype,
  "tukey",
  print_position = "below",
  print_adjust = 1
) %>% 
  mutate(genotype = ordered(genotype, levels = c(
      "WT",
      "<i>Q-4</i>",
      "<i>Q-5</i>",
      "<i>Q-10</i>",
      "<i>Q-12</i>",
      "<i>Q-17</i>",
      "<i>Q</i>"
    )))

rect_data = pheno_data %>% 
  group_by(genotype) %>% 
  summarise(genotype = unique(genotype))

height <- ggplot(
  pheno_data,
  aes(
    x = 0.5,
    y = stretched.height,
    fill = genotype
  )
) +
  geom_rect(data = rect_data,
            aes(fill = genotype, y = 1),
            xmin = -Inf,
            xmax = Inf,
            ymin = -Inf,
            ymax = Inf,
            alpha = 0.5) +
  geom_quasirandom(
  shape = 16,
  alpha = 0.5,
  size = 0.5,
  width = 0.5
  ) +
  geom_violin(
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2
    # scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Stem height [cm]") +
  scale_x_discrete(limits = c(0,1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_textbox_simple(
          orientation = "left-rotated",
          halign = 0.5,
          width = unit(15, "mm")
          ),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text = element_markdown(hjust = 0.5),
        panel.spacing = unit(0.75, "mm")) +
  facet_wrap(~ genotype, nrow = 1)

pdf("lac_height.pdf", width = onecol, height = onecol * 0.15)
# raw_absorbance /
#   activity_grid /
height
dev.off()
```

## Image based phenotyping

### Calibration

```{r}
size_marker <- read_csv(paste0(datapath, "PhD/Phenotyping/2021-05_plantCV_calibration/calibration.csv")) 

ggplot(size_marker,
       aes(x = pixels,
           y = space)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_leo()

summary(lm(pixels ~ space, data = size_marker))

size_marker <- size_marker %>% 
  mutate(space_rel = space / pixels,
         space_cm = space_rel * 5)

print("The spacing of the colour card is equivalent to 1.5 cm.")
print("Length in cm = pixels * 1.5 / space")
print("Area in cm² = pixels² * 1.5² / space²")
```


### Hue

```{r message=FALSE}
# pcv_data <- fromJSON(paste0(
#   datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/images/front/output/2020-05-11_lab_segmentation/results.json"))
# hues <- pcv_data$entities$observations$hue_frequencies %>%
#   mutate(
#     date = pcv_data$entities$metadata$timestamp$value,
#     replicate = pcv_data$entities$metadata$frame$value,
#     genotype = pcv_data$entities$metadata$id$value
#   ) %>%
#   select(genotype, replicate, date, "count" = value, "hue" = label, ) %>%
#   unnest(cols = c(count, hue))
#
# circular_mean_hue <- pcv_data$entities$observations$hue_circular_mean %>%
#   mutate(
#     date = pcv_data$entities$metadata$timestamp$value,
#     replicate = pcv_data$entities$metadata$frame$value,
#     genotype = pcv_data$entities$metadata$id$value
#   ) %>%
#   select(genotype, replicate, date, "mean_hue" = value)
#
# hues <- hues %>%
#   filter(hue != 1) %>%
#   group_by(genotype, replicate) %>%
#   left_join(circular_mean_hue) %>%
#   mutate(
#     pixel_count = sum(count),
#     count_scaled = count / pixel_count,
#     rolling_count = slide_dbl(count_scaled, mean, .before = 3)
#   )
#
# hues_avg <- hues %>%
#   ungroup() %>%
#   mutate(genotype = ordered(genotype,
#                             levels = c(
#                               "Col-0",
#                               "Q",
#                               "Q-4",
#                               "Q-5",
#                               "Q-10",
#                               "Q-12",
#                               "Q-17"
#                             ))) %>%
#   group_by(genotype, hue) %>%
#   summarise(count_mean = mean(count_scaled),
#             mean_mean = mean(mean_hue)) %>%
#   group_by(genotype) %>%
#   mutate(rolling_mean = slide_dbl(count_mean, mean, .before = 3))
#
# H <- round(((1:20) / 20), digits = 2)
# S <- 0.7
# V <- 0.85
#
# hue_values <- NULL
# for (i in H) {
#   hue_values[i * 20] <- (hsv(i, S, V))
# }
#
#
# pheno_avg <- pheno_data %>%
#   group_by(genotype) %>%
#   summarise_if(is.numeric, mean) %>%
#   mutate(genotype = recode(genotype,
#       "lac4/5/10/12/17" = "Q",
#       "lac5/10/12/17" = "Q-4",
#       "lac4/10/12/17" = "Q-5",
#       "lac4/5/12/17" = "Q-10",
#       "lac4/5/10/17" = "Q-12",
#       "lac4/5/10/12" = "Q-17"
#     ))
#
# hue_dens <- ggplot() +
#   geom_density_ridges_gradient(
#     data = hues_avg,
#     aes(
#       x = hue,
#       height = rolling_mean,
#       y = reorder(genotype, mean_mean),
#       # y = genotype,
#       fill = hue
#     ),
#     # scale = 10,
#     stat = "identity",
#     size = 0.2
#   ) +
#   # geom_density_ridges(
#   #   data = hues,
#   #   aes(
#   #     x = hue,
#   #     height = rolling_count,
#   #     y = genotype,
#   #     group = interaction(genotype, replicate)
#   #   ),
#   #   # scale = 10,
#   #   fill = NA,
#   #   colour = rgb(0, 0, 0, 0.25),
#   #   stat = "identity",
#   #   size = 0.2
#   # ) +
#   # geom_text(data = pheno_avg,
#   #           aes(label = paste("Senescence index =", round(senescence, digits = 2)),
#   #               y = genotype),
#   #           x = 100,
#   #           family = "Helvetica",
#   #           size = ggtext_size,
#   #           hjust = 0,
#   #           vjust = 1.1) +
#   scale_fill_gradientn(colors = hue_values) +
#   scale_x_continuous(limits = c(0, 150)) +
#   labs(x = "Hue",
#        y = "") +
#   theme_leo()
#
# pdf("harvest_hue.pdf", width = cm_size(10), height = cm_size(10))
# hue_dens
# dev.off()
```

### Height

```{r message=FALSE}
# pcv_data <- fromJSON("/home/leonard/Dropbox/2020-01_LAC_phenotyping/images/front/output/2020-05-11_lab_segmentation/results.json")
# heights <- as.tibble(pcv_data$entities$observations$height$value) %>%
#   mutate(
#     longest_path = pcv_data$entities$observations$longest_path$value,
#     date = pcv_data$entities$metadata$timestamp$value,
#     rep = pcv_data$entities$metadata$frame$value,
#     genotype = pcv_data$entities$metadata$id$value
#   )
# 
# scale_factor <- read_csv("/home/leonard/Dropbox/2020-01_LAC_phenotyping/images/front/output/2020-05-11_lab_segmentation/size_marker.csv",
#   col_names = c("id", "space")
# ) %>%
#   mutate(id = str_remove(id, fixed(".jpg"))) %>%
#   separate(id, into = c("date", "genotype", "rep"), sep = "_")
# 
# heights <- heights %>%
#   left_join(scale_factor) %>%
#   mutate(
#     scaled_height = value / space,
#     scaled_path = longest_path / space,
#     genotype = recode(genotype,
#       Q = "lac4/5/10/12/17",
#       `Q-4` = "lac5/10/12/17",
#       `Q-5` = "lac4/10/12/17",
#       `Q-10` = "lac4/5/12/17",
#       `Q-12` = "lac4/5/10/17",
#       `Q-17` = "lac4/5/10/12"
#     )
#   ) %>%
#   left_join(pheno_data %>% select(genotype, rep, apparent.height, stretched.height),
#     by = c("genotype", "rep")
#   )
# 
# height_validation <- ggplot(
#   data = heights,
#   aes(
#     x = scaled_height,
#     y = apparent.height
#   )
# ) +
#   geom_point() +
#   geom_smooth(method = "lm")
# 
# height_validation
# 
# summary(lm(heights$scaled_height ~ heights$apparent.height))
# 
# height_validation <- ggplot(
#   data = heights,
#   aes(
#     x = scaled_path,
#     y = stretched.height,
#     colour = genotype
#   )
# ) +
#   geom_point() +
#   geom_smooth(
#     method = "lm",
#     colour = "blue"
#   )
# 
# height_validation
# 
# summary(lm(heights$scaled_path ~ heights$stretched.height))
```

### Rosette growth

```{r message=FALSE}
# #### read-in function ###
# read_plus <- function(flnm) {
#   json <- fromJSON(flnm)
#   json$observations$area$value %>%
#     as_tibble() %>%
#     mutate(filename = basename(flnm))
# }
#
# #### load data ###
# rosette_files <-
#   list.files(
#     path = "/home/leonard/Dropbox/2020-01_LAC_phenotyping/images/top/renamed/nikon_images/",
#     pattern = "*.json",
#     recursive = FALSE,
#     full.names = TRUE
#   )
#
# tray_id <- read_csv("/home/leonard/Dropbox/2020-01_LAC_phenotyping/images/top/renamed/tray_id.csv",
#   col_types = "cccc"
# )
#
# size_marker <- read_csv("/home/leonard/Dropbox/2020-01_LAC_phenotyping/images/top/renamed/nikon_images/output/size_marker_trays.csv",
#   col_names = c("filename", "space")
# ) %>%
#   separate(filename, into = c("date", "tray"), sep = "_") %>%
#   mutate(
#     date = ymd(date),
#     tray = str_remove(tray, fixed(".jpg"))
#   )
#
# rosette_area <- lapply(rosette_files, read_plus) %>%
#   bind_rows() %>%
#   separate(filename, into = c("date", "tray", "plant"), sep = "_") %>%
#   mutate(
#     date = ymd(date),
#     tray = str_remove(tray, fixed(".jpg")),
#     plant = str_remove(plant, fixed(".json"))) %>%
#   left_join(tray_id) %>%
#   left_join(size_marker) %>%
#   mutate(area = value / space,
#          mutation = case_when(genotype == "Col-0" ~ "WT",
#                               TRUE ~ "mutant")) %>%
#   group_by(genotype, date) %>%
#   mutate(area_avg = mean(area)) %>%
#   group_by(genotype) %>%
#   mutate(max = max(area_avg)) %>%
#   filter(date > "2020-01-27")
#
# rosette_growth <- ggplot(
#   data = rosette_area,
#   aes(
#     x = date,
#     y = area
#   )
# ) +
#   geom_line(aes(
#     colour = mutation,
#     group = interaction(genotype, replicate)
#   ),
#   size = 0.2,
#   alpha = 0.25
#   ) +
#   geom_line(aes(
#     colour = mutation,
#     group = genotype,
#     y = area_avg
#   )) +
#   theme_leo() +
#   coord_cartesian(clip = "off") +
#   scale_x_date(limits = c(ymd("20200127"), ymd("20200214"))) +
#   geom_text_repel(
#     data = distinct(rosette_area, max),
#     x = ymd("20200212"),
#     aes(
#       y = max,
#       label = genotype
#     ),
#     family = "Helvetica",
#     segment.colour = "grey75",
#     hjust = 0,
#     direction = "y",
#     nudge_x = 0.5,
#     min.segment.length = 0
#   ) +
#   labs(x = "Date",
#        y = "Rosette Area [scaled px]") +
#   scale_colour_manual(values = pal_ostwald_disc[c(3,1)])
#
# pdf("rosette_growth.pdf", width = cm_size(10), height = cm_size(10))
# rosette_growth
# dev.off()
```

### Root growth

```{r}
root_data <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2020-10_lac_root_growth/2020-10_root_growth.csv"
))

ggplot(root_data, aes(
  y = length.cm,
  x = genotype
)) +
  geom_violin(draw_quantiles = 0.5) +
  geom_quasirandom() +
  theme_leo()
```

# Wiesner

## Point measurements

### Load data

```{r, message=FALSE}
Wiesner_files <-
  list.files(
    path = paste0(datapath, "PhD/Wiesner/2021-05_Wiesner/Stitched/Measurements/"),
    pattern = "*.csv",
    recursive = TRUE,
    full.names = TRUE
  )

Wiesner_data <- map_dfr(Wiesner_files, read_csv) %>%
  separate(image, into = c("date", "genotype", "replicate", "first_image"), sep = "_") %>% 
  mutate(date = str_replace(date, "^021", "2021")) %>% 
  mutate(
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "IF-CML",
        "LP",
        "XF",
        "XF-CML",
        "PX",
        "MX",
        "PH",
        "BG"
      )
    ),
    genotype = ordered(genotype, levels = c(
      "WT",
      "Q-4",
      "Q-5",
      "Q-10",
      "Q-12",
      "Q-17",
      "Q"
    )),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  ) 
  # filter(cell_type %in% c("IF", "XF", "PX", "MX", "PH", "BG"))

if(any(Wiesner_data$first_image != "unstained")) warning("Stained and unstained values might be inverted in some images.")

Wiesner_data <- Wiesner_data %>% 
  mutate(absorbance = stained_absorbance - unstained_absorbance) %>% 
  group_by(date, genotype, replicate) %>% 
  mutate(tissue_clearing = mean(absorbance[cell_type == "PH"]),
         corrected_absorbance = absorbance - tissue_clearing) %>% 
  filter(!(cell_type %in% c("PH", "BG")))

Wiesner_avg <- Wiesner_data %>% 
  group_by(genotype, replicate, cell_type, instance) %>% 
  summarise(corrected_absorbance = mean(corrected_absorbance))

Wiesner_n <- Wiesner_data %>% 
  group_by(genotype) %>% 
  summarise(replicates = paste0(unique(replicate), collapse = ","))
```

### Plot Wiesner violins

```{r}
letter_pos <- letter_groups(Wiesner_data,
                         corrected_absorbance,
                         genotype,
                         "tukey",
                         cell_type,
                         print_position = "below") %>% 
  select(-Letters)

letters <- letter_groups(Wiesner_avg,
                         corrected_absorbance,
                         genotype,
                         "tukey",
                         cell_type,
                         print_position = "below") %>% 
  select(-corrected_absorbance) %>% 
  left_join(letter_pos)

Wiesner_plot <- ggplot(Wiesner_data,
                       aes(x = genotype,
                           y = corrected_absorbance)) +
  geom_quasirandom(aes(colour = instance),
                   shape = 16,
                   alpha = 0.2,
                   size = 1) +
  stat_summary(geom = "crossbar",
               fun = "median",
               size = 0.2,
               fatten = 1) +
  # geom_beeswarm(data = Wiesner_avg,
  #            aes(fill = instance),
  #            shape = 21,
  #            size = 1.5,
  #            alpha = 0.8,
  #            stroke = 0.2) +
  geom_text(data = letters,
            aes(label = Letters),
            size = ggtext_size,
            family = "Helvetica") +
  scale_colour_manual(values = pal_ostwald_disc[c(1,3)]) +
  theme_leo() +
  facet_wrap(~ cell_type, nrow = 1)
  
pdf("lac_Wiesner.pdf", width = twocol, height = onecol * 0.5)
Wiesner_plot
dev.off()
```

## IF profiles

### Load data

```{r}
profile_files <-
  list.files(
    path = "/home/leonard/Dropbox/2021-05_Wiesner_profiles/",
    pattern = "*.csv",
    recursive = F,
    full.names = TRUE
  )

read_profiles <- function(x) {
  read_csv(x) %>% 
    mutate(filename = basename(x))
}

profile_data <- map_dfr(profile_files, read_profiles) %>% 
  group_by(filename) %>% 
  mutate(pixel = row_number()) %>% 
  pivot_longer(contains("ROI"), names_to = "profile", values_to = "absorbance") %>% 
  mutate(profile = as.numeric(str_extract(profile, "[:digit:]+")) + 1,
         absorbance = case_when(absorbance == 0 ~ NA_real_,
                                TRUE ~ absorbance / 255)) %>% 
  drop_na() %>% 
  group_by(filename, profile) %>%
  mutate(pixel = pixel / max(pixel)) %>% 
  separate(filename, into = c("date", "genotype", "replicate"), sep = "_", extra = "drop") %>% 
  mutate(genotype = ordered(genotype, levels = c(
    "WT",
    "Q-4",
    "Q-5",
    "Q-10",
    "Q-12",
    "Q-17",
    "Q"
  ))) %>% 
  mutate(genotype = recode(genotype,
                           "Q-4" = "<i>Q-4</i>",
                           "Q-5" = "<i>Q-5</i>",
                           "Q-10" = "<i>Q-10</i>",
                           "Q-12" = "<i>Q-12</i>",
                           "Q-17" = "<i>Q-17</i>",
                           "Q" = "<i>Q</i>"))
  
```

### Plot profiles

```{r}
rect_data = profile_data %>% 
  group_by(genotype) %>% 
  summarise(genotype = unique(genotype))

profiles <- ggplot(profile_data,
       aes(x = pixel,
           y = absorbance)) +
  geom_rect(data = rect_data,
            aes(fill = genotype, x = 0, y = 0,),
            xmin = -Inf,
            xmax = Inf,
            ymin = -Inf,
            ymax = Inf,
            alpha = 0.5) +
  geom_line(aes(group = interaction(genotype, profile)),
            alpha = 0.25,
            size = 0.1) +
  geom_smooth(se = F, size = 0.2, colour = "black") +
  scale_fill_viridis_d() +
  scale_y_continuous(breaks = c(0, 0.2, 0.4)) +
  theme_leo() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text = element_markdown(hjust = 0.5),
        panel.spacing = unit(0.75, "mm")) +
  facet_wrap(~ genotype, nrow = 1)

pdf("Wiesner_profiles.pdf", width = onecol, height = onecol * 0.15)
profiles
dev.off()

```



# TE collapse

## Load data

```{r, message=FALSE}
collapse_files <-
  list.files(
    path = paste0(datapath, "PhD/Wiesner/2021-04_lac_wiesner/Collapse/Measurements/"),
    pattern = "*.csv",
    recursive = TRUE,
    full.names = TRUE
  )

collapse_data <- vroom::vroom(collapse_files) %>%
  separate(image, into = c("date", "genotype", "replicate", "stained", "size"), sep = "_") %>% 
  mutate(date = str_replace(date, "^021", "2021")) %>% 
  mutate(
    cell_type = ordered(cell_type,
      levels = c(
        "PX",
        "MX"
      )
    ),
    genotype = ordered(genotype, levels = c(
      "WT",
      "Q-4",
      "Q-5",
      "Q-10",
      "Q-12",
      "Q-17",
      "Q"
    )),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  ) %>% 
  group_by(genotype, replicate, point) %>% 
  mutate(cell = case_when(point == 0 ~ row_number(),
                          TRUE ~ NA_integer_)) %>% 
  ungroup() %>% 
  fill(cell)

collapse_stats <- collapse_data %>% 
  group_by(genotype, replicate, cell_type, cell, instance) %>% 
  summarise("Area" = unique(Area) * 4^2, # analysed images were scaled down to 0.25, this corrects the scale
            "Perim." = unique(Perim.) * 4, # analysed images were scaled down to 0.25, this corrects the scale
            "Circ." = unique(Circ.),
            "Solidity" = unique(Solidity)) %>%
  pivot_longer(c(Area:Solidity), names_to = "variable", values_to = "value") %>% 
  mutate(genotype = recode(genotype,
                           "Q-4" =  "<i>Q-4</i>",
                           "Q-5" =  "<i>Q-5</i>",
                           "Q-10" = "<i>Q-10</i>",
                           "Q-12" = "<i>Q-12</i>",
                           "Q-17" = "<i>Q-17</i>",
                           "Q" =    "<i>Q</i>"))

collapse_n <- collapse_stats %>% 
  group_by(genotype) %>% 
  summarise(replicates = paste0(unique(replicate), collapse = ","))
```

## Plot collapse

```{r}

letters <- letter_groups(collapse_stats,
                         value,
                         genotype,
                         "kruskal",
                         variable,
                         cell_type,
                         print_position = "below")

collapse_plot <- ggplot(collapse_stats,
                       aes(x = genotype,
                           y = value)) +
  geom_quasirandom(
    aes(fill = instance),
    shape = 21,
    size = 0.5,
    alpha = 0.5,
    stroke = 0.2) +
  # geom_violin(
  #   draw_quantiles = 0.5,
  #   fill = "white",
  #   colour = "black",
  #   alpha = 0.85,
  #   width = 0.2,
  #   size = 0.2,
  #   scale = "width") +
  stat_summary(geom = "crossbar",
               fun = "median",
               size = 0.2,
               fatten = 1) +
  geom_text(data = letters,
            aes(label = Letters),
            size = ggtext_size,
            family = "Helvetica") +
  scale_fill_manual(values = pal_ostwald_disc[c(1,3)]) +
  theme_leo() +
  facet_grid(variable ~ cell_type, scales = "free_y")
  
pdf("lac_collapse.pdf", width = onecol, height = onecol)
collapse_plot
dev.off()

# presentation figure
collapse_pres_data <- collapse_stats %>% 
  filter(variable == "Solidity" & cell_type == "MX") 

letters <- letter_groups(collapse_pres_data,
                         value,
                         genotype,
                         "kruskal",
                         print_position = "below") %>% 
  mutate(genotype = ordered(genotype, levels = c(
      "WT",
      "<i>Q-4</i>",
      "<i>Q-5</i>",
      "<i>Q-10</i>",
      "<i>Q-12</i>",
      "<i>Q-17</i>",
      "<i>Q</i>"
    )))

rect_data = collapse_pres_data %>% 
  group_by(genotype) %>% 
  summarise(genotype = unique(genotype))

MX_collapse <- ggplot(collapse_pres_data,
       aes(x = 0.5,
           y = value)) +
  geom_rect(data = rect_data,
            aes(fill = genotype, y = 1),
            xmin = -Inf,
            xmax = Inf,
            ymin = -Inf,
            ymax = Inf,
            alpha = 0.5) +
  geom_quasirandom(
    shape = 16,
    size = 0.5,
    alpha = 0.5) +
  # geom_violin(
  #   draw_quantiles = 0.5,
  #   fill = "white",
  #   colour = "black",
  #   alpha = 0.85,
  #   width = 0.2,
  #   size = 0.2,
  #   scale = "width") +
  stat_summary(fill = "white",
               geom = "point",
               fun = "median",
               size = 1,
               shape = 21,
               stroke = 0.2) +
  geom_text(data = letters,
            aes(label = Letters),
            size = ggtext_size,
            family = "Helvetica") +
  labs(y = "TE convexity") +
  scale_fill_viridis_d() +
  ylim(0.4, 1) +
  theme_leo() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text = element_markdown(hjust = 0.5),
        panel.spacing = unit(0.75, "mm")) +
  facet_wrap(~ genotype, nrow = 1)

pdf("collapse_pres.pdf", width = onecol, height = onecol * 0.15)
MX_collapse
dev.off()
```



# RT-qPCR

## Individual experiments

### 2020-10-26

\small

```{r}
plate <- tibble(
  row = rep(LETTERS[1:8], length.out = 96, each = 12),
  column = rep(1:12, length.out = 96, each = 1),
  sample = c(
    rep(c("WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1"),
      length.out = 36, each = 1
    ),
    rep(c("NTC", "CC", "CC", "CC", "CC", "CC"),
      length.out = 36, each = 1
    ),
    rep(NA, length.out = 24)
  ),
  concentration = c(
    rep(0.1, length.out = 36),
    rep(c(1, 0.1, 0.01, 0.001, 0.0001, 0),
      length.out = 36, each = 1
    ),
    rep(NA, length.out = 24)
  ),
  gene = ordered(c(
    rep(c("LAC4", "UBI", "LAC4", "18S", "LAC4", "EF1a"), length.out = 72, each = 6),
    rep(NA, length.out = 24)
  ),
  levels = c("LAC4", "UBI", "18S", "EF1a")
  )
) %>%
  unite("Pos", row, column, sep = "") %>%
  mutate(replicate = "A1")

write_tsv(plate, paste0(
  datapath, "PhD/qPCR/2020-10-26_plate.tsv"
))

results <- read_tsv(paste0(
  datapath, "PhD/qPCR/2020-10-26_cp.tsv"
),
skip = 1
) %>%
  left_join(plate) %>%
  drop_na(sample)

ggplot(
  data = filter(results, sample == "CC" & Cp < 35),
  aes(
    x = concentration,
    y = Cp,
    colour = gene
  )
) +
  geom_point() +
  geom_smooth(
    method = "lm",
    se = F
  ) +
  scale_x_log10() +
  theme_leo()

CCs <- filter(results, sample == "CC") %>%
  select(gene, concentration, Cp) %>%
  filter(Cp < 35) %>%
  nest(data = c(concentration, Cp)) %>%
  mutate(
    fit = map(data, ~ lm(Cp ~ log10(concentration), data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    r.squared = unlist(map(model, ~ .x[["r.squared"]]))
  ) %>%
  unnest(tidied) %>%
  select(gene, r.squared, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(efficiency = (10^(-1 / `log10(concentration)`) - 1) * 100)


results <- left_join(results, CCs) %>%
  group_by(gene, concentration, sample) %>%
  mutate(technical = row_number())

ggplot(
  data = filter(results, sample == "CC" & Cp < 35),
  aes(
    x = concentration,
    y = Cp,
    colour = gene
  )
) +
  geom_point() +
  geom_smooth(
    method = "lm",
    se = F
  ) +
  geom_label(
    data = filter(results, concentration == 1 & technical == 1),
    aes(label = paste0(
      gene,
      ": R² = ",
      round(r.squared, digits = 3),
      "; efficiency = ",
      round(efficiency, digits = 0),
      "%"
    )),
    hjust = 1,
    vjust = 1,
    colour = "black",
    label.size = 0,
    fill = rgb(1, 1, 1, 0.85),
    family = "Helvetica",
    size = ggtext_size
  ) +
  scale_colour_brewer(palette = "Pastel1") +
  scale_x_log10() +
  theme_leo()
```

### 2020-10-27

```{r}
plate <- tibble(
  row = rep(LETTERS[1:8], length.out = 96, each = 12),
  column = rep(1:12, length.out = 96, each = 1),
  sample = c(rep(c(
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "CC", "CC", "CC", "CC", "CC", "NTC",
    "CC", "CC", "CC", "CC", "CC", "NTC"
  ),
  length.out = 96, each = 1
  )),
  gene = ordered(c(rep(c("LAC4", "UBI", "18S", "EF1a"), length.out = 96, each = 24)),
    levels = c("LAC4", "UBI", "18S", "EF1a")
  ),
  replicate = rep(c("A1", "A2"), each = 6, length.out = 96),
  concentration = rep(c(
    rep(c(0.1, 0.16666), length.out = 12, each = 6),
    rep(c(1, 0.1, 0.02, 0.01, 0.005, 0), length.out = 12, each = 1)
  ), length.out = 96, each = 1)
) %>%
  unite("Pos", row, column, sep = "")

write_tsv(plate, paste0(
  datapath, "/PhD/qPCR/2020-10-27_plate.tsv"
))

results <- read_tsv(paste0(
  datapath, "PhD/qPCR/2020-10-27_cp.tsv"
),
skip = 1
) %>%
  left_join(plate)

CCs <- filter(results, sample == "CC") %>%
  select(gene, replicate, concentration, Cp) %>%
  nest(data = c(concentration, Cp)) %>%
  mutate(
    fit = map(data, ~ lm(Cp ~ log10(concentration), data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    r.squared = unlist(map(model, ~ .x[["r.squared"]]))
  ) %>%
  unnest(tidied) %>%
  select(gene, replicate, r.squared, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(efficiency = (10^(-1 / `log10(concentration)`) - 1) * 100)


results <- left_join(results, CCs)

ggplot(
  data = filter(results, sample == "CC" & Cp < 35),
  aes(
    x = concentration,
    y = Cp,
    colour = gene
  )
) +
  geom_point() +
  geom_smooth(
    method = "lm",
    se = F
  ) +
  geom_label(
    data = filter(results, concentration == 0.005),
    aes(label = paste0(
      gene,
      ": R² = ",
      round(r.squared, digits = 3),
      "; efficiency = ",
      round(efficiency, digits = 0),
      "%"
    )),
    hjust = 0,
    vjust = 0,
    colour = "black",
    label.size = 0,
    fill = rgb(1, 1, 1, 0.85),
    family = "Helvetica",
    size = ggtext_size
  ) +
  scale_colour_brewer(palette = "Pastel1") +
  scale_x_log10() +
  theme_leo() +
  facet_wrap(~replicate)

normalised <- results %>%
  filter(sample != "CC" & sample != "NTC") %>%
  group_by(replicate, sample) %>%
  mutate(dCt = Cp[gene == "EF1a"] - Cp) %>%
  group_by(replicate, gene) %>%
  mutate(
    ddCt = dCt - dCt[sample == "WT"],
    fold = 2^ddCt
  ) %>%
  pivot_longer(c(dCt, ddCt, fold), names_to = "metric", values_to = "value")

ggplot(normalised) +
  geom_point(aes(
    x = sample,
    y = value,
    fill = replicate
  ),
  shape = 21,
  alpha = 0.75,
  stroke = 0.2,
  size = 3
  ) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  scale_fill_manual(values = pal_ostwald_disc_long[c(1, 3)]) +
  theme_leo() +
  theme(axis.title = element_blank()) +
  facet_grid(metric ~ gene, scales = "free")
```

### 2020-10-28

```{r}
plate <- tibble(
  row = rep(LETTERS[1:8], length.out = 96, each = 12),
  column = rep(1:12, length.out = 96, each = 1),
  sample = ordered(rep(c(
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "CC", "CC", "CC", "CC", "CC", "NTC",
    "CC", "CC", "CC", "CC", "CC", "NTC"
  ),
  length.out = 96, each = 1
  ), levels = c(
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "CC", "NTC"
  )),
  gene = ordered(c(rep(c("LAC10", "LAC12", "LAC17", "EF1a"), length.out = 96, each = 24)),
    levels = c("LAC10", "LAC12", "LAC17", "EF1a")
  ),
  replicate = rep(c("A1", "A2"), each = 6, length.out = 96),
  concentration = rep(c(
    rep(c(0.1, 0.16666), length.out = 12, each = 6),
    rep(c(1, 0.1, 0.02, 0.01, 0.005, 0), length.out = 12, each = 1)
  ), length.out = 96, each = 1)
) %>%
  unite("Pos", row, column, sep = "")

write_tsv(plate, paste0(
  datapath, "PhD/qPCR/2020-10-28_plate.tsv"
))

results <- read_tsv(paste0(
  datapath, "PhD/qPCR/2020-10-28_cp.tsv"
),
skip = 1
) %>%
  left_join(plate)

CCs <- filter(results, sample == "CC") %>%
  select(gene, replicate, concentration, Cp) %>%
  nest(data = c(concentration, Cp)) %>%
  mutate(
    fit = map(data, ~ lm(Cp ~ log10(concentration), data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    r.squared = unlist(map(model, ~ .x[["r.squared"]]))
  ) %>%
  unnest(tidied) %>%
  select(gene, replicate, r.squared, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(efficiency = (10^(-1 / `log10(concentration)`) - 1) * 100)


results <- left_join(results, CCs)

ggplot(
  data = filter(results, sample == "CC" & Cp < 35),
  aes(
    x = concentration,
    y = Cp,
    colour = gene
  )
) +
  geom_point() +
  geom_smooth(
    method = "lm",
    se = F
  ) +
  geom_label_repel(
    data = filter(results, concentration == 0.005),
    aes(label = paste0(
      gene,
      ": R² = ",
      round(r.squared, digits = 3),
      "; efficiency = ",
      round(efficiency, digits = 0),
      "%"
    )),
    hjust = 0,
    vjust = 0,
    colour = "black",
    label.size = 0,
    fill = rgb(1, 1, 1, 0.85),
    family = "Helvetica",
    size = ggtext_size
  ) +
  scale_colour_brewer(palette = "Pastel1") +
  scale_x_log10() +
  theme_leo() +
  facet_wrap(~replicate)

normalised <- results %>%
  filter(sample != "CC" & sample != "NTC") %>%
  group_by(replicate, sample) %>%
  mutate(dCt = Cp[gene == "EF1a"] - Cp) %>%
  group_by(replicate, gene) %>%
  mutate(
    ddCt = dCt - dCt[sample == "WT"],
    fold = 2^ddCt
  ) %>%
  pivot_longer(c(dCt, ddCt, fold), names_to = "metric", values_to = "value")

normalised_avg <- normalised %>%
  group_by(sample, gene, metric) %>%
  summarise(mean = mean(value))

ggplot(normalised) +
  geom_point(aes(
    x = sample,
    y = value,
    fill = replicate
  ),
  shape = 21,
  alpha = 0.75,
  stroke = 0.2,
  size = 3
  ) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  scale_fill_manual(values = pal_ostwald_disc_long[c(1, 3)]) +
  theme_leo() +
  theme(axis.title = element_blank()) +
  facet_grid(metric ~ gene, scales = "free")

ggplot() +
  geom_tile(
    data = normalised_avg %>%
      filter(metric == "ddCt"),
    aes(
      x = sample,
      y = gene,
      fill = mean
    )
  ) +
  geom_text(
    data = normalised_avg %>%
      filter(metric == "fold"),
    aes(
      x = sample,
      y = gene,
      label = round(mean, digits = 2)
    ),
    family = "Helvetica",
    size = ggtext_size
  ) +
  # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  # scale_fill_manual(values = pal_ostwald_disc_long[c(1, 3)]) +
  scale_fill_gradientn(
    colours = rev(pal_ostwald_cont),
    # limits = c(0,10),
    # na.value = "#ED4137"
  ) +
  theme_leo() +
  guides(fill = guide_colorbar(title = "ddCt")) +
  labs(title = "Fold-change of laccase gene expression in single mutants") +
  theme(
    axis.title = element_blank(),
    legend.position = "bottom"
  )
```

### 2020-10-31

```{r}
plate <- tibble(
  row = rep(LETTERS[1:8], length.out = 96, each = 12),
  column = rep(1:12, length.out = 96, each = 1),
  sample = ordered(rep(c(
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "CC", "CC", "CC", "CC", "CC", "NTC",
    "CC", "CC", "CC", "CC", "CC", "NTC"
  ),
  length.out = 96, each = 1
  ), levels = c(
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "CC", "NTC"
  )),
  gene = ordered(c(rep(c("LAC4", "LAC10", "LAC12", "EF1a"), length.out = 96, each = 24)),
    levels = c("LAC4", "LAC10", "LAC12", "EF1a")
  ),
  replicate = rep(c("B1", "B2"), each = 6, length.out = 96),
  concentration = rep(c(
    rep(0.16666, length.out = 12),
    rep(c(1, 0.1, 0.02, 0.01, 0.005, 0), length.out = 12, each = 1)
  ), length.out = 96, each = 1)
) %>%
  unite("Pos", row, column, sep = "")

write_tsv(plate, paste0(
  datapath, "PhD/qPCR/2020-10-31_plate.tsv"
))

results <- read_tsv(paste0(
  datapath, "PhD/qPCR/2020-10-31_cp.tsv"
),
skip = 1
) %>%
  left_join(plate)

CCs <- filter(results, sample == "CC") %>%
  select(gene, replicate, concentration, Cp) %>%
  nest(data = c(concentration, Cp)) %>%
  mutate(
    fit = map(data, ~ lm(Cp ~ log10(concentration), data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    r.squared = unlist(map(model, ~ .x[["r.squared"]]))
  ) %>%
  unnest(tidied) %>%
  select(gene, replicate, r.squared, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(efficiency = (10^(-1 / `log10(concentration)`) - 1) * 100)


results <- left_join(results, CCs)

ggplot(
  data = filter(results, sample == "CC" & Cp < 35),
  aes(
    x = concentration,
    y = Cp,
    colour = gene
  )
) +
  geom_point() +
  geom_smooth(
    method = "lm",
    se = F
  ) +
  geom_label_repel(
    data = filter(results, concentration == 0.005),
    aes(label = paste0(
      gene,
      ": R² = ",
      round(r.squared, digits = 3),
      "; efficiency = ",
      round(efficiency, digits = 0),
      "%"
    )),
    hjust = 0,
    vjust = 0,
    colour = "black",
    label.size = 0,
    fill = rgb(1, 1, 1, 0.85),
    family = "Helvetica",
    size = ggtext_size
  ) +
  scale_colour_brewer(palette = "Pastel1") +
  scale_x_log10() +
  theme_leo() +
  facet_wrap(~replicate)

normalised <- results %>%
  filter(sample != "CC" & sample != "NTC") %>%
  group_by(replicate, sample) %>%
  mutate(dCt = Cp[gene == "EF1a"] - Cp) %>%
  group_by(replicate, gene) %>%
  mutate(
    ddCt = dCt - dCt[sample == "WT"],
    fold = 2^ddCt
  ) %>%
  pivot_longer(c(dCt, ddCt, fold), names_to = "metric", values_to = "value")

normalised_avg <- normalised %>%
  group_by(sample, gene, metric) %>%
  summarise(mean = mean(value))

ggplot(normalised) +
  geom_point(aes(
    x = sample,
    y = value,
    fill = replicate
  ),
  shape = 21,
  alpha = 0.75,
  stroke = 0.2,
  size = 3
  ) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  scale_fill_manual(values = pal_ostwald_disc_long[c(1, 3)]) +
  theme_leo() +
  theme(axis.title = element_blank()) +
  facet_grid(metric ~ gene, scales = "free")

ggplot() +
  geom_tile(
    data = normalised_avg %>%
      filter(metric == "ddCt"),
    aes(
      x = sample,
      y = gene,
      fill = mean
    )
  ) +
  geom_text(
    data = normalised_avg %>%
      filter(metric == "fold"),
    aes(
      x = sample,
      y = gene,
      label = round(mean, digits = 2)
    ),
    family = "Helvetica",
    size = ggtext_size
  ) +
  # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  # scale_fill_manual(values = pal_ostwald_disc_long[c(1, 3)]) +
  scale_fill_gradientn(
    colours = rev(pal_ostwald_cont),
    # limits = c(0,10),
    # na.value = "#ED4137"
  ) +
  theme_leo() +
  guides(fill = guide_colorbar(title = "ddCt")) +
  labs(title = "Fold-change of laccase gene expression in single mutants") +
  theme(
    axis.title = element_blank(),
    legend.position = "bottom"
  )
```

### 2020-11-02

```{r}
plate <- tibble(
  row = rep(LETTERS[1:8], length.out = 96, each = 12),
  column = rep(1:12, length.out = 96, each = 1),
  sample = ordered(rep(c(
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "CC", "CC", "CC", "CC", "CC", "NTC",
    "CC", "CC", "CC", "CC", "CC", "NTC"
  ),
  length.out = 96, each = 1
  ), levels = c(
    "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1",
    "CC", "NTC"
  )),
  gene = ordered(c(rep(c("LAC11", "LAC17", "UBI", "EF1a"), length.out = 96, each = 24)),
    levels = c("LAC11", "LAC17", "UBI", "EF1a")
  ),
  replicate = rep(c("B1", "B2", "B2", "B1"), each = 6, length.out = 96),
  concentration = rep(c(
    rep(0.16666, length.out = 12),
    rep(c(1, 0.1, 0.02, 0.01, 0.005, 0), length.out = 12, each = 1)
  ), length.out = 96, each = 1)
) %>%
  unite("Pos", row, column, sep = "")

write_tsv(plate, paste0(
  datapath, "PhD/qPCR/2020-11-02_plate.tsv"
))

results <- read_tsv(paste0(
  datapath, "PhD/qPCR/2020-11-02_cp.tsv"
),
skip = 1
) %>%
  left_join(plate)

CCs <- filter(results, sample == "CC") %>%
  select(gene, replicate, concentration, Cp) %>%
  nest(data = c(concentration, Cp)) %>%
  mutate(
    fit = map(data, ~ lm(Cp ~ log10(concentration), data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    r.squared = unlist(map(model, ~ .x[["r.squared"]]))
  ) %>%
  unnest(tidied) %>%
  select(gene, replicate, r.squared, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(efficiency = (10^(-1 / `log10(concentration)`) - 1) * 100)


results <- left_join(results, CCs)

ggplot(
  data = filter(results, sample == "CC" & Cp < 35),
  aes(
    x = concentration,
    y = Cp,
    colour = gene
  )
) +
  geom_point() +
  geom_smooth(
    method = "lm",
    se = F
  ) +
  geom_label_repel(
    data = filter(results, concentration == 0.005),
    aes(label = paste0(
      gene,
      ": R² = ",
      round(r.squared, digits = 3),
      "; efficiency = ",
      round(efficiency, digits = 0),
      "%"
    )),
    hjust = 0,
    vjust = 0,
    colour = "black",
    label.size = 0,
    fill = rgb(1, 1, 1, 0.85),
    family = "Helvetica",
    size = ggtext_size
  ) +
  scale_colour_brewer(palette = "Pastel1") +
  scale_x_log10() +
  theme_leo() +
  facet_wrap(~replicate)

normalised <- results %>%
  filter(sample != "CC" & sample != "NTC") %>%
  group_by(replicate, sample) %>%
  mutate(dCt = Cp[gene == "EF1a"] - Cp) %>%
  group_by(replicate, gene) %>%
  mutate(
    ddCt = dCt - dCt[sample == "WT"],
    fold = 2^ddCt
  ) %>%
  pivot_longer(c(dCt, ddCt, fold), names_to = "metric", values_to = "value")

normalised_avg <- normalised %>%
  group_by(sample, gene, metric) %>%
  summarise(mean = mean(value))

ggplot(normalised) +
  geom_point(aes(
    x = sample,
    y = value,
    fill = replicate
  ),
  shape = 21,
  alpha = 0.75,
  stroke = 0.2,
  size = 3
  ) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  scale_fill_manual(values = pal_ostwald_disc_long[c(1, 3)]) +
  theme_leo() +
  theme(axis.title = element_blank()) +
  facet_grid(metric ~ gene, scales = "free")

ggplot() +
  geom_tile(
    data = normalised_avg %>%
      filter(metric == "ddCt"),
    aes(
      x = sample,
      y = gene,
      fill = mean
    )
  ) +
  geom_text(
    data = normalised_avg %>%
      filter(metric == "fold"),
    aes(
      x = sample,
      y = gene,
      label = round(mean, digits = 2)
    ),
    family = "Helvetica",
    size = ggtext_size
  ) +
  # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  # scale_fill_manual(values = pal_ostwald_disc_long[c(1, 3)]) +
  scale_fill_gradientn(
    colours = rev(pal_ostwald_cont),
    # limits = c(0,10),
    # na.value = "#ED4137"
  ) +
  theme_leo() +
  guides(fill = guide_colorbar(title = "ddCt")) +
  labs(title = "Fold-change of laccase gene expression in single mutants") +
  theme(
    axis.title = element_blank(),
    legend.position = "bottom"
  )
```

## Combined results

```{r}

result_files <-
  list.files(
    path = paste0(datapath, "PhD/qPCR/"),
    pattern = "cp.tsv",
    recursive = FALSE,
    full.names = TRUE
  )

plate_files <-
  list.files(
    path = paste0(datapath, "PhD/qPCR/"),
    pattern = "plate.tsv",
    recursive = FALSE,
    full.names = TRUE
  )

read_results <- function(flnm) {
  read_tsv(flnm, skip = 1) %>%
    mutate(
      filename = str_remove(basename(flnm), fixed(".tsv"))
    ) %>%
    separate(filename, into = c("date", "file"), sep = "_") %>%
    select(-file)
}

read_plates <- function(flnm) {
  read_tsv(flnm) %>%
    mutate(
      filename = str_remove(basename(flnm), fixed(".tsv"))
    ) %>%
    separate(filename, into = c("date", "file"), sep = "_") %>%
    select(-file)
}

results <- map(result_files, read_results) %>%
  bind_rows()

plates <- map(plate_files, read_plates) %>%
  bind_rows()

ref_genes <- tribble(
  ~date, ~gene, ~ref,
  "2020-10-26", "18S", "ref",
  "2020-10-27", "EF1a", "ref",
  "2020-10-28", "EF1a", "ref",
  "2020-10-31", "EF1a", "ref",
  "2020-11-02", "EF1a", "ref",
)

excluded_experiments <- c("2020-10-26")

results <- results %>%
  left_join(plates, by = c("date", "Pos")) %>%
  left_join(ref_genes, by = c("date", "gene")) %>%
  filter(!(date %in% excluded_experiments)) %>%
  mutate(ref = case_when(
    is.na(ref) ~ "goi",
    TRUE ~ ref
  )) %>%
  drop_na(sample) %>%
  mutate(
    gene = ordered(gene, levels = c("LAC4", "LAC10", "LAC11", "LAC12", "LAC17", "UBI", "18S", "EF1a")),
    sample = ordered(sample, levels = c("CC", "NTC", "WT", "lac4-2", "lac5-1", "lac10-1", "lac12-2", "lac17-1"))
  ) %>%
  group_by(date, replicate, gene, sample, concentration, ref) %>%
  summarise(Cp = mean(Cp))

CCs <- filter(results, sample == "CC" & Cp < 40) %>%
  nest(data = c(concentration, Cp)) %>%
  mutate(
    fit = map(data, ~ lm(Cp ~ log10(concentration), data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    r.squared = unlist(map(model, ~ .x[["r.squared"]]))
  ) %>%
  unnest(tidied) %>%
  select(date, gene, replicate, r.squared, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(efficiency = (10^(-1 / `log10(concentration)`) - 1) * 100)

CCs <- results %>%
  filter(concentration == 1) %>%
  select(gene, date, replicate, concentration, Cp) %>%
  left_join(CCs)

avg_CCs <- CCs %>%
  group_by(gene) %>%
  summarise(
    max = max(efficiency) + 5,
    efficiency = mean(efficiency)
  )

ggplot(
  CCs,
  aes(
    x = gene,
    y = efficiency
  )
) +
  stat_summary(
    fun = mean, color = NA,
    fill = "#e8c245",
    alpha = 0.5,
    geom = "bar",
    aes(group = 1), size = 5,
    show.legend = FALSE
  ) +
  geom_jitter(width = 0.1) +
  geom_text(
    data = avg_CCs,
    aes(
      label = paste0(round(efficiency, digits = 0), " %"),
      y = max
    ),
    family = "Helvetica",
    size = ggtext_size
  ) +
  theme_leo()

ggplot(
  data = filter(results, sample == "CC" & Cp < 40),
  aes(
    x = concentration,
    y = Cp,
    colour = gene
  )
) +
  geom_point() +
  geom_smooth(
    method = "lm",
    se = F
  ) +
  # geom_label_repel(
  #   data = CCs,
  #   aes(label = paste0(
  #     gene,
  #     ": R² = ",
  #     round(r.squared, digits = 3),
  #     "; efficiency = ",
  #     round(efficiency, digits = 0),
  #     "%"
  #   )),
  #   hjust = 0,
  #   vjust = 0,
  #   colour = "black",
  #   label.size = 0,
  #   fill = rgb(1, 1, 1, 0.5),
  #   family = "Helvetica",
  #   size = ggtext_size
  # ) +
  scale_colour_brewer(palette = "Pastel1") +
  scale_x_log10() +
  theme_leo() +
  facet_wrap(date ~ replicate)

normalised <- results %>%
  filter(sample != "CC" & sample != "NTC") %>%
  filter(gene != "18S") %>%
  group_by(date, replicate, sample) %>%
  mutate(dCt = Cp[ref == "ref"] - Cp) %>%
  group_by(date, replicate, gene) %>%
  mutate(
    ddCt = dCt - dCt[sample == "WT"],
    fold = 2^ddCt
  ) %>%
  pivot_longer(c(dCt, ddCt, fold), names_to = "metric", values_to = "value")

normalised_avg <- normalised %>%
  group_by(sample, gene, metric) %>%
  summarise(
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE)
  )

ggplot(
  filter(normalised, gene %in% c("LAC4", "LAC11", "LAC12", "LAC17")),
  aes(
    x = sample,
    y = value
  )
) +
  # geom_bar(stat = "identity") +
  ggbeeswarm::geom_quasirandom(aes(fill = replicate),
    shape = 21,
    alpha = 0.75,
    stroke = 0.2,
    size = 1.5
  ) +
  geom_boxplot(
    outlier.alpha = 0,
    alpha = 0.75,
    size = 0.2
  ) +
  # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  scale_fill_manual(values = pal_ostwald_disc_long) +
  theme_leo() +
  theme(axis.title = element_blank()) +
  coord_flip() +
  facet_grid(gene ~ metric, scales = "free")

ggplot() +
  geom_tile(
    data = normalised_avg %>%
      filter(metric == "ddCt"),
    aes(
      x = sample,
      y = gene,
      fill = mean
    ),
    # alpha = 0.75
  ) +
  geom_text(
    data = normalised_avg %>%
      filter(metric == "fold"),
    aes(
      x = sample,
      y = gene,
      label = paste0(round(mean, digits = 2), " ± ", round(sd, digits = 2))
    ),
    family = "Helvetica",
    size = ggtext_size
  ) +
  # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  # scale_fill_manual(values = pal_ostwald_disc_long[c(1, 3)]) +
  scale_fill_gradientn(
    colours = rev(pal_ostwald_cont),
    # colours = wesanderson::wes_palette("Zissou1", 3, type = "continuous"),
    limits = c(-5, 5),
    # midpoint = 0,
    oob = scales::squish
  ) +
  theme_leo() +
  guides(fill = guide_colorbar(title = "ddCt")) +
  labs(title = "Fold-change of laccase gene expression in single mutants") +
  theme(
    axis.title = element_blank(),
    legend.position = "bottom"
  )

WT_ex <- normalised %>%
  filter(gene %in% c("LAC4", "LAC11", "LAC12", "LAC17") &
    sample == "WT" &
    metric == "dCt") %>%
  mutate(gene = ordered(glue("<i>{gene}</i>"), levels = c("<i>LAC4</i>", "<i>LAC11</i>", "<i>LAC12</i>", "<i>LAC17</i>")))


WT_dCt <- ggplot(
  WT_ex,
  aes(
    x = gene,
    y = value
  )
) +
  # geom_bar(stat = "identity") +
  ggbeeswarm::geom_quasirandom(
    shape = 16,
    alpha = 0.75,
    # stroke = 0.2,
    size = 1
  ) +
  geom_boxplot(
    outlier.alpha = 0,
    alpha = 0.75,
    size = 0.2,
    fatten = 1,
    colour = "black",
    width = 0.25
  ) +
  # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_y_log10() +
  scale_fill_manual(values = pal_ostwald_disc_long) +
  labs(y = "Relative expression (&Delta;Ct)") +
  theme_leo() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(),
    axis.title.x = element_textbox_simple()
  ) +
  coord_flip()

pdf("WT_expression.pdf", height = onecol * 0.5, width = onecol * 0.5)
WT_dCt
dev.off()
```

# Section activity

## WT inactivation

```{r}

data <- read_csv(paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAF/2020-09-18_inactivation/2020-09-18_inactivation.csv")) %>%
  mutate(time = slice * interval) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, technical, substrate, treatment, pH, date, cell_type) %>%
  mutate(point = row_number())

#### subtract water column and background ####
data <- data %>%
  group_by(time, genotype, replicate, substrate, technical, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, technical, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == 100]
  )

nested_data <- data %>%
  filter(time >= 100 & time <= 230) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(time, zeroed_absorbance, median_hue) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  filter(term == "time")

raw_absorbance <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 230,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(point, treatment, technical)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  # theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_wrap(~cell_type)

activity_grid <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 230,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(treatment, point, technical)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(ylim = c(0, 0.2)) +
  facet_wrap(~cell_type)

slopes <- ggplot(
  nested_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = treatment,
    y = estimate,
    colour = treatment,
    shape = as.character(technical)
  )
) +
  geom_quasirandom(aes(group = treatment),
    size = 1,
    dodge.width = 0.5,
    alpha = 0.5
  ) +
  geom_violin(
    aes(group = interaction(treatment, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  # scale_colour_manual(values = c("#275d95")) +
  # scale_x_continuous(breaks = c(4, 5, 6, 7)) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_wrap(~cell_type, ncol = 4)

# pdf("WT_inactivation.pdf", width = twocol, height = onecol * 0.5)
raw_absorbance
activity_grid
slopes
# dev.off()
```

### Extension

After overnight incubation, added another 2 µl of 7 mM DAF stock to each well and took a picture every 10 min for 30 cycles.

```{r}

data <- read_csv(paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAF/2020-09-18_inactivation/2020-09-18_inactivation_extended.csv")) %>%
  mutate(time = slice * interval) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, technical, substrate, treatment, pH, date, cell_type) %>%
  mutate(point = row_number())

#### subtract water column and background ####
data <- data %>%
  group_by(time, genotype, replicate, substrate, technical, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, technical, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == 100]
  )

nested_data <- data %>%
  filter(time >= 100 & time <= 230) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(time, zeroed_absorbance, median_hue) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  filter(term == "time")

raw_absorbance <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 230,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(point, treatment)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  # theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_wrap(~cell_type)

activity_grid <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 230,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(treatment, point)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(ylim = c(0, 0.2)) +
  facet_wrap(~cell_type)

slopes <- ggplot(
  nested_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = treatment,
    y = estimate,
    colour = treatment
  )
) +
  geom_quasirandom(
    dodge.width = 0.5,
    alpha = 0.5
  ) +
  geom_violin(
    aes(group = interaction(treatment, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  # scale_colour_manual(values = c("#275d95")) +
  # scale_x_continuous(breaks = c(4, 5, 6, 7)) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_wrap(~cell_type, ncol = 4)

# pdf("WT_inactivation_extended.pdf", width = twocol, height = onecol * 0.5)
raw_absorbance
activity_grid
slopes
# dev.off()
```

## DAB pH 5

```{r}
lm_start <- 150
lm_stop <- 250


data_dab <- read_csv(paste0(
  datapath,
  "PhD/Laccase_activity/2020-09_activity/2020-09_lac_activity.csv"
),
comment = '"#',
col_types = "ccDcccdcddd"
) %>%
  mutate(
    time = slice * interval,
    genotype = ordered(genotype, levels = c(
      "WT",
      "Q-4",
      "Q-5",
      "Q-10",
      "Q-12",
      "Q-17",
      "Q"
    )),
    cell_type = ordered(cell_type, levels = c(
      "IF",
      "LP",
      "XF",
      "PX",
      "MX",
      "PH",
      "BG"
    ))
  ) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  mutate(
    point = row_number(),
    replicate = as.character(replicate)
  )

#### subtract water column and background ####
data_dab <- data_dab %>%
  filter(substrate == "DAB") %>%
  anti_join(read_csv(paste0(
    datapath,
    "PhD/Laccase_activity/2020-09_activity/excluded_sections.csv"
  ),
  col_type = "ccDccc"
  )) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == lm_start]
  )

nested_data_dab <- data_dab %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(data = c(time, zeroed_absorbance, median_hue)) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  group_by(genotype, replicate, date, treatment) %>%
  mutate(PH_slope = mean(estimate[cell_type == "PH"]))
# %>%
#   group_by(genotype, date, substrate, treatment, pH, cell_type) %>%
#   mutate(mean_estimate = mean(estimate)) %>%
#   group_by(date, substrate, treatment, pH, cell_type) %>%
#   mutate(rel_estimate = estimate / mean_estimate[genotype == "WT"])


data_dab <- data_dab %>%
  left_join(select(nested_data_dab, c(genotype:point, adj.r.squared)))

slope_dist <- ggplot(nested_data_dab) +
  geom_density(aes(
    x = adj.r.squared,
    fill = genotype
  ),
  # binwidth = 0.01,
  # position = "identity",
  alpha = 0.25,
  size = 0.1
  ) +
  geom_vline(
    xintercept = 0.85,
    colour = "black",
    linetype = 2
  ) +
  theme_leo() +
  facet_wrap(~cell_type, ncol = 1)

unfiltered_data_dab <- data_dab %>%
  filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    pH == 5 &
    treatment == "none")

data_dab <- data_dab %>%
  filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    pH == 5 &
    treatment == "none" 
    # adj.r.squared > 0.85
    )

nested_data_dab <- nested_data_dab %>%
  filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    pH == 5 &
    treatment == "none" 
    # adj.r.squared > 0.85
    )

avg_slopes <- nested_data_dab %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))

bulk_activity <- avg_slopes %>%
  group_by(genotype, substrate, treatment, pH, cell_type) %>%
  # summarise(mean = mean(mean_estimate)) %>%
  pivot_wider(names_from = cell_type, values_from = mean_estimate) %>%
  summarise(mean = 0.5 * IF + 0.25 * XF + 0.23 * MX + 0.02 * PX)

bulk_bars <- ggplot(bulk_activity, aes(x = genotype, y = mean)) +
  stat_summary(
    fun = mean, color = NA,
    fill = pal_ostwald_disc[2],
    alpha = 0.5,
    geom = "bar",
    aes(group = 1), size = 5,
    show.legend = FALSE
  ) +
  geom_jitter(width = 0.1) +
  labs(y = "Stem activity towards DAB") +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


activity_grid <- ggplot(
  data_dab,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = genotype,
    linetype = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  # geom_line(aes(group = interaction(genotype, replicate, point, date, treatment)),
  #   alpha = 0.1,
  #   size = 0.2
  # ) +
  geom_smooth(
    aes(group = interaction(genotype, replicate, date, treatment)),
    size = 0.2,
    se = F,
    # method = "lm",
    # fullrange = T
  ) +
  labs(
    x = "Time [min]",
    y = "Corrected & zeroed abs."
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 600)) +
  facet_wrap(~cell_type, nrow = 1)

raw_absorbance <- ggplot(
  unfiltered_data_dab,
  aes(
    x = time,
    y = mean_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 0.2
  ) +
  # geom_smooth(size = 0.2,
  #             se = F) +
  labs(
    x = "Time [min]",
    y = "Raw absorbance"
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 600)) +
  facet_wrap(~cell_type, nrow = 1)


letters_tech <- letter_groups(nested_data_dab,
  estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
)

letters <- letter_groups(avg_slopes,
  mean_estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
) %>%
  select(-mean_estimate) %>%
  left_join(select(letters_tech, -Letters))


slopes <- ggplot(
  nested_data_dab,
  aes(
    x = genotype,
    y = estimate,
    fill = genotype
  )
) +
  geom_quasirandom(aes(
    shape = replicate,
    group = genotype,
    fill = genotype
  ),
  colour = "black",
  # fill = "grey90",
  dodge.width = 0.5,
  alpha = 0.5,
  stroke = 0.1,
  size = 0.5
  ) +
  geom_violin(
    aes(group = interaction(treatment, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.4,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  geom_point(
    data = avg_slopes,
    aes(
      y = mean_estimate,
      shape = replicate
    ),
    colour = "black",
    alpha = 0.75,
    stroke = 0.1,
    size = 1
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "DAB oxidation rate") +
  scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    # legend.position = "bottom",
    axis.title.x = element_blank()
  ) +
  facet_wrap(~cell_type, nrow = 1)

pdf("DAB_pH5.pdf", width = twocol, height = onecol * 1.75)
raw_absorbance /
  activity_grid /
slopes
dev.off()

# pdf("DAB_pH5_diagnostics.pdf", width = onecol, height = onecol)
slope_dist
# dev.off()

# pdf("bulk_DAF.pdf", width = 0.5 * onecol, height = 0.5 * onecol)
bulk_bars
# dev.off()
```

## pH pilot

```{r}
data <- read_csv(paste0(
  datapath,
  "PhD/Laccase_activity/2020-09_activity/2020-09_lac_activity.csv"
),
comment = '"#'
) %>%
  mutate(time = slice * interval) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  mutate(point = row_number())

#### subtract water column and background ####
data <- data %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == 60]
  )

nested_data <- data %>%
  filter(time >= 100 & time <= 150) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(time, zeroed_absorbance, median_hue) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  filter(term == "time")

avg_slopes <- nested_data %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))

raw_absorbance <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    date == "2020-09-14"),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = cell_type
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 150,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(point, cell_type)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  # theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_grid(treatment ~ pH)


activity_grid <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    date == "2020-09-14"),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = cell_type
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 150,
    fill = "grey95"
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_grid(treatment ~ pH)


slopes <- ggplot(
  nested_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    date == "2020-09-14"),
  aes(
    x = pH,
    y = estimate,
    colour = treatment
  )
) +
  geom_quasirandom(
    dodge.width = 0.5,
    alpha = 0.5
  ) +
  geom_violin(
    aes(group = interaction(treatment, pH)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  scale_colour_manual(values = c("grey80", "#275d95")) +
  scale_x_continuous(breaks = c(4, 5, 6, 7)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_wrap(~cell_type, ncol = 4)

# pdf("WT_DAF_pH.pdf", width = twocol, height = onecol * 0.5)
raw_absorbance
activity_grid
slopes
# dev.off()
```

## pH optimum

```{r}
# Define the boundaries of the linear phase for each substrate and pH
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "PYGL", "4", 210, 600,
  "PYGL", "5", 90, 200,
  "PYGL", "6", 90, 200,
  "PYGL", "7", 30, 90,
  "DAF", "4", 70, 140,
  "DAF", "5", 80, 160,
  "DAF", "6", 90, 200,
  "DAF", "7", 90, 200
)

# remove points that moved outside the field-of-view due to section movement
sample_rm <- tribble(
  ~substrate, ~genotype, ~replicate, ~pH, ~treatment, ~cell_type, ~time,
  "DAF", "Q", "7", "6", "untreated", "PX", seq(0, 500, 10),
  "DAF", "WT", "8", "5", "autoclaved", c("IF", "CML", "LP", "MX", "PX", "XF", "PH", "BG"), seq(280, 500, 10)
) %>%
  unnest(time) %>%
  unnest(cell_type)

# load individual .csv files (from after the initial file became too large)
activity_opt_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-01_optimal_pH/ROIs/Measurements/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

pH_data_single_files <- map_dfr(activity_opt_files, read_csv)

pH_data <- read_csv(paste0(
  datapath,
  "PhD/Laccase_activity/2021-01_optimal_pH/pH_data.csv"
),
comment = '"#'
) %>%
  bind_rows(pH_data_single_files) %>% 
  mutate(time = slice * interval) %>%
  select(-c(slice, interval)) %>%
  separate(image,
    into = c("date", "substrate", "genotype", "replicate", "pH", "treatment"),
    sep = "_"
  ) %>%
  mutate(
    pH = str_remove(pH, "pH"),
    treatment = str_remove(treatment, fixed(".tiff"))
  ) %>%
  anti_join(sample_rm) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  mutate(point = row_number()) %>%
  left_join(lm_bounds) %>%
  filter(cell_type != "LP" & cell_type != "PX")

#### subtract water column and background ####
pH_data <- pH_data %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == lm_start]
  ) %>%
  filter(cell_type %in% c("IF", "CML", "LP", "MX", "PX", "XF"))

nested_pH_data <- pH_data %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(data = c(time, zeroed_absorbance, median_hue)) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  filter(term == "time")

avg_pH_slopes <- nested_pH_data %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))
```

### PYGL

```{r}

ctrl_slopes <- avg_pH_slopes %>%
  filter(treatment == "autoclaved" & substrate == "PYGL") %>%
  ungroup() %>%
  select(-treatment, replicate) %>%
  group_by(genotype, cell_type, pH) %>%
  summarise(mean_estimate = mean(mean_estimate))

pygl_slopes <- nested_pH_data %>%
  filter(substrate == "PYGL") %>%
  left_join(ctrl_slopes) %>%
  mutate(
    corrected_estimate = case_when(mean_estimate > 0 ~ estimate - mean_estimate,
                                   TRUE ~ estimate)
    )

activity_grid <- ggplot(
  pH_data %>% filter(substrate == "PYGL"),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = interaction(treatment, genotype),
    linetype = treatment
  )
) +
  geom_rect(
    data = lm_bounds %>% filter(substrate == "PYGL"),
    aes(
      xmin = lm_start,
      xmax = lm_stop,
      linetype = NULL,
      x = NULL, 
      y = NULL,
      colour = NULL
    ),
    ymin = -Inf,
    ymax = Inf,
    fill = "grey95"
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  scale_colour_manual(values = c(lighten(desaturate("#d25952", amount = 0.75), amount = 0.5),
                                 "#d25952", 
                                 lighten(desaturate("#275d95", amount = 0.75), amount = 0.5), 
                                 "#275d95")) +
  scale_linetype(guide = "none") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_grid(pH ~ cell_type)

letter_data <- nested_pH_data %>%
  filter(substrate == "PYGL") %>%
  unite("ID", treatment, genotype)

letters <- letter_groups(letter_data,
                         estimate,
                         ID,
                         "tukey",
                         cell_type,
                         pH,
                         print_position = "above",
                         print_adjust = 1
                         ) %>%
  separate(ID, into = c("treatment", "genotype"))

slopes <- ggplot(
  pygl_slopes,
  aes(
    x = pH,
    y = estimate,
    colour = interaction(treatment, genotype)
  )
) +
  geom_hline(
    yintercept = 0,
    size = 0.2
  ) +
  geom_quasirandom(
    dodge.width = 0.75,
    alpha = 0.5,
    shape = 16,
    size = 0.75
  ) +
  geom_violin(
    aes(group = interaction(treatment, pH, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.75),
    size = 0.2,
    scale = "width"
  ) +
  geom_text(data = letters,
            aes(label = Letters,
                group = interaction(treatment, genotype)),
            colour = "black",
            position = position_dodge2(width = 0.75),
            family = "Helvetica",
            size = ggtext_size) +
  scale_colour_manual(values = c(lighten(desaturate("#d25952", amount = 0.75), amount = 0.5),
                                 "#d25952", 
                                 lighten(desaturate("#275d95", amount = 0.75), amount = 0.5), 
                                 "#275d95")) +
  scale_x_discrete() +
  # scale_y_log10() +
  theme_leo() +
  theme(legend.position = "bottom",
        # panel.grid.major.y = element_line(size = 0.2)
        ) +
  facet_wrap(
    ~cell_type, 
    ncol = 6, 
    # scales = "free_y"
    )

pygl_slopes_cont <- pygl_slopes %>%
  mutate(pH = as.numeric(pH)) %>%
  filter(treatment == "untreated") %>%
  group_by(genotype, replicate, pH, cell_type) %>%
  summarise(mean_estimate = mean(corrected_estimate))

ph_cont <- ggplot(pygl_slopes_cont,
       aes(x = pH,
           y = mean_estimate)) +
  geom_hline(
    yintercept = 0,
    size = 0.2
  ) +
  geom_line(aes(colour = genotype,
                group = interaction(replicate, genotype)),
            size = 0.2,
            alpha = 0.25) +
  # geom_point(aes(colour = genotype),
  #            size = 1,
  #            alpha = 0.25,
  #            shape = 16) +
  # stat_smooth(geom = "line",
  #             aes(colour = genotype,
  #                 group = interaction(replicate, genotype)),
  #             span = 1.25,
  #             size = 0.2,
  #             alpha = 0.25,
  #             se = F) +
  geom_smooth(aes(colour = genotype),
              span = 1.25,
              size = 0.5,
              alpha = 1,
              se = F) +
  scale_colour_manual(values = c("#d25952", "#275d95")) +
  expand_limits(y = 0) +
  theme_leo() +
  facet_wrap(
    ~cell_type, 
    ncol = 6, 
    # scales = "free_y"
    )

pdf("PYGL_pH.pdf", width = twocol, height = onecol * 1.75)
activity_grid /
slopes /
ph_cont
dev.off()
```

### DAF

```{r}
activity_grid <- ggplot(
  pH_data %>% filter(substrate == "DAF"),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = interaction(treatment, genotype),
    linetype = treatment
  )
) +
  # annotate("rect",
  #   ymin = -Inf,
  #   ymax = Inf,
  #   xmin = lm_start,
  #   xmax = lm_stop,
  #   fill = "grey95"
  # ) +
  geom_rect(
    data = lm_bounds %>% filter(substrate == "DAF"),
    aes(
      xmin = lm_start,
      xmax = lm_stop,
      linetype = NULL,
      x = NULL, 
      y = NULL,
      colour = NULL
    ),
    ymin = -Inf,
    ymax = Inf,
    fill = "grey95"
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  scale_colour_manual(values = c(lighten(desaturate("#d25952", amount = 0.75), amount = 0.5),
                                 "#d25952", 
                                 lighten(desaturate("#275d95", amount = 0.75), amount = 0.5), 
                                 "#275d95")) +
  scale_linetype(guide = "none") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_grid(pH ~ cell_type)

letter_data <- nested_pH_data %>%
  filter(substrate == "DAF") %>%
  unite("ID", treatment, genotype)

letters <- letter_groups(letter_data,
                         estimate,
                         ID,
                         "tukey",
                         cell_type,
                         pH,
                         print_position = "above",
                         print_adjust = 1
                         ) %>%
  separate(ID, into = c("treatment", "genotype"))

slopes <- ggplot(
  nested_pH_data %>% filter(substrate == "DAF"),
  aes(
    x = pH,
    y = estimate,
    colour = interaction(treatment, genotype)
  )
) +
  geom_hline(
    yintercept = 0,
    size = 0.2
  ) +
  geom_quasirandom(
    dodge.width = 0.75,
    alpha = 0.5,
    shape = 16,
    size = 0.75
  ) +
  geom_violin(
    aes(group = interaction(treatment, pH, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.75),
    size = 0.2,
    scale = "width"
  ) +
  geom_text(data = letters,
            aes(label = Letters,
                group = interaction(treatment, genotype)),
            colour = "black",
            position = position_dodge2(width = 0.75),
            family = "Helvetica",
            size = ggtext_size) +
  scale_colour_manual(values = c(lighten(desaturate("#d25952", amount = 0.75), amount = 0.5),
                                 "#d25952", 
                                 lighten(desaturate("#275d95", amount = 0.75), amount = 0.5), 
                                 "#275d95")) +
  scale_x_discrete() +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_wrap(
    ~cell_type, 
    ncol = 4, 
    # scales = "free_y"
    )

daf_slopes_cont <- avg_pH_slopes %>%
  filter(substrate == "DAF" & treatment == "untreated") %>%
  mutate(pH = as.numeric(pH)) %>%
  group_by(genotype, replicate, pH, cell_type)

ph_cont <- ggplot(daf_slopes_cont,
       aes(x = pH,
           y = mean_estimate)) +
  # geom_point(aes(colour = genotype),
  #            size = 1,
  #            alpha = 0.25,
  #            shape = 16) +
  # stat_smooth(geom = "line",
  #             aes(colour = genotype,
  #                 group = interaction(replicate, genotype)),
  #             span = 1.25,
  #             size = 0.2,
  #             alpha = 0.25,
  #             se = F) +
  geom_line(aes(colour = genotype,
                group = interaction(replicate, genotype)),
            size = 0.2,
            alpha = 0.25) +
  geom_smooth(aes(colour = genotype),
              span = 1.25,
              size = 0.5,
              alpha = 1,
              se = F) +
  labs(y = "DAF oxidation rate") +
  scale_colour_manual(values = c("#d25952", "#275d95")) +
  expand_limits(y = 0) +
  theme_leo() +
  theme(legend.position = c(0.075, 0.9),
        legend.title = element_blank(),
        legend.direction = "horizontal") +
  facet_wrap(
    ~cell_type, 
    ncol = 4, 
    # scales = "free_y"
    )

pdf("DAF_pH.pdf", width = twocol, height = onecol * 0.5)
# activity_grid /
# slopes /
ph_cont
dev.off()
```

## DAF pH 5

```{r}
# start and stop of the time-window for linear regressions
lm_start <- 80
lm_stop <- 160

data_daf <- read_csv(paste0(
  datapath,
  "PhD/Laccase_activity/2020-09_activity/2020-09_lac_activity.csv"
),
comment = '"#',
col_types = "ccDcccdcddd"
) %>%
  mutate(
    time = slice * interval,
    genotype = ordered(genotype, levels = c(
      "WT",
      "Q-4",
      "Q-5",
      "Q-10",
      "Q-12",
      "Q-17",
      "Q"
    )),
    cell_type = ordered(cell_type, levels = c(
      "IF",
      "LP",
      "XF",
      "PX",
      "MX",
      "PH",
      "BG"
    ))
  ) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  mutate(
    point = row_number(),
    replicate = as.character(replicate)
  )

daf_IF_files <-
  list.files(
    path = "/home/leonard/Dropbox/DAF_pH5_IF/ROIs/Measurements/",
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

reps <- read_csv("/home/leonard/Dropbox/DAF_pH5_IF/to_measure_IF.csv") %>% 
  select(1:3) %>% 
  mutate(replicate = as.character(replicate))

daf_IF_data <- map_dfr(daf_IF_files, read_csv) %>%
  mutate(
    time = slice * interval,
    image = str_remove(image, fixed(".tiff"))
  ) %>%
  mutate(
    date = as.Date(ymd(
      str_extract(image, "[:digit:]{4}-[:digit:]{2}-[:digit:]{2}")
    )),
    genotype = str_remove(str_extract(image, "WT|Q-4|Q-5|Q-10|Q-12|Q-17|Q$|Q_"), "_"),
    treatment = "none",
    pH = "5",
    substrate = "DAF"
  ) %>%
  group_by(date, genotype, cell_type, time) %>% 
  mutate(point = row_number()) %>% 
  select(-image, -slice, -interval) %>% 
  left_join(reps)

#### subtract water column and background ####
data_daf <- data_daf %>%
  filter(substrate == "DAF" & cell_type != "IF") %>%
  anti_join(read_csv(paste0(
    datapath,
    "PhD/Laccase_activity/2020-09_activity/excluded_sections.csv"
  ),
  col_type = "ccDccc"
  )) %>%
  bind_rows(daf_IF_data) %>% 
  group_by(time, genotype, replicate, substrate, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == lm_start]
  )

nested_data_daf <- data_daf %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(data = c(time, zeroed_absorbance, median_hue)) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time")
# %>%
#   group_by(genotype, date, substrate, treatment, pH, cell_type) %>%
#   mutate(mean_estimate = mean(estimate)) %>%
#   group_by(date, substrate, treatment, pH, cell_type) %>%
#   mutate(rel_estimate = estimate / mean_estimate[genotype == "WT"])


data_daf <- data_daf %>%
  left_join(select(nested_data_daf, c(genotype:point, adj.r.squared)))

slope_dist <- ggplot(nested_data_daf) +
  geom_density(aes(
    x = adj.r.squared,
    fill = genotype
  ),
  # binwidth = 0.01,
  # position = "identity",
  alpha = 0.25,
  size = 0.1
  ) +
  geom_vline(
    xintercept = 0.85,
    colour = "black",
    linetype = 2
  ) +
  theme_leo() +
  facet_wrap(~cell_type, ncol = 1)


data_daf <- data_daf %>% filter(cell_type %in% c("IF", "CML", "XF", "MX", "PX") &
  pH == 5 &
  treatment == "none" 
  # adj.r.squared > 0.85
  )
nested_data_daf <- nested_data_daf %>% filter(cell_type %in% c("IF", "CML", "XF", "MX", "PX") &
  pH == 5 &
  treatment == "none" 
  # adj.r.squared > 0.85
  )

avg_slopes <- nested_data_daf %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))

bulk_activity <- avg_slopes %>%
  group_by(genotype, substrate, treatment, pH, cell_type) %>%
  # summarise(mean = mean(mean_estimate)) %>%
  pivot_wider(names_from = cell_type, values_from = mean_estimate) %>%
  summarise(mean = 0.5 * IF + 0.25 * XF + 0.23 * MX + 0.02 * PX)

bulk_bars <- ggplot(bulk_activity, aes(x = genotype, y = mean)) +
  stat_summary(
    fun = mean, color = NA,
    fill = pal_ostwald_disc[1],
    alpha = 0.5,
    geom = "bar",
    aes(group = 1), size = 5,
    show.legend = FALSE
  ) +
  geom_jitter(width = 0.1) +
  labs(y = "Stem activity towards DAF") +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


activity_grid <- ggplot(
  data_daf,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = genotype,
    linetype = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  # geom_line(aes(group = interaction(genotype, replicate, point, date, treatment)),
  #   alpha = 0.1,
  #   size = 0.2
  # ) +
  geom_smooth(
    aes(group = interaction(genotype, replicate, date, treatment)),
    size = 0.2,
    se = F,
    # method = "loess",
    # fullrange = T
  ) +
  labs(
    x = "Time [min]",
    y = "Corrected & zeroed abs."
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 400)) +
  facet_grid(~ cell_type)

raw_absorbance <- ggplot(
  data_daf,
  aes(
    x = time,
    y = mean_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 0.2
  ) +
  # geom_smooth(size = 0.2,
  #             se = F) +
  labs(
    x = "Time [min]",
    y = "Raw absorbance"
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 400)) +
  facet_wrap(~cell_type, ncol = 5)


# letters_tech <- letter_groups(nested_data_daf,
#   estimate,
#   genotype,
#   "tukey",
#   cell_type,
#   print_position = "above",
#   print_adjust = 1
# )
# 
# letters <- letter_groups(avg_slopes,
#   mean_estimate,
#   genotype,
#   "tukey",
#   cell_type,
#   print_position = "above",
#   print_adjust = 1
# ) %>%
#   select(-mean_estimate) %>%
#   left_join(select(letters_tech, -Letters))


slopes <- ggplot(
  nested_data_daf,
  aes(
    x = genotype,
    y = estimate,
    fill = genotype
  )
) +
  geom_quasirandom(aes(
    shape = replicate,
    group = genotype,
    fill = genotype
  ),
  colour = "black",
  # fill = "grey90",
  dodge.width = 0.5,
  alpha = 0.5,
  stroke = 0.1,
  size = 0.5
  ) +
  geom_violin(
    aes(group = interaction(treatment, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.4,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  geom_point(
    data = avg_slopes,
    aes(
      y = mean_estimate,
      shape = replicate
    ),
    colour = "black",
    alpha = 0.75,
    stroke = 0.1,
    size = 1
  ) +
  # geom_text(
  #   data = letters,
  #   aes(label = Letters),
  #   size = ggtext_size,
  #   family = "Helvetica"
  # ) +
  labs(y = "DAF oxidation rate") +
  scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank()
  ) +
  facet_wrap(~cell_type, ncol = 5)

pdf("DAF_pH5.pdf", width = twocol, height = twocol)
raw_absorbance /
  activity_grid /
  slopes
dev.off()

# pdf("DAF_pH5_diagnostics.pdf", width = onecol, height = onecol)
# slope_dist
# dev.off()

# pdf("bulk_DAF.pdf", width = 0.5 * onecol, height = 0.5 * onecol)
# bulk_bars
# dev.off()
```

## DAF pH 6

```{r}
# start and stop of the time-window for linear regressions
lm_start <- 80
lm_stop <- 160

reps <- tibble(
  date = c("2021-05-27", "2021-06-07", "2021-06-08", "2021-06-09", "2021-06-10"),
  replicate = c("6", "7", "8", "9", "10")
)

daf6_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-06_DAF_pH6/ROIs/Measurements/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

daf6_data <- map_dfr(daf6_files, read_csv) %>%
  mutate(
    time = slice * interval,
    image = str_remove(image, fixed(".tiff"))
  ) %>%
  separate(image,
    into = c("date", "substrate", "pH", "genotype"),
    sep = "_"
  ) %>%
  left_join(reps) %>%
  mutate(
    genotype = ordered(genotype, levels = c(
      "WT",
      "Q-4",
      "Q-5",
      "Q-10",
      "Q-12",
      "Q-17",
      "Q"
    )),
    cell_type = ordered(cell_type, levels = c(
      "IF",
      "CML",
      "LP",
      "XF",
      "PX",
      "MX",
      "PH",
      "BG"
    ))
  ) %>% 
group_by(genotype, replicate, substrate, pH, date, cell_type, time) %>%
  mutate(point = row_number()) %>%
  select(-slice, -interval)
  

#### subtract water column and background ####
daf6_data <- daf6_data %>%
  group_by(time, genotype, replicate, substrate, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == lm_start]
  )

nested_daf6_data <- daf6_data %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(data = c(time, zeroed_absorbance, median_hue)) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time")
# %>%
#   group_by(genotype, date, substrate, treatment, pH, cell_type) %>%
#   mutate(mean_estimate = mean(estimate)) %>%
#   group_by(date, substrate, treatment, pH, cell_type) %>%
#   mutate(rel_estimate = estimate / mean_estimate[genotype == "WT"])


daf6_data <- daf6_data %>%
  left_join(select(nested_daf6_data, c(genotype:point, adj.r.squared)))

slope_dist <- ggplot(nested_daf6_data) +
  geom_density(aes(
    x = adj.r.squared,
    fill = genotype
  ),
  # binwidth = 0.01,
  # position = "identity",
  alpha = 0.25,
  size = 0.1
  ) +
  geom_vline(
    xintercept = 0.85,
    colour = "black",
    linetype = 2
  ) +
  theme_leo() +
  facet_wrap(~cell_type, ncol = 1)


daf6_data <- daf6_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX", "CML"))
nested_daf6_data <- nested_daf6_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX", "CML"))

avg_slopes <- nested_daf6_data %>%
  group_by(genotype, replicate, substrate, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))

bulk_activity <- avg_slopes %>%
  group_by(genotype, substrate, pH, cell_type) %>%
  # summarise(mean = mean(mean_estimate)) %>%
  pivot_wider(names_from = cell_type, values_from = mean_estimate) %>%
  summarise(mean = 0.5 * IF + 0.25 * XF + 0.23 * MX + 0.02 * PX)

bulk_bars <- ggplot(bulk_activity, aes(x = genotype, y = mean)) +
  stat_summary(
    fun = mean, color = NA,
    fill = pal_ostwald_disc[1],
    alpha = 0.5,
    geom = "bar",
    aes(group = 1), size = 5,
    show.legend = FALSE
  ) +
  geom_jitter(width = 0.1) +
  labs(y = "Stem activity towards DAF") +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


activity_grid <- ggplot(
  daf6_data,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  # geom_line(aes(group = interaction(genotype, replicate, point, date, treatment)),
  #   alpha = 0.1,
  #   size = 0.2
  # ) +
  geom_smooth(
    aes(group = interaction(genotype, replicate, date)),
    size = 0.2,
    se = F,
    # method = "loess",
    # fullrange = T
  ) +
  labs(
    x = "Time [min]",
    y = "Corrected & zeroed abs."
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 400),
                  ylim = c(-0.2, 1)) +
  facet_grid(~ cell_type)

raw_absorbance <- ggplot(
  daf6_data,
  aes(
    x = time,
    y = mean_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 0.2
  ) +
  # geom_smooth(size = 0.2,
  #             se = F) +
  labs(
    x = "Time [min]",
    y = "Raw absorbance"
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 400),
                  ylim = c(-0.2, 1.5)) +
  facet_wrap(~cell_type, ncol = 5)


letters_tech <- letter_groups(nested_daf6_data,
  estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
)

letters <- letter_groups(avg_slopes,
  mean_estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
) %>%
  select(-mean_estimate) %>%
  left_join(select(letters_tech, -Letters))


slopes <- ggplot(
  nested_daf6_data,
  aes(
    x = genotype,
    y = estimate,
    fill = genotype
  )
) +
  geom_quasirandom(aes(
    shape = replicate,
    group = genotype,
    fill = genotype
  ),
  colour = "black",
  # fill = "grey90",
  dodge.width = 0.5,
  alpha = 0.5,
  stroke = 0.1,
  size = 0.5
  ) +
  geom_violin(
    aes(group = genotype),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.4,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  geom_point(
    data = avg_slopes,
    aes(
      y = mean_estimate,
      shape = replicate
    ),
    colour = "black",
    alpha = 0.75,
    stroke = 0.1,
    size = 1
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "DAF oxidation rate") +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank()
  ) +
  facet_wrap(~cell_type, ncol = 5)

pdf("DAF_pH6.pdf", width = twocol, height = twocol)
raw_absorbance /
  activity_grid /
  slopes
dev.off()

# pdf("DAF_pH5_diagnostics.pdf", width = onecol, height = onecol)
# slope_dist
# dev.off()

# pdf("bulk_DAF.pdf", width = 0.5 * onecol, height = 0.5 * onecol)
# bulk_bars
# dev.off()
```


### Animations

```{r}
# gganimate conflicts with showtext, so to generate the animation with the custom theme, comment out showtext, the font_add lines and the "Helvetica" lines in the setup.
lm_start <- 100
lm_stop <- 300

data_sample <- data %>%
  filter(
    # genotype == "WT" &
    date == "2020-10-01" &
      cell_type == "IF"
    # point == 1
  )

data_lm <- data %>%
  filter(
    # genotype == "WT" &
    date == "2020-10-01" &
      cell_type == "IF" &
      time >= lm_start &
      time <= lm_stop
    # point == 1
  ) %>%
  group_by(genotype) %>%
  nest() %>%
  mutate(model = data %>% map(~ lm(zeroed_absorbance ~ time, data = .))) %>%
  mutate(Pred = map2(model, data, predict)) %>%
  unnest(Pred, data)

raw_absorbance <- ggplot(
  data_sample,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  geom_line(
    aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_point(
    aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 1
  ) +
  geom_line(
    data = data_lm,
    aes(y = Pred),
    size = 0.5,
    linetype = 2,
    se = F,
    method = "lm",
    fullrange = T
  ) +
  labs(
    x = "Time [min]",
    y = "Corrected absorbance"
  ) +
  # theme_leo() +
  # theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(0, 400),
  #                 ylim = c(0,2)) +
  # facet_wrap(~cell_type, ncol = 5) +
  transition_reveal(time)


animate(raw_absorbance,
  # renderer = magick_renderer(),
  # device = "tiff",
  height = 2,
  width = 2,
  units = "in",
  res = 300
)

anim_save("Full_IF_1_animation.gif")
```

## Single plots

```{r}
single_violin_data <- nested_data_dab %>%
  full_join(nested_data_daf) %>% 
  mutate(genotype = recode(genotype,
                           "Q-4" = "<i>Q-4</i>",
                           "Q-5" = "<i>Q-5</i>",
                           "Q-10" = "<i>Q-10</i>",
                           "Q-12" = "<i>Q-12</i>",
                           "Q-17" = "<i>Q-17</i>",
                           "Q" = "<i>Q</i>"))

single_violin_avg <- single_violin_data

act_violin <- function(subst, ct) {
  letters <- letter_groups(single_violin_data %>% 
                             filter(substrate == subst & cell_type == ct),
    estimate,
    genotype,
    "tukey",
    print_position = "below",
    print_adjust = 0.75
  ) 

  ggplot(
    data = single_violin_data %>% 
      filter(substrate == subst & cell_type == ct),
    aes(x = genotype, y = estimate)
  ) +
    geom_quasirandom(
      aes(fill = genotype),
      dodge.width = 0.6,
      shape = 21,
      alpha = 0.75,
      size = 1,
      stroke = 0.2
    ) +
    geom_violin(aes(
      group = genotype
    ),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.6),
    size = 0.2,
    scale = "width"
    ) +
    geom_text(
      data = letters,
      aes(label = Letters),
      size = ggtext_size,
      family = "Helvetica",
      position = position_dodge(width = 0.6)
    ) +
    labs(y = paste(subst, "oxidation rate"),
         title = ct) +
    scale_y_continuous(expand = expansion(mult = 0.1)) +
    # scale_x_discrete(labels = c("PX", "PMX", "SMX")) +
    # scale_fill_manual(values = pal_flame_disc) +
    # expand_limits(y = 0) +
    theme_leo() +
    theme(
      text = element_text(family = "Helvetica"),
      axis.title.x = element_blank(),
      axis.title.y = element_markdown(),
      axis.text.y = element_blank(),
      axis.text.x = element_markdown(),
      axis.ticks.y = element_blank()
    )
}

pdf("DAF_IF_pH5.pdf", width = onecol * 0.5, height = onecol * 0.25)
act_violin("DAF", "IF")
dev.off()

pdf("DAB_IF_pH5.pdf", width = onecol * 0.5, height = onecol * 0.25)
act_violin("DAB", "IF")
dev.off()
```

# TE activity

## DAF spectrum

```{r}
daf_plate <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-05-24_DAF_analysis/2021-05-24_DAF.csv")
  ) %>% 
  unite("Well", row, column, sep = "")

daf_abs <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-05-24_DAF_analysis/LB_TE-activity_20210524_115625.csv")
  )

daf <- left_join(daf_abs, daf_plate) %>% 
  separate(Well, into = c("row", "column"), sep = 1) %>% 
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>% 
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 1) - 1 # 1 minute between measurements
  )

spectra <- ggplot(daf,
                  aes(x = wavelength,
                      y = absorbance,
                      group = time)) +
  geom_line() +
  theme_leo() +
  facet_grid(row ~ column)

plotly::ggplotly(spectra)

peaks <- c(290, 360, 610, 800)

daf_peaks <- daf %>% 
  filter(wavelength %in% peaks) %>% 
  mutate(wavelength = as.character(wavelength))

peak_time <- ggplot(daf_peaks,
                    aes(x = time,
                        y = absorbance,
                        colour = wavelength)) +
  geom_point() +
  geom_smooth(aes(group = wavelength)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(row ~ column)

peak_time

peak_conc <- ggplot(daf_peaks %>% filter(time == 39 & concentration > 0.7),
                    aes(x = concentration,
                        y = absorbance,
                        colour = wavelength)) +
  geom_point() +
  geom_smooth(aes(group = wavelength),
              method = "lm", 
              se = F,
              linetype = 2) +
  geom_line(aes(group = wavelength)) +
  theme_leo() +
  scale_x_log10() +
  theme(legend.position = "bottom") +
  facet_wrap(~ row, ncol = 4)

peak_conc
```

## Viability

### Load viability and differentiation data

```{r}
growth_estimates <- read_csv(paste0(datapath, "PhD/Cell cultures/2021_timelines/2021_timeline_counts.csv"),
                             col_types = "Dccnnnnnc") %>%
  select(-comment)

growth_files <-
  list.files(
    path = "/home/leonard/Dropbox/2021-01_inductions/",
    pattern = "*.txt",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = "code",
    col_types = "c",
    # locale = locale(decimal_mark = ",")
  ) %>%
    mutate(filename = basename(flnm)) %>%
    separate(filename, into = c("date", "replicate", "dpi", "treatment"), sep = "_") %>%
    mutate(
      date = ymd(as_date(date)),
      replicate = str_remove(replicate, fixed("R")),
      dpi = as.numeric(str_remove(dpi, fixed("d"))),
      treatment = str_remove(treatment, fixed(".txt"))
    )
}


growth_data <- map(growth_files, read_plus) %>%
  bind_rows() %>%
  mutate(
    code = str_to_lower(code),
    nTEs_alive = str_count(code, "k"),
    nTEs_dead = str_count(code, "l"),
    TEs_alive = str_count(code, "i"),
    TEs_dead = str_count(code, "o")
  ) %>%
  add_row(growth_estimates) %>%
  mutate(
    n = nTEs_alive + nTEs_dead + TEs_alive + TEs_dead,
    nTE_viab = nTEs_alive / (nTEs_alive + nTEs_dead),
    TE_prop = (TEs_alive + TEs_dead) / n,
    TE_viab = TEs_alive / (TEs_alive + TEs_dead),
    TE_viab = case_when(is.nan(TE_viab) ~ 1,
                        TRUE ~ TE_viab)
  )

growth_avg <- growth_data %>%
  group_by(treatment, dpi) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))
```

### Plot differentiation curves

```{r}

growth <- ggplot(growth_data %>% filter(treatment == "ind")) +
  geom_tile(
    data = growth_avg %>% filter(treatment == "ind"),
    aes(
      x = dpi,
      y = TE_prop,
      fill = nTE_viab
    ),
    width = 1,
    height = Inf,
    alpha = 0.75
  ) +
  geom_smooth(
    aes(
      x = dpi,
      y = TE_prop
    ),
    se = F,
    colour = "black",
    # span = 1
  ) +
  # geom_line(
  #   aes(
  #   x = dpi,
  #   y = TE_prop,
  #   group = replicate
  #   ),
  #   size = 0.2,
  #   alpha = 0.5,
  #   # se = F,
  #   colour = "black",
  #   # span = 1
  # ) +
  geom_point(aes(
    x = dpi,
    y = TE_prop,
    fill = TE_viab
  ),
  size = 3,
  shape = 21,
  stroke = 0.2
  ) +
  scale_fill_gradientn(colours = pal_ostwald_cont, trans = "reverse", name = "Viability", limits = c(1, 0)) +
  scale_x_continuous(limits = c(-0.5, 21.5), expand = expansion(add = 0)) +
  labs(
    x = "Days past induction",
    y = "TE proportion"
  ) +
  theme_leo() +
  theme(legend.position = "bottom")

pdf("TE_growth.pdf", width = onecol, height = onecol * 0.5)
growth
# growth_facet
dev.off()
```

#### Sigmoid fit

```{r}

growth_fine <- tibble(
  dpi = rep(rep(seq(0, 21, 0.1), times = 3), times = 4),
  variable = rep(rep(c("nTE_viab", "TE_prop", "TE_viab"), each = 211, length.out = 633), times = 4),
  replicate = rep(c("1", "2", "3", "4"), each = 633, length.out = 2532)
)

growth_long <- growth_data %>%
  filter(treatment == "ind") %>%
  pivot_longer(cols = c(TE_viab, TE_prop),
               names_to = "variable",
               values_to = "value")

growth_sigmoid <- growth_long %>%
  select(replicate, dpi, variable, value) %>%
  full_join(growth_fine) %>%
  filter(variable != "nTE_viab") %>%
  group_by(variable) %>%
  nest(data = c(replicate, dpi, value)) %>%
  mutate(
    model_drc = map(data, ~ drc::drm(value ~ dpi, data = .x, fct = drc::G.3())),
    tidy_drc = map(model_drc, tidy),
    tidy_drc = map(tidy_drc, `[`, c("term", "estimate"))
  ) %>%
  unnest(tidy_drc) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(
    # data = map2(data, b, ~ mutate(.x, b_drc = round(.y, digits = 1))),
    data = map2(data, b, ~ mutate(.x, b_drc = 1)), # set b to 1 to avoid singular gradients (no idea why)
    data = map2(data, d, ~ mutate(.x, d_drc = round(.y, digits = 1))),
    data = map2(data, e, ~ mutate(.x, e_drc = round(.y, digits = 1))),
    model_nls = map(data, ~ nls(
      value ~ b / (1 + exp(-d * (dpi - e))),
      start = c(b = unique(.x$b_drc), d = unique(.x$d_drc), e = unique(.x$e_drc)),
      data = .x
    )),
    tidy_nls = map(model_nls, tidy),
    tidy_nls = map(tidy_nls, `[`, c("term", "estimate")),
    predicted = map2(model_nls, data, ~ predict(.x, newdata = .y))
  ) %>%
  select(-b, -d, -e) %>%
  unnest(tidy_nls) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  unnest(c(data, predicted)) %>%
  mutate(variable = recode(variable,
                           nTE_viab = "Non-TE viability",
                           TE_prop = "TE proportion",
                           TE_viab = "TE viability"))

sigmoid_inflection <- growth_sigmoid %>%
  group_by(variable) %>%
  summarise(inflection_x = mean(round(e, digits = 1)),
            inflection_y = mean(predicted[round(dpi, digits = 1) == round(inflection_x, digits = 1)]))

growth_facet <- ggplot(
  growth_sigmoid,
  aes(
    x = dpi,
    y = value
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  geom_segment(data = sigmoid_inflection,
             aes(x = inflection_x,
                 xend = inflection_x,
                 y = inflection_y,
                 yend = Inf),
             size = 0.2,
             linetype = 2,
             # arrow = arrow(ends = "first",
             #               type = "closed",
             #               angle = 10,
             #               length = unit(1.5, "mm"))
             ) +
  geom_point(
    # aes(colour = replicate),
    alpha = 0.5,
    shape = 16,
    size = 0.5
  ) +
  geom_text(data = sigmoid_inflection,
            aes(x = inflection_x,
                y = 1,
                label = paste(" ", inflection_x, "dpi")),
            family = "Helvetica",
            size = ggtext_size,
            hjust = 0) +
  # stat_smooth(geom = "line",
  #             aes(group = replicate),
  #             size = 0.2,
  #             alpha = 0.5,
  #             span = 0.9) +
  geom_line(aes(y = predicted),
    colour = "#275d95",
    size = 0.2
  ) +
  scale_y_continuous(limits = c(0, 1),
                     labels = c("0", "25", "50", "75", "100")) +
  labs(y = "Proportion [%]",
       x = "Days past induction (dpi)") +
  theme_leo() +
  facet_wrap(~variable, ncol = 3)

pdf("TE_growth_sigmoid.pdf", width = onecol * 0.8, height = onecol * 0.4)
# growth
growth_facet
dev.off()

# svglite::svglite("TE_growth_sigmoid.svg", width = onecol, height = onecol * 0.5)
# # growth
# growth_facet
# dev.off()
# 
# ragg::agg_png("TE_growth_sigmoid.png", width = onecol, height = onecol * 0.5,
#               units = "in", res = 600)
# growth_facet
# dev.off()

```

## Pilots

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "MBTH", 4, 100, 400,
  "MBTH", 5, 100, 400,
  "MBTH", 6, 100, 400,
  "MBTH", 7, 100, 400,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
)

abs_max <- tibble(
  substrate = c("DAF", "PYGL", "SGZ", "ABTS"),
  abs_max = c(610, 360, 525, 420),
  abs_min = c(450, 600, 600, 480)
  )

plate <- tibble(
  row = rep(LETTERS[1:4], length.out = 48, each = 12),
  column = rep(1:12, length.out = 48, each = 1),
  sample = c(
    rep(c(
      rep(c("TE", "nTE", "ctrl"),
      length.out = 12, each = 4
      )
    ),
    length.out = 48
    )
  ),
  substrate = ordered(rep(c("DAF", "PYGL", "SGZ", "ABTS"), each = 12),
                      levels = c("DAF", "PYGL", "SGZ", "ABTS")),
  pH = rep(rep(c(4:7), length.out = 12), length.out = 48),
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

pilot1 <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-17_pilot.csv")
  ) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>% 
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>% 
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = `Cycle #` * 20) %>% # 20 minutes between measurements
  group_by(sample, substrate, pH, replicate, day) %>%
  mutate(density = absorbance[wavelength == 600 & `Cycle #` == 1],
         adjusted_absorbance = case_when(sample == "ctrl" ~ absorbance,
                                         TRUE ~ absorbance / density),
         zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 2]) %>% 
  select(-`Cycle #`, -`Time (s)`)
  
pilot1_peaks <- pilot1 %>%
  group_by(sample, substrate, pH, replicate, day, time, lm_start, lm_stop, Well) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>% 
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max])

ggplot(pilot1_peaks,
       aes(x = time,
           y = corrected_absorbance,
           colour = sample)) +
  geom_line() +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(pH ~ substrate, scale = "free")

pilot1_nested <- pilot1_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(column = as.numeric(str_remove(Well, "[:alpha:]")),
         row = ordered(str_extract(Well, "[:alpha:]"),
                       levels = c("A", "B", "C", "D")))

ggplot(
  pilot1_nested,
  aes(x = column, y = row, fill = estimate)) +
  geom_tile() +
  # scale_x_discrete(limits = rev(levels(pilot1_nested$dilution))) +
  scale_y_discrete(limits = rev(levels(pilot1_nested$row))) +
  # scale_fill_gradientn(colours = rev(pal_ostwald_cont)) +
  scale_fill_viridis_c() +
  geom_label(aes(label = round(estimate, digits = 4))) +
  theme_leo() 
 

# plotly::ggplotly(ggplot(filter(pilot1, sample == "nTE" & substrate == "DAF" & pH == 5),
#        aes(x = wavelength,
#            y = adjusted_absorbance,
#            colour = time,
#            group = time)) +
#   geom_line(size = 0.1))

```

### Calibration

```{r}
# load data ####
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400
)

abs_max <- tibble(
  substrate = c("DAF", "PYGL", "SGZ", "ABTS"),
  abs_max = c(610, 450, 525, 420),
  abs_min = c(450, 600, 600, 480)
)

plate <- tibble(
  row = rep(LETTERS[1:3], length.out = 18, each = 6),
  column = rep(1:6, length.out = 18, each = 1),
  dilution = rep(c(1, 0.5, 0.25, 0.125, 0.0625, 0.03125), length.out = 18),
  technical = rep(c(1:3), each = 6, length.out = 18),
  sample = "nTE",
  substrate = ordered(c("PYGL"), levels = c("DAF", "PYGL", "SGZ", "ABTS")),
  pH = 6,
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

calibration <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-22_OD_calibration.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>% 
  group_by(sample, substrate, pH, replicate, dilution, technical, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance # do not adjust for density
      # TRUE ~ absorbance / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

# validate OD600 for cell density ####
calibration_density <- calibration %>%
  summarise(density = mean(density))

cal_r2 <- round(
  summary(
    lm(density ~ dilution, data = calibration_density)
    )$adj.r.squared, 
  digits = 2)

ggplot(calibration_density,
       aes(x = dilution,
           y = density)) +
  geom_point() +
  geom_smooth(method = "lm") +
  annotate("text",
           label = paste("R² =", cal_r2),
           x = 0.1,
           y = 1.4) +
  theme_leo()

# plot absorbance over time ####
calibration_peaks <- calibration %>%
  group_by(
    sample, substrate, pH, replicate, dilution, technical, day, time, lm_start, lm_stop, density
    ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>% 
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max])

ggplot(calibration_peaks,
       aes(x = time,
           y = corrected_absorbance,
           colour = sample)) +
  geom_line(aes(group = technical)) +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_wrap(~ dilution)

# calculate slopes of linear phase ####
calibration_nested <- calibration_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(dilution = as.character(dilution))

ggplot(
  calibration_nested,
  aes(x = density, y = estimate)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "PYGL oxidation rate") +
  expand_limits(y = 0) +
  theme_leo() +
  facet_wrap(~substrate)

```

### Calibration II

```{r}

lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400
)

abs_max <- tibble(
  substrate = c("DAF", "PYGL", "SGZ", "ABTS"),
  abs_max = c(610, 360, 525, 420),
  abs_min = c(450, 600, 600, 480)
)

plate <- tibble(
  row = rep(LETTERS[1:6], length.out = 48, each = 8),
  column = rep(1:8, length.out = 48, each = 1),
  concentration = rep(c(10, 5, 2.5), each = 8, length.out = 48),
  dilution = rep(c(1, 0.5, 0.25, 0.125, 0.0625, 0.03125, 0.015625, 0), length.out = 48),
  sample = "nTE",
  substrate = ordered(rep(c("PYGL", "ABTS"), each = 24, length.out = 48), levels = c("DAF", "PYGL", "SGZ", "ABTS")),
  pH = rep(c(6, 4), each = 24, length.out = 48),
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

calibration <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-23_OD_calibration.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>% 
  group_by(sample, substrate, pH, replicate, dilution, concentration, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance # do not adjust for density
      # TRUE ~ absorbance / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

# validate OD600 for cell density ####
calibration_density <- calibration %>%
  summarise(density = mean(density))

cal_r2 <- round(
  summary(
    lm(density ~ dilution, data = calibration_density)
    )$adj.r.squared, 
  digits = 2)

ggplot(calibration_density,
       aes(x = dilution,
           y = density)) +
  geom_point(aes(colour = pH)) +
  geom_smooth(method = "lm") +
  annotate("text",
           label = paste("R² =", cal_r2),
           x = 0.1,
           y = 1.4) +
  theme_leo()

# check which wavelength to use for PYGL ####
calibration_wide <- calibration %>%
  select(-measurement, -absorbance, -adjusted_absorbance) %>%
  filter(wavelength %in% c(300, 360, 450)) %>%
  pivot_wider(names_from = wavelength, values_from = zeroed_absorbance)

ggplot(filter(calibration_wide, substrate == "PYGL"),
       aes(x = `450`, y = `360`)) +
  geom_point() +
  geom_smooth(method = "lm")

# plot absorbance over time ####
calibration_peaks <- calibration %>%
  group_by(
    sample, substrate, pH, replicate, dilution, concentration, day, time, lm_start, lm_stop, density
    ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>% 
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max])

ggplot(calibration_peaks,
       aes(x = time,
           y = corrected_absorbance,
           colour = concentration)) +
  geom_line(aes(group = concentration)) +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(substrate ~ dilution)

# calculate slopes of linear phase ####
calibration_nested <- calibration_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(dilution = as.factor(dilution))

ggplot(
  calibration_nested,
  aes(x = density, y = estimate, colour = concentration)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "Oxidation rate") +
  expand_limits(y = 0) +
  theme_leo() +
  facet_wrap(~ substrate, scales = "free_y")

ggplot(
  calibration_nested,
  aes(x = dilution, y = interaction(concentration, substrate), fill = estimate)) +
  geom_tile() +
  scale_x_discrete(limits = rev(levels(calibration_nested$dilution))) +
  # scale_fill_gradientn(colours = rev(pal_ostwald_cont)) +
  scale_fill_viridis_c() +
  geom_label(aes(label = round(estimate, digits = 4))) +
  theme_leo() 

```

### Calibration III

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "MBTH", 4, 100, 400,
  "MBTH", 5, 100, 400,
  "MBTH", 6, 100, 400,
  "MBTH", 7, 100, 400,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
)

abs_max <- tibble(
  substrate = c("ABTS", "DAF", "MBTH", "PYGL", "SGZ"),
  abs_max = c(420, 610, 505, 360, 525),
  abs_min = c(480, 450, 700, 600, 600)
)

plate <- tibble(
  row = rep(LETTERS[1:5], length.out = 40, each = 8),
  column = rep(1:8, length.out = 40, each = 1),
  concentration = rep(c(5, 0.07, 5, 0.1, 6), each = 8, length.out = 40),
  dilution = rep(c(1, 0.5, 0.25, 0.125, 0.0625, 0.03125, 0.015625, 0), length.out = 40),
  sample = "TE",
  substrate = ordered(rep(c("ABTS", "DAF", "PYGL", "SGZ", "MBTH"), each = 8, length.out = 40), 
                      levels = c("ABTS", "DAF", "PYGL", "SGZ", "MBTH")),
  pH = rep(c(4, 5, 6, 5, 5), each = 8, length.out = 40),
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

calibration <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-24_OD_calibration.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    substrate = ordered(substrate, levels = c("ABTS", "DAF", "PYGL", "SGZ", "MBTH")),
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>% 
  group_by(sample, substrate, pH, replicate, dilution, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance # do not adjust for density
      # TRUE ~ absorbance / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

# validate OD600 for cell density ####
calibration_density <- calibration %>%
  summarise(density = mean(density))

cal_r2 <- round(
  summary(
    lm(density ~ dilution, data = calibration_density)
    )$adj.r.squared, 
  digits = 2)

ggplot(calibration_density,
       aes(x = dilution,
           y = density)) +
  geom_point(aes(colour = pH)) +
  geom_smooth(method = "lm") +
  annotate("text",
           label = paste("R² =", cal_r2),
           x = 0.1,
           y = 1.4) +
  theme_leo()

# check which wavelength to use for PYGL ####
calibration_wide <- calibration %>%
  select(-measurement, -absorbance, -adjusted_absorbance) %>%
  filter(wavelength %in% c(300, 360, 450)) %>%
  pivot_wider(names_from = wavelength, values_from = zeroed_absorbance)

ggplot(filter(calibration_wide, substrate == "PYGL"),
       aes(x = `450`, y = `360`)) +
  geom_point() +
  geom_smooth(method = "lm")

# plot absorbance over time ####
calibration_peaks <- calibration %>%
  group_by(
    sample, substrate, pH, replicate, dilution, day, time, lm_start, lm_stop, density
    ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>% 
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max])

ggplot(calibration_peaks,
       aes(x = time,
           y = corrected_absorbance)) +
  geom_line() +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(substrate ~ dilution)

# calculate slopes of linear phase ####
calibration_nested <- calibration_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(dilution = as.factor(dilution))

ggplot(
  calibration_nested,
  aes(x = density, y = estimate)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "Oxidation rate") +
  expand_limits(y = 0) +
  theme_leo() +
  facet_wrap(~ substrate, scales = "free_y")

ggplot(
  calibration_nested,
  aes(x = dilution, y = substrate, fill = estimate)) +
  geom_tile() +
  scale_x_discrete(limits = rev(levels(calibration_nested$dilution))) +
  scale_y_discrete(limits = rev(levels(calibration_nested$substrate))) +
  # scale_fill_gradientn(colours = rev(pal_ostwald_cont)) +
  scale_fill_viridis_c() +
  geom_label(aes(label = round(estimate, digits = 4))) +
  theme_leo() 

```

### Calibration IV

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "MBTH", 4, 100, 400,
  "MBTH", 5, 100, 400,
  "MBTH", 6, 100, 400,
  "MBTH", 7, 100, 400,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
)

abs_max <- tibble(
  substrate = c("ABTS", "DAF", "MBTH", "PYGL", "SGZ"),
  abs_max = c(420, 610, 505, 450, 525),
  abs_min = c(480, 450, 700, 600, 600)
)

plate <- tibble(
  row = rep(LETTERS[1:6], length.out = 48, each = 8),
  column = rep(1:8, length.out = 48, each = 1),
  concentration = rep(c(5, 0.5, 0.05), each = 16, length.out = 48),
  dilution = rep(c(1, 0.5, 0.25, 0.125, 0.0625, 0.03125, 0.015625, 0), length.out = 48),
  sample = rep(c("TE", "nTE"), each = 8, length.out = 48),
  substrate = ordered("PYGL", 
                      levels = c("ABTS", "DAF", "PYGL", "SGZ", "MBTH")),
  pH = 6,
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

calibration <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-25_OD_calibration.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    substrate = ordered(substrate, levels = c("ABTS", "DAF", "PYGL", "SGZ", "MBTH")),
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>% 
  group_by(sample, substrate, pH, replicate, dilution, concentration, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance # do not adjust for density
      # TRUE ~ absorbance / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

# validate OD600 for cell density ####
calibration_density <- calibration %>%
  summarise(density = mean(density))

cal_r2 <- round(
  summary(
    lm(density ~ dilution, data = calibration_density)
    )$adj.r.squared, 
  digits = 2)

ggplot(calibration_density,
       aes(x = dilution,
           y = density)) +
  geom_point(aes(colour = sample)) +
  geom_smooth(aes(colour = sample),
              method = "lm") +
  annotate("text",
           label = paste("R² =", cal_r2),
           x = 0.1,
           y = 1.4) +
  theme_leo()

# check which wavelength to use for PYGL ####
calibration_wide <- calibration %>%
  select(-measurement, -absorbance, -adjusted_absorbance) %>%
  filter(wavelength %in% c(300, 360, 450)) %>%
  pivot_wider(names_from = wavelength, values_from = zeroed_absorbance)

ggplot(filter(calibration_wide, substrate == "PYGL"),
       aes(x = `450`, y = `360`, colour = concentration)) +
  geom_point() +
  geom_smooth(method = "lm")

# plot absorbance over time ####
calibration_peaks <- calibration %>%
  group_by(
    sample, substrate, pH, replicate, dilution, concentration, day, time, lm_start, lm_stop, density
    ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>% 
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max])

ggplot(calibration_peaks,
       aes(x = time,
           y = corrected_absorbance,
           colour = sample)) +
  geom_line() +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(concentration ~ dilution)

# calculate slopes of linear phase ####
calibration_nested <- calibration_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(dilution = as.factor(dilution))

ggplot(
  calibration_nested,
  aes(x = density, y = estimate)) +
  geom_point() +
  geom_smooth(method = "loess") +
  labs(y = "Oxidation rate") +
  expand_limits(y = 0) +
  theme_leo() +
  facet_grid(sample ~ concentration, scales = "free_y")

ggplot(
  calibration_nested,
  aes(x = dilution, y = interaction(sample, concentration), fill = estimate)) +
  geom_tile() +
  scale_x_discrete(limits = rev(levels(calibration_nested$dilution))) +
  # scale_y_discrete(limits = rev(levels(calibration_nested$substrate))) +
  # scale_fill_gradientn(colours = rev(pal_ostwald_cont)) +
  scale_fill_viridis_c() +
  geom_label(aes(label = round(estimate, digits = 4))) +
  theme_leo() 

```

## Full assays

### Load plate layouts

```{r}
plate_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-04_TE_activity/csv_files/plates/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_csv(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("date", "started"), sep = "_") %>%
    mutate(
      Well = paste0(row, column),
      started = str_remove(started, fixed(".csv")),
      date = ymd(date)
    ) %>% 
    select(-row, -column)
}

TE_plates <- map_dfr(plate_files, read_plus)
```

### Check individual experiments

```{r}
read_vroom <- function(flnm) {
  vroom(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("author", "assay", "date", "time"), sep = "_") %>%
    select(-author, -assay) %>%
    mutate(
      time = str_remove(time, fixed(".csv")),
      date = ymd(date),
      started = ymd_hms(paste(date, time, sep = "_")),
      started = case_when(hour(started) < 14 ~ "morning", 
                          TRUE ~ "evening")
    ) %>% 
    select(-time) %>% 
    tidyfast::dt_pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement")
}

test_spec <- read_vroom(
  paste0(datapath, "PhD/Laccase_activity/2021-04_TE_activity/csv_files/absorbance/LB_TE-activity_20210512_190857.csv")) %>%
  left_join(TE_plates, by = c("date", "started", "Well")) %>% 
  drop_na()

gc()

test_data <- test_spec %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  filter(time < 390) %>% 
  group_by(date, replicate, substrate, pH, wavelength, time) %>% 
  mutate("blank" = absorbance[sample == "neg. ctrl."]) %>% 
  group_by(date, sample, substrate, pH, replicate, day) %>%
  mutate(
    density = mean(absorbance[wavelength == 600 & `Cycle #` %in% c(1, 2)]),
    adjusted_absorbance = case_when(
      sample == "neg. ctrl." ~ absorbance,
      # TRUE ~ absorbance # do not adjust for density
      TRUE ~ (absorbance - blank) / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

plotly::ggplotly(ggplot(test_data %>% filter(Well == "F8"),
       aes(x = wavelength,
           y = absorbance,
           group = time)) +
  geom_line(size = 0.2,
            alpha = 0.5))

```


### Load absorbance data

```{r}
abs_max <- tibble(
  substrate = c("ABTS", "DAF", "MBTH", "PYGL", "SGZ"),
  abs_max = c(420, 610, 505, 450, 530), #DAF default: 610
  abs_min = c(480, 930, 700, 600, 600) #DAF default: 515
)

spec_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-04_TE_activity/csv_files/absorbance/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

read_vroom <- function(flnm) {
  vroom(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("author", "assay", "date", "time"), sep = "_") %>%
    select(-author, -assay) %>%
    mutate(
      time = str_remove(time, fixed(".csv")),
      date = ymd(date),
      started = ymd_hms(paste(date, time, sep = "_")),
      started = case_when(hour(started) < 14 ~ "morning", 
                          TRUE ~ "evening")
    ) %>% 
    select(-time) %>% 
    pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>% 
    filter(wavelength %in% c(abs_max$abs_max, abs_max$abs_min))
}

TE_spec <- map_dfr(spec_files, read_vroom) %>%
  left_join(TE_plates, by = c("date", "started", "Well")) %>% 
  drop_na()

gc()

TE_data <- TE_spec %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  filter(time < 390) %>% 
  group_by(date, replicate, substrate, pH, wavelength, time) %>% 
  mutate("blank" = absorbance[sample == "neg. ctrl."]) %>% 
  group_by(date, sample, substrate, pH, replicate, day) %>%
  mutate(
    density = mean(absorbance[wavelength == 600 & `Cycle #` %in% c(1, 2)]),
    adjusted_absorbance = case_when(
      sample == "neg. ctrl." ~ absorbance,
      # TRUE ~ absorbance # do not adjust for density
      TRUE ~ (absorbance - blank) / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

rm(TE_spec)
gc()
```

### Plot absorbance over time

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 100, 400,
  "ABTS", 7, 100, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 20, 100,
  "DAF", 7, 100, 300,
  "MBTH", 4, 100, 300,
  "MBTH", 5, 100, 300,
  "MBTH", 6, 100, 300,
  "MBTH", 7, 20, 120,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 300,
  "SGZ", 4, 200, 400,
  "SGZ", 5, 200, 400,
  "SGZ", 6, 200, 400,
  "SGZ", 7, 200, 400,
)

kinetics <- TE_data %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>% 
  group_by(
    date, sample, substrate, pH, replicate, day, time, lm_start, lm_stop, density
    ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>% 
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    adjusted_absorbance = adjusted_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max])

pdf("TE_kinetics.pdf", height = twocol, width = twocol)
ggplot(kinetics %>% filter(sample == "TE"),
       aes(x = time,
           y = corrected_absorbance,
           colour = pH,
           linetype = sample)) +
  # geom_line(aes(group = interaction(sample, pH))) +
  stat_smooth(geom = "line",
              aes(group = interaction(replicate, pH)),
              alpha = 0.5,
              size = 0.2,
              se = F) +
  geom_smooth(data = filter(kinetics, sample == "TE" & time %in% c(lm_start:lm_stop)),
              aes(group = interaction(replicate, pH)),
              method = "lm",
              size = 0.5,
              se = F) +
  # scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(substrate ~ day,
             scales = "free_y")
dev.off()

pdf("TE_kinetics_ABTS_4.pdf", height = onecol * 0.5, width = twocol)
ggplot(kinetics %>% filter(sample == "TE" & pH == 4 & substrate == "ABTS"),
       aes(x = time,
           y = corrected_absorbance,
           colour = pH,
           linetype = sample)) +
  # geom_line(aes(group = interaction(sample, pH))) +
  stat_smooth(geom = "line",
              aes(group = interaction(replicate, pH)),
              alpha = 0.5,
              size = 0.2,
              se = F) +
  geom_smooth(data = filter(kinetics, 
                            sample == "TE" &
                              pH == 4 &
                              substrate == "ABTS" &
                              time %in% c(lm_start:lm_stop)),
              aes(group = interaction(replicate, pH)),
              method = "lm",
              size = 0.5,
              se = F) +
  labs(y = "Corrected absorbance",
       x = "Time [min]") +
  scale_x_continuous(limits = c(0, 400), breaks = c(100, 300)) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_grid(substrate ~ day,
             scales = "free_y")
dev.off()

pdf("TE_kinetics_4.pdf", height = onecol * 1.5, width = twocol)
ggplot(kinetics %>% filter(sample == "TE" & pH == 4),
       aes(x = time,
           y = corrected_absorbance,
           colour = pH,
           linetype = sample)) +
  # geom_line(aes(group = interaction(sample, pH))) +
  stat_smooth(geom = "line",
              aes(group = interaction(replicate, pH)),
              alpha = 0.5,
              size = 0.2,
              se = F) +
  geom_smooth(data = filter(kinetics, 
                            sample == "TE" &
                              pH == 4 &
                              time %in% c(lm_start:lm_stop)),
              aes(group = interaction(replicate, pH)),
              method = "lm",
              size = 0.5,
              se = F) +
  labs(y = "Corrected absorbance",
       x = "Time [min]") +
  scale_x_continuous(limits = c(0, 400), breaks = c(100, 300)) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_grid(substrate ~ day,
             scales = "free_y")
dev.off()
```


### Plot linear phase slope

```{r}
# write_csv(kinetics, "kinetics.csv")

kinetics_nested <- kinetics %>%
  # filter(substrate != "SGZ") %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -adjusted_absorbance) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(pH = as.factor(pH)) %>% 
  # group_by(substrate, pH, replicate, day) %>% # subtract nTE activity (2 lines)
  # mutate(estimate = estimate - estimate[sample == "nTE"]) %>%
  # filter(adj.r.squared > 0.5) %>%
  group_by(substrate, pH, replicate, sample) %>%
  mutate(scaled_estimate = estimate / max(estimate),
         scaled_estimate = case_when(scaled_estimate < 0 ~ 0,
                                     TRUE ~ scaled_estimate)) %>% 
  group_by(pH, replicate) %>%
  mutate(pH_scaled = estimate / max(estimate),
         pH_scaled = case_when(pH_scaled < 0 ~ 0,
                                     TRUE ~ pH_scaled)) %>% 
  group_by(substrate, replicate) %>%
  mutate(substrate_scaled = estimate / max(estimate),
         substrate_scaled = case_when(substrate_scaled < 0 ~ 0,
                                     TRUE ~ substrate_scaled))

kinetic_max <- kinetics_nested %>% 
  filter(day > 3) %>% 
  group_by(pH, sample, substrate, day) %>% 
  summarise(scaled_estimate = mean(scaled_estimate)) %>%
  group_by(pH, sample, substrate) %>% 
  mutate(
    max_estimate = max(scaled_estimate)
  ) %>% 
  filter(scaled_estimate == max_estimate)

slope_grid <- ggplot(kinetics_nested %>% filter(sample == "TE"),
       aes(x = day,
           y = scaled_estimate,
           colour = substrate)) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max %>% filter(sample == "TE"),
  #            aes(xintercept = day),
  #            size = 0.2,
  #            linetype = 2) +
  geom_line(aes(group = interaction(replicate, sample)),
            size = 0.2,
            alpha = 0.5) +
  stat_smooth(geom = "line",
              size = 0.4,
              se = FALSE) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )) +
  scale_alpha_discrete(range = c(0.3, 1)) +
  labs(y = "Normalised substrate oxidation rate") +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_grid(pH ~ substrate)


pH_facet <- ggplot(kinetics_nested %>% filter(sample == "TE"),
       aes(x = day,
           y = scaled_estimate)) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max,
  #            aes(xintercept = day,
  #                colour = sample),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2,
  #           alpha = 0.5) +
  stat_smooth(geom = "line",
              size = 0.4,
              se = FALSE) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )) +
  scale_alpha_discrete(guide = "none", range = c(0.3, 1)) +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  guides(colour = guide_legend(label.position = "bottom",
                               nrow = 2)) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        strip.text = element_blank(),
        legend.position = c(0.5,-0.1),
        legend.title = element_blank(),
        legend.key.width = unit(1.5, "mm"),
        legend.key.height = unit(1.5, "mm"),
        legend.direction = "horizontal") +
  facet_wrap(~ pH, ncol = 1)

substrate_facet <- ggplot(kinetics_nested %>% filter(sample == "TE"),
       aes(x = day,
           y = substrate_scaled,
           colour = substrate,
           alpha = pH)) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max,
  #            aes(xintercept = day,
  #                colour = sample),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2,
  #           alpha = 0.5) +
  stat_smooth(geom = "line",
              size = 0.4,
              se = FALSE) +
  # scale_alpha(name = "pH") +
  # scale_colour_brewer(palette = "Set1", guide = "none") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    ), guide = "none") +
  scale_alpha_discrete(range = c(0.3, 1)) +
  # scale_colour_manual(values = pal_pedersen_disc, name = "pH") +
  theme_leo() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        strip.text = element_blank(),
        # legend.title = element_blank(),
        legend.key.height = unit(2.5, "mm"),
        legend.key.width = unit(1.5, "mm"),
        legend.position = c(1.025, 0.5)) +
  facet_wrap(~ substrate, nrow = 1)

layout = "
AAAAAB
AAAAAB
AAAAAB
AAAAAB
AAAAAB
CCCCC#
"
pdf("TE_activity_slopes.pdf", width = onecol, height = onecol)
slope_grid 
# + pH_facet + substrate_facet +
  # plot_layout(design = layout)
dev.off()

```

#### Single pH

```{r}
kinetics_single <- kinetics_nested %>% 
  filter(pH == 5) %>% 
  mutate(pH = paste("pH", pH),
         substrate = recode(substrate,
                            "MBTH" = "L-DOPA"))
slope_grid <- ggplot(kinetics_single %>% filter(sample == "TE"),
       aes(x = day,
           y = scaled_estimate,
           colour = substrate)) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max %>% filter(sample == "TE"),
  #            aes(xintercept = day),
  #            size = 0.2,
  #            linetype = 2) +
  geom_line(aes(group = interaction(replicate, sample)),
            size = 0.2,
            alpha = 0.5) +
  stat_smooth(geom = "line",
              size = 0.4,
              se = FALSE) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )) +
  labs(y = "Relative oxidation rate",
       x = "Days past induction") +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  theme(strip.text.y = element_markdown(padding = unit(0.1, "mm")),
        axis.title.y = element_textbox_simple(
          orientation = "left-rotated",
          halign = 0.5,
          width = unit(15, "mm")
          )) +
  facet_grid(pH ~ substrate)

pdf("TE_activity_pH5.pdf", width = onecol, height = onecol * 0.25)
slope_grid
dev.off()
```

#### Supplement with explicit nTE

```{r}
# write_csv(kinetics, "kinetics.csv")

kinetics_nested <- kinetics %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -adjusted_absorbance) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(pH = as.factor(pH)) %>% 
  group_by(substrate, pH, replicate, day) %>% 
  # mutate(estimate = estimate - estimate[sample == "nTE"]) %>% 
  # filter(adj.r.squared > 0.5) %>%
  group_by(substrate, pH, replicate) %>%
  mutate(scaled_estimate = estimate / max(estimate),
         scaled_estimate = case_when(scaled_estimate < 0 ~ 0,
                                     TRUE ~ scaled_estimate)) %>% 
  group_by(pH, replicate) %>%
  mutate(pH_scaled = estimate / max(estimate),
         pH_scaled = case_when(pH_scaled < 0 ~ 0,
                                     TRUE ~ pH_scaled)) %>% 
  group_by(substrate, replicate) %>%
  mutate(substrate_scaled = estimate / max(estimate),
         substrate_scaled = case_when(substrate_scaled < 0 ~ 0,
                                     TRUE ~ substrate_scaled))

kinetic_max <- kinetics_nested %>% 
  filter(day > 3) %>% 
  group_by(pH, sample, substrate, day) %>% 
  summarise(scaled_estimate = mean(scaled_estimate)) %>%
  group_by(pH, sample, substrate) %>% 
  mutate(
    max_estimate = max(scaled_estimate)
  ) %>% 
  filter(scaled_estimate == max_estimate)

slope_grid <- ggplot(kinetics_nested %>% filter(sample != "neg. ctrl."),
       aes(x = day,
           y = scaled_estimate,
           colour = substrate,
           linetype = sample,
           alpha = pH)) +
  # geom_vline(data = kinetic_max %>% filter(sample != "neg. ctrl."),
  #            aes(xintercept = day),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2) +
  stat_smooth(geom = "line",
              size = 0.4,
              se = FALSE) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )) +
  scale_alpha_discrete(range = c(0.3, 1)) +
  labs(y = "Normalised substrate oxidation rate") +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_grid(pH ~ substrate)


pH_facet <- ggplot(kinetics_nested %>% filter(sample != "neg. ctrl."),
       aes(x = day,
           y = scaled_estimate,
           colour = substrate,
           linetype = sample,
           alpha = pH)) +
  # geom_vline(data = kinetic_max,
  #            aes(xintercept = day,
  #                colour = sample),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2,
  #           alpha = 0.5) +
  stat_smooth(geom = "line",
              size = 0.4,
              se = FALSE) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )) +
  scale_alpha_discrete(guide = "none", range = c(0.3, 1)) +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  guides(colour = guide_legend(label.position = "bottom",
                               nrow = 2)) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        strip.text = element_blank(),
        legend.position = c(0.5,-0.2),
        legend.title = element_blank(),
        legend.key.width = unit(2.5, "mm"),
        legend.key.height = unit(1.5, "mm"),
        legend.direction = "horizontal") +
  facet_wrap(~ pH, ncol = 1)

substrate_facet <- ggplot(kinetics_nested %>% filter(sample != "neg. ctrl."),
       aes(x = day,
           y = substrate_scaled,
           colour = substrate,
           linetype = sample,
           alpha = pH)) +
  # geom_vline(data = kinetic_max,
  #            aes(xintercept = day,
  #                colour = sample),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2,
  #           alpha = 0.5) +
  stat_smooth(geom = "line",
              size = 0.4,
              se = FALSE) +
  # scale_alpha(name = "pH") +
  # scale_colour_brewer(palette = "Set1", guide = "none") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    ), guide = "none") +
  scale_alpha_discrete(range = c(0.3, 1)) +
  scale_linetype(guide = "none") +
  # scale_colour_manual(values = pal_pedersen_disc, name = "pH") +
  theme_leo() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        strip.text = element_blank(),
        # legend.title = element_blank(),
        legend.key.height = unit(2.5, "mm"),
        legend.key.width = unit(1.5, "mm"),
        legend.position = c(1.025, 0.5)) +
  facet_wrap(~ substrate, nrow = 1)

layout = "
AAAAAB
AAAAAB
AAAAAB
AAAAAB
AAAAAB
CCCCC#
"
pdf("TE_activity_slopes_supp.pdf", width = onecol * 1.5, height = onecol)
slope_grid + pH_facet + substrate_facet +
  plot_layout(design = layout)
dev.off()
```

## PA inductions

### Viability

```{r}
growth_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-05_PA_inductions/viability/"),
    pattern = "*.txt",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = "code",
    col_types = "c",
    # locale = locale(decimal_mark = ",")
  ) %>%
    mutate(filename = basename(flnm)) %>%
    separate(filename, into = c("date", "replicate", "dpi", "treatment"), sep = "_") %>%
    mutate(
      date = ymd(as_date(date)),
      replicate = str_remove(replicate, fixed("R")),
      dpi = as.numeric(str_remove(dpi, fixed("d"))),
      treatment = str_remove(treatment, fixed(".txt"))
    )
}


PA_growth_data <- map(growth_files, read_plus) %>%
  bind_rows() %>%
  mutate(
    code = str_to_lower(code),
    nTEs_alive = str_count(code, "k"),
    nTEs_dead = str_count(code, "l"),
    TEs_alive = str_count(code, "i"),
    TEs_dead = str_count(code, "o")
  ) %>%
  mutate(
    n = nTEs_alive + nTEs_dead + TEs_alive + TEs_dead,
    nTE_viab = nTEs_alive / (nTEs_alive + nTEs_dead),
    TE_prop = (TEs_alive + TEs_dead) / n,
    TE_viab = TEs_alive / (TEs_alive + TEs_dead),
    TE_viab = case_when(is.nan(TE_viab) ~ 1,
                        TRUE ~ TE_viab)
  )
```


### Load plate layouts

```{r}
plate_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-05_PA_inductions/csv_files/plates/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_csv(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("date", "started"), sep = "_") %>%
    mutate(
      Well = paste0(row, column),
      started = str_remove(started, fixed(".csv")),
      date = ymd(date)
    ) %>% 
    select(-row, -column)
}

PA_plates <- map_dfr(plate_files, read_plus)
```

### Load absorbance data

```{r}
spec_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-05_PA_inductions/csv_files/absorbance/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

read_vroom <- function(flnm) {
  vroom(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("author", "assay", "date", "time"), sep = "_") %>%
    select(-author, -assay) %>%
    mutate(
      time = str_remove(time, fixed(".csv")),
      date = ymd(date),
      started = ymd_hms(paste(date, time, sep = "_")),
      started = case_when(hour(started) < 14 ~ "morning", 
                          TRUE ~ "evening")
    ) %>% 
    select(-time)
}

PA_spec <- map_dfr(spec_files, read_vroom) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  left_join(PA_plates, by = c("date", "started", "Well")) %>% 
  drop_na()

PA_data <- PA_spec %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  filter(time < 390) %>% 
  group_by(date, replicate, substrate, pH, wavelength, time) %>% 
  group_by(date, sample, substrate, pH, replicate, day) %>%
  mutate(
    density = mean(absorbance[wavelength == 600 & `Cycle #` %in% c(1, 2)]),
    adjusted_absorbance = absorbance, # adjust for density
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)
```

### Plot absorbance over time

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 100, 400,
  "ABTS", 7, 100, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 100, 300,
  "DAF", 7, 100, 300,
  "MBTH", 4, 100, 300,
  "MBTH", 5, 100, 300,
  "MBTH", 6, 100, 300,
  "MBTH", 7, 20, 120,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 300,
  "SGZ", 4, 200, 400,
  "SGZ", 5, 200, 400,
  "SGZ", 6, 200, 400,
  "SGZ", 7, 200, 400,
)

abs_max <- tibble(
  substrate = c("ABTS", "DAF", "MBTH", "PYGL", "SGZ"),
  abs_max = c(420, 610, 505, 450, 530),
  abs_min = c(480, 515, 700, 600, 600)
  # abs_min = 1000
)

PA_kinetics <- PA_data %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>% 
  group_by(
    date, sample, substrate, pH, replicate, day, time, lm_start, lm_stop, density
    ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>% 
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    adjusted_absorbance = adjusted_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max])

pdf("PA_kinetics.pdf", height = twocol, width = twocol)
ggplot(PA_kinetics,
       aes(x = time,
           y = corrected_absorbance,
           colour = pH,
           linetype = sample)) +
  # geom_line(aes(group = interaction(sample, pH))) +
  stat_smooth(geom = "line",
              aes(group = interaction(replicate, sample, pH)),
              alpha = 0.5,
              size = 0.2,
              se = F) +
  geom_smooth(data = filter(PA_kinetics, time %in% c(lm_start:lm_stop)),
              aes(group = interaction(replicate, sample, pH)),
              method = "lm",
              size = 0.5,
              se = F) +
  # scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(substrate ~ day,
             scales = "free_y")
dev.off()
```

### Plot linear phase slope

```{r}
# write_csv(kinetics, "kinetics.csv")

PA_kinetics_nested <- PA_kinetics %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -adjusted_absorbance) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(pH = as.factor(pH)) %>% 
  group_by(substrate, pH, replicate, sample) %>%
  mutate(scaled_estimate = estimate / max(estimate),
         scaled_estimate = case_when(scaled_estimate < 0 ~ 0,
                                     TRUE ~ scaled_estimate)) %>% 
  group_by(pH, replicate) %>%
  mutate(pH_scaled = estimate / max(estimate),
         pH_scaled = case_when(pH_scaled < 0 ~ 0,
                                     TRUE ~ pH_scaled)) %>% 
  group_by(substrate, replicate) %>%
  mutate(substrate_scaled = estimate / max(estimate),
         substrate_scaled = case_when(substrate_scaled < 0 ~ 0,
                                     TRUE ~ substrate_scaled))

PA_kinetic_max <- PA_kinetics_nested %>% 
  group_by(pH, sample, substrate, day) %>% 
  summarise(scaled_estimate = mean(scaled_estimate)) %>%
  group_by(pH, sample, substrate) %>% 
  mutate(
    max_estimate = max(scaled_estimate)
  ) %>% 
  filter(scaled_estimate == max_estimate)

slope_grid <- ggplot(PA_kinetics_nested,
       aes(x = day,
           y = scaled_estimate,
           colour = sample)) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max %>% filter(sample == "TE"),
  #            aes(xintercept = day),
  #            size = 0.2,
  #            linetype = 2) +
  geom_line(aes(group = interaction(replicate, sample)),
            size = 0.2) +
  stat_smooth(geom = "line",
              size = 0.4,
              se = FALSE) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(values = pal_ostwald_disc[c(1,3)]) +
  labs(y = "Normalised substrate oxidation rate") +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(pH ~ substrate)

pdf("PA_activity_slopes.pdf", width = onecol, height = onecol)
slope_grid
dev.off()

```

# Raman microspectroscopy

## Load spectra

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
rmn_files <-
  list.files(
    path = paste0(datapath, "PhD/Raman/2020-11_lac_mutants/"),
    pattern = "*.txt",
    recursive = TRUE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = c("wavenumber", "intensity"),
    col_types = "cc",
    # locale = locale(decimal_mark = ",")
  ) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("date", "genotype", "replicate", "cell_type", "TE"), sep = "_") %>%
    select(-date) %>%
    mutate(
      wavenumber = as.numeric(str_replace(wavenumber, fixed(","), fixed("."))),
      intensity = as.numeric(str_replace(intensity, fixed(","), fixed("."))),
      TE = str_remove(TE, fixed(".txt")),
    ) %>%
    filter(wavenumber > 300 &
      cell_type != "IFML") %>%
    pivot_wider(
      id_cols = c(genotype, replicate, cell_type, TE),
      names_from = wavenumber,
      values_from = intensity
    ) %>%
    group_by(genotype, replicate, cell_type, TE) %>%
    nest()
}

rmn_lac <- map_dfr(rmn_files, read_plus)

#### baseline correction ####
rmn_als <- function(x) {
  corrected_spectra <- baseline.als(as.matrix(x),
    lambda = 5,
    p = 0.01,
    maxit = 100
  )
  as_tibble(corrected_spectra$corrected, rownames = NA)
}

rmn_lac_corrected <- rmn_lac %>%
  mutate(corrected_data = map(data, rmn_als)) %>%
  select(-data) %>%
  unnest() %>%
  pivot_longer(-c(genotype, cell_type, replicate, TE),
    names_to = "wavenumber",
    values_to = "corrected.intensity"
  ) %>%
  drop_na() %>%
  mutate(wavenumber = as.numeric(wavenumber))

#### filtering and scaling ####

# alignment
lig_peak <- rmn_lac_corrected %>%
  unite("ID",
    genotype, cell_type, replicate, TE,
    remove = F,
    sep = "_"
  ) %>%
  filter(round(wavenumber, digits = 0) %in% c(370:390)) %>%
  group_by(genotype, replicate, cell_type, TE) %>%
  mutate(
    peak_pos = wavenumber[which.max(corrected.intensity)]
  ) %>%
  select(-wavenumber, -corrected.intensity) %>%
  unique() %>%
  group_by(cell_type) %>%
  mutate(peak_pos_ref = peak_pos[genotype == "WT" & replicate == 5 & TE == 1])

rmn_lac_aligned <- rmn_lac_corrected %>%
  left_join(lig_peak) %>%
  group_by(genotype, replicate, cell_type, TE, wavenumber) %>%
  mutate(wavenumber = wavenumber + (peak_pos_ref - peak_pos))

# scaling and filtering
rmn_lac_scaled <- rmn_lac_aligned %>%
  group_by(genotype, cell_type, replicate, TE) %>%
  mutate(
    AUC = MESS::auc(wavenumber, corrected.intensity),
    scaled = corrected.intensity / AUC,
    scaled_lig = corrected.intensity / (
      (corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) + corrected.intensity[abs(wavenumber - 1330) == min(abs(wavenumber - 1330))][1]
    ),
    scaled_cellu = corrected.intensity /
      corrected.intensity[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1]
  )

rmn_lac_avg <- rmn_lac_scaled %>%
  mutate(wavenumber = round(wavenumber, digits = 1)) %>%
  group_by(genotype, cell_type) %>%
  arrange(genotype, cell_type, wavenumber) %>%
  summarise(
    roll_mean = slider::slide_index_dbl(scaled, wavenumber, mean, .before = 1, .after = 1),
    roll_sd = slider::slide_index_dbl(scaled, wavenumber, sd, .before = 2, .after = 2),
    roll_scaled_cellu = slider::slide_index_dbl(scaled_cellu, wavenumber, mean, .before = 1, .after = 1),
    wavenumber = wavenumber
  )

rmn_lac_sum <- rmn_lac_scaled %>%
  group_by(genotype, cell_type, replicate, TE) %>%
  summarise(
    "unscaled_lignin" =
      (corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) +
        corrected.intensity[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "broad_lignin" =
      corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] +
        corrected.intensity[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1] +
        corrected.intensity[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1] +
        corrected.intensity[abs(wavenumber - 1625) == min(abs(wavenumber - 1625))][1],
    "total_lignin" = (scaled_cellu[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) +
      scaled_cellu[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "P_rel" = scaled_lig[abs(wavenumber - 993) == min(abs(wavenumber - 993))][1],
    "G_rel" = scaled_lig[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "G_tot" = scaled[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "GOH_rel" = scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1],
    "GCHO_rel" = scaled_lig[abs(wavenumber - 1625) == min(abs(wavenumber - 1625))][1],
    "GCHO_tot" = scaled[abs(wavenumber - 1625) == min(abs(wavenumber - 1625))][1],
    "S_rel" = scaled_lig[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "S_tot" = scaled[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "cellulose" =
      scaled[abs(wavenumber - 1095) == min(abs(wavenumber - 1095))][1] +
        scaled[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1] +
        scaled[abs(wavenumber - 1120) == min(abs(wavenumber - 1120))][1],
    "cellu_cryst" = scaled[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1] /
      scaled[abs(wavenumber - 1095) == min(abs(wavenumber - 1095))][1],
    "lig.cellu" = total_lignin / cellulose,
    "S.G" = scaled_lig[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1] /
      scaled_lig[abs(wavenumber - 1273) == min(abs(wavenumber - 1273))][1],
    "GOH.G" = scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1] /
      scaled_lig[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "GCHO.GOH" = scaled_lig[abs(wavenumber - 1625) == min(abs(wavenumber - 1625))][1] /
      scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1],
    "O4_van_rel" = scaled_lig[abs(wavenumber - 1303) == min(abs(wavenumber - 1303))][1],
    "other_van_rel" = scaled_lig[abs(wavenumber - 785) == min(abs(wavenumber - 785))][1],
    "O4_syr_rel" = scaled_lig[abs(wavenumber - 1297) == min(abs(wavenumber - 1297))][1],
    "other_syr_rel" = scaled_lig[abs(wavenumber - 450) == min(abs(wavenumber - 450))][1],
    "Benz_rel" = O4_van_rel + other_van_rel + O4_syr_rel + other_syr_rel,
    "AUC" = mean(AUC)
  )
```

## View spectra

```{r}
rmn_lac_test <- ggplot(
  rmn_lac_scaled, 
  aes(
    x = wavenumber,
    y = scaled_cellu
  )
) +
  scale_x_continuous(
    trans = "reverse",
    # limits = c(1020, 980)
  ) +
  # scale_y_continuous(limits = c(-0.001, 0.003)) +
  geom_vline(
    xintercept = c(1658, 1625, 1600, 1334, 1273, 1120, 1095, 993, 378),
    size = 0.1
  ) +
  # annotate("text",
  #          label = c("1660", "1600", "1330", "1120", "1095", "1001", "375"),
  #          y = 0.007,
  #          x = c(1661, 1601, 1331, 1170, 1096, 1002, 376),
  #          hjust = 0,
  #          family = "Helvetica",
  #          size = ggtext_size) +
  geom_line(aes(
    group = interaction(cell_type, replicate, TE),
    colour = cell_type
  ),
  alpha = 0.5,
  size = 0.1
  ) +
  # geom_ribbon(data = rmn_lac_avg,
  #           aes(fill = genotype,
  #               y = roll_mean,
  #               ymin = roll_mean - roll_sd,
  #               ymax = roll_mean + roll_sd),
  #           colour = NA,
  #           alpha = 0.25) +
  # geom_line(
  #   data = rmn_lac_avg %>% filter(genotype == "WT" & cell_type == "MX"),
  #   aes(
  #     colour = cell_type,
  #     y = roll_scaled_cellu
  #   ),
  #   size = 0.2
  # ) +
  labs(
    x = expression(paste("Wavenumber [", cm^-1, "]")),
    y = "Scaled scattering intensity"
  ) +
  # scale_color_brewer(palette = "Set1", aesthetics = c("colour", "fill")) +
  scale_colour_manual(values = pal_pedersen_disc) +
  theme_leo() +
  theme(
    # legend.position = "bottom",
    legend.title = element_blank()
  ) +
  guides(colour = guide_legend(override.aes = list(alpha = 1, size = 1))) +
  facet_grid(genotype~cell_type)

# plotly::ggplotly(rmn_lac_test)
pdf("rmn_lac.pdf", height = twocol, width = twocol)
rmn_lac_test
dev.off()
```

## Lignin composition

```{r}

violin_data <- rmn_lac_sum %>%
  select(
    "Total lignin" = total_lignin,
    "S/G" = S.G,
    # "P-units" = P_rel,
    # AUC,
    # "Cellulose cryst." = cellu_cryst,
    # "Benzaldehydes" = Benz_rel,
    "G-CHOH" = GOH_rel,
    "G-CHO" = GCHO_rel,
    "G-CHO/G-CHOH" = GCHO.GOH
  ) %>%
  filter(cell_type != "LP") %>%
  pivot_longer(
    cols = -c(genotype:replicate),
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "LP",
        "XF",
        "PX",
        "MX"
      )
    ),
    genotype = ordered(genotype, levels = c(
      "WT",
      "Q-4",
      "Q-5",
      "Q-10",
      "Q-12",
      "Q-17",
      "Q"
    )),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  )

violin_data_avg <- violin_data %>%
  group_by(genotype, cell_type, replicate, variable, instance) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))


rmn_n <- rmn_lac_sum %>%
  group_by(genotype, replicate, cell_type) %>%
  summarise(n = n())

```

### Overview

```{r}

letters <- letter_groups(violin_data,
  value,
  genotype,
  "tukey",
  variable,
  cell_type,
  print_position = "above"
) %>%
  mutate(value = case_when(
    variable == "S/G" & cell_type %in% c("PX", "MX") ~
    value + 1,
    variable == "Total lignin" & cell_type == "MX" ~
    value + 0.0005,
    variable == "P-units" & cell_type == "MX" ~
    value + 0.025,
    TRUE ~ value
  ))

letters_avg <- letter_groups(violin_data_avg,
  value,
  genotype,
  "tukey",
  variable,
  cell_type,
  print_position = "above"
) %>%
  select(-value) %>%
  left_join(select(letters, -Letters), by = c("variable", "cell_type", "genotype"))
  

lig_violin <- ggplot(
  violin_data,
  aes(
    x = genotype,
    y = value
  )
) +
  ggbeeswarm::geom_quasirandom(
    aes(colour = instance),
    shape = 16,
    size = 1,
    # dodge.width = 0.5,
    alpha = 0.5
  ) +
  # geom_violin(
  #   draw_quantiles = 0.5,
  #   fill = "white",
  #   colour = "black",
  #   alpha = 0.85,
  #   width = 0.2,
  #   # position = position_dodge(width = 0.5),
  #   size = 0.2,
  #   scale = "width"
  # ) +
  # geom_boxplot(
  #   # draw_quantiles = 0.5,
  #   outlier.alpha = 0,
  #   fill = "white",
  #   colour = "black",
  #   alpha = 0.85,
  #   width = 0.2,
  #   # position = position_dodge(width = 0.5),
  #   size = 0.2,
  #   fatten = 1
  # ) +
  geom_violin(
    draw_quantiles = 0.5,
    # outlier.alpha = 0,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.4,
    scale = "width",
    # position = position_dodge(width = 0.5),
    size = 0.2,
    # fatten = 1
  ) +
  # geom_point(
  #   data = violin_data_avg,
  #   aes(y = value,
  #       colour = instance),
  #   shape = 16,
  #   alpha = 0.75,
  #   size = 1.5
  # ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  scale_colour_manual(values = pal_ostwald_disc[c(1, 3)]) +
  # scale_colour_brewer(palette = "Set1") +
  # scale_colour_viridis_d(drop = FALSE) +
  scale_x_discrete(drop = FALSE) +
  theme_leo() +
  theme(
    axis.title = element_blank(),
    strip.placement = "outside",
    strip.text = element_text(hjust = 0.5, face = "plain"),
    legend.position = "bottom"
  ) +
  facet_grid(variable ~ cell_type, scales = "free_y", switch = "y")

pdf("lig_violin_complete.pdf", width = twocol, height = twocol)
lig_violin
dev.off()
```

### Find specificity

```{r}

raman_regressions <- violin_data %>%
  group_by(variable, cell_type) %>%
  mutate(value = scale(value, scale = TRUE, center = TRUE)) %>%
  group_by(genotype, replicate, cell_type, variable) %>%
  mutate(cell = row_number()) %>%
  pivot_wider(names_from = variable, values_from = value) %>%
  # select(-AUC) %>%
  pivot_longer(cols = -c(1:6), names_to = "variable", values_to ="value") %>%
  nest(data = -c(variable, cell_type)) %>%
  group_by(variable, cell_type) %>%
  mutate(
    model = map(data, ~lm(value ~ `Total lignin`, data = .x)),
    model_glance = map(model, glance),
    predicted = map(model, predict),
    residuals = map(model, residuals),
    adj.r.squared = unlist(map(model_glance, ~ .x[["adj.r.squared"]]))) %>%
  unnest(c(data, predicted, residuals)) 

raman_regression_avg <- raman_regressions %>%
  group_by(genotype, cell_type, variable) %>%
  summarise(value = mean(value),
            predicted = mean(predicted),
            divergence = value - predicted,
            value_label = case_when(divergence > 0 ~ value + 1,
                                    TRUE ~ value -1),
            `Total lignin` = mean(`Total lignin`),
            adj.r.squared = mean(adj.r.squared))

resid_plot <- ggplot(raman_regressions) +
  geom_point(aes(
    x = `Total lignin`,
    y = value,
    alpha = abs(residuals),
    colour = abs(residuals),
    group = interaction(genotype, replicate, cell)
  ),
  shape = 16,
  size = 0.75
  ) +
  geom_line(aes(
    x = `Total lignin`,
    y = predicted
  )) +
  geom_point(
    data = raman_regression_avg,
    aes(
      x = `Total lignin`,
      y = value,
      fill = genotype
    ),
    shape = 21,
    stroke = 0.2
  ) +
  geom_text(
    data = raman_regression_avg %>% filter(genotype == "WT"),
    aes(
      x = 2,
      y = 5,
      label = paste("R² = ", round(adj.r.squared, digits = 2))
    ),
    family = "Helvetica",
    size = ggtext_size,
    hjust = 1,
    vjust = 1
  ) +
  geom_label_repel(
    data = raman_regression_avg %>% filter(abs(divergence) > 0.5),
    aes(
      x = `Total lignin`,
      y = value,
      label = genotype
    ),
    family = "Helvetica",
    fontface = "bold",
    size = ggtext_size,
    min.segment.length = 0,
    segment.size = 0.2,
    nudge_x = -1,
    nudge_y = 1,
    label.size = NA,
    label.padding = 0,
    fill = rgb(1, 1, 1, 0.85)
    # direction = "y"
  ) +
  theme_leo() +
  theme(legend.position = "bottom",
        axis.title.y = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(hjust = 0.5, face = "plain"),
        legend.title = element_blank()) +
  scale_alpha_continuous(range = c(0.25, 0.75), guide = "none") +
  # scale_fill_brewer(palette = "Set2") +
  scale_colour_distiller(palette = "Greys", direction = 1, guide = "none") +
  # coord_fixed(ratio = 1,
  #             xlim = c(-2, 2),
  #             ylim = c(-2, 2)) +
  facet_grid(variable ~ cell_type, switch = "y")

pdf("lig_comp_residuals.pdf", width = onecol, height = onecol * 1.6)
resid_plot
dev.off()

# plotly::ggplotly(resid_plot)

```

### Single plots

```{r}
# scatter plots
scatter_data <- rmn_lac_sum %>%
  select(
    "Total lignin" = total_lignin,
    "S/G" = S.G,
    "P-units" = P_rel,
    AUC,
    "Cellulose cryst." = cellu_cryst,
    "Benzaldehydes" = Benz_rel,
    # "P/cellulose" = P.cellu,
    # "G-units" = G_rel,
    "G-CHOH" = GOH_rel,
    # "Lignin/cellulose" = lig.cellu,
    "G<sub>CHO</sub>/G<sub>OH</sub>" = GCHO.GOH
  ) %>%
  filter(cell_type != "LP") 

# single correlations
lig_sg <- ggplot(scatter_data,
       aes(x = `Total lignin`, y = `S/G`)
       ) +
  geom_point(
    shape = 21,
    alpha = 0.5,
    stroke = 0.2,
    aes(fill = genotype)
    ) +
  # stat_ellipse(aes(colour = genotype),
  #              # geom = "polygon",
  #              type = "t", 
  #              level = 0.4) +
  geom_smooth(method = "loess",
              se = F,
              colour = "black",
              span = 3) +
  scale_fill_viridis_d() +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_wrap(~cell_type)

pdf("lignin_SG.pdf", width = onecol, height = onecol)
lig_sg
dev.off()

# single comparisons

single_violin_data <- violin_data %>% 
  mutate(genotype = recode(genotype,
                           "Q-4" = "<i>Q-4</i>",
                           "Q-5" = "<i>Q-5</i>",
                           "Q-10" = "<i>Q-10</i>",
                           "Q-12" = "<i>Q-12</i>",
                           "Q-17" = "<i>Q-17</i>",
                           "Q" = "<i>Q</i>"),
         variable = recode(variable,
                           "G-CHO/G-CHOH" = "<b>G</b><sub>CHO</sub>/<b>G</b><sub>CHOH</sub>"))

lig_violin <- function(var, ct) {
  letters <- letter_groups(single_violin_data %>% 
                             filter(variable == var & cell_type == ct),
    value,
    genotype,
    "tukey",
    print_position = "below",
    print_adjust = 0.5
  ) 

  ggplot(
    data = single_violin_data %>% 
      filter(variable == var & cell_type == ct),
    aes(x = genotype, y = value)
  ) +
    geom_quasirandom(
      aes(fill = genotype),
      dodge.width = 0.6,
      shape = 21,
      alpha = 0.75,
      size = 1,
      stroke = 0.2
    ) +
    geom_violin(aes(
      group = genotype
    ),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.6),
    size = 0.2,
    scale = "width"
    ) +
    geom_text(
      data = letters,
      aes(label = Letters),
      size = ggtext_size,
      family = "Helvetica",
      position = position_dodge(width = 0.6)
    ) +
    labs(y = var,
         title = ct) +
    scale_y_continuous(expand = expansion(mult = 0.1)) +
    # scale_x_discrete(labels = c("PX", "PMX", "SMX")) +
    # scale_fill_manual(values = pal_flame_disc) +
    # expand_limits(y = 0) +
    theme_leo() +
    theme(
      text = element_text(family = "Helvetica"),
      axis.title.x = element_blank(),
      axis.title.y = element_markdown(),
      axis.text.y = element_blank(),
      axis.text.x = element_markdown(),
      axis.ticks.y = element_blank()
    )
}
pdf("IF_ald_to_alc.pdf", width = onecol * 0.5, height = onecol * 0.25)
lig_violin("<b>G</b><sub>CHO</sub>/<b>G</b><sub>CHOH</sub>", "IF") 
dev.off()

pdf("IF_total_lignin.pdf", width = onecol * 0.5, height = onecol * 0.25)
lig_violin("Total lignin", "IF") 
dev.off()
```

## Raman PCA

### Complete spectra

```{r}

pca_data <- rmn_lac_scaled %>% 
  filter(cell_type != "LP") %>% 
  group_by(genotype, replicate, cell_type, wavenumber) %>%
  mutate(wavenumber = round(wavenumber)) %>%
  unite("ID", genotype, replicate, cell_type, TE) %>% 
  group_by(ID) %>% 
  complete(wavenumber = seq(min(wavenumber), max(wavenumber), by = 1L)) %>% 
  select(ID, wavenumber, scaled) %>% 
  filter(wavenumber %in% c(320:1780)) %>% 
  arrange(wavenumber, .by_group = T) %>% 
  fill(scaled) %>% 
  pivot_wider(names_from = wavenumber, values_from = scaled)

pca_result <- prcomp(pca_data[, -1], center = TRUE, scale. = TRUE)
rownames(pca_result$x) <- pca_data$ID

# factoextra::fviz_pca_biplot(pca_result)

gg_pca <- as_tibble(pca_result$x, rownames = NA) %>%
  rownames_to_column(var = "ID") %>%
  separate(ID, sep = "_", into = c("genotype", "replicate", "cell_type", "TE"))

gg_pca_ellipse <- gg_pca %>%
  group_by(genotype, cell_type) %>%
  summarise(
    PC1 = mean(PC1),
    PC2 = mean(PC2)
  )


complete_pca <- ggplot(gg_pca, aes(x = PC1, y = PC2, fill = genotype)) +
  geom_hline(yintercept = 0, linetype = 1, size = 0.2) +
  geom_vline(xintercept = 0, linetype = 1, size = 0.2) +
  geom_point(
    size = 1,
    stroke = 0.2,
    alpha = 0.5,
    shape = 21
  ) +
  stat_ellipse(geom = "polygon", type = "t", level = 0.4) +
  geom_label_repel(
    data = gg_pca_ellipse,
    aes(label = genotype),
    # fill = NA,
    size = ggtext_size,
    segment.alpha = 0,
    label.size = NA,
    family = "Helvetica"
  ) +
  # stat_ellipse(aes(fill = NULL), colour = "black", linetype = 2, size = 0.2) +
  # annotate("text",
  #   x = c(-35, 18, 7, -25),
  #   y = c(18, 25, -17, -25),
  #   label = c("Epidermis", "Vascular\nbundle", "Interfascicular\nfibre", "Pith"),
  #   family = "Helvetica",
  #   size = ggtext_size,
  #   hjust = 0
  # ) +
  labs(
    # x = "PC 1 [36.4 %]",
    # y = "PC 2 [19.5 %]",
    title = "Overall lignin"
  ) +
  scale_fill_viridis_d(alpha = 0.5) +
  theme_leo() +
  theme(
    plot.margin = unit(c(2, 2, 3, 2), "mm"),
    plot.title = element_text(size = 10)
  ) +
  facet_wrap(~ cell_type, scale = "free")

pdf("overall_PCA.pdf", width = twocol, height = onecol)
complete_pca
dev.off()

```

### Selected peaks

```{r}

cell_type_pca <- function(celltype) {
  pca_data <- rmn_lac_sum %>%
    select(
      "Total lignin" = total_lignin,
      "S/G" = S.G,
      "P-units" = P_rel,
      AUC,
      # "Cellulose cryst." = cellu_cryst,
      "Benzaldehydes" = Benz_rel,
      # "P/cellulose" = P.cellu,
      "G-units" = G_rel,
      "S-units" = S_rel,
      "G-CHO/G-OH" = GCHO.GOH
    ) %>%
    filter(cell_type %in% celltype) %>%
    group_by(genotype, replicate, cell_type) %>%
    mutate(cell = row_number()) %>%
    pivot_wider(everything(), names_from = cell_type, values_from = c(4:11)) %>%
    unite("ID", genotype, replicate, cell)

  pca_result <- prcomp(pca_data[, -1], center = TRUE, scale. = TRUE)
  rownames(pca_result$x) <- pca_data$ID

  # factoextra::fviz_pca_biplot(pca_result)

  gg_pca <- as_tibble(pca_result$x, rownames = NA) %>%
    rownames_to_column(var = "ID") %>%
    separate(ID, sep = "_", into = c("genotype", "replicate", "cell"))

  gg_pca_ellipse <- gg_pca %>%
    group_by(genotype) %>%
    summarise(
      PC1 = mean(PC1),
      PC2 = mean(PC2)
    )

  ggplot(gg_pca, aes(x = PC1, y = PC2, fill = genotype)) +
    geom_hline(yintercept = 0, linetype = 1, size = 0.2) +
    geom_vline(xintercept = 0, linetype = 1, size = 0.2) +
    geom_point(
      size = 1,
      stroke = 0.2,
      alpha = 0.75,
      shape = 21
    ) +
    stat_ellipse(geom = "polygon", type = "t", level = 0.4) +
    geom_label_repel(
      data = gg_pca_ellipse,
      aes(
        label = genotype,
        fill = genotype
      ),
      size = ggtext_size,
      segment.alpha = 0,
      label.size = NA,
      family = "Helvetica"
    ) +
    # stat_ellipse(aes(fill = NULL), colour = "black", linetype = 2, size = 0.2) +
    # annotate("text",
    #   x = c(-35, 18, 7, -25),
    #   y = c(18, 25, -17, -25),
    #   label = c("Epidermis", "Vascular\nbundle", "Interfascicular\nfibre", "Pith"),
    #   family = "Helvetica",
    #   size = ggtext_size,
    #   hjust = 0
    # ) +
    labs(
      # x = "PC 1 [36.4 %]",
      # y = "PC 2 [19.5 %]",
      title = celltype
    ) +
    scale_fill_viridis_d(alpha = 0.5) +
    theme_leo() +
    theme(
      plot.margin = unit(c(2, 2, 3, 2), "mm"),
      plot.title = element_text(size = 10)
    )
}

# pdf("celltype_PCAs.pdf", width = onecol * 1.5, height = onecol)
cell_type_pca("PX") + cell_type_pca("MX") + cell_type_pca("XF") + cell_type_pca("IF")
# dev.off()

corr_data <- rmn_lac_sum %>%
  select(
    "Total lignin" = total_lignin,
    "S/G" = S.G,
    "P-units" = P_rel,
    AUC,
    # "Cellulose cryst." = cellu_cryst,
    "Benzaldehydes" = Benz_rel,
    # "P/cellulose" = P.cellu,
    "G-units" = G_rel,
    "S-units" = S_rel,
    "G-CHO/G-OH" = GCHO.GOH
  ) %>%
  filter(cell_type != "LP") %>%
  group_by(genotype, replicate) %>%
  mutate(cell = row_number()) %>%
  unite("ID", genotype, replicate, cell, cell_type) %>%
  column_to_rownames(., var = "ID")

# pdf("lignin_corr.pdf")
corrplot::corrplot.mixed(cor(as.matrix(corr_data)))
# dev.off()
```

# Multivariate analysis

```{r}
pca_rmn <- rmn_lac_sum %>%
  select(
    "Total lignin" = total_lignin,
    "S/G" = S.G,
    "P-units" = P_rel,
    AUC,
    # "Cellulose cryst." = cellu_cryst,
    "Benzaldehydes" = Benz_rel,
    # "P/cellulose" = P.cellu,
    "G-units" = G_rel,
    "S-units" = S_rel,
    "G-CHO/G-OH" = GCHO.GOH
  ) %>%
  filter(cell_type != "LP") %>%
  group_by(genotype, cell_type) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE))) 

pca_activity <- ungroup(nested_data_dab) %>%
  add_row(ungroup(nested_data_daf)) %>%
  select(genotype, cell_type, substrate, estimate) %>%
  group_by(genotype, cell_type, substrate) %>%
  summarise(estimate = mean(estimate, na.rm = TRUE)) %>%
  pivot_wider(everything(), names_from = substrate, values_from = estimate)

pca_complete <- pca_rmn %>%
  left_join(pca_activity) %>%
  pivot_wider(everything(), names_from = cell_type, values_from = -c(1,2))

pca_result <- prcomp(pca_complete[, -1], center = TRUE, scale. = TRUE)
rownames(pca_result$x) <- pca_complete$genotype

factoextra::fviz_pca_biplot(pca_result)

cell_type_pca <- function(celltype) {
  pca_data <- pca_rmn %>%
  left_join(pca_activity) %>%
  filter(cell_type == celltype) %>%
  pivot_wider(everything(), names_from = cell_type, values_from = -c(genotype, cell_type))

  pca_result <- prcomp(pca_data[, -1], center = TRUE, scale. = TRUE)
  rownames(pca_result$x) <- pca_data$genotype

  # factoextra::fviz_pca_biplot(pca_result)

  gg_pca <- as_tibble(pca_result$x, rownames = NA) %>%
    rownames_to_column(var = "genotype") %>%
    mutate(genotype = ordered(genotype, levels = c(
      "WT",
      "Q-4",
      "Q-5",
      "Q-10",
      "Q-12",
      "Q-17",
      "Q"
    )))

  # gg_pca_ellipse <- gg_pca %>%
  #   group_by(genotype) %>%
  #   summarise(
  #     PC1 = mean(PC1),
  #     PC2 = mean(PC2)
  #   )

  ggplot(gg_pca, aes(x = PC1, y = PC2, fill = genotype)) +
    geom_hline(yintercept = 0, linetype = 1, size = 0.2) +
    geom_vline(xintercept = 0, linetype = 1, size = 0.2) +
    geom_point(
      size = 3,
      stroke = 0.2,
      alpha = 0.75,
      shape = 21
    ) +
    # stat_ellipse(geom = "polygon", type = "t", level = 0.4) +
    geom_label_repel(
      data = gg_pca,
      aes(
        label = genotype,
        fill = genotype
      ),
      size = ggtext_size,
      segment.alpha = 0,
      label.size = NA,
      family = "Helvetica"
    ) +
    # stat_ellipse(aes(fill = NULL), colour = "black", linetype = 2, size = 0.2) +
    # annotate("text",
    #   x = c(-35, 18, 7, -25),
    #   y = c(18, 25, -17, -25),
    #   label = c("Epidermis", "Vascular\nbundle", "Interfascicular\nfibre", "Pith"),
    #   family = "Helvetica",
    #   size = ggtext_size,
    #   hjust = 0
    # ) +
    labs(
      # x = "PC 1 [36.4 %]",
      # y = "PC 2 [19.5 %]",
      title = celltype
    ) +
    scale_fill_viridis_d(alpha = 0.5) +
    theme_leo() +
    theme(
      plot.margin = unit(c(2, 2, 3, 2), "mm"),
      plot.title = element_text(size = 10)
    )
}

pdf("celltype_PCAs.pdf", width = onecol * 1.5, height = onecol)
cell_type_pca("PX") + cell_type_pca("MX") + cell_type_pca("XF") + cell_type_pca("IF")
dev.off()
```

# Supplements

## Expression

### Load data

```{r}
expression <- read_csv("/home/leonard/Documents/Uni/Master/Master thesis/Laccases/Expression/R_file.csv") %>% 
  filter(dataset == "array") %>% 
  mutate(time = case_when(time == 0 ~ "Proliferation",
                          TRUE ~ "SCW formation"),
         laccase = ordered(laccase, levels = c(
           "LAC1",
           "LAC2",
           "LAC3",
           "LAC4",
           "LAC5",
           "LAC6",
           "LAC7",
           "LAC8",
           "LAC9",
           "LAC10",
           "LAC11",
           "LAC12",
           "LAC13",
           "LAC14",
           "LAC15",
           "LAC16",
           "LAC17",
           "XCP2",
           "IRX3"
         )))
```

### Plot Expression
```{r}
expression_highlight <- tibble(laccase = c("LAC4", "LAC5", "LAC10", "LAC11", "LAC12", "LAC17")) %>% 
  mutate(laccase = ordered(laccase, levels = c(
           "LAC1",
           "LAC2",
           "LAC3",
           "LAC4",
           "LAC5",
           "LAC6",
           "LAC7",
           "LAC8",
           "LAC9",
           "LAC10",
           "LAC11",
           "LAC12",
           "LAC13",
           "LAC14",
           "LAC15",
           "LAC16",
           "LAC17",
           "XCP2",
           "IRX3"
         )))

expression_plot <- ggplot(expression,
       aes(x = laccase)) +
  geom_tile(data = expression_highlight,
            aes(y = 3,
                width = 0.75,
                height = 10),
            fill = "#ffcc3d") +
  scale_fill_manual(values = c("black", "white")) +
  scale_x_discrete(drop = F) +
  geom_pointrange(aes(
    y = absolute, 
    fill = time,
    ymin = absolute - absolute.sd,
           ymax = absolute + absolute.sd),
                  shape = 21,
                  stroke = 0.2) +
  labs(y = "Relative expression") +
  coord_flip(clip = "off", ylim = c(0, 8)) +
  theme_leo() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(hjust = 0),
        axis.ticks = element_blank(),
        # panel.border = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank()) 

pdf("lac_expression.pdf", width = onecol * 0.3, height = onecol * 0.65)
expression_plot
dev.off()
```


