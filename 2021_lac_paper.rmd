---
title: "Laccase manuscript"
author: "Leonard Blaschek"
date: "01/02/2021"
output: HTML
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(baseline)
library(broom)
library(colorspace)
library(gganimate)
library(ggbeeswarm)
library(ggrepel)
library(ggridges)
library(ggtext)
library(glue)
library(jsonlite)
library(lubridate)
library(patchwork)
library(showtext)
library(slider)
library(tidyverse)
library(tukeygrps)
library(vroom)
# library(sf)

## import Helvetica ####
font_add(
  "Helvetica",
  regular = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Lt.otf",
  italic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-LtIt.otf",
  bold = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Bd.otf",
  bolditalic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-BdIt.otf"
)
showtext_auto()

#### generating plot theme ####
theme_leo <- function(base_size = 6,
                      base_family = "Helvetica") {
  theme_minimal(
    base_size = base_size,
    base_family = base_family
  ) %+replace%
    theme(
      strip.text = element_text(
        hjust = 0,
        # face = "italic"
      ),
      axis.ticks = element_line(
        size = 0.125,
        lineend = "square",
        color = "black"
      ),
      axis.text.x = element_text(
        size = 6,
        colour = "black",
        margin = margin(1, 1, 1, 1)
      ),
      axis.text.y = element_text(
        colour = "black",
        size = 6,
        angle = 0,
        vjust = 0.5,
        hjust = 1,
        margin = margin(1, 1, 1, 1)
      ),
      axis.title = element_text(
        colour = "black",
        size = 6
      ),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black", size = 0.25),
      panel.spacing = unit(1.5, "mm"),
      legend.position = "none",
      legend.text = element_text(size = 6),
      legend.key.height = unit(4, "mm"),
      plot.title = element_text(
        size = 6,
        hjust = 0
      ),
      complete = TRUE
    )
}

pal_ostwald_disc <- c(
  "#275d95",
  "#e8c245",
  "#d25952"
)

pal_ostwald_disc_long <- c(
  "#8fab1d",
  "#2d7d73",
  "#1d566f",
  "#275d95",
  "#e8c245",
  "#d25952"
)

pal_ostwald_cont <- c(
  "#155DA7",
  "#0A75B9",
  # "#0C89C9",
  "#FED32F",
  # "#F8A63A",
  "#EF663A",
  "#ED4137"
)

pal_ostwald_5 <- c(
  "#155DA7",
  "#929c67",
  "#FED32F",
  "#f79333",
  "#ED4137"
)

pal_pedersen_disc <- c(
  "#264653",
  "#2a9d8f",
  "#e9c46a",
  "#f4a261",
  "#e76f51"
)

pal_dawn <- c(
  "#434c52ff",
  "#46636fff",
  "#6088a0ff",
  "#ab6c82ff",
  "#d8737fff",
  "#eaa05fff",
  "#ffd175ff"
)

pal_zissou <- wesanderson::wes_palette("Zissou1", 6, type = "continuous")

# function to strip html for excel exports
strip_html <- function(s) {
    rvest::html_text(rvest::read_html(charToRaw(as.character(s))))
}

# convenience vectors of mutant types
Q <- "Q"
quad <- c("Q-4", "Q-5", "Q-10", "Q-12", "Q-17")
triple <- c("Q-4/10", "Q-4/12", "Q-4/17", "Q-5/10", "Q-5/12", "Q-5/17", "Q-10/12", "Q-12/17")
WT <- "WT"

Q_it <- "<i>Q</i>"
quad_it <- c("<i>Q-4</i>", "<i>Q-5</i>", "<i>Q-10</i>", "<i>Q-12</i>", "<i>Q-17</i>")
triple_it <- c("<i>Q-4/10</i>", "<i>Q-4/12</i>", "<i>Q-4/17</i>", "<i>Q-5/10</i>", "<i>Q-5/12</i>", "<i>Q-5/17</i>", "<i>Q-10/12</i>", "<i>Q-12/17</i>")

# convenience figure size functions
ggtext_size <- 6 / (14 / 5)
cm_size <- function(x) x / 2.54
twocol <- 18 / 2.54
onehalfcol <- 14 / 2.54
onecol <- 9 / 2.54

# path for statistics output
stat_path <- "/home/leonard/Dropbox/2021_lac_manuscript/Submission/PlantCell_revised/supplementary/statistics/"

#### machine dependent paths ####
datapath <- ifelse(dir.exists("/data/"), "/data/",
  ifelse(dir.exists("/run/media/leonard/data/grsync/data/"), "/run/media/leonard/data/grsync/data/",
    ifelse(dir.exists("/run/media/leonard/data/"), "/run/media/leonard/data/", "/home/leonard/Documents/Uni/")
  )
)
```

# Phenotyping

## Height of single to quintuple mutants

### Load data

#### 2020--2021

```{r}
names <- read_csv("/home/leonard/Dropbox/2021_lac_manuscript/lac_mutant_names.csv") %>% 
  rename("genotype" = short_name)

stems_III <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2021-04_lac_mutants/2021-07_harvesting.csv"
)) %>%
  left_join(read_csv(paste0(datapath, "PhD/Phenotyping/2021-04_lac_mutants/plant_order.csv"))) %>%
  select(-sil.length, -stem.weight) %>%
  rename("rep" = replicate) %>% 
  mutate(instance = "2021-07")

# combine stem data
pheno_2020 <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/2020-04-16_harvesting.csv"
)) %>%
  mutate(instance = "2020-04") %>% 
  rename("stem.weight" = stem.w) %>%
  bind_rows(read_csv(paste0(
    datapath, "PhD/Phenotyping/2020-09_lac_mutants/2020-11-05_harvesting.csv"
  )) %>%
    mutate(instance = "2020-11") %>% 
    bind_rows(stems_III) %>%
    select(-plant)) %>%
  mutate(genotype = recode(genotype,
    "Col-0" = "WT"
  )) %>%
  left_join(names) %>% 
  mutate(rep = as.character(rep),
         genotype = case_when(str_detect(genotype, "Q") ~ long_name,
                              TRUE ~ genotype)) %>%
  filter(genotype != "lac5/10/17") %>% 
  select(genotype, "replicate" = rep, instance, "height" = stretched.height) %>% 
  drop_na()
```

#### 2016--2017

```{r}
pheno_2017 <- read_csv(paste0(datapath, "PhD/Phenotyping/2017_lac_mutants/harvesting_lac_1.csv")) %>%
  mutate(
    genotype = str_replace_all(genotype, fixed("x"), fixed("/")),
    instance = case_when(
      replicate %in% c("A", "B", "C") ~ "2017_1",
      replicate %in% c("D", "E", "F") ~ "2017_2",
      TRUE ~ "2017_3"
    )
  ) %>%
  select(genotype, replicate, instance, height) %>%
  drop_na()
```

#### Combine data

```{r}
pheno_full <- bind_rows(pheno_2017, pheno_2020) %>%
  mutate(genotype = recode(genotype,
                           "lac17/10/12" = "lac10/12/17",
                           "lac4/17/10/12" = "lac4/10/12/17",
                           "lac4/17/10" = "lac4/10/17",
                           "lac4/17/12" = "lac4/12/17",
                           "lac17" = "lac17-1"),
    type = ordered(as.character(str_count(genotype, "lac|/")), levels = c("0", "1", "2", "3", "4", "5"))
  ) %>% 
  filter(height > 20) %>%  # remove plants damaged during growth
  group_by(instance) %>%
  mutate(
    genotype = str_replace_all(genotype, "/", ";"),
    genotype = case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    mean_WT = mean(height[genotype == "WT"]),
    rel_height = height / mean_WT * 100
  )

pheno_n <- pheno_full %>% 
  group_by(genotype) %>% 
  summarise(n = n())
```

### Plot full mutant panel

```{r}
letters <- letter_groups(pheno_full,
                         rel_height,
                         genotype,
                         "tukey",
                         print_position = "below")

full_mutant_plot <- ggplot(
  pheno_full,
  aes(
    x = reorder(genotype, rel_height, FUN = median),
    y = rel_height
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = type),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  annotate("richtext",
    x = c(2.5, 10.5),
    y = c(115, 40),
    label = c("<i>Q</i>", "WT"),
    size = ggtext_size,
    family = "Helvetica",
    label.size = NA,
    label.r = unit(0, "lines"),
    # fill = c(pal_ostwald_5[5], pal_dawn[1]),
    fill = NA,
    # colour = c("black", "white")
  ) +
  annotate("curve",
    x = c(2.2, 11),
    xend = c(1, 12),
    y = c(115, 40),
    yend = c(85, 60),
    curvature = 0.4,
    lineend = "butt",
    size = 0.2,
    arrow = arrow(length = unit(0.03, "npc"), type = "closed")
  ) +
  labs(y = "Stem height [% of WT]") +
  scale_fill_manual(
    values = c(pal_dawn[1], pal_ostwald_5),
    guide = guide_legend(
      title = "Number of mutations",
      title.position = "top",
      direction = "horizontal",
      keywidth = unit(2, "mm"),
      keyheight = unit(2, "mm"),
      nrow = 1
    )
  ) +
  # scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5
    ),
    axis.text.x = element_markdown(
      angle = 45,
      hjust = 1,
      vjust = 1
    ),
    legend.position = c(0.89, 0.15),
    legend.background = element_rect(fill = "grey95", colour = NA)
  )

pdf("all_mutants.pdf", width = twocol, height = onecol * 0.5)
full_mutant_plot
dev.off()
```

#### Statistics

```{r}
stat_tab <- pheno_full %>%
  drop_na() %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    rel_height,
    genotype,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column("variable" = "height [% of WT]") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S02A_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column("variable" = "height [% of WT]") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S02A_tukey.csv"))
```


## Higher order mutants -- manual

### Load data

```{r message=FALSE}
# format silique data from growth instance III
sil_III <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2021-04_lac_mutants/2021-07_harvesting.csv"
)) %>%
  left_join(read_csv(paste0(datapath, "PhD/Phenotyping/2021-04_lac_mutants/plant_order.csv"))) %>%
  select(genotype, genotype, "rep" = replicate, "length" = sil.length) %>%
  separate_rows(length, sep = ",") %>%
  mutate(
    length = as.numeric(length),
    rep = as.character(rep)
  )

# combine silique data
siliques <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/2020-04-16_siliques.csv"
)) %>%
  bind_rows(read_csv(paste0(
    datapath, "PhD/Phenotyping/2020-09_lac_mutants/2020-11-05_siliques.csv"
  )) %>%
    select(-plant)) %>%
  mutate(rep = as.character(rep)) %>%
  pivot_longer(-c(genotype, rep), names_to = "sil", values_to = "length") %>%
  select(-sil) %>%
  bind_rows(sil_III) %>%
  mutate(genotype = recode(genotype,
    "Col-0" = "WT",
    "lac4/5/10/12/17" = "Q",
    "lac5/10/12/17" = "Q-4",
    "lac4/10/12/17" = "Q-5",
    "lac4/5/12/17" = "Q-10",
    "lac4/5/10/17" = "Q-12",
    "lac4/5/10/12" = "Q-17"
  )) %>%
  mutate(genotype = ordered(case_when(
    genotype == "WT" ~ genotype,
    TRUE ~ paste0("<i>", genotype, "</i>")
  ),
  levels = c(WT, triple_it, quad_it, Q_it)
  ))


# format stem data from growth instance III
stems_III <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2021-04_lac_mutants/2021-07_harvesting.csv"
)) %>%
  left_join(read_csv(paste0(datapath, "PhD/Phenotyping/2021-04_lac_mutants/plant_order.csv"))) %>%
  select(-sil.length, -stem.weight) %>%
  rename("rep" = replicate)

# combine stem data
pheno_data <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/2020-04-16_harvesting.csv"
)) %>%
  rename("stem.weight" = stem.w) %>%
  bind_rows(read_csv(paste0(
    datapath, "PhD/Phenotyping/2020-09_lac_mutants/2020-11-05_harvesting.csv"
  )) %>%
    bind_rows(stems_III) %>%
    select(-plant)) %>%
  mutate(genotype = recode(genotype,
    "Col-0" = "WT",
    "lac4/5/10/12/17" = "Q",
    "lac5/10/12/17" = "Q-4",
    "lac4/10/12/17" = "Q-5",
    "lac4/5/12/17" = "Q-10",
    "lac4/5/10/17" = "Q-12",
    "lac4/5/10/12" = "Q-17"
  )) %>%
  mutate(rep = as.character(rep)) %>%
  mutate(genotype = ordered(case_when(
    genotype == "WT" ~ genotype,
    TRUE ~ paste0("<i>", genotype, "</i>")
  ),
  levels = c(WT, triple_it, quad_it, Q_it)
  )) %>%
  left_join(siliques %>%
    group_by(genotype, rep) %>%
    summarise(mean.sil.length = mean(length))) %>%
  select(-mat.sil, -green.sil, -fl.stands) %>%
  filter(genotype %in% c(WT, quad_it, Q_it))
```

### Height

```{r}
letters <- letter_groups(pheno_data,
  stretched.height,
  genotype,
  "tukey",
  print_position = "below",
  print_adjust = 1
) %>%
  mutate(genotype = ordered(genotype, levels = c(WT, triple_it, quad_it, Q_it)))

final_height <- ggplot(
  pheno_data,
  aes(
    x = genotype,
    y = stretched.height,
    fill = genotype
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Stem height [cm]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(18, "mm")
    ),
    axis.text.x = element_markdown()
  ) 

final_height
```

#### Statistics

```{r}
stat_tab <- pheno_data %>%
  drop_na(stretched.height) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    stretched.height,
    genotype,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column("variable" = "height [cm]") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "01G_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column("variable" = "height [cm]") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "01G_tukey.csv"))
```

### Silique size

```{r}

siliques_avg <- siliques %>% 
  group_by(genotype, rep) %>% 
  summarise(length = mean(length)) %>% 
  left_join(pheno_data %>% select(genotype, rep, stretched.height)) %>% 
  drop_na()

siliques_rel <- siliques_avg %>% 
  group_by(genotype) %>% 
  summarise(length = mean(length)) %>% 
  ungroup() %>% 
  mutate(rel_length = length / length[genotype == "WT"])

letters_tech <- letter_groups(siliques %>%  filter(genotype %in% c(WT, quad_it, Q_it)),
  length,
  genotype,
  "tukey",
  print_position = "below",
  print_adjust = 1
) %>%
  mutate(genotype = ordered(genotype, levels = c(WT, triple_it, quad_it, Q_it))) %>% 
  select(-Letters)

letters <- letter_groups(siliques_avg %>% filter(genotype %in% c(WT, quad_it, Q_it)),
  length,
  genotype,
  "tukey",
  print_position = "below",
  print_adjust = 1
) %>%
  mutate(genotype = ordered(genotype, levels = c(WT, triple_it, quad_it, Q_it))) %>% 
  select(-length) %>% 
  left_join(letters_tech)

silique_plot <- ggplot(
  siliques %>% filter(genotype %in% c(WT, quad_it, Q_it)),
  aes(
    x = genotype,
    y = length,
    fill = genotype
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 2,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Silique length [cm]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(18, "mm")
    ),
    axis.text.x = element_markdown()
  ) 

r_sq <- glance(lm(length ~ stretched.height, data = siliques_avg))$adj.r.squared %>% 
  round(digits = 2)

r <- cor(x = siliques_avg$length, y = siliques_avg$stretched.height) %>% 
  round(digits = 2)

silique_linreg <- ggplot(siliques_avg,
       aes(x = stretched.height,
           y = length)) +
  geom_point(shape = 16,
             alpha = 0.5) +
  geom_smooth(method = "lm") +
  annotate("richtext", 
           label = paste0("R<sup>2</sup> = ", r_sq, "<br><i>r</i> = ", r),
           x = 55,
           y = 1.2,
           hjust = 1,
           fill = NA,
           label.size = NA,
           family = "Helvetica",
           size = ggtext_size) +
  labs(x = "Plant height at harvest [cm]",
       y = "Average silique length [cm]") +
  theme_leo()

silique_plot
silique_linreg
```

#### Statistics

```{r}
stat_tab <- siliques_avg %>% filter(genotype %in% c(WT, quad_it, Q_it)) %>%
  drop_na(length) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    length,
    genotype,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column("variable" = "silique length [cm]") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S02D_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column("variable" = "silique length [cm]") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S02D_tukey.csv"))
```

### [unused] Silique number

```{r, eval=FALSE}
sil_data <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/2020-04-16_harvesting.csv"
)) %>%
  mutate(
    siliques = green.sil + mat.sil,
    genotype = recode(genotype,
      "Col-0" = "WT",
      "lac4/5/10/12/17" = "Q",
      "lac5/10/12/17" = "Q-4",
      "lac4/10/12/17" = "Q-5",
      "lac4/5/12/17" = "Q-10",
      "lac4/5/10/17" = "Q-12",
      "lac4/5/10/12" = "Q-17"
    )
  ) %>%
  mutate(genotype = ordered(case_when(
    genotype == "WT" ~ genotype,
    TRUE ~ paste0("<i>", genotype, "</i>")
  ),
  levels = c(WT, triple_it, quad_it, Q_it)
  ))

letters <- letter_groups(sil_data,
                         siliques,
                         genotype,
                         "tukey",
                         print_position = "below")

sil_number <- ggplot(sil_data,
                     aes(x = genotype,
                         y = siliques)) +
  geom_quasirandom(shape = 21,
                   size = 1.5,
                   stroke = 0.2,
                   fill = "white",
                   alpha = 0.75) +
  geom_boxplot(width = 0.25, 
               alpha = 0.5,
               outlier.alpha = 0,
               colour = "black",
               fatten = 1,
               size = 0.2) +
  geom_text(data = letters,
            aes(label = Letters),
            size = ggtext_size,
            family = "Helvetica") +
  annotate("richtext",
           label = "<i>n</i> = 5",
           hjust = 0,
           x = 6.5,
           y = 1500,
           label.size = NA,
           size = ggtext_size,
           family = "Helvetica") +
  labs(y = "Silique number at harvest") +
  theme_leo() +
  theme(axis.text.x = element_markdown(),
        axis.title.x = element_blank())

letters <- letter_groups(pheno_data,
                         stretched.height,
                         genotype,
                         "tukey",
                         print_position = "below")

height_box <- ggplot(pheno_data,
                     aes(x = genotype,
                         y = stretched.height)) +
  geom_quasirandom(shape = 21,
                   size = 1.5,
                   stroke = 0.2,
                   fill = "white",
                   alpha = 0.75) +
  geom_boxplot(width = 0.25, 
               alpha = 0.5,
               outlier.alpha = 0,
               colour = "black",
               fatten = 1,
               size = 0.2) +
  geom_text(data = letters,
            aes(label = Letters),
            size = ggtext_size,
            family = "Helvetica") +
  annotate("richtext",
           label = "<i>n</i> = 15",
           hjust = 0,
           x = 6.5,
           y = 55,
           label.size = NA,
           size = ggtext_size,
           family = "Helvetica") +
  labs(y = "Stem heigth at harvest [cm]") +
  theme_leo() +
  theme(axis.text.x = element_markdown(),
        axis.title.x = element_blank())

pdf("simple_pheno_fig.pdf", height = onecol * 0.75, width = onecol * 0.75)
sil_number / height_box
dev.off()
```


### [unused] Stem thickness

```{r, eval=FALSE}
thickness_data <- pheno_data %>% 
  filter(genotype %in% c(WT, quad_it, Q_it)) %>% 
  mutate(
    rep = as.numeric(rep),
    instance = case_when(
      rep < 6 ~ "1",
      rep < 11 ~ "2",
      TRUE ~ "3"
    ))

ggplot(thickness_data, aes(x = instance, y = thickness)) +
  geom_point() +
  geom_boxplot(alpha = 0.5)
```



## Higher order mutants -- image based

### [unused] Calibration

```{r, eval=FALSE}
size_marker <- read_csv(paste0(datapath, "PhD/Phenotyping/2021-05_plantCV_calibration/calibration.csv"))

ggplot(
  size_marker,
  aes(
    x = pixels,
    y = space
  )
) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_leo()

summary(lm(pixels ~ space, data = size_marker))

print("The spacing of the colour card is equivalent to 1.5 cm.")
print("Length in cm = pixels * 1.5 / space")
print("Area in cm² = pixels² * 1.5² / space²")
```

### Rosette growth

#### Load data

```{r message=FALSE}
#### read-in function ###
read_plus <- function(flnm) {
  json <- fromJSON(flnm)
  json$observations$default$area$value %>%
    as_tibble() %>%
    mutate(filename = basename(flnm))
}

#### growth instance I ####
rosette_files <-
  list.files(
    path = paste0(datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/images/top/renamed/"),
    pattern = "*.json$",
    recursive = FALSE,
    full.names = TRUE
  )

tray_id <- read_csv(
  paste0(datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/plant_order.csv")
)

size_marker <- read_csv(
  paste0(datapath, "PhD/Phenotyping/2020-01_LAC_phenotyping/images/top/renamed/output/size_marker_trays.csv"),
  col_names = c("filename", "space")
) %>%
  separate(filename, into = c("dpg", "tray"), sep = "_") %>%
  mutate(
    tray = str_remove(tray, fixed(".jpg"))
  )

rosette_area_I <- map_dfr(rosette_files, read_plus) %>%
  separate(filename, into = c("dpg", "tray", "plant"), sep = "_") %>%
  mutate(
    tray = str_remove(tray, fixed(".jpg")),
    plant = as.numeric(str_remove(plant, fixed(".json"))) + 1
  ) %>%
  left_join(size_marker) %>%
  mutate(
    dpg = as.numeric(dpg),
    tray = as.numeric(tray),
    instance = 1,
    value = value / ((space / 1.5)^2)
  ) %>%
  # "space" from the size marker equals 1.5 cm
  left_join(tray_id %>% select(genotype, replicate, tray, "plant" = plant_tray)) %>%
  # anti_join(overlapping_plants) %>%
  filter(dpg < 30 & dpg != 9) # numbering on day 9 is off

#### growth instance II ####
rosette_files <-
  list.files(
    path = paste0(datapath, "PhD/Phenotyping/2020-09_lac_mutants/top/"),
    pattern = "*.json$",
    recursive = FALSE,
    full.names = TRUE
  )

overlapping_plants <- read_csv(
  paste0(datapath, "PhD/Phenotyping/2020-09_lac_mutants/excluded.csv")
) %>%
  mutate(plant = plant + 1) # numbering in .csv file is from 0-14

tray_id <- read_csv(
  paste0(datapath, "PhD/Phenotyping/2020-09_lac_mutants/plant_order.csv")
)

size_marker <- read_csv(
  paste0(datapath, "PhD/Phenotyping/2020-09_lac_mutants/top/output/size_marker_trays.csv"),
  col_names = c("filename", "space")
) %>%
  separate(filename, into = c("dpg", "tray"), sep = "_") %>%
  mutate(
    tray = str_remove(tray, fixed(".jpg"))
  )

rosette_area_II <- map_dfr(rosette_files, read_plus) %>%
  separate(filename, into = c("dpg", "tray", "plant"), sep = "_") %>%
  mutate(
    tray = str_remove(tray, fixed(".jpg")),
    plant = as.numeric(str_remove(plant, fixed(".json"))) + 1
  ) %>%
  left_join(size_marker) %>%
  mutate(
    dpg = as.numeric(dpg),
    tray = as.numeric(tray),
    instance = 2,
    value = value / ((space / 1.5)^2)
  ) %>%
  # "space" from the size marker equals 1.5 cm
  anti_join(overlapping_plants) %>%
  left_join(tray_id %>% select(genotype, replicate, tray, "plant" = plant_tray)) %>%
  filter(dpg < 30)

#### growth instance III ####
rosette_files <-
  list.files(
    path = paste0(datapath, "PhD/Phenotyping/2021-04_lac_mutants/top/renamed/"),
    pattern = "*.json$",
    recursive = FALSE,
    full.names = TRUE
  )

overlapping_plants <- read_csv(
  paste0(datapath, "PhD/Phenotyping/2021-04_lac_mutants/excluded.csv")
) %>%
  mutate(plant = plant + 1) # numbering in .csv file is from 0-14

tray_id <- read_csv(
  paste0(datapath, "PhD/Phenotyping/2021-04_lac_mutants/plant_order.csv")
)

size_marker <- read_csv(
  paste0(datapath, "PhD/Phenotyping/2021-04_lac_mutants/top/renamed/output/size_marker_trays.csv"),
  col_names = c("filename", "space")
) %>%
  separate(filename, into = c("dpg", "tray"), sep = "_") %>%
  mutate(
    tray = str_remove(tray, fixed(".jpg"))
  )

rosette_area_III <- map_dfr(rosette_files, read_plus) %>%
  separate(filename, into = c("dpg", "tray", "plant"), sep = "_") %>%
  mutate(
    tray = str_remove(tray, fixed(".jpg")),
    plant = as.numeric(str_remove(plant, fixed(".json"))) + 1
  ) %>%
  left_join(size_marker) %>%
  mutate(
    dpg = as.numeric(dpg),
    tray = as.numeric(tray),
    instance = 3,
    value = value / ((space / 1.5)^2)
  ) %>%
  # "space" from the size marker equals 1.5 cm
  anti_join(overlapping_plants) %>%
  left_join(tray_id %>% select(genotype, replicate, tray, "plant" = plant_tray)) %>%
  filter(dpg < 30)

rosette_area <- bind_rows(rosette_area_I, rosette_area_II, rosette_area_III) %>%
  mutate(genotype = ordered(case_when(
    genotype == "WT" ~ genotype,
    TRUE ~ paste0("<i>", genotype, "</i>")
  ),
  levels = c(WT, triple_it, quad_it, Q_it)
  )) %>%
  filter(genotype != "<i>Q-4/12</i>")
```

#### Area over time

```{r}
label_data <- rosette_area %>% 
  filter(genotype %in% c(WT, quad_it, Q_it) & dpg == 29) %>% 
  group_by(genotype) %>% 
  summarise(value = mean(value),
            dpg = 29)

area_plot <- ggplot(
  rosette_area %>% filter(genotype %in% c(WT, quad_it, Q_it)),
  aes(
    x = dpg,
    y = value,
    colour = genotype
  )
) +
  geom_vline(xintercept = c(20, 29),
             linetype = 2,
             size = 0.2) +
  geom_line(aes(group = interaction(genotype, replicate)),
    size = 0.2,
    alpha = 0.2
  ) +
  geom_smooth(
    se = F,
    size = 0.4,
    linetype = 2,
    span = 0.4
  ) +
  geom_richtext(data = label_data,
            aes(label = genotype),
            family = "Helvetica",
            size = ggtext_size,
            label.size = NA,
            fill = NA,
            hjust = 0) +
  labs(x = "Days past germination",
       y = "Rosette area [cm<sup>2</sup>]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_leo() +
  theme(axis.title.y = element_markdown())

area_plot
```


#### Growth rate

```{r}
# define linear phase
lm_start <- 20
lm_stop <- 29

# calculate slopes
nested_rosette_area <- rosette_area %>%
  filter(dpg >= lm_start & dpg <= lm_stop & genotype %in% c(WT, quad_it, Q_it)) %>%
  select(genotype, replicate, value, dpg) %>%
  nest(data = c(dpg, value)) %>%
  mutate(
    fit = map(data, ~ lm(value ~ dpg, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "dpg")

# calculate average R²
avg_r_sq <- nested_rosette_area %>%
  group_by(genotype) %>%
  summarise(
    mean_r_sq = mean(adj.r.squared, na.rm = TRUE),
    sd_r_sq = sd(adj.r.squared, na.rm = TRUE)
  )

letters <- letter_groups(nested_rosette_area,
  estimate,
  genotype,
  "tukey",
  print_position = "below",
  print_adjust = 0.5
) %>%
  mutate(genotype = ordered(genotype, levels = c(WT, triple_it, quad_it, Q_it)))

# plot slopes
rosette_growth_plot <- ggplot(
  nested_rosette_area,
  aes(
    x = genotype,
    y = estimate
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Growth [cm<sup>2</sup> day<sup>-1</sup>]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown()
  ) 

rosette_growth_plot
```

##### Statistics

```{r}
stat_tab <- nested_rosette_area %>%
  drop_na(estimate) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    estimate,
    genotype,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column("variable" = "rosette growth rate [cm²/day]") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "01C_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column("variable" = "rosette growth rate [cm²/day]") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "01C_tukey.csv"))
```

### Stem growth

#### Load data

```{r}
pcv_data_II <- fromJSON(paste0(
  datapath,
  "PhD/Phenotyping/2020-09_lac_mutants/front/renamed/output/results.json"
))

pcv_data_III <- fromJSON(paste0(
  datapath,
  "PhD/Phenotyping/2021-04_lac_mutants/front/renamed/output/results.json"
))

scale_II <- read_csv(paste0(
  datapath,
  "PhD/Phenotyping/2020-09_lac_mutants/size_marker.csv"
),
col_names = c("filename", "space")
) %>%
  mutate(image = str_remove(filename, fixed(".jpg"))) %>%
  separate(image, into = c("dpg", "plant")) %>%
  mutate(dpg = as.numeric(dpg)) %>%
  distinct()

scale_III <- read_csv(paste0(
  datapath,
  "PhD/Phenotyping/2021-04_lac_mutants/size_marker.csv"
),
col_names = c("filename", "space")
) %>%
  mutate(image = str_remove(filename, fixed(".jpg"))) %>%
  separate(image, into = c("dpg", "plant")) %>%
  mutate(dpg = as.numeric(dpg)) %>%
  distinct()

ID_II <- read_csv(paste0(
  datapath,
  "PhD/Phenotyping/2020-09_lac_mutants/plant_order.csv"
)) %>%
  select(genotype, replicate, plant) %>%
  mutate(plant = as.character(plant))

ID_III <- read_csv(paste0(
  datapath,
  "PhD/Phenotyping/2021-04_lac_mutants/plant_order.csv"
)) %>%
  select(genotype, replicate, plant) %>%
  mutate(plant = as.character(plant))

stem_data_II <- tibble(
  plant = pcv_data_II$entities$metadata$id$value,
  dpg = as.numeric(pcv_data_II$entities$metadata$timestamp$value),
  height = pcv_data_II$entities$observations$default$height$value,
  long_axis = pcv_data_II$entities$observations$default$ellipse_major_axis$value,
  longest_path = pcv_data_II$entities$observations$default$longest_path$value,
  hue = pcv_data_II$entities$observations$default$hue_circular_mean$value,
  area = pcv_data_II$entities$observations$default$area$value,
) %>%
  left_join(ID_II) %>%
  left_join(scale_II)

stem_data_III <- tibble(
  plant = pcv_data_III$entities$metadata$id$value,
  dpg = as.numeric(pcv_data_III$entities$metadata$timestamp$value),
  height = pcv_data_III$entities$observations$default$height$value,
  long_axis = pcv_data_III$entities$observations$default$ellipse_major_axis$value,
  longest_path = pcv_data_III$entities$observations$default$longest_path$value,
  hue = pcv_data_III$entities$observations$default$hue_circular_mean$value,
  area = pcv_data_III$entities$observations$default$area$value,
) %>%
  left_join(ID_III) %>%
  left_join(scale_III)

stem_data <- bind_rows(stem_data_II, stem_data_III) %>%
  mutate(
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ),
    instance = case_when(
      replicate < 6 ~ "1",
      replicate < 11 ~ "2",
      TRUE ~ "3"
    ),
    height = height / space * 1.5,
    long_axis = long_axis / space * 1.5,
    longest_path = longest_path / space * 1.5,
    area = area / ((space / 1.5)^2)
  ) %>%
  anti_join(
    read_csv(paste0(datapath, "PhD/Phenotyping/2021-04_lac_mutants/excluded_stems.csv"))
  ) %>%
  filter(genotype != "<i>Q-4/12</i>") %>%
  group_by(genotype, replicate) %>%
  mutate(
    flowering_start = dpg[height == min(height[height > 5])],
    dpb = dpg - flowering_start
  )
```

#### Bolting

```{r}

flower_data <- stem_data %>% filter(genotype %in% c(WT, quad_it, Q_it)) %>% 
  group_by(genotype, replicate) %>% 
  summarise(flowering_start = mean(flowering_start),
            instance = unique(instance))

letters <- letter_groups(flower_data,
                        flowering_start,
                        genotype,
                        "tukey",
                        print_position = "below")
bolt_geno <- ggplot(flower_data, aes(x = genotype, y = flowering_start)) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Bolting [dpg]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown()
  ) 

p_val <- glance(t.test(flowering_start ~ instance, data = flower_data))$p.value %>% 
  formatC(digits = 1, format = "e")

bolt_inst <- ggplot(flower_data, aes(x = instance, y = flowering_start)) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    # aes(fill = instance),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 2,
    scale = "width"
  ) +
  annotate("richtext", 
           label = paste0("<i>P</i> = ", p_val),
           x = 1.5,
           y = 25,
           hjust = 0.5,
           fill = NA,
           label.size = NA,
           family = "Helvetica",
           size = ggtext_size) +
  labs(y = "Bolting [dpg]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  labs(x = "Growth instance") +
  theme_leo() +
  theme(
    # axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown()
  ) 

bolt_geno
bolt_inst

```

##### Statistics

```{r}
stat_tab <- flower_data %>%
  drop_na(flowering_start) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    flowering_start,
    genotype,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column("variable" = "bolting [dpg]") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S02C_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column("variable" = "bolting [dpg]") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S02C_tukey.csv"))
```

#### [unused] Hue over time

```{r, eval=FALSE}
hue_plot <- ggplot(
  stem_data %>% filter(genotype %in% c(WT, quad_it, Q_it) &
    dpb < 31),
  aes(
    x = dpb,
    y = hue,
    colour = genotype
  )
) +
  geom_line(aes(group = interaction(plant, replicate)),
    size = 0.2,
    alpha = 0.2
  ) +
  geom_smooth(
    se = F,
    size = 0.4,
    linetype = 2,
    span = 0.4
  ) +
  labs(x = "Days past bolting",
       y = "Hue [°]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_y_continuous(position = "right") +
  theme_leo() +
  theme(axis.title.y = element_markdown()) +
  facet_wrap(~ paste("Growth instance", instance))

hue_plot
```

#### [unused] Hue at harvest

```{r, eval=FALSE}
hue_end <- stem_data %>% 
  filter(genotype %in% c(WT, quad_it, Q_it)) %>% 
  group_by(genotype, replicate) %>% 
  summarise(hue_end = min(hue[dpb > 28]),
            instance = unique(instance))

letters <- letter_groups(hue_end,
                         hue_end,
                         genotype,
                         "tukey",
                         instance,
                         print_position = "below")

hue_violin <- ggplot(hue_end,
                     aes(x = genotype, 
                         y = hue_end)) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Hue at time of harvest [°]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown()
  ) +
  facet_wrap(~ paste("Growth instance", instance))

hue_violin
```

#### Height over time

```{r}
label_data <- stem_data %>% 
  filter(genotype %in% c(WT, quad_it, Q_it) & dpb == 30) %>% 
  group_by(genotype) %>% 
  summarise(height = mean(height),
            dpb = 30)

height_plot <- ggplot(
  stem_data %>% filter(genotype %in% c(WT, quad_it, Q_it) &
    dpb < 31),
  aes(
    x = dpb,
    y = height,
    colour = genotype
  )
) +
  geom_vline(xintercept = c(-3, 11),
             linetype = 2,
             size = 0.2) +
  geom_line(aes(group = interaction(plant, replicate)),
    size = 0.2,
    alpha = 0.2
  ) +
  geom_smooth(
    se = F,
    size = 0.4,
    linetype = 2,
    span = 0.4
  ) +
  geom_richtext(data = label_data,
            aes(label = genotype),
            family = "Helvetica",
            size = ggtext_size,
            label.size = NA,
            fill = NA,
            hjust = 0) +
  labs(x = "Days past bolting",
       y = "Stem height [cm]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  scale_y_continuous(position = "right") +
  theme_leo() +
  theme(axis.title.y = element_markdown())


height_plot
```

#### [unused] Area over time

```{r, eval=FALSE}
label_data <- stem_data %>% 
  filter(genotype %in% c(WT, quad_it, Q_it) & dpb == 30) %>% 
  group_by(genotype) %>% 
  summarise(area = mean(area),
            dpb = 30)

area_plot <- ggplot(
  stem_data %>% filter(genotype %in% c(WT, quad_it, Q_it) &
    dpb < 31),
  aes(
    x = dpb,
    y = area,
    colour = genotype
  )
) +
  geom_vline(xintercept = c(-3, 11),
             linetype = 2,
             size = 0.2) +
  geom_line(aes(group = interaction(plant, replicate)),
    size = 0.2,
    alpha = 0.2
  ) +
  geom_smooth(
    se = F,
    size = 0.4,
    linetype = 2,
    span = 0.4
  ) +
  geom_richtext(data = label_data,
            aes(label = genotype),
            family = "Helvetica",
            size = ggtext_size,
            label.size = NA,
            fill = NA,
            hjust = 0) +
  labs(x = "Days past bolting",
       y = "Stem area [cm]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  scale_y_continuous(position = "right") +
  theme_leo() +
  theme(axis.title.y = element_markdown())


area_plot
```

#### Growth rate

```{r}
# define linear phase
lm_start <- -3
lm_stop <- 11

# calculate slopes
nested_stem_data <- stem_data %>%
  filter(dpb >= lm_start & dpb <= lm_stop & genotype %in% c(WT, quad_it, Q_it)) %>%
  select(genotype, replicate, height, dpb) %>%
  nest(data = c(dpb, height)) %>%
  mutate(
    fit = map(data, ~ lm(height ~ dpb, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "dpb")

# calculate average R²
avg_r_sq <- nested_stem_data %>%
  group_by(genotype) %>%
  summarise(
    mean_r_sq = mean(adj.r.squared, na.rm = TRUE),
    sd_r_sq = sd(adj.r.squared, na.rm = TRUE)
  )

letters <- letter_groups(nested_stem_data,
  estimate,
  genotype,
  "tukey",
  print_position = "below",
  print_adjust = 0.5
) %>%
  mutate(genotype = ordered(genotype, levels = c(WT, triple_it, quad_it, Q_it)))

# plot slopes
stem_growth_plot <- ggplot(
  nested_stem_data,
  aes(
    x = genotype,
    y = estimate
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_violin(
  #   aes(fill = genotype),
  #   draw_quantiles = 0.5,
  #   # fill = "white",
  #   colour = "black",
  #   alpha = 1,
  #   width = 0.75,
  #   size = 0.2,
  #   adjust = 1
  #   # scale = "width"
  # ) +
  # geom_quasirandom(
  #   shape = 21,
  #   alpha = 1,
  #   size = 0.75,
  #   width = 0.25,
  #   stroke = 0.2,
  #   fill = "white",
  # ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Growth [cm day<sup>-1</sup>]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown()
  ) 

stem_growth_plot
```

##### Statistics

```{r}
stat_tab <- nested_stem_data %>%
  drop_na(estimate) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    estimate,
    genotype,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column("variable" = "stem growth rate [cm/day]") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "01F_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column("variable" = "stem growth rate [cm/day]") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "01F_tukey.csv"))
```

### Stem angle

```{r}
# The code for the root angle analysis got lost during a backup mishap.
# The data is at /home/leonard/Dropbox/2021_lac_manuscript/lodging/stem_angles.csv
# The code should generate violin plots comparing the delta of stem base angles from 90 degrees
```

#### Load data

```{r}
ID <- ID_II %>%
  mutate(instance = "2020-09") %>%
  bind_rows(ID_III %>% mutate(instance = "2021-04"))

angles <- read_csv("/home/leonard/Dropbox/2021_lac_manuscript/lodging/stem_angles.csv") %>%
  mutate(plant = as.character(plant)) %>%
  left_join(ID) %>%
  mutate(
    base_d90 = abs(90 - base_angle),
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    )
  )
```

#### Plot base angle delta

```{r}
letters <- letter_groups(
  angles,
  base_d90,
  genotype,
  "kruskal",
  print_position = "below"
)

base_delta <- ggplot(
  angles,
  aes(
    x = genotype,
    y = base_d90
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_violin(
  #   aes(fill = genotype),
  #   draw_quantiles = 0.5,
  #   # fill = "white",
  #   colour = "black",
  #   alpha = 1,
  #   width = 0.75,
  #   size = 0.2,
  #   adjust = 1
  #   # scale = "width"
  # ) +
  # geom_quasirandom(
  #   shape = 21,
  #   alpha = 1,
  #   size = 0.75,
  #   width = 0.25,
  #   stroke = 0.2,
  #   fill = "white",
  # ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Stem base angle [&#8710;90]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown()
  ) 

base_delta
```

##### Statistics

```{r}
stat_tab <- angles %>%
  drop_na(base_d90) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    base_d90,
    genotype,
    "kruskal",
    table = TRUE
  )

  anova_tab <- stat_tab$kruskal %>% 
    add_column("variable" = "stem base angle [delta90]") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S01F_kruskal.csv"))

  tukey_tab <- stat_tab$dunn %>%
    add_column("variable" = "stem base angle [delta90]") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "01F_dunn.csv"))
```





### Root growth

#### Load data

```{r}
root_data <- read_csv(paste0(
  datapath, "PhD/Phenotyping/2020-10_lac_root_growth/2020-10_roots.csv"
)) %>% 
  mutate(genotype = ordered(case_when(
    genotype == "WT" ~ genotype,
    TRUE ~ paste0("<i>", genotype, "</i>")
  ),
  levels = c(WT, triple_it, quad_it, Q_it)
  )) 
```

#### Length over time

```{r}
root_plot <- ggplot(
  root_data %>% filter(genotype %in% c(WT, quad_it, Q_it)),
  aes(
    x = dpg,
    y = length,
    colour = genotype
  )
) +
  geom_line(aes(group = interaction(genotype, position, plant)),
    size = 0.2,
    alpha = 0.2
  ) +
  geom_smooth(
    method = "lm",
    fullrange = T,
    se = F,
    size = 0.4,
    linetype = 2
  ) +
  labs(x = "Days past germination",
       y = "Root length [cm]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  theme_leo() +
  theme(axis.title.y = element_markdown())


root_plot
```

#### Growth rate

```{r}
lm_start <- 2
lm_stop <- 7

# calculate slopes
nested_root_data <- root_data %>%
  filter(dpg >= lm_start & dpg <= lm_stop & genotype %in% c(WT, quad_it, Q_it)) %>%
  select(genotype, position, plant, length, dpg) %>%
  nest(data = c(dpg, length)) %>%
  mutate(
    fit = map(data, ~ lm(length ~ dpg, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "dpg")

letters <- letter_groups(nested_root_data,
  estimate,
  genotype,
  "tukey",
  print_position = "below",
  print_adjust = 0.5
) %>%
  mutate(genotype = ordered(genotype, levels = c(WT, triple_it, quad_it, Q_it)))

# plot slopes
roots <- ggplot(
  nested_root_data,
  aes(
    x = genotype,
    y = estimate
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.5,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Root growth [cm day<sup>-1</sup>]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown()
  ) 
roots
```

##### Statistics

```{r}
stat_tab <- nested_root_data %>%
  drop_na(estimate) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    estimate,
    genotype,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column("variable" = "root growth rate [cm/day]") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S02B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column("variable" = "root growth rate [cm/day]") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S02B_tukey.csv"))
```


## Pheno figure

```{r}
pdf("Blaschek2022_figure1.pdf", height = onecol * 0.8, width = twocol)
area_plot +
  inset_element(rosette_growth_plot,
    left = 0.15, bottom = 0.55, right = 0.65, top = 0.85,
    align_to = "full"
  ) +
  height_plot + 
  inset_element(stem_growth_plot,
    left = 0.025, bottom = 0.675, right = 0.525, top = 0.975,
    align_to = "full"
  ) +
  inset_element(final_height,
    left = 0.425, bottom = 0.075, right = 0.925, top = 0.375,
    align_to = "full"
  ) 
dev.off()
```

## Pheno supplementary figure

```{r}
layout <- "
AAAAAA
BBCCDD
####EE
"
pdf("Blaschek2022_figureS2.pdf", height = onecol, width = twocol)
full_mutant_plot + roots + bolt_geno + silique_plot + base_delta +
  plot_layout(design = layout) &
  plot_annotation(
    tag_levels = "A"
  ) &
  theme(plot.tag = element_text(size = 10, face = "bold", family = "Helvetica"))
dev.off()
```

# Section activity

## [unused] WT inactivation

```{r, eval=FALSE}

data <- read_csv(paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAF/2020-09-18_inactivation/2020-09-18_inactivation.csv")) %>%
  mutate(time = slice * interval) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, technical, substrate, treatment, pH, date, cell_type) %>%
  mutate(point = row_number())

#### subtract water column and background ####
data <- data %>%
  group_by(time, genotype, replicate, substrate, technical, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, technical, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == 100]
  )

nested_data <- data %>%
  filter(time >= 100 & time <= 230) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(time, zeroed_absorbance, median_hue) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  filter(term == "time")

raw_absorbance <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 230,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(point, treatment, technical)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  # theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_wrap(~cell_type)

activity_grid <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 230,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(treatment, point, technical)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(ylim = c(0, 0.2)) +
  facet_wrap(~cell_type)

slopes <- ggplot(
  nested_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = treatment,
    y = estimate,
    colour = treatment,
    shape = as.character(technical)
  )
) +
  geom_quasirandom(aes(group = treatment),
    size = 1,
    dodge.width = 0.5,
    alpha = 0.5
  ) +
  geom_violin(
    aes(group = interaction(treatment, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  # scale_colour_manual(values = c("#275d95")) +
  # scale_x_continuous(breaks = c(4, 5, 6, 7)) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_wrap(~cell_type, ncol = 4)

# pdf("WT_inactivation.pdf", width = twocol, height = onecol * 0.5)
raw_absorbance
activity_grid
slopes
# dev.off()
```

### [unused] Extension

After overnight incubation, added another 2 µl of 7 mM DAF stock to each well and took a picture every 10 min for 30 cycles.

```{r, eval=FALSE}

data <- read_csv(paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAF/2020-09-18_inactivation/2020-09-18_inactivation_extended.csv")) %>%
  mutate(time = slice * interval) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, technical, substrate, treatment, pH, date, cell_type) %>%
  mutate(point = row_number())

#### subtract water column and background ####
data <- data %>%
  group_by(time, genotype, replicate, substrate, technical, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, technical, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == 100]
  )

nested_data <- data %>%
  filter(time >= 100 & time <= 230) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(time, zeroed_absorbance, median_hue) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  filter(term == "time")

raw_absorbance <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 230,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(point, treatment)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  # theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_wrap(~cell_type)

activity_grid <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 230,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(treatment, point)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(ylim = c(0, 0.2)) +
  facet_wrap(~cell_type)

slopes <- ggplot(
  nested_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX")),
  aes(
    x = treatment,
    y = estimate,
    colour = treatment
  )
) +
  geom_quasirandom(
    dodge.width = 0.5,
    alpha = 0.5
  ) +
  geom_violin(
    aes(group = interaction(treatment, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  # scale_colour_manual(values = c("#275d95")) +
  # scale_x_continuous(breaks = c(4, 5, 6, 7)) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_wrap(~cell_type, ncol = 4)

# pdf("WT_inactivation_extended.pdf", width = twocol, height = onecol * 0.5)
raw_absorbance
activity_grid
slopes
# dev.off()
```

## [unused] pH pilot

```{r, eval=FALSE}
data <- read_csv(paste0(
  datapath,
  "PhD/Laccase_activity/2020-09_activity/2020-09_lac_activity.csv"
),
comment = '"#'
) %>%
  mutate(time = slice * interval) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  mutate(point = row_number())

#### subtract water column and background ####
data <- data %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == 60]
  )

nested_data <- data %>%
  filter(time >= 100 & time <= 150) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(time, zeroed_absorbance, median_hue) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  filter(term == "time")

avg_slopes <- nested_data %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))

raw_absorbance <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    date == "2020-09-14"),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = cell_type
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 150,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(point, cell_type)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  # theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_grid(treatment ~ pH)


activity_grid <- ggplot(
  data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    date == "2020-09-14"),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = cell_type
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 100,
    xmax = 150,
    fill = "grey95"
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_grid(treatment ~ pH)


slopes <- ggplot(
  nested_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX") &
    date == "2020-09-14"),
  aes(
    x = pH,
    y = estimate,
    colour = treatment
  )
) +
  geom_quasirandom(
    dodge.width = 0.5,
    alpha = 0.5
  ) +
  geom_violin(
    aes(group = interaction(treatment, pH)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  scale_colour_manual(values = c("grey80", "#275d95")) +
  scale_x_continuous(breaks = c(4, 5, 6, 7)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_wrap(~cell_type, ncol = 4)

# pdf("WT_DAF_pH.pdf", width = twocol, height = onecol * 0.5)
raw_absorbance
activity_grid
slopes
# dev.off()
```

## pH optimum

### Load data

```{r}
# Define the boundaries of the linear phase for each substrate and pH
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "PYGL", "4", 210, 600,
  "PYGL", "5", 90, 200,
  "PYGL", "6", 90, 200,
  "PYGL", "7", 30, 90,
  "DAF", "4", 70, 140,
  "DAF", "5", 80, 160,
  "DAF", "6", 90, 200,
  "DAF", "7", 90, 200
)

# remove points that moved outside the field-of-view due to section movement
sample_rm <- tribble(
  ~substrate, ~genotype, ~replicate, ~pH, ~treatment, ~cell_type, ~time,
  "DAF", "Q", "7", "6", "untreated", "PX", seq(0, 500, 10),
  "DAF", "WT", "8", "5", "autoclaved", c("IF", "CML", "CC", "LP", "MX", "PX", "XF", "PH", "BG"), seq(280, 500, 10)
) %>%
  unnest(time) %>%
  unnest(cell_type)

# load individual .csv files (from after the initial file became too large)
activity_opt_files <-
  list.files(
    path = c(paste0(datapath, "PhD/Laccase_activity/2021-01_optimal_pH/ROIs/Measurements/"),
             "/home/leonard/Dropbox/2021_lac_manuscript/Activity/pH_CC/ROIs/Measurements/",
             "/home/leonard/Dropbox/2021_lac_manuscript/Activity/autoclaved/ROIs/Measurements/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

pH_data_single_files <- map_dfr(activity_opt_files, read_csv)

pH_data <- read_csv(paste0(
  datapath,
  "PhD/Laccase_activity/2021-01_optimal_pH/pH_data.csv"
),
comment = '"#'
) %>%
  bind_rows(pH_data_single_files) %>%
  mutate(time = slice * interval) %>%
  select(-c(slice, interval)) %>%
  separate(image,
    into = c("date", "substrate", "genotype", "replicate", "pH", "treatment"),
    sep = "_"
  ) %>%
  mutate(
    pH = str_remove(pH, "pH"),
    treatment = str_remove(treatment, fixed(".tiff"))
  ) %>%
  anti_join(sample_rm) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  mutate(point = row_number()) %>%
  left_join(lm_bounds)

#### subtract water column and background ####
pH_data <- pH_data %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == lm_start]
  ) %>%
  filter(cell_type != "PH" & cell_type != "BG")

nested_pH_data <- pH_data %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(data = c(time, zeroed_absorbance, median_hue)) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  filter(term == "time") %>% 
  mutate(
    cell_type = recode(cell_type, 
                       "CML" = "IF-CML",
                       "CC" = "IF-CC"),
    cell_type = ordered(cell_type,
                             levels = c(
                               "IF",
                               "IF-CML",
                               "IF-CC",
                               "XF",
                               "PX",
                               "MX",
                               "LP",
                               "PH",
                               "BG"
                             ))) %>% 
  mutate(genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)))

avg_pH_slopes <- nested_pH_data %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate)) 
```

### Plot PYGL

#### Line plots

```{r}

ctrl_slopes <- avg_pH_slopes %>%
  filter(treatment == "autoclaved" & substrate == "PYGL") %>%
  ungroup() %>%
  select(-treatment, -replicate) %>%
  group_by(genotype, cell_type, pH) %>%
  summarise(mean_estimate = mean(mean_estimate))

pygl_slopes <- nested_pH_data %>%
  filter(substrate == "PYGL" & treatment == "untreated" & cell_type %in% c("IF", "IF-CML", "IF-CC", "XF", "PX", "MX")) %>%
  left_join(ctrl_slopes) %>%
  mutate(
    corrected_estimate = case_when(
      mean_estimate > 0 ~ estimate - mean_estimate,
      TRUE ~ estimate
    )
  )

pygl_slopes_cont <- pygl_slopes %>%
  mutate(pH = as.numeric(pH)) %>%
  filter(treatment == "untreated") %>%
  group_by(genotype, replicate, pH, cell_type) %>%
  summarise(mean_estimate = mean(corrected_estimate))

ph_cont_pygl <- ggplot(
  pygl_slopes_cont,
  aes(
    x = pH,
    y = mean_estimate * 1000
  )
) +
  geom_line(aes(
    colour = genotype,
    group = interaction(replicate, genotype)
  ),
  size = 0.2,
  alpha = 0.25
  ) +
  geom_smooth(aes(colour = genotype),
    span = 1.25,
    size = 0.5,
    alpha = 1,
    se = F
  ) +
  labs(y = "PYGL oxidation rate") +
  scale_color_manual(values = pal_dawn[c(1,7)], aesthetics = c("colour", "fill")) +
  theme_leo() +
  theme(
    legend.position = c(0.06, 0.9),
    legend.title = element_blank(),
    legend.direction = "horizontal",
    legend.text = element_markdown()
  ) +
  facet_wrap(
    ~cell_type,
    nrow = 1,
    scales = "free_y"
  )

pdf("PYGL_pH.pdf", width = twocol, height = onecol * 0.4)
ph_cont_pygl
dev.off()
```

#### Violins

```{r}
pH_violin_data <- nested_pH_data %>% 
  filter(substrate == "PYGL" & cell_type %in% c("IF", "MX")) %>% 
  unite("ID", genotype, treatment, sep = " ", remove = FALSE) %>% 
  mutate(
  ID = ordered(ID, levels = c("WT untreated", "WT autoclaved", "<i>Q</i> untreated", "<i>Q</i> autoclaved")),
    estimate = case_when(estimate < 0 ~ 0,
                              TRUE ~ estimate)
    )

pH_violin_avg <- pH_violin_data %>% 
  group_by(genotype, treatment, ID, replicate, pH, cell_type) %>% 
  summarise(estimate = median(estimate))

letters_tech <- pH_violin_data %>% 
  unite("ID_pH", ID, pH) %>%
  letter_groups(
    .,
    estimate,
    ID_pH,
    "tukey",
    cell_type,
    print_position = "above"
  ) %>% 
  select(-Letters)

letters <- pH_violin_avg %>%
  unite("ID_pH", ID, pH) %>%
  letter_groups(
    .,
    estimate,
    ID_pH,
    "tukey",
    cell_type,
    print_position = "above"
  ) %>% 
  select(-estimate) %>% 
  left_join(letters_tech) %>% 
  separate(ID_pH, into = c("ID", "pH"), sep = "_") %>% 
  mutate(ID = ordered(ID, levels = c("WT untreated", "WT autoclaved", "<i>Q</i> untreated", "<i>Q</i> autoclaved")))

legend_labels <- tribble(
  ~cell_type, ~ID, ~pH,
  "IF", "WT untreated", "4",
  "IF", "WT autoclaved", "4",
  "IF", "<i>Q</i> untreated", "4",
  "IF", "<i>Q</i> autoclaved", "4"
) %>% 
  left_join(letters) %>% 
  mutate(estimate = estimate + 0.0001, #0.0001 when letters are printed
         position = estimate + 0.0002) %>% 
  mutate(ID = ordered(ID, levels = c("WT untreated", "WT autoclaved", "<i>Q</i> untreated", "<i>Q</i> autoclaved")))

pygl_violin <- ggplot(
  pH_violin_data,
  aes(
    x = pH,
    y = estimate
  )
) +
  geom_quasirandom(
    aes(colour = ID),
    dodge.width = 0.6,
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.1
  ) +
  geom_violin(
    aes(fill = ID),
    position = position_dodge(width = 0.6),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(
  #   data = pH_violin_avg,
  #   aes(fill = ID),
  #   shape = 21,
  #   position = position_dodge(width = 0.6)
  # ) +
  geom_richtext(
    data = legend_labels,
    aes(
      label = ID,
      group = ID,
      y = position
    ),
    label.size = NA,
    fill = NA,
    angle = 90,
    hjust = 0,
    position = position_dodge(width = 0.6),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  geom_linerange(
    data = legend_labels,
    aes(
      x = pH,
      ymin = estimate,
      ymax = position,
      group = ID
    ),
    position = position_dodge(width = 0.6),
    size = 0.2
  ) +
  geom_text(
    data = letters,
    aes(
      label = Letters,
      group = ID
    ),
    position = position_dodge(width = 0.6),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "PYGL oxidation rate") +
  scale_color_manual(values = c(pal_dawn[1], "#E3E6E8", pal_dawn[7], "#F3EAD8"), aesthetics = c("colour", "fill")) +
  scale_y_continuous(limits = c(0, 0.002)) +
  theme_leo() +
  theme(
    # axis.title.x = element_blank(),
    # axis.text.x = element_markdown(angle = 45, hjust = 1, vjust = 1),
    # legend.position = "top"
  ) +
  facet_wrap(~cell_type, ncol = 2)

pdf("PYGL_pH_violins.pdf", width = twocol, height = onecol * 0.4)
pygl_violin
dev.off()
```

##### Statistics

```{r}
stat_tab <- pH_violin_avg %>%
  drop_na(estimate) %>% 
  mutate(pH = paste("pH", pH)) %>% 
  unite("ID_pH", ID, pH, sep = " ") %>%
  rowwise() %>%
  mutate(ID_pH = strip_html(ID_pH)) %>%
  group_by(ID_pH, cell_type) %>%
  mutate(
    "n" = n(),
    ID_pH = paste0(ID_pH, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    estimate,
    ID_pH,
    "tukey",
    cell_type,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = "PYGL oxidation rate",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S03E_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = "PYGL oxidation rate",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S03E_tukey.csv"))
```



### Plot DAF

#### Line plots

```{r}
activity_grid <- ggplot(
  pH_data %>% filter(substrate == "DAF"),
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = interaction(treatment, genotype),
    linetype = treatment
  )
) +
  # annotate("rect",
  #   ymin = -Inf,
  #   ymax = Inf,
  #   xmin = lm_start,
  #   xmax = lm_stop,
  #   fill = "grey95"
  # ) +
  geom_rect(
    data = lm_bounds %>% filter(substrate == "DAF"),
    aes(
      xmin = lm_start,
      xmax = lm_stop,
      linetype = NULL,
      x = NULL,
      y = NULL,
      colour = NULL
    ),
    ymin = -Inf,
    ymax = Inf,
    fill = "grey95"
  ) +
  geom_smooth(
    size = 0.2,
    se = F
  ) +
  labs(x = "Time [min]") +
  # scale_colour_manual(values = c(
  #   lighten(desaturate("#d25952", amount = 0.75), amount = 0.5),
  #   "#d25952",
  #   lighten(desaturate("#275d95", amount = 0.75), amount = 0.5),
  #   "#275d95"
  # )) +
  scale_color_manual(values = pal_dawn[c(1,7)], aesthetics = c("colour", "fill")) +
  scale_linetype(guide = "none") +
  theme_leo() +
  theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(60, 100)) +
  facet_grid(pH ~ cell_type)

# letter_data <- nested_pH_data %>%
#   filter(substrate == "DAF") %>%
#   unite("ID", treatment, genotype)
# 
# letters <- letter_groups(letter_data,
#   estimate,
#   ID,
#   "tukey",
#   cell_type,
#   pH,
#   print_position = "above",
#   print_adjust = 1
# ) %>%
#   separate(ID, into = c("treatment", "genotype"))

slopes <- ggplot(
  nested_pH_data %>% filter(substrate == "DAF"),
  aes(
    x = pH,
    y = estimate,
    colour = interaction(treatment, genotype)
  )
) +
  geom_hline(
    yintercept = 0,
    size = 0.2
  ) +
  geom_quasirandom(
    dodge.width = 0.75,
    alpha = 0.5,
    shape = 16,
    size = 0.75
  ) +
  geom_violin(
    aes(group = interaction(treatment, pH, genotype)),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.75),
    size = 0.2,
    scale = "width"
  ) +
  # geom_text(
  #   data = letters,
  #   aes(
  #     label = Letters,
  #     group = interaction(treatment, genotype)
  #   ),
  #   colour = "black",
  #   position = position_dodge2(width = 0.75),
  #   family = "Helvetica",
  #   size = ggtext_size
  # ) +
  scale_colour_manual(values = c(
    lighten(desaturate("#d25952", amount = 0.75), amount = 0.5),
    "#d25952",
    lighten(desaturate("#275d95", amount = 0.75), amount = 0.5),
    "#275d95"
  )) +
  scale_x_discrete() +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_wrap(
    ~cell_type,
    ncol = 4,
    # scales = "free_y"
  )

daf_slopes_cont <- avg_pH_slopes %>%
  filter(substrate == "DAF" & treatment == "untreated" & cell_type %in% c("IF", "IF-CML", "IF-CC", "XF", "PX", "MX")) %>%
  mutate(pH = as.numeric(pH)) %>%
  group_by(genotype, replicate, pH, cell_type)

ph_cont <- ggplot(
  daf_slopes_cont,
  aes(
    x = pH,
    y = mean_estimate * 1000
  )
) +
  # geom_point(aes(colour = genotype),
  #            size = 1,
  #            alpha = 0.25,
  #            shape = 16) +
  # stat_smooth(geom = "line",
  #             aes(colour = genotype,
  #                 group = interaction(replicate, genotype)),
  #             span = 1.25,
  #             size = 0.2,
  #             alpha = 0.25,
  #             se = F) +
  geom_line(aes(
    colour = genotype,
    group = interaction(replicate, genotype)
  ),
  size = 0.2,
  alpha = 0.25
  ) +
  geom_smooth(aes(colour = genotype),
    span = 1.25,
    size = 0.5,
    alpha = 1,
    se = F
  ) +
  labs(y = "DAF oxidation rate") +
  # scale_colour_manual(values = c("#d25952", "#275d95")) +
  scale_color_manual(values = pal_dawn[c(1,7)], aesthetics = c("colour", "fill")) +
  expand_limits(y = 0) +
  theme_leo() +
  theme(
    legend.position = c(0.06, 0.9),
    legend.title = element_blank(),
    legend.direction = "horizontal",
    legend.text = element_markdown()
  ) +
  facet_wrap(
    ~cell_type,
    nrow = 1,
    # scales = "free_y"
  )

pdf("DAF_pH.pdf", width = twocol, height = onecol * 0.5)
ph_cont
dev.off()
```

#### Violins

```{r}
pH_violin_data <- nested_pH_data %>% 
  filter(substrate == "DAF" & cell_type %in% c("IF", "MX")) %>% 
  unite("ID", genotype, treatment, sep = " ", remove = FALSE) %>% 
  mutate(
  ID = ordered(ID, levels = c("WT untreated", "WT autoclaved", "<i>Q</i> untreated", "<i>Q</i> autoclaved")),
    estimate = case_when(estimate < 0 ~ 0,
                              TRUE ~ estimate)
    )

pH_violin_avg <- pH_violin_data %>% 
  group_by(genotype, treatment, ID, replicate, pH, cell_type) %>% 
  summarise(estimate = mean(estimate))

letters_tech <- pH_violin_data %>% 
  unite("ID_pH", ID, pH) %>%
  letter_groups(
    .,
    estimate,
    ID_pH,
    "tukey",
    cell_type,
    print_position = "above"
  ) %>% 
  select(-Letters)

letters <- pH_violin_avg %>%
  unite("ID_pH", ID, pH) %>%
  letter_groups(
    .,
    estimate,
    ID_pH,
    "tukey",
    cell_type,
    print_position = "above"
  ) %>% 
  select(-estimate) %>% 
  left_join(letters_tech) %>% 
  separate(ID_pH, into = c("ID", "pH"), sep = "_") %>% 
  mutate(ID = ordered(ID, levels = c("WT untreated", "WT autoclaved", "<i>Q</i> untreated", "<i>Q</i> autoclaved")))

legend_labels <- tribble(
  ~cell_type, ~ID, ~pH,
  "IF", "WT untreated", "4",
  "IF", "WT autoclaved", "4",
  "IF", "<i>Q</i> untreated", "4",
  "IF", "<i>Q</i> autoclaved", "4"
) %>% 
  left_join(letters) %>% 
  mutate(estimate = estimate + 0.0002, # 0.0002 when letters are printed
         position = estimate + 0.0004) %>% 
  mutate(ID = ordered(ID, levels = c("WT untreated", "WT autoclaved", "<i>Q</i> untreated", "<i>Q</i> autoclaved")))

DAF_violin <- ggplot(
  pH_violin_data,
  aes(
    x = pH,
    y = estimate
  )
) +
  geom_quasirandom(
    aes(colour = ID),
    dodge.width = 0.6,
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.1
  ) +
  geom_violin(
    aes(fill = ID),
    position = position_dodge(width = 0.6),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_richtext(
    data = legend_labels,
    aes(label = ID,
        group = ID,
        y = position),
    label.size = NA,
    fill = NA,
    angle = 90,
    hjust = 0,
    position = position_dodge(width = 0.6),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  geom_linerange(
    data = legend_labels,
    aes(x = pH,
        ymin = estimate,
        ymax = position,
        group = ID),
    position = position_dodge(width = 0.6),
    size = 0.2
  ) +
  geom_text(
    data = letters,
    aes(label = Letters,
        group = ID),
    position = position_dodge(width = 0.6),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "DAF oxidation rate") +
  scale_color_manual(values = c(pal_dawn[1], "#E3E6E8", pal_dawn[7], "#F3EAD8"), aesthetics = c("colour", "fill")) +
  scale_y_continuous(limits = c(0, 0.0037)) +
  theme_leo() +
  theme(
    # axis.title.x = element_blank(),
    # axis.text.x = element_markdown(angle = 45, hjust = 1, vjust = 1),
    # legend.position = "top"
  ) +
  facet_wrap(~cell_type, ncol = 2)

pdf("DAF_pH_violins.pdf", width = twocol, height = onecol * 0.4)
DAF_violin
dev.off()
```

##### Statistics

```{r}
stat_tab <- pH_violin_avg %>%
  drop_na(estimate) %>% 
  mutate(pH = paste("pH", pH)) %>% 
  unite("ID_pH", ID, pH, sep = " ") %>%
  rowwise() %>%
  mutate(ID_pH = strip_html(ID_pH)) %>%
  group_by(ID_pH, cell_type) %>%
  mutate(
    "n" = n(),
    ID_pH = paste0(ID_pH, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    estimate,
    ID_pH,
    "tukey",
    cell_type,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = "DAF oxidation rate",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S03C_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = "DAF oxidation rate",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S03C_tukey.csv"))
```

### Method supplemental

#### Select single condition

```{r}

pH_data_sample <- pH_data %>%
  filter(genotype %in% c("Q", "WT") &
    cell_type == "XF" &
    pH == 6 &
    substrate == "DAF") %>% 
  mutate(genotype = recode(genotype,
                           "Q" = "<i>Q</i>"),
         genotype = ordered(genotype, levels = c("WT", "<i>Q</i>")))

pre <- pH_data_sample %>%
  filter(time < lm_start)

mid <- pH_data_sample %>%
  filter(time %in% c(unique(lm_start):unique(lm_stop)))

post <- pH_data_sample %>%
  filter(time > lm_stop)
```

#### Plot absorbance over time

```{r}
raw_absorbance <- ggplot(
  pH_data_sample,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = interaction(treatment, genotype)
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = unique(pH_data_sample$lm_start),
    xmax = unique(pH_data_sample$lm_stop),
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(genotype, replicate, point, date, treatment)),
    alpha = 0.1,
    size = 0.1
  ) +
  geom_smooth(
    data = pre,
    aes(group = treatment),
    method = "lm",
    se = F,
    size = 0.5
  ) +
  geom_smooth(
    data = mid,
    aes(group = treatment),
    method = "lm",
    se = F,
    size = 0.5
  ) +
  geom_smooth(
    data = post,
    aes(group = treatment),
    method = "lm",
    se = F,
    size = 0.5
  ) +
  scale_colour_manual(values = c("grey70", pal_dawn[1], "grey70", pal_dawn[7])) +
  labs(
    x = "Time [min]",
    y = "Corrected & zeroed<br>DAF absorbance"
  ) +
  theme_leo() +
  theme(strip.text = element_markdown(),
        axis.title.y = element_textbox_simple(
          orientation = "left-rotated",
          halign = 0.5)) +
  coord_cartesian(xlim = c(0, 500)) +
  facet_wrap(~ genotype)

pdf("daf_6_XF_timeline.pdf", width = twocol, height = onecol * 0.5)
raw_absorbance
dev.off()
```

#### Arrange figure

```{r}
pdf("activity_supp.pdf", height = onecol * 1.6, width = twocol)
raw_absorbance + DAF_violin + ph_cont_pygl + pygl_violin +
  plot_layout(nrow = 4, heights = c(1, 1, 0.8, 1))
```


## DAB pH 5

### Load data

```{r}
lm_start <- 150
lm_stop <- 250

# Load original measurements
data_dab <- read_csv(paste0(
  datapath,
  "PhD/Laccase_activity/2020-09_activity/2020-09_lac_activity.csv"
),
comment = '"#',
col_types = "ccDcccdcddd"
) %>%
  mutate(
    time = slice * interval
  ) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  mutate(
    point = row_number(),
    replicate = as.character(replicate)
  ) %>% 
  filter(cell_type != "IF")

# Load additional measurements (repeated exps. and IF/CML measurements)
dab_files <-
  list.files(
    path = c(paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAB_pH5_IF/ROIs/Measurements/"),
             paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAB_pH5_repeats/ROIs/Measurements/"),
             "/home/leonard/Dropbox/2021_lac_manuscript/Activity/DAB_CC/Measurements/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

# reps <- read_csv(paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAF_pH5_IF/to_measure_IF.csv")) %>%
#   select(1:3) %>%
#   mutate(replicate = as.character(replicate))

dab_repeats_data <- map_dfr(dab_files, read_csv) %>%
  mutate(
    time = slice * interval,
    image = str_remove(image, fixed(".tiff"))
  ) %>%
  separate(image, into = c("date", "genotype", "replicate"), sep = "_") %>% 
  mutate(
    date = as.Date(ymd(date)),
    treatment = "none",
    pH = "5",
    substrate = "DAB"
  ) %>%
  group_by(date, genotype, cell_type, time) %>%
  mutate(point = row_number()) %>%
  select(-slice, -interval) 

#### subtract water column and background ####
data_dab <- data_dab %>%
  filter(substrate == "DAB") %>%
  bind_rows(dab_repeats_data) %>%
  anti_join(read_csv(paste0(
    datapath,
    "PhD/Laccase_activity/2020-09_activity/excluded_sections.csv"
  ),
  col_type = "ccDccc"
  )) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == lm_start]
  ) %>% 
  mutate(genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, quad_it, Q_it)),
    cell_type = recode(cell_type, 
                       "CML" = "IF-CML",
                       "CC" = "IF-CC"),
    cell_type = ordered(cell_type, levels = c(
      "IF",
      "IF-CML",
      "IF-CC",
      "XF",
      "PX",
      "MX"
    )))

nested_data_dab <- data_dab %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(data = c(time, zeroed_absorbance, median_hue)) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(estimate = estimate * 1000) %>% 
  group_by(genotype, replicate, date, treatment) %>%
  mutate(PH_slope = mean(estimate[cell_type == "PH"]))
# %>%
#   group_by(genotype, date, substrate, treatment, pH, cell_type) %>%
#   mutate(mean_estimate = mean(estimate)) %>%
#   group_by(date, substrate, treatment, pH, cell_type) %>%
#   mutate(rel_estimate = estimate / mean_estimate[genotype == "WT"])


data_dab <- data_dab %>%
  left_join(select(nested_data_dab, c(genotype:point, adj.r.squared)))

data_dab <- data_dab %>%
  filter(
    cell_type %in% c("IF", "IF-CML", "IF-CC", "XF", "MX", "PX") &
      pH == 5 &
      treatment == "none"
    # adj.r.squared > 0.85
  )

nested_data_dab <- nested_data_dab %>%
  filter(
    cell_type %in% c("IF", "IF-CML", "IF-CC", "XF", "MX", "PX") &
      pH == 5 &
      treatment == "none"
    # adj.r.squared > 0.85
  )

avg_slopes_dab <- nested_data_dab %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))
```

### Diagnostic figures

```{r}

slope_dist <- ggplot(nested_data_dab) +
  geom_density(aes(
    x = adj.r.squared,
    fill = genotype
  ),
  # binwidth = 0.01,
  # position = "identity",
  alpha = 0.25,
  size = 0.1
  ) +
  geom_vline(
    xintercept = 0.85,
    colour = "black",
    linetype = 2
  ) +
  theme_leo() +
  facet_wrap(~cell_type, ncol = 1)

bulk_activity <- avg_slopes_dab %>%
  group_by(genotype, substrate, treatment, pH, cell_type) %>%
  # summarise(mean = mean(mean_estimate)) %>%
  pivot_wider(names_from = cell_type, values_from = mean_estimate) %>%
  summarise(mean = 0.5 * IF + 0.25 * XF + 0.23 * MX + 0.02 * PX)

bulk_bars <- ggplot(bulk_activity, aes(x = genotype, y = mean)) +
  stat_summary(
    fun = mean, color = NA,
    fill = pal_ostwald_disc[2],
    alpha = 0.5,
    geom = "bar",
    aes(group = 1), size = 5,
    show.legend = FALSE
  ) +
  geom_jitter(width = 0.1) +
  labs(y = "Stem activity towards DAB") +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


activity_grid <- ggplot(
  data_dab,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = genotype,
    linetype = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  # geom_line(aes(group = interaction(genotype, replicate, point, date, treatment)),
  #   alpha = 0.1,
  #   size = 0.2
  # ) +
  geom_smooth(
    aes(group = interaction(genotype, replicate, date, treatment)),
    size = 0.2,
    se = F,
    # method = "lm",
    # fullrange = T
  ) +
  labs(
    x = "Time [min]",
    y = "Corrected & zeroed abs."
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 600)) +
  facet_wrap(~cell_type, nrow = 1)

raw_absorbance <- ggplot(
  data_dab,
  aes(
    x = time,
    y = mean_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 0.2
  ) +
  # geom_smooth(size = 0.2,
  #             se = F) +
  labs(
    x = "Time [min]",
    y = "Raw absorbance"
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 600)) +
  facet_wrap(~cell_type, nrow = 1)

plotly::ggplotly(activity_grid)
```

### Oxidation rates

```{r}
letters_tech <- letter_groups(nested_data_dab,
  estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
)

letters <- letter_groups(avg_slopes_dab,
  mean_estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
) %>%
  select(-mean_estimate) %>%
  left_join(select(letters_tech, -Letters))


dab_slopes <- ggplot(
  nested_data_dab,
  aes(
    x = genotype,
    y = estimate,
    fill = genotype
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(
  #   data = avg_slopes,
  #   aes(
  #     y = mean_estimate,
  #   ),
  #   fill = "white",
  #   shape = 21,
  #   alpha = 0.75,
  #   stroke = 0.2,
  #   size = 0.75
  # ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "DAB oxidation rate") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_markdown(angle = 45, hjust = 1, vjust = 1)
  ) +
  facet_wrap(~cell_type, ncol = 6)

pdf("DAB_pH5.pdf", width = twocol, height = onecol * 0.25)
dab_slopes
dev.off()
```

#### Statistics

```{r}
stat_tab <- avg_slopes_dab %>%
  drop_na(mean_estimate) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype, cell_type) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    mean_estimate,
    genotype,
    "tukey",
    cell_type,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = "DAB oxidation rate",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "02C_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = "DAB oxidation rate",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "02C_tukey.csv"))
```

## DAF pH 5

### Load data

```{r}
# start and stop of the time-window for linear regressions
lm_start <- 80
lm_stop <- 160

data_daf <- read_csv(paste0(
  datapath,
  "PhD/Laccase_activity/2020-09_activity/2020-09_lac_activity.csv"
),
comment = '"#',
col_types = "ccDcccdcddd"
) %>%
  mutate(
    time = slice * interval
  ) %>%
  select(-c(slice, interval)) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  mutate(
    point = row_number(),
    replicate = as.character(replicate)
  )

daf_IF_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAF_pH5_IF/ROIs/Measurements/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

daf_CC_files <- 
  list.files(
    path = "/home/leonard/Dropbox/2021_lac_manuscript/Activity/DAF_CC/ROIs/Measurements/",
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

reps <- read_csv(paste0(datapath, "PhD/Laccase_activity/2020-09_activity/DAF_pH5_IF/to_measure_IF.csv")) %>%
  select(1:3) %>%
  mutate(replicate = as.character(replicate))

daf_IF_data <- map_dfr(c(daf_IF_files, daf_CC_files), read_csv) %>%
  mutate(
    time = slice * interval,
    image = str_remove(image, fixed(".tiff"))
  ) %>%
  mutate(
    date = as.Date(ymd(
      str_extract(image, "[:digit:]{4}-[:digit:]{2}-[:digit:]{2}")
    )),
    genotype = str_remove(str_extract(image, "WT|Q-4|Q-5|Q-10|Q-12|Q-17|Q$|Q_"), "_"),
    treatment = "none",
    pH = "5",
    substrate = "DAF"
  ) %>%
  group_by(date, genotype, cell_type, time) %>%
  mutate(point = row_number()) %>%
  select(-image, -slice, -interval) %>%
  left_join(reps)

#### subtract water column and background ####
data_daf <- data_daf %>%
  filter(substrate == "DAF" & cell_type != "IF") %>%
  anti_join(read_csv(paste0(
    datapath,
    "PhD/Laccase_activity/2020-09_activity/excluded_sections.csv"
  ),
  col_type = "ccDccc"
  )) %>%
  bind_rows(daf_IF_data) %>%
  group_by(time, genotype, replicate, substrate, treatment, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == lm_start]
  ) %>% 
  mutate(genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, quad_it, Q_it)),
    cell_type = recode(cell_type, 
                       "CML" = "IF-CML",
                       "CC" = "IF-CC"),
    cell_type = ordered(cell_type, levels = c(
      "IF",
      "IF-CML",
      "IF-CC",
      "XF",
      "PX",
      "MX"
    ))
    )

nested_data_daf <- data_daf %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(data = c(time, zeroed_absorbance, median_hue)) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>% 
  mutate(estimate = estimate * 1000)
# %>%
#   group_by(genotype, date, substrate, treatment, pH, cell_type) %>%
#   mutate(mean_estimate = mean(estimate)) %>%
#   group_by(date, substrate, treatment, pH, cell_type) %>%
#   mutate(rel_estimate = estimate / mean_estimate[genotype == "WT"])


data_daf <- data_daf %>%
  left_join(select(nested_data_daf, c(genotype:point, adj.r.squared)))

data_daf <- data_daf %>% filter(
  cell_type %in% c("IF", "IF-CML", "IF-CC", "XF", "MX", "PX") &
    pH == 5 &
    treatment == "none"
  # adj.r.squared > 0.85
)
nested_data_daf <- nested_data_daf %>% filter(
  cell_type %in% c("IF", "IF-CML", "IF-CC", "XF", "MX", "PX") &
    pH == 5 &
    treatment == "none"
  # adj.r.squared > 0.85
)

avg_slopes_daf <- nested_data_daf %>%
  group_by(genotype, replicate, substrate, treatment, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))
```

### Diagnostic figures

```{r}

slope_dist <- ggplot(nested_data_daf) +
  geom_density(aes(
    x = adj.r.squared,
    fill = genotype
  ),
  # binwidth = 0.01,
  # position = "identity",
  alpha = 0.25,
  size = 0.1
  ) +
  geom_vline(
    xintercept = 0.85,
    colour = "black",
    linetype = 2
  ) +
  theme_leo() +
  facet_wrap(~cell_type, ncol = 1)




bulk_activity <- avg_slopes_daf %>%
  group_by(genotype, substrate, treatment, pH, cell_type) %>%
  # summarise(mean = mean(mean_estimate)) %>%
  pivot_wider(names_from = cell_type, values_from = mean_estimate) %>%
  summarise(mean = 0.5 * IF + 0.25 * XF + 0.23 * MX + 0.02 * PX)

bulk_bars <- ggplot(bulk_activity, aes(x = genotype, y = mean)) +
  stat_summary(
    fun = mean, color = NA,
    fill = pal_ostwald_disc[1],
    alpha = 0.5,
    geom = "bar",
    aes(group = 1), size = 5,
    show.legend = FALSE
  ) +
  geom_jitter(width = 0.1) +
  labs(y = "Stem activity towards DAF") +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


activity_grid <- ggplot(
  data_daf,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = genotype,
    linetype = treatment
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  # geom_line(aes(group = interaction(genotype, replicate, point, date, treatment)),
  #   alpha = 0.1,
  #   size = 0.2
  # ) +
  geom_smooth(
    aes(group = interaction(genotype, replicate, date, treatment)),
    size = 0.2,
    se = F,
    # method = "loess",
    # fullrange = T
  ) +
  labs(
    x = "Time [min]",
    y = "Corrected & zeroed abs."
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 400)) +
  facet_grid(~cell_type)

raw_absorbance <- ggplot(
  data_daf,
  aes(
    x = time,
    y = mean_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 0.2
  ) +
  # geom_smooth(size = 0.2,
  #             se = F) +
  labs(
    x = "Time [min]",
    y = "Raw absorbance"
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0, 400)) +
  facet_wrap(~cell_type, ncol = 5)

plotly::ggplotly(activity_grid)
```

### Oxidation rates

```{r}

letters_tech <- letter_groups(nested_data_daf,
  estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
)

letters <- letter_groups(avg_slopes_daf,
  mean_estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
) %>%
  select(-mean_estimate) %>%
  left_join(select(letters_tech, -Letters))



daf_slopes <- ggplot(
  nested_data_daf,
  aes(
    x = genotype,
    y = estimate,
    fill = genotype
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(
  #   data = avg_slopes,
  #   aes(
  #     y = mean_estimate,
  #   ),
  #   fill = "white",
  #   shape = 21,
  #   alpha = 0.75,
  #   stroke = 0.2,
  #   size = 0.75
  # ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "DAF oxidation rate") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_markdown(angle = 45, hjust = 1, vjust = 1)
  ) +
  facet_wrap(~cell_type, ncol = 6)

pdf("DAF_pH5.pdf", width = twocol, height = onecol * 0.25)
daf_slopes
dev.off()
```

#### Statistics

```{r}
stat_tab <- avg_slopes_daf %>%
  drop_na(mean_estimate) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype, cell_type) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    mean_estimate,
    genotype,
    "tukey",
    cell_type,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = "DAF oxidation rate",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "02B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = "DAF oxidation rate",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "02B_tukey.csv"))
```

## [unused] DAF pH 6

```{r, eval=FALSE}
# start and stop of the time-window for linear regressions
lm_start <- 80
lm_stop <- 160

reps <- tibble(
  date = c("2021-05-27", "2021-06-07", "2021-06-08", "2021-06-09", "2021-06-10"),
  replicate = c("6", "7", "8", "9", "10")
)

daf6_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-06_DAF_pH6/ROIs/Measurements/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

daf6_data <- map_dfr(daf6_files, read_csv) %>%
  mutate(
    time = slice * interval,
    image = str_remove(image, fixed(".tiff"))
  ) %>%
  separate(image,
    into = c("date", "substrate", "pH", "genotype"),
    sep = "_"
  ) %>%
  left_join(reps) %>%
  mutate(
    genotype = ordered(genotype, levels = c(
      "WT",
      "Q-4",
      "Q-5",
      "Q-10",
      "Q-12",
      "Q-17",
      "Q"
    )),
    cell_type = ordered(cell_type, levels = c(
      "IF",
      "CML",
      "LP",
      "XF",
      "PX",
      "MX",
      "PH",
      "BG"
    ))
  ) %>%
  group_by(genotype, replicate, substrate, pH, date, cell_type, time) %>%
  mutate(point = row_number()) %>%
  select(-slice, -interval)


#### subtract water column and background ####
daf6_data <- daf6_data %>%
  group_by(time, genotype, replicate, substrate, pH, date) %>%
  mutate(
    corrected_absorbance = mean_absorbance - mean(mean_absorbance[cell_type == "PH"])
  ) %>%
  group_by(genotype, replicate, substrate, pH, date, cell_type, point) %>%
  mutate(
    zeroed_absorbance = corrected_absorbance - corrected_absorbance[time == lm_start]
  )

nested_daf6_data <- daf6_data %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-mean_absorbance, -corrected_absorbance) %>%
  nest(data = c(time, zeroed_absorbance, median_hue)) %>%
  mutate(
    fit = map(data, ~ lm(zeroed_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time")
# %>%
#   group_by(genotype, date, substrate, treatment, pH, cell_type) %>%
#   mutate(mean_estimate = mean(estimate)) %>%
#   group_by(date, substrate, treatment, pH, cell_type) %>%
#   mutate(rel_estimate = estimate / mean_estimate[genotype == "WT"])


daf6_data <- daf6_data %>%
  left_join(select(nested_daf6_data, c(genotype:point, adj.r.squared)))

slope_dist <- ggplot(nested_daf6_data) +
  geom_density(aes(
    x = adj.r.squared,
    fill = genotype
  ),
  # binwidth = 0.01,
  # position = "identity",
  alpha = 0.25,
  size = 0.1
  ) +
  geom_vline(
    xintercept = 0.85,
    colour = "black",
    linetype = 2
  ) +
  theme_leo() +
  facet_wrap(~cell_type, ncol = 1)


daf6_data <- daf6_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX", "CML"))
nested_daf6_data <- nested_daf6_data %>% filter(cell_type %in% c("IF", "XF", "MX", "PX", "CML"))

avg_slopes <- nested_daf6_data %>%
  group_by(genotype, replicate, substrate, pH, date, cell_type) %>%
  summarise(mean_estimate = mean(estimate))

bulk_activity <- avg_slopes %>%
  group_by(genotype, substrate, pH, cell_type) %>%
  # summarise(mean = mean(mean_estimate)) %>%
  pivot_wider(names_from = cell_type, values_from = mean_estimate) %>%
  summarise(mean = 0.5 * IF + 0.25 * XF + 0.23 * MX + 0.02 * PX)

bulk_bars <- ggplot(bulk_activity, aes(x = genotype, y = mean)) +
  stat_summary(
    fun = mean, color = NA,
    fill = pal_ostwald_disc[1],
    alpha = 0.5,
    geom = "bar",
    aes(group = 1), size = 5,
    show.legend = FALSE
  ) +
  geom_jitter(width = 0.1) +
  labs(y = "Stem activity towards DAF") +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


activity_grid <- ggplot(
  daf6_data,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  # geom_line(aes(group = interaction(genotype, replicate, point, date, treatment)),
  #   alpha = 0.1,
  #   size = 0.2
  # ) +
  geom_smooth(
    aes(group = interaction(genotype, replicate, date)),
    size = 0.2,
    se = F,
    # method = "loess",
    # fullrange = T
  ) +
  labs(
    x = "Time [min]",
    y = "Corrected & zeroed abs."
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(
    xlim = c(0, 400),
    ylim = c(-0.2, 1)
  ) +
  facet_grid(~cell_type)

raw_absorbance <- ggplot(
  daf6_data,
  aes(
    x = time,
    y = mean_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  geom_line(aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 0.2
  ) +
  # geom_smooth(size = 0.2,
  #             se = F) +
  labs(
    x = "Time [min]",
    y = "Raw absorbance"
  ) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  coord_cartesian(
    xlim = c(0, 400),
    ylim = c(-0.2, 1.5)
  ) +
  facet_wrap(~cell_type, ncol = 5)


letters_tech <- letter_groups(nested_daf6_data,
  estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
)

letters <- letter_groups(avg_slopes,
  mean_estimate,
  genotype,
  "tukey",
  cell_type,
  print_position = "above",
  print_adjust = 1
) %>%
  select(-mean_estimate) %>%
  left_join(select(letters_tech, -Letters))


slopes <- ggplot(
  nested_daf6_data,
  aes(
    x = genotype,
    y = estimate,
    fill = genotype
  )
) +
  geom_quasirandom(aes(
    shape = replicate,
    group = genotype,
    fill = genotype
  ),
  colour = "black",
  # fill = "grey90",
  dodge.width = 0.5,
  alpha = 0.5,
  stroke = 0.1,
  size = 0.5
  ) +
  geom_violin(
    aes(group = genotype),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.4,
    position = position_dodge(width = 0.5),
    size = 0.2,
    scale = "width"
  ) +
  geom_point(
    data = avg_slopes,
    aes(
      y = mean_estimate,
      shape = replicate
    ),
    colour = "black",
    alpha = 0.75,
    stroke = 0.1,
    size = 1
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "DAF oxidation rate") +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank()
  ) +
  facet_wrap(~cell_type, ncol = 5)

pdf("DAF_pH6.pdf", width = twocol, height = twocol)
raw_absorbance /
  activity_grid /
  slopes
dev.off()

# pdf("DAF_pH5_diagnostics.pdf", width = onecol, height = onecol)
# slope_dist
# dev.off()

# pdf("bulk_DAF.pdf", width = 0.5 * onecol, height = 0.5 * onecol)
# bulk_bars
# dev.off()
```


## [unused] Animations

```{r, eval=FALSE}
# gganimate conflicts with showtext, so to generate the animation with the custom theme, comment out showtext, the font_add lines and the "Helvetica" lines in the setup.
lm_start <- 100
lm_stop <- 300

data_sample <- data %>%
  filter(
    # genotype == "WT" &
    date == "2020-10-01" &
      cell_type == "IF"
    # point == 1
  )

data_lm <- data %>%
  filter(
    # genotype == "WT" &
    date == "2020-10-01" &
      cell_type == "IF" &
      time >= lm_start &
      time <= lm_stop
    # point == 1
  ) %>%
  group_by(genotype) %>%
  nest() %>%
  mutate(model = data %>% map(~ lm(zeroed_absorbance ~ time, data = .))) %>%
  mutate(Pred = map2(model, data, predict)) %>%
  unnest(Pred, data)

raw_absorbance <- ggplot(
  data_sample,
  aes(
    x = time,
    y = zeroed_absorbance,
    colour = genotype
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = lm_start,
    xmax = lm_stop,
    fill = "grey95"
  ) +
  geom_line(
    aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 0.2
  ) +
  geom_point(
    aes(group = interaction(genotype, replicate, point, date)),
    alpha = 0.1,
    size = 1
  ) +
  geom_line(
    data = data_lm,
    aes(y = Pred),
    size = 0.5,
    linetype = 2,
    se = F,
    method = "lm",
    fullrange = T
  ) +
  labs(
    x = "Time [min]",
    y = "Corrected absorbance"
  ) +
  # theme_leo() +
  # theme(legend.position = "bottom") +
  # coord_cartesian(xlim = c(0, 400),
  #                 ylim = c(0,2)) +
  # facet_wrap(~cell_type, ncol = 5) +
  transition_reveal(time)


animate(raw_absorbance,
  # renderer = magick_renderer(),
  # device = "tiff",
  height = 2,
  width = 2,
  units = "in",
  res = 300
)

anim_save("Full_IF_1_animation.gif")
```

## [unused] Single plots

```{r, eval=FALSE}
single_violin_data <- nested_data_dab %>%
  full_join(nested_data_daf) %>%
  mutate(genotype = recode(genotype,
    "Q-4" = "<i>Q-4</i>",
    "Q-5" = "<i>Q-5</i>",
    "Q-10" = "<i>Q-10</i>",
    "Q-12" = "<i>Q-12</i>",
    "Q-17" = "<i>Q-17</i>",
    "Q" = "<i>Q</i>"
  ))

single_violin_avg <- single_violin_data

act_violin <- function(subst, ct) {
  letters <- letter_groups(single_violin_data %>%
    filter(substrate == subst & cell_type == ct),
  estimate,
  genotype,
  "tukey",
  print_position = "below",
  print_adjust = 0.75
  )

  ggplot(
    data = single_violin_data %>%
      filter(substrate == subst & cell_type == ct),
    aes(x = genotype, y = estimate)
  ) +
    geom_quasirandom(
      aes(fill = genotype),
      dodge.width = 0.6,
      shape = 21,
      alpha = 0.75,
      size = 1,
      stroke = 0.2
    ) +
    geom_violin(aes(
      group = genotype
    ),
    draw_quantiles = 0.5,
    fill = "white",
    colour = "black",
    alpha = 0.85,
    width = 0.2,
    position = position_dodge(width = 0.6),
    size = 0.2,
    scale = "width"
    ) +
    geom_text(
      data = letters,
      aes(label = Letters),
      size = ggtext_size,
      family = "Helvetica",
      position = position_dodge(width = 0.6)
    ) +
    labs(
      y = paste(subst, "oxidation rate"),
      title = ct
    ) +
    scale_y_continuous(expand = expansion(mult = 0.1)) +
    # scale_x_discrete(labels = c("PX", "PMX", "SMX")) +
    # scale_fill_manual(values = pal_flame_disc) +
    # expand_limits(y = 0) +
    theme_leo() +
    theme(
      text = element_text(family = "Helvetica"),
      axis.title.x = element_blank(),
      axis.title.y = element_markdown(),
      axis.text.y = element_blank(),
      axis.text.x = element_markdown(),
      axis.ticks.y = element_blank()
    )
}

pdf("DAF_IF_pH5.pdf", width = onecol * 0.5, height = onecol * 0.25)
act_violin("DAF", "IF")
dev.off()

pdf("DAB_IF_pH5.pdf", width = onecol * 0.5, height = onecol * 0.25)
act_violin("DAB", "IF")
dev.off()
```

## Assemble figure

```{r}
layout <- "
ABBBBBB
ACCCCCC
"
pdf("Blaschek2022_figure2.pdf", width = twocol, height = onecol * 1.2)
ph_cont + daf_slopes + dab_slopes + 
  plot_layout(nrow = 3) &
  plot_annotation(
    tag_levels = "A"
  ) &
  theme(plot.tag = element_text(size = 10, face = "bold", family = "Helvetica"))
dev.off()
```

# Wiesner

## Point measurements

### Load data

```{r, message=FALSE}
Wiesner_files <-
  list.files(
    path = c(paste0(datapath, "PhD/Wiesner/2021-05_Wiesner/Stitched/Measurements/"),
             paste0(datapath, "PhD/Wiesner/2021-05_Wiesner/2021-09-03_wonky-images/Measurements/"),
             "/home/leonard/Dropbox/2021_lac_manuscript/Wiesner/CC_points/Measurements/"),
    pattern = "*.csv",
    recursive = TRUE,
    full.names = TRUE
  )

Wiesner_data <- map_dfr(Wiesner_files, read_csv) %>%
  separate(image, into = c("date", "genotype", "replicate", "first_image"), sep = "_") %>%
  mutate(date = str_replace(date, "^021", "2021")) %>%
  mutate(
    cell_type = recode(cell_type,
                       "CC" = "IF-CC"),
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "IF-CML",
        "IF-CC",
        "LP",
        "XF",
        "XF-CML",
        "PX",
        "MX",
        "PH",
        "BG"
      )
    ),
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  ) %>%
  filter(cell_type %in% c("IF", "IF-CML", "IF-CC", "XF", "PX", "MX", "PH", "BG"))

if (any(Wiesner_data$first_image != "unstained")) warning("Stained and unstained values might be inverted in some images.")

Wiesner_data <- Wiesner_data %>%
  mutate(absorbance = stained_absorbance - unstained_absorbance) %>%
  group_by(date, genotype, replicate) %>%
  mutate(
    tissue_clearing = mean(absorbance[cell_type == "PH"]),
    corrected_absorbance = absorbance - tissue_clearing
  ) %>%
  filter(!(cell_type %in% c("PH", "BG")))

Wiesner_avg <- Wiesner_data %>%
  group_by(genotype, replicate, cell_type, instance) %>%
  summarise(corrected_absorbance = mean(corrected_absorbance))

Wiesner_n <- Wiesner_data %>%
  group_by(genotype) %>%
  summarise(replicates = paste0(unique(replicate), collapse = ","))
```

### [unused] Instance differences

```{r}
relative_Wiesner <- Wiesner_avg %>% 
  group_by(genotype, cell_type, instance) %>% 
  summarise(mean_absorbance = mean(corrected_absorbance)) %>% 
  group_by(cell_type, instance) %>% 
  mutate(WT_change = mean_absorbance / mean_absorbance[genotype == "WT"])

ggplot(relative_Wiesner,
       aes(x = genotype,
           y = mean_absorbance,
           fill = instance)) +
  geom_col(position = "dodge") +
  facet_wrap(~ cell_type)
```


### Plot Wiesner violins

```{r}
letter_pos <- letter_groups(Wiesner_data,
  corrected_absorbance,
  genotype,
  "tukey",
  cell_type,
  print_position = "below",
  print_adjust = 0.5,
) %>%
  select(-Letters)

letters <- letter_groups(Wiesner_avg,
  corrected_absorbance,
  genotype,
  "tukey",
  cell_type,
  print_position = "below"
) %>%
  select(-corrected_absorbance) %>%
  left_join(letter_pos)

Wiesner_plot <- ggplot(
  Wiesner_data,
  aes(
    x = genotype,
    y = corrected_absorbance
  ) 
) +
  # geom_violin(
  #   aes(fill = genotype),
  #   draw_quantiles = 0.5,
  #   # fill = "white",
  #   colour = "black",
  #   alpha = 1,
  #   width = 0.75,
  #   size = 0.2,
  #   adjust = 1
  #   # scale = "width"
  # ) +
  # geom_quasirandom(
  #   shape = 21,
  #   alpha = 1,
  #   size = 0.75,
  #   width = 0.25,
  #   stroke = 0.2,
  #   fill = "white",
  # ) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Relative <b>G</b><sub>CHO</sub>") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown(angle = 45, hjust = 1, vjust = 1),
    panel.spacing = unit(0.5, "mm")
  ) +
  facet_wrap(~cell_type, nrow = 1)

pdf("lac_Wiesner.pdf", width = twocol * 1.05, height = onecol * 0.3)
Wiesner_plot
dev.off()
```

#### Statistics

```{r}
stat_tab <- Wiesner_avg %>%
  drop_na(corrected_absorbance) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype, cell_type) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    corrected_absorbance,
    genotype,
    "tukey",
    cell_type,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = "Wiesner stain absorbance",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "03B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = "Wiesner stain absorbance",
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "03B_tukey.csv"))
```

## [unused] IF profiles

### [unused] Pilot

#### [unused] Load data

```{r, eval=FALSE}
profile_files <-
  list.files(
    path = "/home/leonard/Dropbox/2021-05_Wiesner_profiles/",
    pattern = "*.csv",
    recursive = F,
    full.names = TRUE
  )

read_profiles <- function(x) {
  read_csv(x) %>%
    mutate(filename = basename(x))
}

profile_data <- map_dfr(profile_files, read_profiles) %>%
  group_by(filename) %>%
  mutate(pixel = row_number()) %>%
  pivot_longer(contains("ROI"), names_to = "profile", values_to = "absorbance") %>%
  mutate(
    profile = as.numeric(str_extract(profile, "[:digit:]+")) + 1,
    absorbance = case_when(
      absorbance == 0 ~ NA_real_,
      TRUE ~ absorbance / 255
    )
  ) %>%
  drop_na() %>%
  group_by(filename, profile) %>%
  mutate(pixel = pixel / max(pixel)) %>%
  separate(filename, into = c("date", "genotype", "replicate"), sep = "_", extra = "drop") %>%
  mutate(genotype = ordered(genotype, levels = c(
    "WT",
    "Q-4",
    "Q-5",
    "Q-10",
    "Q-12",
    "Q-17",
    "Q"
  ))) %>%
  mutate(genotype = recode(genotype,
    "Q-4" = "<i>Q-4</i>",
    "Q-5" = "<i>Q-5</i>",
    "Q-10" = "<i>Q-10</i>",
    "Q-12" = "<i>Q-12</i>",
    "Q-17" = "<i>Q-17</i>",
    "Q" = "<i>Q</i>"
  ))
```

#### [unused] Plot profiles

```{r, eval=FALSE}
rect_data <- profile_data %>%
  group_by(genotype) %>%
  summarise(genotype = unique(genotype))

profiles <- ggplot(
  profile_data,
  aes(
    x = pixel,
    y = absorbance
  )
) +
  geom_rect(
    data = rect_data,
    aes(fill = genotype, x = 0, y = 0, ),
    xmin = -Inf,
    xmax = Inf,
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.5
  ) +
  geom_line(aes(group = interaction(genotype, profile)),
    alpha = 0.25,
    size = 0.1
  ) +
  geom_smooth(se = F, size = 0.2, colour = "black") +
  scale_fill_viridis_d() +
  scale_y_continuous(breaks = c(0, 0.2, 0.4)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_markdown(hjust = 0.5),
    panel.spacing = unit(0.75, "mm")
  ) +
  facet_wrap(~genotype, nrow = 1)

pdf("Wiesner_profiles.pdf", width = onecol, height = onecol * 0.15)
profiles
dev.off()
```

### [unused] Cell corner profiles

#### [unused] Load data 

```{r, eval=FALSE}

Wiesner_clearing <- Wiesner_data %>% 
  select(genotype, replicate, tissue_clearing) %>% 
  distinct()

CC_Wiesner_files <-
  list.files(
    path = "/home/leonard/Dropbox/2021_lac_manuscript/Heatmaps/",
    pattern = "*.csv",
    recursive = FALSE,
    full.names = TRUE
  )

read_CC <- function(flnm) {
  read_csv(flnm, show_col_types = FALSE) %>%
    mutate(file = basename(flnm)) %>%
    separate(file, into = c("date", "genotype", "replicate", "notes"), sep = "_", extra = "merge") %>%
    select(-notes) %>% 
    pivot_longer(-c("date", "genotype", "replicate"), names_to = "ROI", values_to = "value") %>%
    mutate(ROI = str_remove(ROI, "Roi_"),
           value = value / 255)
}

CC_Wiesner <- map_dfr(CC_Wiesner_files, read_CC) %>%
  mutate(genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    )) %>% 
  group_by(date, genotype, replicate, ROI) %>%
  mutate(
    pixel = row_number(),
    distance = pixel / 8.81, # distance in µm based on the Axiovert 40x scale
    CC = median(distance),
    position = distance - CC,
    scaled = (value - min(value)) / (max(value) - min(value)),
    layer = case_when(position < -3 & position > -5 ~ "CML",
                      # position > 2 & position < 3 ~ "SCW",
                      position > -1 & position < 1 ~ "CC"),
    layer = ordered(layer, levels = c("CML", "CC"))
  )

CC_Wiesner_line <- CC_Wiesner %>% 
  group_by(genotype, replicate, ROI, layer) %>% 
  summarise(value = mean(value)) %>% 
  left_join(Wiesner_clearing) %>% 
  mutate(value_corrected = value - tissue_clearing)

CC_Wiesner_avg <- CC_Wiesner %>% 
  drop_na() %>% 
  group_by(genotype, replicate, layer) %>% 
  summarise(value = mean(value))
```

#### [unused] Intensity violins

```{r, eval=FALSE}

letters <- letter_groups(CC_Wiesner_avg,
                         value,
                         genotype,
                         "tukey",
                         layer)

ggplot(CC_Wiesner_line %>% drop_na(), 
       aes(x = genotype,
           y = value)) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(data = CC_Wiesner_avg,
  #            shape = 21,
  #            fill = "white",
  #            stroke = 0.2,
  #            size = 2,
  #            alpha = 1) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Wiesner absorbance") +
  scale_fill_manual(values = pal_dawn) +
  # scale_y_continuous(breaks = c(0.5, 0.75, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(valign = 0.5,
                                              halign = 0.5,
                                              orientation = "left-rotated"),
    # axis.title.y = element_textbox_simple(
    #   orientation = "left-rotated",
    #   halign = 0.5,
    #   width = unit(25, "mm")
    # ),
    axis.text.x = element_markdown(),
    # strip.placement = "outside",
    strip.text = element_text(hjust = 0.5)
  ) +
  facet_wrap(~ layer)
```

#### [unused] Plot profiles

```{r, eval=FALSE}
CC_profiles_full <- ggplot(CC_Wiesner,
       aes(x = position,
           y = value,
           colour = genotype)) +
  annotate("rect",
           ymin = -Inf,
           ymax = Inf,
           xmin = c(-5, -1, 2),
           xmax = c(-3, 1, 3),
           fill = "grey95") +
  geom_line(aes(group = interaction(genotype, replicate, ROI)),
                size = 0.2,
                alpha = 0.2) +
  geom_smooth(method = "loess",
              span = 0.2,
              se = FALSE) +
  labs(y = "Wiesner absorbance",
       x = "Cell wall layer") +
  # scale_x_continuous(breaks = c(-35, 0, 20),
  #                    labels = c("CML", "CC", "SCW"),
  #                    limits = c(-44, 25)) +
  scale_colour_manual(values = pal_dawn) +
  theme_leo() +
  theme(legend.position = "none",
        legend.text = element_markdown(),
        strip.text = element_markdown(hjust = 0.5),
        # legend.title = element_blank(),
        axis.title.y = element_textbox_simple(valign = 0.5,
                                              halign = 0.5,
                                              orientation = "left-rotated"),
        axis.title.x = element_blank(),
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank()
  ) +
  facet_wrap(~ genotype, ncol = 2)

pdf("Wiesner_profiles.pdf", width = onecol, height = onecol)
CC_profiles_full
dev.off()
```

# Mäule 

## Load data

```{r}
maule_data <- read_csv("/home/leonard/Dropbox/2021_lac_manuscript/Mäule/maule_hue.csv") %>%
  mutate(
    hue = hue255 / 255 * 360,
    hue = case_when(
      hue < 100 ~ hue + 360,
      TRUE ~ hue
    ),
    cell_type = recode(cell_type,
                       "CML" = "IF-CML",
                       "CC" = "IF-CC"),
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "IF-CML",
        "IF-CC",
        "XF",
        "PX",
        "MX"
      )
    ),
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    )
  )
```

## Mäule violins

```{r}

hue_palette1 <- scales::hue_pal(h = c(330, 360), c = 150, l = 45, direction = 1)
hue_palette2 <- scales::hue_pal(h = c(10, 50), c = 150, l = 45, direction = 1)
hue_palette <- c(hue_palette1(n = 4), hue_palette2(n = 5))
scales::show_col(hue_palette)

bar_data <- tibble(
  colour = as.character(c(1:9)),
  hue = seq(from = 330, to = 410, by = 10)
) %>%
  mutate(
    cell_type = ordered("MX",
      levels = c(
        "IF",
        "IF-CML",
        "IF-CC",
        "XF",
        "PX",
        "MX"
      )
    ),
    genotype = "<i>Q</i>"
  )

maule_plot <- ggplot(
  maule_data,
  aes(
    x = genotype,
    y = hue
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  scale_fill_manual(values = pal_dawn) +
  ggnewscale::new_scale("fill") +
  geom_tile(
    data = bar_data,
    aes(fill = colour,
        height = 10.2, 
        y = hue),
    position = position_nudge(y = 0, x = 1.25)
  ) +
  geom_text(data = bar_data %>% filter(colour == 9),
            position = position_nudge(y = 5, x = 2.1),
            label = "Visual hue scale",
            angle = -90,
            hjust = 0,
            family = "Helvetica",
            size = ggtext_size) +
  scale_fill_manual(values = hue_palette) +
  scale_y_continuous(limits = c(324, 416), 
                     expand = expansion(add = 0),
                     breaks = c(340, 360, 380, 400),
                     labels = c("340", "360", "20", "40")) +
  coord_cartesian(clip = "off",
                  xlim = c(1,7)) +
  labs(y = "Mäule stain hue [°]") +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown(angle = 45, hjust = 1, vjust = 1),
    panel.spacing = unit(0.5, "mm"),
    plot.margin = unit(c(1, 7, 1, 1), "mm") 
  ) +
  facet_wrap(~cell_type, nrow = 1)

pdf("maule_plot.pdf", width = twocol, height = onecol * 0.4)
maule_plot
dev.off()
```





# Raman microspectroscopy

## Load spectra

### Laccase

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
rmn_files <-
  list.files(
    path = paste0(datapath, "PhD/Raman/2020-11_lac_mutants"),
    pattern = "*.txt",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = c("wavenumber", "intensity"),
    col_types = "cc",
    # locale = locale(decimal_mark = ",")
  ) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("date", "genotype", "replicate", "cell_type", "TE"), sep = "_") %>%
    select(-date) %>%
    mutate(
      wavenumber = as.numeric(str_replace(wavenumber, fixed(","), fixed("."))),
      intensity = as.numeric(str_replace(intensity, fixed(","), fixed("."))),
      TE = str_remove(TE, fixed(".txt")),
    ) %>%
    filter(wavenumber > 300 &
      cell_type != "IFML") %>%
    pivot_wider(
      id_cols = c(genotype, replicate, cell_type, TE),
      names_from = wavenumber,
      values_from = intensity
    ) %>%
    group_by(genotype, replicate, cell_type, TE) %>%
    nest()
}

rmn_lac <- map_dfr(rmn_files, read_plus)

#### baseline correction ####
rmn_als <- function(x) {
  corrected_spectra <- baseline.als(as.matrix(x),
    lambda = 5,
    p = 0.01,
    maxit = 100
  )
  as_tibble(corrected_spectra$corrected, rownames = NA)
}

rmn_lac_corrected <- rmn_lac %>%
  mutate(corrected_data = map(data, rmn_als)) %>%
  select(-data) %>%
  unnest() %>%
  pivot_longer(-c(genotype, cell_type, replicate, TE),
    names_to = "wavenumber",
    values_to = "corrected.intensity"
  ) %>%
  drop_na() %>%
  mutate(wavenumber = as.numeric(wavenumber))

#### filtering and scaling ####

# alignment
lig_peak <- rmn_lac_corrected %>%
  unite("ID",
    genotype, cell_type, replicate, TE,
    remove = F,
    sep = "_"
  ) %>%
  filter(round(wavenumber, digits = 0) %in% c(370:390)) %>%
  group_by(genotype, replicate, cell_type, TE) %>%
  mutate(
    peak_pos = wavenumber[which.max(corrected.intensity)]
  ) %>%
  select(-wavenumber, -corrected.intensity) %>%
  unique() %>%
  group_by(cell_type) %>%
  mutate(peak_pos_ref = peak_pos[genotype == "WT" & replicate == 5 & TE == 1])

rmn_lac_aligned <- rmn_lac_corrected %>%
  left_join(lig_peak) %>%
  group_by(genotype, replicate, cell_type, TE, wavenumber) %>%
  mutate(wavenumber = wavenumber + (peak_pos_ref - peak_pos))

# scaling and filtering
rmn_lac_scaled <- rmn_lac_aligned %>%
  group_by(genotype, cell_type, replicate, TE) %>%
  mutate(
    AUC = MESS::auc(wavenumber, corrected.intensity),
    scaled = corrected.intensity / AUC,
    scaled_lig = corrected.intensity / (
      (corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) + corrected.intensity[abs(wavenumber - 1330) == min(abs(wavenumber - 1330))][1]
    ),
    scaled_cellu = corrected.intensity /
      corrected.intensity[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1]
  )

rmn_lac_avg <- rmn_lac_scaled %>%
  mutate(wavenumber = round(wavenumber, digits = 1)) %>%
  group_by(genotype, cell_type) %>%
  arrange(genotype, cell_type, wavenumber) %>%
  summarise(
    roll_mean = slider::slide_index_dbl(scaled, wavenumber, mean, .before = 1.5, .after = 1.5),
    roll_sd = slider::slide_index_dbl(scaled, wavenumber, sd, .before = 2, .after = 2),
    roll_scaled_cellu = slider::slide_index_dbl(scaled_cellu, wavenumber, mean, .before = 1.5, .after = 1.5),
    wavenumber = wavenumber
  )

rmn_lac_sum <- rmn_lac_scaled %>%
  group_by(genotype, cell_type, replicate, TE) %>%
  summarise(
    "unscaled_lignin" =
      (corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) +
        corrected.intensity[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "broad_lignin" =
      corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] +
        corrected.intensity[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1] +
        corrected.intensity[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1] +
        corrected.intensity[abs(wavenumber - 1624) == min(abs(wavenumber - 1624))][1],
    "total_lignin" = (scaled[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) +
      scaled[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "P_rel" = scaled_lig[abs(wavenumber - 993) == min(abs(wavenumber - 993))][1],
    "G_rel" = scaled_lig[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "G_tot" = scaled[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "GOH_rel" = scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1],
    "GCHO_rel" = scaled_lig[abs(wavenumber - 1624) == min(abs(wavenumber - 1624))][1],
    "GCHO_tot" = scaled[abs(wavenumber - 1624) == min(abs(wavenumber - 1624))][1],
    "S_rel" = scaled_lig[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "S_tot" = scaled[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "cellulose" =
      # scaled[abs(wavenumber - 1095) == min(abs(wavenumber - 1095))][1] +
        scaled[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1],
        # scaled[abs(wavenumber - 1120) == min(abs(wavenumber - 1120))][1],
    "cellu_cryst" = scaled[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1] /
      scaled[abs(wavenumber - 1095) == min(abs(wavenumber - 1095))][1],
    "lig.cellu" = total_lignin / cellulose,
    "S.G" = scaled_lig[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1] /
      scaled_lig[abs(wavenumber - 1273) == min(abs(wavenumber - 1273))][1],
    "GOH.G" = scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1] /
      scaled_lig[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "GCHO.GOH" = scaled_lig[abs(wavenumber - 1624) == min(abs(wavenumber - 1624))][1] /
      scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1],
    "O4_van_rel" = scaled_lig[abs(wavenumber - 1303) == min(abs(wavenumber - 1303))][1],
    "other_van_rel" = scaled_lig[abs(wavenumber - 785) == min(abs(wavenumber - 785))][1],
    "O4_syr_rel" = scaled_lig[abs(wavenumber - 1297) == min(abs(wavenumber - 1297))][1],
    "other_syr_rel" = scaled_lig[abs(wavenumber - 450) == min(abs(wavenumber - 450))][1],
    "Benz_rel" = O4_van_rel + other_van_rel + O4_syr_rel + other_syr_rel,
    "AUC" = mean(AUC)
  )

```

### Phenylpropanoid references

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
rmn_files <-
  list.files(
    path = "/home/leonard/Dropbox/2021_lac_manuscript/Raman_refs/",
    pattern = "*.txt",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = c("wavenumber", "intensity"),
    col_types = "cc",
    # locale = locale(decimal_mark = ",")
  ) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("genotype", "cell_type"), sep = "-") %>%
    mutate(
      wavenumber = as.numeric(str_replace(wavenumber, fixed(","), fixed("."))),
      intensity = as.numeric(str_replace(intensity, fixed(","), fixed("."))),
      replicate = str_extract(cell_type, "[:digit:]"),
      cell_type = str_remove(cell_type, "[:digit:]\\.txt"),
    ) %>%
    filter(wavenumber > 300) %>%
    pivot_wider(
      id_cols = c(genotype, replicate, cell_type),
      names_from = wavenumber,
      values_from = intensity
    ) %>%
    group_by(genotype, replicate, cell_type) %>%
    nest()
}

rmn_ref <- map_dfr(rmn_files, read_plus)

#### baseline correction ####
rmn_als <- function(x) {
  corrected_spectra <- baseline.als(as.matrix(x),
    lambda = 5,
    p = 0.01,
    maxit = 100
  )
  as_tibble(corrected_spectra$corrected, rownames = NA)
}

rmn_ref_corrected <- rmn_ref %>%
  mutate(corrected_data = map(data, rmn_als)) %>%
  select(-data) %>%
  unnest() %>%
  pivot_longer(-c(genotype, cell_type, replicate),
    names_to = "wavenumber",
    values_to = "corrected.intensity"
  ) %>%
  drop_na() %>%
  mutate(wavenumber = as.numeric(wavenumber))

#### filtering and scaling ####

# alignment
lig_peak <- rmn_ref_corrected %>%
  unite("ID",
    genotype, cell_type, replicate,
    remove = F,
    sep = "_"
  ) %>%
  filter(round(wavenumber, digits = 0) %in% c(370:390)) %>%
  group_by(genotype, replicate, cell_type) %>%
  mutate(
    peak_pos = wavenumber[which.max(corrected.intensity)]
  ) %>%
  select(-wavenumber, -corrected.intensity) %>%
  unique() %>%
  group_by(cell_type) %>%
  mutate(peak_pos_ref = 378.561) # align to the LAC data

rmn_ref_aligned <- rmn_ref_corrected %>%
  left_join(lig_peak) %>%
  group_by(genotype, replicate, cell_type, wavenumber) %>%
  mutate(wavenumber = wavenumber + (peak_pos_ref - peak_pos))

# scaling and filtering
rmn_ref_scaled <- rmn_ref_aligned %>%
  group_by(genotype, cell_type, replicate) %>%
  mutate(
    AUC = MESS::auc(wavenumber, corrected.intensity),
    scaled = corrected.intensity / AUC,
    scaled_lig = corrected.intensity / (
      (corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) + corrected.intensity[abs(wavenumber - 1330) == min(abs(wavenumber - 1330))][1]
    ),
    scaled_cellu = corrected.intensity /
      corrected.intensity[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1]
  )

rmn_ref_avg <- rmn_ref_scaled %>%
  mutate(wavenumber = round(wavenumber, digits = 1)) %>%
  group_by(genotype, cell_type) %>%
  arrange(genotype, cell_type, wavenumber) %>%
  summarise(
    roll_mean = slider::slide_index_dbl(scaled, wavenumber, mean, .before = 1.5, .after = 1.5),
    roll_sd = slider::slide_index_dbl(scaled, wavenumber, sd, .before = 2, .after = 2),
    roll_scaled_cellu = slider::slide_index_dbl(scaled_cellu, wavenumber, mean, .before = 1.5, .after = 1.5),
    wavenumber = wavenumber
  )

rmn_ref_sum <- rmn_ref_scaled %>%
  group_by(genotype, cell_type, replicate) %>%
  summarise(
    "unscaled_lignin" =
      (corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) +
        corrected.intensity[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "broad_lignin" =
      corrected.intensity[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] +
        corrected.intensity[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1] +
        corrected.intensity[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1] +
        corrected.intensity[abs(wavenumber - 1624) == min(abs(wavenumber - 1624))][1],
    "total_lignin" = (scaled[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1] / 2) +
      scaled[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "P_rel" = scaled_lig[abs(wavenumber - 993) == min(abs(wavenumber - 993))][1],
    "G_rel" = scaled_lig[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "G_tot" = scaled[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "GOH_rel" = scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1],
    "GCHO_rel" = scaled_lig[abs(wavenumber - 1624) == min(abs(wavenumber - 1624))][1],
    "GCHO_tot" = scaled[abs(wavenumber - 1624) == min(abs(wavenumber - 1624))][1],
    "S_rel" = scaled_lig[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "S_tot" = scaled[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1],
    "cellulose" =
      # scaled[abs(wavenumber - 1095) == min(abs(wavenumber - 1095))][1] +
        scaled[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1],
        # scaled[abs(wavenumber - 1120) == min(abs(wavenumber - 1120))][1],
    "cellu_cryst" = scaled[abs(wavenumber - 378) == min(abs(wavenumber - 378))][1] /
      scaled[abs(wavenumber - 1095) == min(abs(wavenumber - 1095))][1],
    "lig.cellu" = total_lignin / cellulose,
    "S.G" = scaled_lig[abs(wavenumber - 1334) == min(abs(wavenumber - 1334))][1] /
      scaled_lig[abs(wavenumber - 1273) == min(abs(wavenumber - 1273))][1],
    "GOH.G" = scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1] /
      scaled_lig[abs(wavenumber - 1600) == min(abs(wavenumber - 1600))][1],
    "GCHO.GOH" = scaled_lig[abs(wavenumber - 1624) == min(abs(wavenumber - 1624))][1] /
      scaled_lig[abs(wavenumber - 1658) == min(abs(wavenumber - 1658))][1],
    "O4_van_rel" = scaled_lig[abs(wavenumber - 1303) == min(abs(wavenumber - 1303))][1],
    "other_van_rel" = scaled_lig[abs(wavenumber - 785) == min(abs(wavenumber - 785))][1],
    "O4_syr_rel" = scaled_lig[abs(wavenumber - 1297) == min(abs(wavenumber - 1297))][1],
    "other_syr_rel" = scaled_lig[abs(wavenumber - 450) == min(abs(wavenumber - 450))][1],
    "Benz_rel" = O4_van_rel + other_van_rel + O4_syr_rel + other_syr_rel,
    "AUC" = mean(AUC)
  )
```

## Plot spectra

### Laccase

```{r}

partial_spec <- function(min_wn, max_wn) {
  data <- rmn_lac_scaled %>%
    filter(
      wavenumber >= min_wn & wavenumber <= max_wn &
        cell_type == "IF" &
        genotype %in% c("WT", "Q")
    ) %>%
    mutate(genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ))

  ggplot(
    data,
    aes(
      x = wavenumber,
      y = scaled_cellu,
      colour = genotype
    )
  ) +
    geom_vline(
      xintercept = c(378, 1273, 1334, 1600, 1624, 1658),
      linetype = 2,
      size = 0.2
    ) +
    geom_line(aes(group = interaction(replicate, genotype, TE)),
      alpha = 0.5,
      size = 0.2
    ) +
    # geom_smooth(se = F,
    #             linetype = 1,
    #             size = 0.2) +
    labs(
      y = "Normalised intensity",
      x = "Wavenumber [cm<sup>-1</sup>]"
    ) +
    scale_colour_manual(values = pal_dawn[c(1, 7)]) +
    guides(color = guide_legend(override.aes = list(
      alpha = 1,
      size = 0.4
    ))) +
    scale_y_continuous(limits = c(-0.1, 8)) +
    scale_x_reverse(expand = expansion(mult = 0.01)) +
    theme_leo() +
    theme(
      axis.title.x = element_textbox_simple(halign = 0.5),
      plot.margin = unit(c(1, 1, 1, 6), "mm"),
      legend.position = c(0.9675, 0.9),
      legend.text = element_markdown()
    )
}

full <- partial_spec(300, 1700)

pdf("spectra.pdf", width = twocol, height = onecol * 0.3)
full
dev.off()

```

### Phenylpropanoid references

```{r}

partial_spec <- function(min_wn, max_wn) {
  data <- rmn_ref_scaled %>%
    filter(
      wavenumber >= min_wn & wavenumber <= max_wn &
        cell_type == "IF"
    )

  ggplot(
    data,
    aes(
      x = wavenumber,
      y = scaled_cellu,
      colour = genotype
    )
  ) +
    geom_vline(
      xintercept = c(378, 1273, 1334, 1600, 1624, 1658),
      linetype = 2,
      size = 0.2
    ) +
    geom_line(aes(group = interaction(genotype)),
      alpha = 0.5,
      size = 0.2
    ) +
    # geom_smooth(se = F,
    #             linetype = 1,
    #             size = 0.2) +
    labs(
      y = "Normalised intensity",
      x = "Wavenumber [cm<sup>-1</sup>]"
    ) +
    scale_x_reverse(expand = expansion(mult = 0.01)) +
    theme_leo() +
    theme(
      axis.title.x = element_textbox_simple(halign = 0.5),
      plot.margin = unit(c(1, 1, 1, 6), "mm"),
      legend.position = "right",
      legend.text = element_markdown()
    )
}

full <- partial_spec(300, 1700)

pdf("spectra_ref.pdf", width = twocol, height = onecol * 0.3)
full
dev.off()

```

## Lignin composition

### Main figure

#### Format dataframes

```{r}
violin_data <- rmn_lac_sum %>%
  select(
    # "Total lignin" = total_lignin,
    "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>" = lig.cellu,
    "<sup>**S**</sup>&frasl;<sub>**G**</sub>" = S.G,
    # "S" = S_rel,
    # "G" = G_rel,
    # "P-units" = P_rel,
    # AUC,
    # "Cellulose cryst." = cellu_cryst,
    # "Benzaldehydes" = Benz_rel,
    # "G-CHOH" = GOH_rel,
    # "G-CHO" = GCHO_rel,
    "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>" = GCHO.GOH
  ) %>%
  filter(cell_type != "LP") %>%
  pivot_longer(
    cols = -c(genotype:replicate),
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    variable = ordered(
      variable,
      levels = c(
        "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>",
        "<sup>**S**</sup>&frasl;<sub>**G**</sub>",
        "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>"
      )),
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "LP",
        "XF",
        "PX",
        "MX"
      )
    ),
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  )

ref_labels <- tribble(
  ~genotype, ~cell_type, ~variable, ~label,
  "fah1", "PMX", "<sup>**S**</sup>&frasl;<sub>**G**</sub>", "<i>fah1</i> MX (traces of <b>S</b>)",
  "ccr1_3", "IF", "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>", "<i>ccr1-3</i> IF (traces of lignin)",
  "cad4x5", "IF", "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>", "<i>cad4;5</i> IF (overaccumulates <b>G</b><sub>CHO</sub>)"
)

ref_data <- rmn_ref_sum %>%
  select(
    genotype,
    cell_type,
    replicate,
    "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>" = lig.cellu,
    "<sup>**S**</sup>&frasl;<sub>**G**</sub>" = S.G,
    "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>" = GCHO.GOH
  ) %>%
  pivot_longer(
    cols = -c(genotype:replicate),
    names_to = "variable",
    values_to = "value"
  ) %>%
  right_join(ref_labels) %>%
  ungroup() %>%
  mutate(
    variable = ordered(
      variable,
      levels = c(
        "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>",
        "<sup>**S**</sup>&frasl;<sub>**G**</sub>",
        "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>"
      )
    ),
    cell_type = c("IF", "MX", "IF"),
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "LP",
        "XF",
        "PX",
        "MX"
      )
    )
  )

violin_data_avg <- violin_data %>%
  group_by(genotype, cell_type, replicate, variable, instance) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))
```

#### Plot figure

```{r}
letters <- letter_groups(violin_data,
  value,
  genotype,
  "tukey",
  variable,
  cell_type,
  print_position = "above",
  print_adjust = 1.5
) %>%
  mutate(value = case_when(
    variable == "<sup>**S**</sup>&frasl;<sub>**G**</sub>" & cell_type %in% c("PX", "MX") ~
    value + 0.5,
    TRUE ~ value
  ))

letters_avg <- letter_groups(violin_data_avg,
  value,
  genotype,
  "tukey",
  variable,
  cell_type,
  print_position = "above"
) %>%
  select(-value) %>%
  left_join(select(letters, -Letters), by = c("variable", "cell_type", "genotype"))


lig_violin <- ggplot(
  violin_data,
  aes(
    x = genotype,
    y = value
  )
) +
  geom_hline(data = ref_data %>% select(-cell_type),
             aes(yintercept = value),
             size = 0.2,
             linetype = 2,
             colour = "grey") +
  geom_richtext(data = ref_data,
            aes(y = value,
                label = label),
            label.size = NA,
            x = 4,
            hjust = 0.5,
            vjust = c(0.6, 0.5, 0.5),
            family = "Helvetica",
            size = ggtext_size,
            colour = "grey") +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters_avg,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  expand_limits(y = 0) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_markdown(),
    strip.placement = "outside",
    strip.text.y.left = element_textbox_simple(halign = 0.5, 
                                               orientation = "left-rotated",
                                               size = 8),
  ) +
  facet_grid(variable ~ cell_type, scales = "free_y", switch = "y")

pdf("Raman_fig.pdf", width = twocol, height = onecol * 0.7)
lig_violin 
dev.off()
```

#### Statistics

```{r}
stat_tab <- violin_data_avg %>%
  drop_na(value) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype),
         variable = str_remove_all(strip_html(variable), fixed("*"))) %>%
  group_by(genotype, cell_type, variable) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    value,
    genotype,
    "tukey",
    cell_type,
    variable,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = stat_tab$variable,
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "04B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = stat_tab$variable,
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "04B_tukey.csv"))
```

### Supplemental figure

#### WT cell types

```{r}
violin_data <- rmn_lac_sum %>%
  select(
    # "Total lignin" = total_lignin,
    "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>" = lig.cellu,
    "<sup>**S**</sup>&frasl;<sub>**G**</sub>" = S.G,
    # "S" = S_rel,
    # "G" = G_rel,
    # "P-units" = P_rel,
    # AUC,
    # "Cellulose cryst." = cellu_cryst,
    # "Benzaldehydes" = Benz_rel,
    # "G-CHOH" = GOH_rel,
    # "G-CHO" = GCHO_rel,
    "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>" = GCHO.GOH
  ) %>%
  filter(genotype == "WT" & cell_type != "LP") %>%
  pivot_longer(
    cols = -c(genotype:replicate),
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    variable = ordered(variable,
      levels = c(
        "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>",
        "<sup>**S**</sup>&frasl;<sub>**G**</sub>",
        "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>"
      )
    ),
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "LP",
        "XF",
        "PX",
        "MX"
      )
    ),
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  )

violin_data_avg <- violin_data %>%
  group_by(genotype, cell_type, replicate, variable, instance) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))

ref_labels <- tribble(
  ~genotype, ~cell_type, ~variable, ~label,
  "fah1", "PMX", "<sup>**S**</sup>&frasl;<sub>**G**</sub>", "<i>fah1</i> MX (traces of <b>S</b>)",
  "ccr1_3", "IF", "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>", "<i>ccr1-3</i> IF (traces of lignin)",
  "cad4x5", "IF", "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>", "<i>cad4;5</i> IF (overaccumulates <b>G</b><sub>CHO</sub>)"
)

ref_data <- rmn_ref_sum %>%
  select(
    genotype,
    cell_type,
    replicate,
    "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>" = lig.cellu,
    "<sup>**S**</sup>&frasl;<sub>**G**</sub>" = S.G,
    "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>" = GCHO.GOH
  ) %>%
  pivot_longer(
    cols = -c(genotype:replicate),
    names_to = "variable",
    values_to = "value"
  ) %>%
  right_join(ref_labels) %>%
  ungroup() %>%
  mutate(
    variable = ordered(
      variable,
      levels = c(
        "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>",
        "<sup>**S**</sup>&frasl;<sub>**G**</sub>",
        "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>"
      )
    ),
    cell_type = c("IF", "MX", "IF"),
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "LP",
        "XF",
        "PX",
        "MX"
      )
    )
  )

letters <- letter_groups(violin_data,
  value,
  cell_type,
  "tukey",
  variable,
  print_position = "above",
  print_adjust = 1.5
) 

letters_avg <- letter_groups(violin_data_avg,
  value,
  cell_type,
  "tukey",
  variable,
  print_position = "above"
) %>%
  select(-value) %>%
  left_join(select(letters, -Letters), by = c("variable", "cell_type"))


lig_violin_WT <- ggplot(
  violin_data,
  aes(
    x = cell_type,
    y = value
  )
) +
  geom_hline(data = ref_data %>% select(-cell_type),
             aes(yintercept = value),
             size = 0.2,
             linetype = 2,
             colour = "grey") +
  geom_richtext(data = ref_data %>% select(-cell_type),
            aes(y = value,
                label = label),
            label.size = NA,
            x = 2.5,
            hjust = 0.5,
            vjust = c(0.6, 0.5, 0.5),
            family = "Helvetica",
            size = ggtext_size,
            colour = "grey") +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters_avg,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  expand_limits(y = 0) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_markdown(),
    strip.placement = "outside",
    strip.text.y.left = element_textbox_simple(halign = 0.5, 
                                               orientation = "left-rotated",
                                               size = 8),
  ) +
  facet_wrap(~ variable, scales = "free_y", switch = "y")

pdf("Raman_WT.pdf", width = twocol, height = onecol * 0.7)
lig_violin_WT
dev.off()
```

##### Statistics

```{r}
stat_tab <- violin_data_avg %>%
  drop_na(value) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype),
         variable = str_remove_all(strip_html(variable), fixed("*"))) %>%
  group_by(genotype, cell_type, variable) %>%
  mutate(
    "n" = n(),
    cell_type = paste0(cell_type, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    value,
    cell_type,
    "tukey",
    variable,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = stat_tab$variable) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S05A_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = stat_tab$variable) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S05A_tukey.csv"))
```

#### Complete lignin

##### Format dataframes

```{r}
violin_data <- rmn_lac_sum %>%
  select(
    # "Total lignin" = total_lignin,
    # "<sup>Lignin&thinsp;</sup>&frasl;<sub>cellulose</sub>" = lig.cellu,
    # "<sup>**S**</sup>&frasl;<sub>**G**</sub>" = S.G,
    "<b>S</b>" = S_rel,
    "<b>G</b>" = G_rel,
    "<b>P</b>" = P_rel,
    # AUC,
    "Cellulose cryst." = cellu_cryst,
    "Benz-<br>aldehydes" = Benz_rel,
    "<b>G</b><sub>CHOH</sub>" = GOH_rel,
    "<b>G</b><sub>CHO</sub>" = GCHO_rel,
    # "<sup>**G**<sub>CHO&thinsp;</sub></sup>&frasl;<sub>**G**<sub>CHOH</sub></sub>" = GCHO.GOH
  ) %>%
  filter(cell_type != "LP") %>%
  pivot_longer(
    cols = -c(genotype:replicate),
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    variable = ordered(
      variable,
      levels = c(
        "Cellulose cryst.",
        "<b>S</b>",
        "<b>G</b>",
        "<b>G</b><sub>CHO</sub>",
        "<b>G</b><sub>CHOH</sub>",
        "Benz-<br>aldehydes",
        "<b>P</b>"
      )
    ),
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "LP",
        "XF",
        "PX",
        "MX"
      )
    ),
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  )

violin_data_avg <- violin_data %>%
  group_by(genotype, cell_type, replicate, variable, instance) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))

ref_labels <- tribble(
  ~genotype, ~cell_type, ~variable, ~label,
  "fah1", "PMX", "<b>S</b>", "<i>fah1</i> MX (traces of <b>S</b>)",
  "fah1", "PMX", "<b>G</b>", "<i>fah1</i> MX (traces of <b>S</b>)",
  "cad4x5", "IF", "<b>G</b><sub>CHOH</sub>", "<i>cad4;5</i> IF (depleted of <b>G</b><sub>CHOH</sub>)",
  "cad4x5", "IF", "<b>G</b><sub>CHO</sub>", "<i>cad4;5</i> IF (overaccumulates <b>G</b><sub>CHOH</sub>)"
)

ref_data <- rmn_ref_sum %>%
  select(
    genotype,
    cell_type,
    replicate,
    "<b>S</b>" = S_rel,
    "<b>G</b>" = G_rel,
    "<b>G</b><sub>CHOH</sub>" = GOH_rel,
    "<b>G</b><sub>CHO</sub>" = GCHO_rel
  ) %>%
  pivot_longer(
    cols = -c(genotype:replicate),
    names_to = "variable",
    values_to = "value"
  ) %>%
  right_join(ref_labels) %>%
  ungroup() %>%
  mutate(
    variable = ordered(
      variable,
      levels = c(
        "Cellulose cryst.",
        "<b>S</b>",
        "<b>G</b>",
        "<b>G</b><sub>CHO</sub>",
        "<b>G</b><sub>CHOH</sub>",
        "Benz-<br>aldehydes",
        "<b>P</b>"
      )
    ),
    cell_type = "IF",
    cell_type = ordered(cell_type,
      levels = c(
        "IF",
        "LP",
        "XF",
        "PX",
        "MX"
      )
    )
  )
```

##### Plot figure

```{r}
letters <- letter_groups(violin_data,
  value,
  genotype,
  "tukey",
  variable,
  cell_type,
  print_position = "below",
  print_adjust = 1.5
) %>%
  mutate(value = case_when(
    cell_type == "MX" & variable != "Cellulose cryst." & variable != "<b>P</b>" ~ value - 0.3 * value,
    cell_type == "MX" & variable == "<b>P</b>" ~ value - 0.04,
    cell_type == "PX" & variable == "Cellulose cryst." ~ value + 0.1,
    TRUE ~ value
  ))

letters_avg <- letter_groups(violin_data_avg,
  value,
  genotype,
  "tukey",
  variable,
  cell_type,
  print_position = "below"
) %>%
  select(-value) %>%
  left_join(select(letters, -Letters), by = c("variable", "cell_type", "genotype"))


lig_violin <- ggplot(
  violin_data,
  aes(
    x = genotype,
    y = value
  )
) +
  geom_hline(data = ref_data %>% select(-cell_type),
             aes(yintercept = value),
             size = 0.2,
             linetype = 2,
             colour = "grey") +
  geom_richtext(data = ref_data,
            aes(y = value,
                label = label),
            label.size = NA,
            x = 4,
            hjust = 0.5,
            vjust = c(0.2, 1, 1, 0.5),
            family = "Helvetica",
            size = ggtext_size,
            colour = "grey") +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters_avg,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  expand_limits(y = 0) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_markdown(),
    strip.placement = "outside",
    strip.text.y.left = element_textbox_simple(halign = 0.5, 
                                               orientation = "left-rotated"),
  ) +
  facet_grid(variable ~ cell_type, scales = "free_y", switch = "y")

pdf("lig_complete.pdf", width = twocol, height = onecol * 1.5)
lig_violin
dev.off()
```

##### Statistics

```{r}
stat_tab <- violin_data_avg %>%
  drop_na(value) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype),
         variable = str_remove_all(strip_html(variable), fixed("*"))) %>%
  group_by(genotype, cell_type, variable) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    value,
    genotype,
    "tukey",
    cell_type,
    variable,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = stat_tab$variable,
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S05B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = stat_tab$variable,
      "cell_type" = stat_tab$cell_type) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S05B_tukey.csv"))
```

#### Assemble figure 

```{r}
pdf("Raman_supp_fig.pdf", width = twocol, height = twocol)
lig_violin_WT + lig_violin +
  plot_layout(ncol = 1, heights = c(1, 4)) &
  plot_annotation(
    tag_levels = "A"
  ) &
  theme(plot.tag = element_text(size = 10, face = "bold", family = "Helvetica"))
dev.off()
```


# Cell corner fluorescence

## Relative fluorescence

### Load data

```{r}
CC_files <-
  list.files(
    path = "/home/leonard/Dropbox/2021_lac_manuscript/CC_measurements/",
    pattern = "*.csv",
    recursive = FALSE,
    full.names = TRUE
  )

read_CC <- function(flnm) {
  read_csv(flnm, show_col_types = FALSE) %>%
    mutate(file = basename(flnm)) %>%
    separate(file, into = c("date", "genotype", "replicate", "notes"), sep = "_", extra = "merge") %>%
    mutate(speed = as.numeric(str_remove(str_extract(notes, "[:digit:]speed"), "speed")),
           sum = as.numeric(str_remove(str_extract(notes, "[:digit:]sum"), "sum")),
           laser = as.numeric(str_remove(str_extract(notes, "[:digit:]{2}perc"), "perc")),
           laser = case_when(is.na(laser) ~ 100,
                             TRUE ~ laser)) %>% 
    select(-notes) %>% 
    pivot_longer(-c("date", "genotype", "replicate", "speed", "sum", "laser"), names_to = "ROI", values_to = "value") %>%
    mutate(ROI = str_remove(ROI, "Roi_"))
}

CC_data <- map_dfr(CC_files, read_CC) %>%
  mutate(genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    )) %>% 
  group_by(date, genotype, replicate, ROI) %>%
  mutate(
    pixel = row_number(),
    CC = median(pixel),
    position = pixel - CC,
    scaled = (value - min(value)) / (max(value) - min(value)),
    layer = case_when(position < -29 & position > -41 ~ "CML",
                      position > 14 & position < 26 ~ "SCW",
                      position > -6 & position < 6 ~ "CC"),
    layer = ordered(layer, levels = c("CML", "CC", "SCW")),
    mean_CML = mean(value[layer == "CML"], na.rm = TRUE),
    scaled_CML = value / mean_CML
  )

CC_data_avg <- CC_data %>% 
  drop_na() %>% 
  group_by(genotype, replicate, layer) %>% 
  summarise(scaled_CML = mean(scaled_CML))
```

### Plot profiles

```{r}
CC_profiles <- ggplot(CC_data %>% filter(genotype %in% c("WT", "<i>Q</i>", "<i>Q-12</i>")),
       aes(x = position,
           y = scaled_CML,
           colour = genotype)) +
  annotate("rect",
           ymin = -Inf,
           ymax = Inf,
           xmin = c(-40, -5, 15),
           xmax = c(-30, 5, 25),
           fill = "grey95") +
  geom_line(aes(group = interaction(genotype, replicate, ROI)),
                size = 0.2,
                alpha = 0.5) +
  geom_smooth(method = "loess",
              span = 0.2,
              se = FALSE) +
  labs(y = "Autofluorescence<br>normalised to CML",
       x = "Cell wall layer") +
  scale_x_continuous(breaks = c(-35, 0, 20),
                     labels = c("CML", "CC", "SCW"),
                     limits = c(-44, 44)) +
  scale_colour_manual(values = pal_dawn[c(1, 5, 7)]) +
  theme_leo() +
  theme(legend.position = c(0.15, 0.85),
        legend.text = element_markdown(),
        legend.title = element_blank(),
        axis.title.y = element_textbox_simple(valign = 0.5,
                                              halign = 0.5,
                                              orientation = "left-rotated")
        # axis.title.x = element_blank(),
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank()
  )
plotly::ggplotly(CC_profiles)
pdf("CC_plot.pdf", width = onecol, height = onecol)
CC_profiles
dev.off()
```

#### All profiles

```{r}
CC_profiles_full <- ggplot(CC_data,
       aes(x = position,
           y = scaled_CML,
           colour = genotype)) +
  annotate("rect",
           ymin = -Inf,
           ymax = Inf,
           xmin = c(-40, -5, 15),
           xmax = c(-30, 5, 25),
           fill = "grey95") +
  geom_line(aes(group = interaction(genotype, replicate, ROI)),
                size = 0.2,
                alpha = 0.5) +
  geom_smooth(method = "loess",
              span = 0.2,
              se = FALSE) +
  labs(y = "Autofluorescence normalised to CML",
       x = "Cell wall layer") +
  scale_x_continuous(breaks = c(-35, 0, 20),
                     labels = c("CML", "CC", "SCW"),
                     limits = c(-44, 44)) +
  scale_colour_manual(values = pal_dawn) +
  theme_leo() +
  theme(legend.position = "none",
        legend.text = element_markdown(),
        strip.text = element_markdown(hjust = 0.5),
        # legend.title = element_blank(),
        axis.title.y = element_textbox_simple(valign = 0.5,
                                              halign = 0.5,
                                              orientation = "left-rotated"),
        axis.title.x = element_blank(),
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank()
  ) +
  facet_wrap(~ genotype, ncol = 2)

pdf("supp_CC_plot.pdf", width = onecol, height = onecol)
CC_profiles_full
dev.off()
```

### CC violins

```{r}

letters_tech <- letter_groups(CC_data %>% filter(layer == "CC"),
                         scaled_CML,
                         genotype,
                         "tukey",
                         print_position = "below") %>% 
  select(-Letters)

letters <- letter_groups(CC_data_avg %>% filter(layer == "CC"),
                         scaled_CML,
                         genotype,
                         "tukey",
                         print_position = "below") %>% 
  select(-scaled_CML) %>% 
  left_join(letters_tech)

CC_plot <- ggplot(
  CC_data %>% filter(layer == "CC"),
  aes(
    x = genotype,
    y = scaled_CML
  )
) +
  geom_hline(yintercept = 1,
             size = 0.2,
             linetype = 2) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  annotate("text",
           label = " CML",
           x = 0,
           y = 0.95,
           hjust = 0,
           vjust = 1,
           family = "Helvetica",
           size = ggtext_size
           ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(data = CC_data_avg %>% filter(layer == "CC"),
  #            shape = 21,
  #            fill = "white",
  #            stroke = 0.2,
  #            size = 2,
  #            alpha = 1) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "CC autofluorescence<br>normalised to CML") +
  scale_fill_manual(values = pal_dawn) +
  # scale_y_continuous(breaks = c(0.5, 0.75, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(valign = 0.5,
                                              halign = 0.5,
                                              orientation = "left-rotated"),
    # axis.title.y = element_textbox_simple(
    #   orientation = "left-rotated",
    #   halign = 0.5,
    #   width = unit(25, "mm")
    # ),
    axis.text.x = element_markdown(),
    # strip.placement = "outside",
    strip.text = element_text(hjust = 0.5)
  )

pdf("lac_CC.pdf", width = onecol, height = onecol * 0.5)
CC_plot
dev.off()
```

#### Statistics

```{r}
stat_tab <- CC_data_avg %>% 
  filter(layer == "CC") %>%
  drop_na(scaled_CML) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    scaled_CML,
    genotype,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = "CC autofluorescence realtive to CML") %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "05D_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = "CC autofluorescence realtive to CML") %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "05D_tukey.csv"))
```

### [unused] S2/S3 layers

```{r, eval=FALSE}
layers <- read_csv("/home/leonard/Dropbox/2021_lac_manuscript/CC_measurements/SCW/2022-03-02_SCW.csv") %>% 
  mutate(genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    )) %>% 
  group_by(date, genotype, replicate) %>% 
  mutate(
    point = rep(seq(1, 10), each = 2, length.out = 20),
    layer = rep(c("S2", "S3"), length.out = 20)) %>% 
  pivot_wider(id_cols = c(date, genotype, replicate, point), names_from = layer, values_from = value) %>% 
  mutate(ratio = S3 / S2)

layers_avg <- layers %>% 
  group_by(genotype, replicate) %>% 
  summarise(ratio = mean(ratio))

letters_tech <- letter_groups(layers,
                         ratio,
                         genotype,
                         "tukey",
                         print_position = "below") %>% 
  select(-Letters)

letters <- letter_groups(layers_avg,
                         ratio,
                         genotype,
                         "tukey",
                         print_position = "below") %>% 
  select(-ratio) %>% 
  left_join(letters_tech)

layers_plot <- ggplot(
  layers,
  aes(
    x = genotype,
    y = ratio
  )
) +
  geom_hline(yintercept = 1,
             size = 0.2,
             linetype = 2) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  annotate("text",
           label = " S2",
           x = 3.5,
           y = 1,
           hjust = 0,
           vjust = 1,
           family = "Helvetica",
           size = ggtext_size
           ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(data = CC_data_avg %>% filter(layer == "SCW"),
  #            shape = 21,
  #            fill = "white",
  #            stroke = 0.2,
  #            size = 2,
  #            alpha = 1) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "S3 autofluorescence<br>relative to adjacent S2") +
  scale_fill_manual(values = pal_dawn[c(1,2,6)]) +
  # scale_y_continuous(breaks = c(0.5, 0.75, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_textbox_simple(valign = 0.5,
                                              halign = 0.5),
    # axis.title.y = element_textbox_simple(
    #   orientation = "left-rotated",
    #   halign = 0.5,
    #   width = unit(25, "mm")
    # ),
    axis.text.y = element_markdown(),
    axis.title.y = element_blank(),
    # strip.placement = "outside",
    strip.text = element_text(hjust = 0.5)
  ) +
  coord_flip()

pdf("lac_SCW_layers.pdf", width = onecol * 0.4, height = onecol * 0.5)
layers_plot
dev.off()
```
## Absolute fluorescence

### Load data

```{r}
CC_files <-
  list.files(
    path = "/home/leonard/Dropbox/2021_lac_manuscript/CC_measurements/absolute/Measurements/",
    pattern = "*.csv",
    recursive = FALSE,
    full.names = TRUE
  )

read_CC <- function(flnm) {
  read_csv(flnm, show_col_types = FALSE) %>%
    mutate(file = str_remove(basename(flnm), fixed(".csv"))) %>%
    separate(file, into = c("date", "genotype", "replicate"), sep = "_")
}

CC_abs <- map_dfr(CC_files, read_CC) %>%
  mutate(genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ))

CC_abs_avg <- CC_abs %>% 
  drop_na() %>% 
  group_by(genotype, replicate, layer) %>% 
  summarise(value = mean(value))
```

### Layer violins

```{r}

# letter within panels
letters_tech <- letter_groups(CC_abs,
                         value,
                         genotype,
                         "tukey",
                         layer,
                         print_position = "above") %>%
  select(-Letters)

letters <- letter_groups(CC_abs_avg,
                         value,
                         genotype,
                         "tukey",
                         layer,
                         print_position = "above") %>%
  select(-value) %>%
  left_join(letters_tech)

# letters across panels
# letters_tech <- CC_abs %>%
#   unite("ID", genotype, layer) %>%
#   letter_groups(.,
#     value,
#     ID,
#     "tukey",
#     print_position = "above"
#   ) %>%
#   select(-Letters)
# 
# letters <- CC_abs_avg %>%
#   unite("ID", genotype, layer) %>%
#   letter_groups(.,
#     value,
#     ID,
#     "tukey",
#     print_position = "above"
#   ) %>%
#   select(-value) %>%
#   left_join(letters_tech) %>%
#   separate(ID, into = c("genotype", "layer"), sep = "_") %>%
#   mutate(genotype = ordered(genotype,
#     levels = c(WT, triple_it, quad_it, Q_it)
#   ))

layer_plot <- ggplot(
  CC_abs,
  aes(
    x = genotype,
    y = value
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(data = CC_data_avg %>% filter(layer == "CC"),
  #            shape = 21,
  #            fill = "white",
  #            stroke = 0.2,
  #            size = 2,
  #            alpha = 1) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Absolute autofluorescence") +
  scale_fill_manual(values = pal_dawn) +
  scale_y_continuous(breaks = c(0, 20000, 40000)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_textbox_simple(valign = 0.5,
                                              halign = 0.5),
    # axis.title.y = element_textbox_simple(
    #   orientation = "left-rotated",
    #   halign = 0.5,
    #   width = unit(25, "mm")
    # ),
    axis.text.y = element_markdown(),
    # strip.placement = "outside",
    strip.text = element_text(hjust = 0.5)
  ) +
  facet_wrap(~layer, ncol = 1) +
  coord_flip()

pdf("lac_layers.pdf", height = onecol * 1.5, width = onecol * 0.7)
layer_plot
dev.off()
```

#### Statistics

```{r}
stat_tab <- CC_abs_avg %>%
  drop_na(value) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype, layer) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    value,
    genotype,
    "tukey",
    layer,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "layer" = stat_tab$layer) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S06B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "layer" = stat_tab$layer) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S06B_tukey.csv"))
```


## Combined figure

```{r}
pdf("CC_figure.pdf", width = onecol * 0.7, height = onecol)
CC_profiles / CC_plot +
  plot_layout(heights = c(0.6, 0.4))
dev.off()
```

## Supplementary figure

```{r}
pdf("CC_figure_supp.pdf", width = twocol * 0.6, height = onecol * 1.5)
layer_plot + CC_profiles_full +
  plot_layout(widths = c(1,2))
dev.off()
```

# Lignin function

## TE collapse

### Load data

```{r, message=FALSE}
collapse_files <-
  list.files(
    path = c(paste0(datapath, "PhD/Wiesner/2021-05_Wiesner/Collapse/Measurements/"),
             "/home/leonard/Dropbox/2021_lac_manuscript/Wiesner/Collapse/Measurements/"),
    pattern = "*.csv",
    recursive = TRUE,
    full.names = TRUE
  )

collapse_data <- vroom::vroom(collapse_files) %>%
  separate(image, into = c("date", "genotype", "replicate", "stained", "size"), sep = "_", extra = "merge") %>%
  mutate(date = str_replace(date, "^021", "2021")) %>%
  mutate(
    cell_type = ordered(cell_type,
      levels = c(
        "PX",
        "MX",
        "SX"
      )
    ),
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  ) %>%
  distinct() %>% 
  group_by(genotype, replicate, point) %>%
  mutate(cell = case_when(
    point == 0 ~ row_number(),
    TRUE ~ NA_integer_
  )) %>%
  ungroup() %>%
  fill(cell)

```

#### Calculate perimeters

```{r}
perimeters <- collapse_data %>%
  group_by(genotype, replicate, cell_type, cell) %>% 
  select(point, x, y)

perimeters_sf <- perimeters %>%
  unite("ID", genotype:cell, remove = FALSE, sep = "_") %>%
  group_by(ID) %>%
  mutate(
    x = x - mean(x, na.rm = TRUE),
    y = y - mean(y, na.rm = TRUE)
  ) %>%
  group_by(ID, point) %>%
  summarise(xy = list(c(x, y))) %>%
  group_by(ID) %>%
  mutate(
    max_point = max(point)
  ) %>%
  bind_rows(filter(., point == 0) %>%
    group_by(ID) %>%
    mutate(point = max_point + 1)) %>%
  arrange(ID, point) %>%
  summarise(xy = list(c(xy))) %>%
  mutate(geometry = map(
    xy,
    ~ do.call(rbind, .) %>% # make each list a matrix
      list() %>% # st_polygon() requires a list
      st_polygon()
  )) %>%
  st_as_sf() %>% 
  group_by(ID) %>%
  mutate(
    smooth_geometry = smoothr::smooth(geometry, method = "ksmooth", smoothness = 2),
    area = st_area(smooth_geometry),
    convex_hull = st_convex_hull(smooth_geometry),
    convex_area = st_area(convex_hull),
    convexity = area / convex_area,
    perimeter = lwgeom::st_perimeter(smooth_geometry),
    circularity = 4 * pi * (area / (perimeter^2))
  ) %>%
  separate(ID, into = c("genotype", "replicate", "cell_type", "cell"), sep = "_") %>%
  mutate(
    genotype = ordered(genotype, levels = c(levels = c(WT, triple_it, quad_it, Q_it))),
    cell_type = ordered(cell_type, levels = c("PX", "MX", "SX"))
  )
```


### Plot PX/MX collapse

```{r}
collapse_stats <- perimeters_sf %>%
  filter(cell_type != "SX") %>% 
  group_by(genotype, replicate, cell_type, cell) %>%
  summarise(
    # "Area" = unique(Area) * 4^2, # analysed images were scaled down to 0.25, this corrects the scale
    # "Perim." = unique(Perim.) * 4, # analysed images were scaled down to 0.25, this corrects the scale
    # "Circ." = unique(Circ.),
    "Solidity" = unique(convexity)
  ) %>% 
  mutate(cell_type = paste0(cell_type, " convexity"))

collapse_avg <- collapse_stats %>% 
  group_by(genotype, cell_type, replicate) %>% 
  summarise("Solidity" = mean(Solidity))

collapse_n <- collapse_stats %>%
  group_by(genotype) %>%
  summarise(replicates = paste0(unique(replicate), collapse = ","))

letters_tech <- letter_groups(collapse_stats,
  Solidity,
  genotype,
  "tukey",
  cell_type,
  print_position = "below"
) %>% 
  select(-Letters)

letters <- letter_groups(collapse_avg,
  Solidity,
  genotype,
  "tukey",
  cell_type,
  print_position = "below"
) %>% 
  select(-Solidity) %>% 
  left_join(letters_tech)

collapse_plot <- ggplot(
  collapse_stats,
  aes(
    x = genotype,
    y = Solidity
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(data = collapse_avg,
  #            shape = 21,
  #            fill = "white",
  #            stroke = 0.2,
  #            size = 1,
  #            alpha = 0.5) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "TE convexity") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  scale_y_continuous(breaks = c(0.5, 0.75, 1)) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title = element_blank(),
    # axis.title.y = element_textbox_simple(
    #   orientation = "left-rotated",
    #   halign = 0.5,
    #   width = unit(25, "mm")
    # ),
    axis.text.x = element_markdown(),
    strip.placement = "outside",
    strip.text = element_text(hjust = 0.5)
  ) +
  facet_wrap(~cell_type, nrow = 2, strip.position = "left")

pdf("lac_collapse.pdf", width = onecol, height = onecol * 0.5)
collapse_plot
dev.off()
```

#### Statistics

```{r}
stat_tab <- collapse_avg %>%
  drop_na(Solidity) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype, cell_type) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    Solidity,
    genotype,
    "tukey",
    cell_type,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = stat_tab$cell_type
      ) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "06_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = stat_tab$cell_type
      ) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "06_tukey.csv"))
```

### Plot SX collapse

```{r}
collapse_stats <- perimeters_sf %>%
  filter(cell_type == "SX") %>%
  group_by(genotype, replicate, cell_type, cell) %>%
  summarise(
    # "Area" = unique(Area) * 4^2, # analysed images were scaled down to 0.25, this corrects the scale
    # "Perim." = unique(Perim.) * 4, # analysed images were scaled down to 0.25, this corrects the scale
    # "Circ." = unique(Circ.),
    "Solidity" = unique(convexity)
  ) %>% 
  mutate(cell_type = paste0(cell_type, " convexity"))

collapse_avg <- collapse_stats %>% 
  group_by(genotype, cell_type, replicate) %>% 
  summarise("Solidity" = mean(Solidity))

collapse_n <- collapse_stats %>%
  group_by(genotype) %>%
  summarise(replicates = paste0(unique(replicate), collapse = ","))

letters_tech <- letter_groups(collapse_stats,
  Solidity,
  genotype,
  "tukey",
  cell_type,
  print_position = "below"
) %>% 
  select(-Letters)

letters <- letter_groups(collapse_avg,
  Solidity,
  genotype,
  "tukey",
  cell_type,
  print_position = "below"
) %>% 
  select(-Solidity) %>% 
  left_join(letters_tech)

collapse_plot <- ggplot(
  collapse_stats,
  aes(
    x = genotype,
    y = Solidity
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(data = collapse_avg,
  #            shape = 21,
  #            fill = "white",
  #            stroke = 0.2,
  #            size = 1,
  #            alpha = 0.5) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "TE convexity") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  scale_y_continuous(breaks = c(0.5, 0.75, 1)) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title = element_blank(),
    # axis.title.y = element_textbox_simple(
    #   orientation = "left-rotated",
    #   halign = 0.5,
    #   width = unit(25, "mm")
    # ),
    axis.text.x = element_markdown(),
    strip.placement = "outside",
    strip.text = element_text(hjust = 0.5)
  ) +
  facet_wrap(~cell_type, nrow = 3, strip.position = "left")

pdf("lac_collapse_SX.pdf", width = onecol, height = onecol * 0.4)
collapse_plot
dev.off()
```

#### Statistics

```{r}
stat_tab <- collapse_avg %>%
  drop_na(Solidity) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype, cell_type) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    Solidity,
    genotype,
    "tukey",
    cell_type,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = stat_tab$cell_type
      ) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S07B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = stat_tab$cell_type
      ) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S07B_tukey.csv"))
```

### Plot perimeter length

```{r}
perim_length <- perimeters_sf %>%
  group_by(genotype, replicate, cell_type, cell) %>%
  summarise(
    # "Area" = unique(area) * 4^2, # analysed images were scaled down to 0.25, this corrects the scale
    "Perimeter" = unique(perimeter) / 8.8106 * 4, # actual scale is 8.8106 px/µm, analysed images were scaled down to 0.25, this corrects the scale
    # "Circ." = unique(Circ.),
    # "Solidity" = unique(Solidity)
  ) 
# %>% 
  # mutate(cell_type = paste0(cell_type, " perimeter [µm]"))

perim_length_avg <- perim_length %>% 
  group_by(genotype, cell_type, replicate) %>% 
  summarise("Perimeter" = mean(Perimeter))

perim_n <- perim_length %>%
  group_by(genotype) %>%
  summarise(replicates = paste0(unique(replicate), collapse = ","))

letters_tech <- letter_groups(perim_length,
  Perimeter,
  genotype,
  "tukey",
  cell_type,
  print_position = "below"
) %>% 
  select(-Letters)

letters <- letter_groups(perim_length_avg,
  Perimeter,
  genotype,
  "tukey",
  cell_type,
  print_position = "below"
) %>% 
  select(-Perimeter) %>% 
  left_join(letters_tech)

perimeter_plot <- ggplot(
  perim_length,
  aes(
    x = genotype,
    y = Perimeter
  )
) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_point(data = collapse_avg,
  #            shape = 21,
  #            fill = "white",
  #            stroke = 0.2,
  #            size = 1,
  #            alpha = 0.5) +
  geom_text(
    data = letters,
    aes(label = Letters),
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Perimeter [µm]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  scale_y_continuous() +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    # axis.title.y = element_textbox_simple(
    #   orientation = "left-rotated",
    #   halign = 0.5,
    #   width = unit(25, "mm")
    # ),
    axis.text.x = element_markdown(),
    strip.placement = "outside",
    strip.text = element_textbox_simple(
      hjust = 0.5,
      orientation = "left-rotated",
      width = unit(2, "mm"))
  ) +
  facet_wrap(
    ~cell_type, 
    nrow = 3, 
    strip.position = "left"
    )

pdf("lac_perimeter.pdf", width = onecol, height = onecol * 0.5)
perimeter_plot
dev.off()

```

#### Statistics

```{r}
stat_tab <- perim_length_avg %>%
  drop_na(Perimeter) %>% 
  rowwise() %>%
  mutate(genotype = strip_html(genotype)) %>%
  group_by(genotype, cell_type) %>%
  mutate(
    "n" = n(),
    genotype = paste0(genotype, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    Perimeter,
    genotype,
    "tukey",
    cell_type,
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "variable" = "perimeter",
      "cell_type" = stat_tab$cell_type
      ) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S08A_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "variable" = "perimeter",
      "cell_type" = stat_tab$cell_type
      ) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S08A_tukey.csv"))
```

### Draw perimeters

```{r}
perimeters_sf_sample <- perimeters_sf %>% 
  group_by(genotype, cell_type, replicate) %>% 
  slice_sample(n = 3) %>% 
  filter(cell_type != "SX")

perimeter_plot <- ggplot() +
  geom_sf(
    data = perimeters_sf_sample,
    aes(colour = convexity,
        geometry = smooth_geometry,),
    # colour = "black",
    fill = NA,
    lwd = 0.1,
    key_glyph = "point"
  ) +
  theme_leo() +
  scale_x_continuous(expand = expansion(mult = 0)) +
  scale_y_continuous(expand = expansion(mult = 0)) +
  scale_colour_gradientn(colours = pal_ostwald_cont, trans = "reverse", name = "Convexity") +
  guides(colour = guide_colourbar(barheight = unit(1, "mm"))) +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "bottom",
    panel.border = element_blank(),
    # panel.background = element_rect(fill = "black"),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    strip.text = element_textbox_simple(halign = 0.5)
  ) +
  facet_grid(cell_type ~ genotype, switch = "y")

pdf("lac_perimeters.pdf", width = onecol * 0.9, height = onecol * 0.5)
perimeter_plot
dev.off()
```

#### SX

```{r}
perimeters_sf_sample <- perimeters_sf %>% 
  group_by(genotype, cell_type, replicate) %>% 
  slice_sample(n = 3) %>% 
  filter(cell_type == "SX")

perimeter_plot <- ggplot() +
  geom_sf(
    data = perimeters_sf_sample,
    aes(colour = convexity,
        geometry = smooth_geometry,),
    # colour = "black",
    fill = NA,
    lwd = 0.1,
    key_glyph = "point"
  ) +
  theme_leo() +
  scale_x_continuous(expand = expansion(mult = 0)) +
  scale_y_continuous(expand = expansion(mult = 0)) +
  scale_colour_gradientn(colours = pal_ostwald_cont, trans = "reverse", name = "Convexity") +
  guides(colour = guide_colourbar(barheight = unit(1, "mm"))) +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "bottom",
    panel.border = element_blank(),
    # panel.background = element_rect(fill = "black"),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    strip.text = element_textbox_simple(halign = 0.5)
  ) +
  facet_grid(cell_type ~ genotype, switch = "y")

pdf("lac_perimeters_SX.pdf", width = onecol * 0.9, height = onecol * 0.25)
perimeter_plot
dev.off()
```

## IF swelling

### Load data

```{r}
swelling_files <- list.files(
  path = paste0(datapath, "PhD/Safranin-Astra/Measurements/"),
  recursive = FALSE,
  full.names = TRUE
)

swelling_data <- map_dfr(swelling_files, read_csv) %>%
  select(-Angle) %>%
  rename("thickness" = Length) %>% 
  separate(image, into = c("date", "genotype", "replicate"), sep = "_") %>%
  mutate(
    state = ordered(state, levels = c("fresh", "dry", "rehydrated")),
    genotype = ordered(case_when(
      genotype == "WT" ~ genotype,
      TRUE ~ paste0("<i>", genotype, "</i>")
    ),
    levels = c(WT, triple_it, quad_it, Q_it)
    ),
    instance = case_when(
      replicate %in% c(1:5) ~ "1",
      TRUE ~ "2"
    )
  ) %>% 
  group_by(date, genotype, replicate) %>% 
  mutate(cell = rep(seq(1:10), each = 3, length.out = 60)) %>% 
  filter(date != "2021-09-03") # those are too dark to differentiate CW from background
```

### Absolute thickness

#### Main figure

```{r}

swelling_data_fresh <- swelling_data %>% 
  filter(cell_type == "IF") %>% 
  mutate(state = ordered(state, levels = rev(levels(state))),
         genotype = ordered(genotype, levels = rev(levels(genotype)))
         )

swelling_data_avg <- swelling_data_fresh %>% 
  group_by(genotype, state, replicate) %>% 
  summarise(thickness = mean(thickness))

letters_tech <- swelling_data_fresh %>%
  unite("ID", genotype, state) %>%
  letter_groups(.,
    thickness,
    ID,
    "tukey",
    print_position = "above"
  ) %>% 
  select(-Letters)

letters <- swelling_data_avg %>%
  unite("ID", genotype, state) %>%
  letter_groups(.,
    thickness,
    ID,
    "tukey",
    print_position = "above"
  ) %>%
  select(-thickness) %>% 
  left_join(letters_tech) %>% 
  separate(ID, into = c("genotype", "state"), sep = "_") %>% 
  mutate(state = ordered(state, levels = c("rehydrated", "dry", "fresh")),
         genotype = ordered(genotype, levels = rev(c(WT, triple_it, quad_it, Q_it))))

absolute_thick <- ggplot(swelling_data_fresh,
       aes(x = state,
           y = thickness)) +
  geom_quasirandom(
    aes(group = interaction(state, genotype)),
    dodge.width = 0.6,
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.05
  ) +
  geom_violin(
    aes(fill = genotype,
        group = interaction(state, genotype)),
    draw_quantiles = 0.5,
    position = position_dodge(width = 0.6),
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters,
        group = interaction(state, genotype)),
    position = position_dodge(width = 0.6),
    vjust = 0.4,
    hjust = 0.5,
    size = ggtext_size,
    family = "Helvetica"
  ) +
  labs(y = "Cell wall thickness [µm]") +
  scale_color_manual(values = rev(pal_dawn), aesthetics = c("colour", "fill")) +
  scale_y_continuous(position = "right") +
  scale_x_discrete(expand = expansion(mult = 0.25)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_textbox_simple(
      # orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    # axis.text.y = element_markdown(
    #   angle = 90,
    #   hjust = 0.5),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    strip.text = element_markdown()
  ) +
  coord_flip()

pdf("fresh_IF.pdf", width = onecol * 0.35, height = onecol * 0.71)
absolute_thick
dev.off()
```

##### Statistics

```{r}
stat_tab <- swelling_data_avg %>%
  unite("ID", genotype, state) %>%
  drop_na(thickness) %>% 
  rowwise() %>%
  mutate(ID = strip_html(ID)) %>%
  group_by(ID) %>%
  mutate(
    "n" = n(),
    ID = paste0(ID, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    thickness,
    ID,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "cell_type" = "IF"
      ) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "07B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "cell_type" = "IF"
      ) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "07B_tukey.csv"))
```

#### Supplementary figure

```{r}

swelling_data_fresh <- swelling_data %>% 
  filter(cell_type == "MX") %>% 
  mutate(state = ordered(state, levels = levels(state)),
         genotype = ordered(genotype, levels = levels(genotype))
         )

swelling_data_avg <- swelling_data_fresh %>% 
  group_by(genotype, state, replicate) %>% 
  summarise(thickness = mean(thickness))

letters_tech <- swelling_data_fresh %>%
  unite("ID", genotype, state) %>%
  letter_groups(.,
    thickness,
    ID,
    "tukey",
    print_position = "above"
  ) %>% 
  select(-Letters)

letters <- swelling_data_avg %>%
  unite("ID", genotype, state) %>%
  letter_groups(.,
    thickness,
    ID,
    "tukey",
    print_position = "above"
  ) %>%
  select(-thickness) %>% 
  left_join(letters_tech) %>% 
  separate(ID, into = c("genotype", "state"), sep = "_") %>% 
  mutate(state = ordered(state, levels = c("fresh", "dry", "rehydrated")),
         genotype = ordered(genotype, levels = c(WT, triple_it, quad_it, Q_it)))

absolute_thick <- ggplot(swelling_data_fresh,
       aes(x = genotype,
           y = thickness)) +
  geom_quasirandom(
    aes(group = interaction(state, genotype)),
    dodge.width = 0.6,
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.05
  ) +
  geom_violin(
    aes(fill = genotype,
        group = interaction(state, genotype)),
    draw_quantiles = 0.5,
    position = position_dodge(width = 0.6),
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  geom_text(
    data = letters,
    aes(label = Letters,
        group = interaction(state, genotype)),
    position = position_dodge(width = 0.6),
    vjust = 0.4,
    hjust = 0.5,
    size = ggtext_size,
    family = "Helvetica"
  ) +
  annotate("text",
           label = c("fresh", "dried", "rehydrated"),
           y = c(0.5, 0, 0.5),
           x = c(0.85, 1, 1.15),
           hjust = c(1, 0.5, 0),
           size = ggtext_size,
           family = "Helvetica") +
  annotate("segment",
           x = c(0.8, 1, 1.2),
           xend = c(0.75, 1, 1.25),
           y = c(1.1, 1.15, 1.2),
           yend = c(0.8, 0.3, 0.8),
           size = 0.2) +
  labs(y = "MX cell wall thick. [µm]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  scale_y_continuous(limits = c(0, 5)) +
  theme_leo() +
  theme(axis.text.x = element_markdown(),
        axis.title.x = element_blank())

pdf("fresh_MX.pdf", width = onecol, height = onecol * 0.3)
absolute_thick
dev.off()
```

##### Statistics

```{r}
stat_tab <- swelling_data_avg %>%
  unite("ID", genotype, state) %>%
  drop_na(thickness) %>% 
  rowwise() %>%
  mutate(ID = strip_html(ID)) %>%
  group_by(ID) %>%
  mutate(
    "n" = n(),
    ID = paste0(ID, " (n = ", n, ")")
  ) %>%
  letter_groups(.,
    thickness,
    ID,
    "tukey",
    table = TRUE
  )

  anova_tab <- stat_tab$anova %>% 
    add_column(
      "cell_type" = "MX"
      ) %>% 
    distinct()
  write_csv(anova_tab, paste0(stat_path, "S08B_anova.csv"))

  tukey_tab <- stat_tab$tukey %>%
    add_column(
      "cell_type" = "MX"
      ) %>% 
    distinct()
  write_csv(tukey_tab, paste0(stat_path, "S08B_tukey.csv"))
```

### [unused] Relative thickness

```{r, eval=FALSE}

rel_swelling_data <- swelling_data %>% 
  group_by(genotype, replicate, cell_type, cell) %>% 
  mutate(rel_thickness = thickness / thickness[state == "fresh"] * 100) %>% 
  filter(state != "fresh")


ggplot(rel_swelling_data,
       aes(x = state,
           y = rel_thickness)) +
  geom_hline(yintercept = 100,
             linetype = 2,
             size = 0.2) +
  geom_quasirandom(
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.5
  ) +
  geom_violin(
    aes(fill = genotype),
    draw_quantiles = 0.5,
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  labs(y = "Cell wall thickness [%]") +
  scale_color_manual(values = pal_dawn, aesthetics = c("colour", "fill")) +
  # scale_x_discrete(limits = c(0, 1)) +
  # scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_leo() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(25, "mm")
    ),
    axis.text.x = element_markdown(),
    strip.text = element_markdown()
  ) +
  facet_wrap(cell_type ~ genotype)
```

## [unused] Correlations with plant height

```{r, eval=FALSE}

rel_swelling_data <- swelling_data %>% 
  group_by(genotype, replicate, cell_type, cell) %>% 
  mutate(rel_thickness = thickness / thickness[state == "dry"]) %>% 
  filter(state == "fresh" & cell_type == "IF") %>% 
  rename("rep" = replicate) %>% 
  group_by(genotype, rep) %>% 
  summarise(swelling_factor = mean(rel_thickness))

collapse_height <- collapse_data %>% 
  select(genotype, cell_type, "rep" = replicate, Solidity) %>% 
  group_by(genotype, rep, cell_type) %>% 
  summarise(mean_convexity = mean(Solidity)) %>% 
  pivot_wider(names_from = cell_type, values_from = mean_convexity) %>% 
  left_join(pheno_data %>% select(genotype, rep, "height" = stretched.height)) %>% 
  left_join(rel_swelling_data)

summary(lm(height ~ MX, data = collapse_height))

ggplot(collapse_height,
       aes(x = MX,
           y = height)) +
  geom_point() +
  geom_smooth(method = "lm")

summary(lm(height ~ swelling_factor, data = collapse_height))

ggplot(collapse_height,
       aes(x = swelling_factor,
           y = height)) +
  geom_point() +
  geom_smooth(method = "lm")

summary(lm(height ~ MX + swelling_factor, data = collapse_height))
```

# Supplements

## Genotyping primers

```{r}
options(knitr.kable.NA = '')
geno_data <- read_csv("/home/leonard/Dropbox/2021_lac_manuscript/Tables/genotyping_primers.csv") %>% 
  mutate(primer = rep(c("FW", "RV"), length.out = 10),
         `Primer pair mutant allele` = paste0(primer, ": ", `Primer pair mutant allele`),
         `Primer pair WT allele` = paste0(primer, ": ", `Primer pair WT allele`)) %>% 
  select(-primer)

geno_tab <- knitr::kable(geno_data,
  "latex",
  # align = "lllllcccc",
  # caption = "Raman bands validated by Py--GC/MS.",
  # col.names = c(
  #   "Band no.",
  #   "Band intensity at",
  #   "Normalised to",
  #   "Assigned polymer",
  #   "Assigned structure",
  #   "Pearson's r",
  #   "P-value",
  #   "Pearson's r",
  #   "P-value"
  # ),
  booktabs = TRUE,
  linesep = ""
) %>%
  kableExtra::column_spec(c(4, 5), monospace = TRUE) %>%
  kableExtra::column_spec(1, italic = TRUE)

readr::write_file(geno_tab, "lac_tableS1.txt")
```


## Expression

### Load data

```{r}
expression <- read_csv("/home/leonard/Documents/Uni/Master/Master thesis/Laccases/Expression/R_file.csv") %>%
  mutate(
    time = case_when(
      time == 0 ~ "Proliferation",
      TRUE ~ "SCW formation"
    ),
    dataset = recode(dataset,
                     "array" = "Microarray",
                     "seq" = "RNA-Seq"),
    laccase = ordered(laccase, levels = c(
      "LAC1",
      "LAC2",
      "LAC3",
      "LAC4",
      "LAC5",
      "LAC6",
      "LAC7",
      "LAC8",
      "LAC9",
      "LAC10",
      "LAC11",
      "LAC12",
      "LAC13",
      "LAC14",
      "LAC15",
      "LAC16",
      "LAC17",
      "XCP2",
      "IRX3"
    ))
  )
```

### Plot Expression
```{r}
expression_highlight <- tibble(laccase = c("LAC4", "LAC5", "LAC10", "LAC11", "LAC12", "LAC17")) %>%
  mutate(laccase = ordered(laccase, levels = c(
    "LAC1",
    "LAC2",
    "LAC3",
    "LAC4",
    "LAC5",
    "LAC6",
    "LAC7",
    "LAC8",
    "LAC9",
    "LAC10",
    "LAC11",
    "LAC12",
    "LAC13",
    "LAC14",
    "LAC15",
    "LAC16",
    "LAC17",
    "XCP2",
    "IRX3"
  )))

expression_plot <- ggplot(
  expression,
  aes(x = laccase)
) +
  geom_tile(
    data = expression_highlight,
    aes(
      y = 3,
      width = 0.75,
      height = Inf
    ),
    fill = "#ffcc3d"
  ) +
  annotate("tile",
           x = c(18, 19),
           y = 1,
           height = Inf,
           width = 0.75,
           fill = "grey95") +
  scale_fill_manual(values = c("black", "white")) +
  scale_x_discrete(drop = F) +
  geom_pointrange(aes(
    y = absolute,
    fill = time,
    ymin = absolute - absolute.sd,
    ymax = absolute + absolute.sd
  ),
  shape = 21,
  stroke = 0.2
  ) +
  labs(y = "Relative expression") +
  coord_flip(ylim = c(0, 8)) +
  theme_leo() +
  theme(
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_text(hjust = 0, face = "italic"),
    axis.ticks = element_blank(),
    # panel.border = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  ) +
  facet_wrap(~dataset, nrow = 1)

pdf("Blaschek2022_figureS1.pdf", width = onecol * 0.6, height = onecol * 0.65)
expression_plot
dev.off()
```

## TODO: PCA

```{r}
# The code for the root angle analysis got lost during a backup mishap.
# The code should generate one PCA comparing Raman data between different cell types and genotypes.
# The figure should show one panel per cell type, with small transparent points indicating measurements and large labeled points indicating the average.
# Subsequently the vectors of the variables are added in inkscape as a circle at the centre of the four figure panels.
```

## Export complete data

```{r}
writexl::write_xlsx(list(
  "plant height at harvest" = pheno_full %>%
    rename("height [cm]" = height, "mean height of the corresponding WT[cm]" = mean_WT, "height [% of WT]" = rel_height) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "silique lengths" = siliques %>%
    rename("replicate" = rep, "length [cm]" = length) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "rosette area over time" = rosette_area %>%
    rename("area [cm²]" = value) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "rosette area growth rate" = nested_rosette_area %>%
    select(-c(data, fit, term)) %>%
    rename("growth rate [cm² per day]" = estimate) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "plant height over time" = stem_data %>%
    select(genotype, replicate, instance, dpg, "bolting [dpg]" = flowering_start, dpb, "height [cm]" = height) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "stem height growth rate" = nested_stem_data %>%
    select(-c(data, fit, term)) %>%
    rename("growth rate [cm per day]" = estimate) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "root length over time" = root_data %>%
    rename("position on plate" = position, "root length [cm]" = length) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "root length growth rate" = nested_root_data %>%
    select(-c(data, fit, term)) %>%
    rename("growth rate [cm per day]" = estimate) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  # "LAC pH optimum absorbance" = pH_data %>% rename("start of linear phase" = lm_start, "end of linear phase" = lm_stop),
  "LAC pH optimum oxidation rates" = nested_pH_data %>%
    select(-c(date, data, fit, term, lm_start, lm_stop)) %>%
    rename("relative oxidation rate" = estimate) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  # "DAB absorbance over time" = data_dab %>% select(-c(date, adj.r.squared)) %>% mutate("start of linear phase" = 150, "end of linear phase" = 250),
  "DAB oxidation rates" = nested_data_dab %>%
    select(-c(date, data, fit, term, PH_slope)) %>%
    rename("relative oxidation rate" = estimate) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  # "DAF absorbance over time" = data_daf %>% select(-c(date, adj.r.squared)) %>% mutate("start of linear phase" = 80, "end of linear phase" = 160),
  "DAF oxidation rates" = nested_data_daf %>%
    select(-c(date, data, fit, term)) %>%
    rename("relative oxidation rate" = estimate) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "Wiesner data" = Wiesner_data %>%
    select(-first_image) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "Mäule data" = maule_data %>%
    select(-hue255) %>%
    mutate(hue = case_when(hue > 360 ~ hue - 360, TRUE ~ hue)) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "Raman spectra" = rmn_lac_scaled %>% select(-c(ID, peak_pos, peak_pos_ref, AUC)) %>% rename("cell" = TE, "baseline corrected intensity (BCI)" = corrected.intensity, "BCI scaled to AUC" = scaled, "BCI scaled to total lignin" = scaled_lig, "BCI scaled to total cellulose" = scaled_cellu),
  "Raman bands" = rmn_lac_sum %>%
    select(genotype,
      replicate,
      cell_type,
      "cell" = TE, total_lignin,
      "G [of total lignin]" = G_rel,
      "S [of total lignin]" = S_rel,
      "P [of total lignin]" = P_rel,
      "G-CHOH [of total lignin]" = GOH_rel,
      "terminal G-CHO [of total lignin]" = GCHO_rel,
      "benzaldehydes [of total lignin]" = Benz_rel,
      "total cellulose" = cellulose,
      "cellulose crystallinity" = cellu_cryst,
      "lignin/cellulose" = lig.cellu,
      "S/G" = S.G,
      "G-CHO/G-CHOH" = GCHO.GOH
    ),
  "absolute autofluorescence" = CC_abs %>%
    select(genotype, replicate, "cell wall layer" = layer, "pixel value [16 bit]" = value) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "relative autofluorescence" = CC_data %>%
    select(genotype, replicate, ROI, "pixel value" = value, pixel, "pixel [relative to CC]" = position, "mean pixel value of CML" = mean_CML, "value scaled to CML" = scaled_CML) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "TE collapse" = perimeters_sf %>%
    select(genotype, replicate, cell_type, cell, convexity) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "TE perimeters" = perim_length %>%
    select(genotype, replicate, cell_type, cell, Perimeter) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype)),
  "CW swelling" = swelling_data %>%
    select(genotype, replicate, instance, cell_type, cell, state, "thickness [µm]" = thickness) %>%
    rowwise() %>%
    mutate(genotype = strip_html(genotype))
),
path = "Blaschek2022_data.xlsx",
col_names = TRUE,
format_headers = TRUE,
use_zip64 = FALSE
)
```

## Statistics table

```{r}
stat_tables <- list.files(
  path = "/home/leonard/Dropbox/2021_lac_manuscript/Submission/PlantCell/supplementary/Statistics/",
  full.names = TRUE
)

read_stats <- function(flnm) {
  read_csv(flnm) %>% 
    mutate(filename = basename(flnm)) %>% 
    separate(filename, into = c("Figure panel"), sep = "_", extra = "drop") %>% 
    rename("P-value (adjusted if applicable)" = contains("value"))
}

stat_table <- map_dfr(stat_tables, read_stats) %>%
  select(
    "Figure panel",
    "Statistical test" = "method",
    "Degrees of freedom (adjusted if applicable)" = "df",
    "Test statistic" = "statistic",
    "Variable" = "variable",
    "Compared groups with numbers of replicates" = "contrast",
    # "Other grouping (if applicable)" = "group",
    "P-value (adjusted if applicable)"
  ) %>%
  # mutate(Variable = str_replace(Variable, fixed("Benz_rel"), "Benzaldehydes"),
  #        Variable = str_replace(Variable, fixed("GCHO_rel"), "G-CHO"),
  #        Variable = str_replace(Variable, fixed("GOH_rel"), "G-CHOH"),
  #        Variable = str_replace(Variable, fixed("Benz_rel"), "Benzaldehydes"),
  #        Variable = str_replace(Variable, fixed("S.G"), "S/G"),
  #        Variable = str_replace(Variable, fixed("n_v"), "Adjacency to TEs [%]"),
  #        Variable = str_replace(Variable, fixed("max.stress"), "Strength"),
  #        Variable = str_replace(Variable, fixed("modulus"), "Stiffness"),
  #        Variable = str_replace(Variable, fixed("bold(S)~'/'~bold(G)"), "S/G"),
  #        Variable = str_replace(Variable, fixed("bold(S)"), "S"),
  #        Variable = str_replace(Variable, fixed("bold(G)[CHOH]"), "G-CHOH"),
  #        Variable = str_replace(Variable, fixed("Terminal~bold(G)[CHO]"), "Terminal G-CHO"),
  #        Variable = str_replace(Variable, fixed("Term.~bold(G)[CHO]"), "Terminal G-CHO"),
  #        Variable = str_replace(Variable, fixed("Total~bold(G)[CHO]"), "Total G-CHO"),
  #        Variable = str_replace(Variable, fixed("bold(G)"), "G"),
  #        Variable = str_replace(Variable, fixed("bold(P)"), "P"),
  #        Variable = str_replace(Variable, fixed("lig.cellu"), "Lignin/cellulose"),
  #        Variable = str_replace(Variable, fixed("break_point"), "Flexibility"),
  #        Variable = str_replace(Variable, fixed("GCHO_term.GCHOH"), "G-CHO/G-CHOH"),
  #        Variable = str_replace(Variable, fixed("GCHO.GOH"), "G-CHO/G-CHOH"),
  #        Variable = str_replace(Variable, fixed("G[CHO]~'/'~G-CHOH"), "G-CHO/G-CHOH")) %>%
  arrange(
    `Figure panel`,
    Variable,
    `Degrees of freedom (adjusted if applicable)`,
    `P-value (adjusted if applicable)`
  )

write_csv(stat_table,
  "Blaschek2022_supplemental_stats.csv",
  na = ""
)

list_of_tables <- stat_table %>% 
  group_split(`Figure panel`)

list_of_tables %>% 
  map(~pull(.,`Figure panel`)) %>% # Pull out Species variable
  map(~as.character(.)) %>% # Convert factor to character
  map(~unique(.)) -> names(list_of_tables) # Set this as names for list members

list_of_tables %>%
  writexl::write_xlsx(path = "Blaschek2022_supplemental_stats.xlsx")


ggplot(stat_table,
       aes(x = `P-value (adjusted if applicable)`)) +
  geom_histogram(binwidth = 0.005)
```