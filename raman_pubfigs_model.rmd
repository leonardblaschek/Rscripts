---
title: "Raman publication figures"
author: "Leonard Blaschek"
date: "14/10/2019"
output: 
  pdf_document:
    latex_engine: lualatex
    fig_caption: yes
    includes:
      in_header: rmd_temp.tex
sansfont: IBM Plex Sans
monofont: Inconsolata
mainfont: IBM Plex Sans
bibliography: /home/leonard/Documents/Bibliographics/zotero_lib.bib
link-citations: true
linkcolor: black
urlcolor: blue
citecolor: blue
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(grid)
library(png)
library(magick)
library(baseline)
library(PerformanceAnalytics)
library(ropls)
library(corrplot)
library(factoextra)
library(showtext)
library(ggthemes)
library(zoo)
library(kableExtra)
library(viridis)
library(tidyverse)
library(broom)
library(ggrepel)
library(gplots)
library(ggridges)
library(RColorBrewer)
library(tukeygrps)
library(cowplot)
library(ggbeeswarm)

# import Helvetica
font_add(
  "Helvetica",
  regular = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Lt.otf",
  italic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-LtIt.otf",
  bold = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Bd.otf",
  bolditalic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-BdIt.otf"
)
showtext_auto()

# generating plot theme
theme_leo <- function(base_size = 8,
                      base_family = "Helvetica") {
  theme_minimal(
    base_size = base_size,
    base_family = base_family
  ) %+replace%
    theme(
      strip.text = element_text(hjust = 0, face = "italic"),
      axis.ticks = element_line(
        size = 0.2,
        lineend = "square",
        color = "black"
      ),
      axis.text.x = element_text(
        size = 8,
        colour = "black", # flipped coords
        margin = margin(1, 1, 1, 1)
      ),
      axis.text.y = element_text(
        colour = "black",
        size = 8,
        angle = 0,
        vjust = 0.5,
        hjust = 1,
        margin = margin(1, 1, 1, 1)
      ),
      axis.title = element_text(
        colour = "black",
        size = 8
      ),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black", size = 0.2),
      panel.spacing = unit(1.5, "mm"),
      legend.position = "none",
      legend.text = element_text(size = 8),
      legend.key.height = unit(4, "mm"),
      legend.margin = unit(c(0, 0, 0, 0), "mm"),
      plot.margin = unit(c(2, 2, 2, 2), "mm"),
      complete = TRUE
    )
}

update_geom_defaults("line", list(size = 0.2))
update_geom_defaults("segment", list(size = 0.2))

scale_range <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}
scale_z <- function(x) {
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
scale_max <- function(x) {
  x / max(x)
}
# scale_lig <- function(x) {
#   x / max(x[wavenumber > 1590 & wavenumber < 1610])
# }

# Physiologia dimensions
twocol <- 16.6 / 2.54
onehalfcol <- 12.5 / 2.54
onecol <- 8 / 2.54
ggtext_size <- 8 / (14 / 5)
```

### Figure 1 -- spectra of the monomers and DHPs

```{r model compounds, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

rmn_model_files <-
  list.files(
    path = "/home/leonard/Documents/Uni/PhD/Raman/Zoltan/",
    pattern = ".csv",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_csv(flnm,
    comment = "#",
    col_names = FALSE,
    skip = 5,
    cols_only(
      X1 = col_number(),
      X2 = col_number()
    )
  ) %>%
    mutate(filename = flnm)
}

rmn_models <- lapply(rmn_model_files, read_plus) %>%
  bind_rows()

#### baseline correct Raman data ####
# rmn_models_wide <- rmn_models %>%
#   group_by(filename) %>%
#   rename("wavenumber" = "X1",
#          "intensity" = "X2") %>%
#   mutate(group_id = row_number()) %>%
#   spread(wavenumber, intensity) %>%
#   select(-group_id) %>%
#   summarise_all(funs(sum(., na.rm = TRUE)))

rmn_models_nest <- rmn_models %>%
  group_by(filename) %>%
  rename("wavenumber" = "X1",
         "intensity" = "X2") %>%
  nest()

pvt <- function(df) pivot_wider(data = df, names_from = wavenumber, values_from = intensity)

bl_corr <- function(df) {
  correction <- baseline(as.matrix(df),
                         method = "als",
  lambda = 5,
  p = 0.01,
  maxit = 100
)
  as_tibble((getCorrected(correction)))
}

rmn_models_corrected <- rmn_models_nest %>%
  mutate(wide = map(data, pvt),
         correction = map(wide, bl_corr)) %>%
  select(-wide, -data) %>%
  unnest_wider(correction) %>%
  pivot_longer(cols = -filename, names_to = "wavenumber", values_to = "intensity") %>%
  drop_na() %>%
  ungroup()

rmn_models <- rmn_models_corrected %>%
  mutate(filename = str_remove(basename(filename), ".\\.csv$")) %>%
  separate(filename, into = c("state", "unit", "gamma"), remove = FALSE) %>%
  # rename(
  #   "wavenumber" = "X1",
  #   "intensity" = "X2"
  # ) %>%
  mutate(
    wavenumber = round(as.numeric(wavenumber), digits = 0),
    unit = recode(unit,
      "g" = "G",
      "s" = "S"
    )
  ) %>%
  filter(wavenumber %in% c(300:1700)) %>%
  group_by(state, unit, gamma) %>%
  mutate(
    AUC = MESS::auc(wavenumber, intensity),
    # AUC_1600_prop = MESS::auc(wavenumber, intensity, from = 1580, to = 1615) / AUC,
    # scaled = intensity
    scaled = intensity / AUC
  ) %>%
  ungroup() %>%
  mutate(scaled = scale_max(scaled))

rmn_models <- rmn_models %>%
  ungroup() %>%
  mutate(filename = ordered(filename,
    levels =
      rev(c(
        "poly-g-oh",
        "mono-g-oh",
        "poly-g-cho",
        "mono-g-cho",
        "mono-g-cooh",
        "mono-s-oh",
        "poly-s-cho",
        "mono-s-cho",
        "mono-s-cooh",
        "mono-h-cooh",
        "mono-c-cooh",
        "mono-gsat-oh",
        "mono-5h-cooh"
      ))
  ), gamma = ordered(gamma, levels = rev(c("oh", "cho", "cooh"))))


spectra_plot <- ggplot(filter(rmn_models, unit %in% c("G", "S"))) +
  geom_text_repel(
    data = tibble(
      wavenumber = rep(c(1656, 1620, 1600, 1334, 1276), 2),
      unit = rep(c("G", "S"), each = 5, len = 10),
      gamma = rep("COOH", 10),
      scaled = rep(1, 10)
    ),
    aes(
      label = wavenumber,
      x = wavenumber,
      y = scaled
    ),
    angle = 90,
    hjust = 0.5,
    direction = "x",
    min.segment.length = 0,
    segment.size = 0.4,
    nudge_y = -0.25,
    segment.colour = "grey85",
    family = "Helvetica",
    size = ggtext_size
  ) +
  annotate("segment",
    x = c(1656, 1620, 1600, 1334, 1276),
    xend = c(1656, 1620, 1600, 1334, 1276),
    y = 1,
    yend = Inf,
    colour = "grey85",
    size = 0.4
  ) +
  geom_ridgeline(aes(
    x = wavenumber,
    y = gamma,
    height = rollmean(scaled, 3, na.pad = TRUE),
    # fill = state,
    colour = state,
  ),
  alpha = 0.5,
  size = 0.2,
  # colour = NA,
  fill = NA,
  scale = 2.5,
  min_height = -0.05
  ) +
  geom_ridgeline(
    data = tibble(
      wavenumber = rep(300:1700, 3),
      gamma = rep(c("cooh", "oh", "cooh"), each = 1401),
      unit = rep(c("G", "S", "S"), each = 1401),
      state = "poly",
      scaled = 0
    ),
    aes(
      x = wavenumber,
      y = gamma,
      height = rollmean(scaled, 3, na.pad = TRUE),
      # fill = state,
      colour = state
    ),
    alpha = 0.5,
    size = 0.2,
    # colour = NA,
    fill = NA,
    linetype = 2,
    scale = 2.5,
    min_height = -0.002
  ) +
  scale_fill_manual(values = c("poly" = "#d73027", "mono" = "#4575b4")) +
  scale_colour_manual(values = c("poly" = "#d73027", "mono" = "#4575b4")) +
  scale_x_reverse(
    limits = c(1700, 300),
    # sec.axis = sec_axis(~., breaks = unique(peak_pres$peak))
  ) +
  scale_y_discrete(
    labels = c(
      expression("R"[COOH]),
      expression("R"[CHO]),
      expression("R"[CHOH])
    )
  ) +
  labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +
  theme_leo() +
  theme(
    # panel.spacing = unit(5, "mm"),
    axis.title.y = element_blank(),
    strip.text = element_text(size = 8),
    axis.text.x.top = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
  ) +
  facet_wrap(~unit, ncol = 2)


#### Upset plot ####
peak_pres <- read_csv("/home/leonard/Documents/Uni/PhD/Raman/synth_peak_presence.csv") %>%
  complete(peak, compound, fill = list(present = "no")) %>%
  separate(compound, into = c("state", "unit", "gamma"), sep = "-", remove = FALSE) %>%
  mutate(
    compound = ordered(compound,
      levels =
        rev(c(
          "poly-g-oh",
          "mono-g-oh",
          "mono-gsat-oh",
          "poly-g-cho",
          "mono-g-cho",
          "mono-g-cooh",
          "mono-5h-cooh",
          "mono-s-oh",
          "poly-s-cho",
          "mono-s-cho",
          "mono-s-cooh",
          "mono-c-cooh",
          "mono-h-cooh"
        ))
    ),
    unit = recode(unit,
      "g" = "G",
      "s" = "S"
    ),
    gamma = ordered(gamma, levels = rev(c("oh", "cho", "cooh")))
  )

peak_pres_max <- peak_pres %>%
  group_by(peak) %>%
  summarise(
    max = max(compound[present == "yes"]),
    min = min(compound[present == "yes"])
  )

peak_upset <- ggplot(peak_pres) +
  geom_point(
    data = filter(peak_pres, present == "no"),
    aes(
      x = reorder(peak, -as.numeric(peak)),
      y = compound,
      colour = state,
      alpha = present,
      size = present
    ),
    shape = 20
  ) +
  geom_segment(
    data = peak_pres_max,
    aes(
      group = peak,
      y = min,
      yend = max,
      x = reorder(peak, -as.numeric(peak)),
      xend = reorder(peak, -as.numeric(peak))
    ),
    size = 0.2
  ) +
  geom_point(
    data = filter(peak_pres, present == "yes"),
    aes(
      x = reorder(peak, -as.numeric(peak)),
      y = compound,
      colour = state,
      alpha = present,
      size = present
    ),
    shape = 20
  ) +
  labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +
  scale_y_discrete(labels = rev(c(
    expression(paste("G"[CHOH])),
    expression(paste("G"[CHOH])),
    expression(paste("G"[sat - CHOH])),
    expression(paste("G"[CHO])),
    expression(paste("G"[CHO])),
    expression(paste("G"[COOH])),
    expression(paste("5H"[COOH])),
    expression(paste("S"[CHOH])),
    expression(paste("S"[CHO])),
    expression(paste("S"[CHO])),
    expression(paste("S"[COOH])),
    expression(paste("C"[COOH])),
    expression(paste("H"[COOH]))
  ))) +
  scale_colour_manual(values = c(
    "poly" = "#d73027",
    "mono" = "#4575b4"
  )) +
  scale_alpha_manual(values = c(
    "yes" = 1,
    "no" = 0.1
  )) +
  scale_size_manual(values = c("yes" = 3, "no" = 1)) +
  theme_leo() +
  theme(
    panel.border = element_blank(),
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    axis.ticks = element_blank(),
    axis.title.y = element_blank(),
    # axis.text.y = element_blank()
  )
# pdf("peak_upset_plot.pdf", height = 2)
# peak_upset
# dev.off()

pdf("Raman_figure1.pdf", width = twocol, height = 5)
plot_grid(spectra_plot,
  peak_upset,
  labels = c("A", "B"),
  nrow = 2,
  rel_heights = c(1, 0.75),
  label_size = 10,
  label_fontfamily = "Helvetica",
  label_x = -0.005,
  label_y = 1.005
)
dev.off()
```


\newpage

### Figure 2 -- spectra, AUC, PCA and corresponding images of four *Arabidopsis* WT tissues.

#### Figure 2A -- spectra and AUC

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
#### import and tidy Raman data ####
rmn_files <-
  list.files(
    path = "/home/leonard/Documents/Uni/PhD/Raman/measurements/",
    pattern = "*.CSV",
    recursive = TRUE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_csv(flnm,
    comment = "#",
    col_names = FALSE,
    skip = 0,
    cols_only(
      X1 = col_number(),
      X2 = col_number()
    )
  ) %>%
    mutate(filename = flnm)
}

rmn_data <- lapply(rmn_files, read_plus) %>%
  bind_rows()

# rmn_data <- rmn_data %>%
#   select(c(1:3))

rmn_data$filename <- basename(rmn_data$filename)

# rmn_data$filename <-
#   str_replace(rmn_data$filename, fixed("fah 1"), "fah1")

rmn_data <- rmn_data %>%
  distinct(X1, filename, .keep_all = TRUE) %>%
  separate(
    filename,
    into = c("cell.type", "replicate"),
    sep = "[XhFi]",
    extra = "merge"
  ) %>%
  rename("wavenumber" = X1, "intensity" = X2) %>%
  mutate(
    cell.type = recode(cell.type,
      "Proc-S" = "Vascular bundle",
      "Proc-pt" = "Pith",
      "Proc-I" = "Interfascicular fibre",
      "Proc-Ep" = "Epidermis"
    ),
    replicate = str_remove(replicate, ".CSV")
  )

rmn_data$wavenumber <- round(rmn_data$wavenumber, digits = 0)

#### baseline correct Raman data ####
rmn_data_wide <- rmn_data %>%
  group_by(cell.type, replicate) %>%
  mutate(group_id = row_number()) %>%
  spread(wavenumber, intensity) %>%
  select(-group_id) %>%
  summarise_all(funs(sum(., na.rm = TRUE)))

rmn_data_mat <- as.matrix(rmn_data_wide[, -c(1:4)])
rownames(rmn_data_mat) <- paste(rmn_data_wide$cell.type,
  rmn_data_wide$replicate,
  sep = "_"
)

rmn_data_correction <- baseline.als(rmn_data_mat,
  lambda = 5,
  p = 0.01,
  maxit = 100
)
rmn_data_all <- as_tibble(rmn_data_correction$corrected, rownames = NA)

rmn_data_all <- rmn_data_all %>%
  rownames_to_column() %>%
  separate(rowname, sep = "_", into = c("cell.type", "replicate"), remove = TRUE) %>%
  gather(key = "wavenumber", value = "corrected.intensity", -c(cell.type, replicate)) %>%
  mutate(wavenumber = str_replace(wavenumber, pattern = fixed("X."), replacement = "-")) %>%
  mutate(wavenumber = str_replace(wavenumber, pattern = fixed("X"), replacement = "")) %>%
  mutate(wavenumber = as.numeric(wavenumber)) %>%
  group_by(cell.type, replicate) %>%
  inner_join(., rmn_data, by = c("cell.type", "replicate", "wavenumber")) %>%
  filter(wavenumber %in% c(300:1700)) %>%
  mutate("total_auc" = MESS::auc(wavenumber, corrected.intensity))

# rmn_data_all$genotype <- ordered(rmn_data_all$genotype,
#                                          levels = c(
#                                            "Col-0",
#                                            "4cl1",
#                                            "4cl2",
#                                            "4cl1x4cl2",
#                                            "ccoaomt1",
#                                            "fah1",
#                                            "omt1",
#                                            "ccr1-3",
#                                            "ccr1xfah1",
#                                            "cad4",
#                                            "cad5",
#                                            "cad4xcad5"
#                                          ))
write_csv(rmn_data_all, "raman_spectra_cell_types.csv")

rmn_data_all_avg <- rmn_data_all %>%
  group_by(cell.type, wavenumber) %>%
  summarise(
    intensity = mean(corrected.intensity),
    auc = mean(total_auc),
    auc_sd = sd(total_auc)
  ) %>%
  ungroup() %>%
  mutate(cell.type = as.factor(cell.type))

spectra <- ggplot(data = rmn_data_all_avg) +
  geom_ridgeline(aes(
    x = wavenumber,
    y = cell.type,
    # height = rollmean(intensity, 10, na.pad = TRUE) / 1000,
    height = intensity / 1000,
    fill = cell.type,
    group = cell.type
  ),
  alpha = 0.75,
  size = 0.2,
  # colour = NA,
  scale = 0.5,
  min_height = -500
  ) +
  geom_text(
    data = filter(rmn_data_all_avg, wavenumber == 1699), aes(
      x = wavenumber,
      y = cell.type,
      label = cell.type
    ),
    hjust = 0,
    nudge_y = -0.1,
    family = "Helvetica",
    size = ggtext_size
  ) +
  # geom_text(
  #   data = filter(rmn_data_all_avg, wavenumber == 403), aes(
  #     x = wavenumber,
  #     y = cell.type,
  #     label = paste("Total area under curve = ",
  #                   round(auc / 1000, digits = 0),
  #                   " AU ± ",
  #                   round(auc_sd / 1000, digits = 0))
  #   ),
  #   hjust = 1,
  #   nudge_y = -0.1,
  #   family = "Helvetica",
  #   size = ggtext_size
  # ) +
  scale_fill_viridis_d() +
  scale_x_reverse() +
  labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +
  theme_leo() +
  theme(
    plot.margin = unit(c(2, 0, 2, 2), "mm"),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

rmn_data_all_auc <- rmn_data_all %>%
  group_by(cell.type, replicate) %>%
  summarise(auc = mean(total_auc)) %>%
  ungroup()

auc_boxes <- ggplot(data = rmn_data_all_auc, aes(x = cell.type, y = auc / 1000)) +
  geom_quasirandom(aes(fill = cell.type),
    shape = 21,
    alpha = 0.75,
    size = 3,
    stroke = 0.2
  ) +
  geom_boxplot(
    alpha = 0.5,
    outlier.alpha = 0,
    fatten = 1,
    size = 0.2,
    # width = 0.25
  ) +
  scale_fill_viridis_d() +
  theme_leo() +
  labs(y = "AUC") +
  scale_y_continuous(
    expand = expand_scale(mult = 0.07),
    breaks = c(0, 200, 400)
  ) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.margin = unit(c(2, 0.5, 2, 0), "mm")
  ) +
  coord_flip()
```

#### Figure 2 B -- PCA

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
rmn_data_all_wide <- rmn_data_all %>%
  complete(wavenumber = 400:1700) %>%
  # filter(cell.type %in% c("Epidermis", "Pith")) %>%
  group_by(cell.type, replicate, replicate, wavenumber) %>%
  mutate(scaled = corrected.intensity / total_auc)

pca_data <- na.locf(rmn_data_all_wide) %>%
  ungroup() %>%
  select(cell.type, replicate, wavenumber, scaled) %>%
  unite("ID", cell.type, replicate) %>%
  drop_na() %>%
  pivot_wider(
    names_from = wavenumber,
    values_from = scaled
  ) %>%
  select_if(~ !any(is.na(.))) %>%
  ungroup()

#### make PCA ####
pca_result <- prcomp(pca_data[, -1], center = TRUE, scale. = TRUE)
rownames(pca_result$x) <- pca_data$ID

# fviz_pca_biplot(pca_result)

gg_pca <- as_tibble(pca_result$x, rownames = NA) %>%
  rownames_to_column(var = "ID") %>%
  separate(ID, sep = "_", into = c("cell.type", "replicate"))

pca <- ggplot(gg_pca, aes(x = PC1, y = PC2, fill = cell.type)) +
  geom_hline(yintercept = 0, linetype = 1, size = 0.2) +
  geom_vline(xintercept = 0, linetype = 1, size = 0.2) +
  # stat_ellipse(geom = "polygon", alpha = 0.5, type = "t", level = 0.4) +
  stat_ellipse(aes(fill = NULL), colour = "black", linetype = 2, size = 0.2) +
  geom_point(
    size = 3,
    stroke = 0.4,
    alpha = 0.75,
    shape = 21
  ) +
  annotate("text",
    x = c(-35, 18, 7, -25),
    y = c(18, 25, -17, -25),
    label = c("Epidermis", "Vascular\nbundle", "Interfascicular\nfibre", "Pith"),
    family = "Helvetica",
    size = ggtext_size,
    hjust = 0
  ) +
  labs(
    x = "PC 1 [36.4 %]",
    y = "PC 2 [19.5 %]"
  ) +
  scale_fill_viridis_d() +
  theme_leo() +
  theme(
    plot.margin = unit(c(2, 2, 3, 2), "mm")
  )

celltypes_at <-
  rasterGrob(image_read_pdf(
    "/home/leonard/Dropbox/Raman manuscript/Edits/Raman_figure2_img.pdf"
  ))

pdf("Raman_figure2.pdf", width = twocol, height = 3.9)
twoA_B <- plot_grid(celltypes_at,
  pca,
  ncol = 1,
  labels = c("A", "B"),
  label_size = 10,
  label_fontfamily = "Helvetica",
  label_x = -0.02,
  label_y = 1.01
)
twoC <- plot_grid(spectra,
  auc_boxes,
  labels = c("C"),
  label_size = 10,
  label_fontfamily = "Helvetica",
  rel_widths = c(0.8, 0.2),
  ncol = 2,
  align = "h",
  label_x = -0.02,
  label_y = 1.005
)
plot_grid(twoA_B,
  twoC,
  rel_widths = c(0.3, 0.7),
  align = "h",
  axis = "tb"
)
dev.off()
```

\newpage

### Figure 3 -- spectra, AUC of the two tissues in *Arabidopsis* WT and mutants

```{r load and correct mutant spectra, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}

#### import and tidy Raman data ####
rmn_files <-
  list.files(
    path = "/home/leonard/Documents/Uni/PhD/IRX/RAMAN/nuoendagula/",
    pattern = "*.txt",
    recursive = TRUE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = FALSE,
    skip = 25,
    cols_only(
      X1 = col_number(),
      X2 = col_number()
    )
  ) %>%
    mutate(
      filename = flnm,
      exp_time = readLines(flnm) %>%
        str_split("\t") %>%
        grep("Exposure Time: .* s", ., value = T) %>%
        str_remove_all("#Exposure Time: | s") %>%
        as.numeric(),
      pwr = readLines(flnm) %>%
        str_split("\t") %>%
        grep("Excitation Power: .* mW", ., value = T) %>%
        str_remove_all("#Excitation Power: | mW") %>%
        as.numeric(),
      nd_fltr = 1 - (readLines(flnm) %>%
        str_split("\t") %>%
        grep("% \\([0-9]{3}/255\\)", ., value = T) %>%
        str_remove_all("#ND Filter : | % \\([0-9]{3}/255\\)") %>%
        as.numeric() / 100)
    )
}

rmn_data <- lapply(rmn_files, read_plus) %>%
  bind_rows()

# rmn_data <- rmn_data %>%
#   select(c(1:3))

rmn_data$filename <- basename(rmn_data$filename)

rmn_data$filename <-
  str_replace(rmn_data$filename, fixed("fah 1"), "fah1")

rmn_data <- rmn_data %>%
  distinct(X1, filename, .keep_all = TRUE) %>%
  separate(
    filename,
    into = c("genotype", "replicate", "cell.type", "technical"),
    sep = "\\s*#|-|\\s",
    extra = "merge"
  ) %>%
  rename("wavenumber" = X1, "intensity" = X2) %>%
  mutate(
    genotype = recode(
      genotype,
      "4cl1＆2" = "4cl1x4cl2",
      "cad4＆5" = "cad4xcad5",
      "ccoaomt" = "ccoaomt1",
      "ccr1" = "ccr1-3",
      "col.o" = "Col-0",
      "Col.0" = "Col-0",
      "ccr1＆fah1" = "ccr1xfah1"
    ),
    cell.type = recode(cell.type,
      "px" = "PX",
      "SX" = "SMX",
      "MX" = "PMX"
    ),
    replicate = str_extract(
      replicate,
      "\\d"
    ),
    technical = str_extract(
      technical,
      "(\\d)+"
    ),
    wavenumber = round(wavenumber, digits = 0)
  ) %>%
  filter(cell.type != "？？") %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  mutate(intensity = intensity / (exp_time * pwr * nd_fltr)) %>%
  select(-exp_time, -pwr, -nd_fltr)

#### baseline correct Raman data ####
rmn_data_wide <- rmn_data %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  mutate(group_id = row_number()) %>%
  spread(wavenumber, intensity) %>%
  select(-group_id) %>%
  summarise_all(funs(sum(., na.rm = TRUE)))

rmn_data_mat <- as.matrix(rmn_data_wide[, -c(1:4)])
rownames(rmn_data_mat) <- paste(rmn_data_wide$genotype,
  rmn_data_wide$cell.type,
  rmn_data_wide$replicate,
  rmn_data_wide$technical,
  sep = "_"
)

rmn_data_correction <- baseline.als(rmn_data_mat,
  lambda = 5,
  p = 0.01,
  maxit = 100
)
rmn_data_corrected <- as_tibble(rmn_data_correction$corrected, rownames = NA)

rmn_data_corrected <- rmn_data_corrected %>%
  rownames_to_column() %>%
  separate(rowname, sep = "_", into = c("genotype", "cell.type", "replicate", "technical"), remove = TRUE) %>%
  gather(key = "wavenumber", value = "corrected.intensity", -c(genotype, cell.type, replicate, technical)) %>%
  mutate(wavenumber = str_replace(wavenumber, pattern = fixed("X."), replacement = "-")) %>%
  mutate(wavenumber = str_replace(wavenumber, pattern = fixed("X"), replacement = "")) %>%
  mutate(wavenumber = as.numeric(wavenumber)) %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  inner_join(., rmn_data, by = c("genotype", "cell.type", "replicate", "technical", "wavenumber")) %>%
  ungroup() %>%
  filter(genotype != "ccr1xfah1" &
    wavenumber %in% c(300:1700) &
    cell.type %in% c("IF", "PMX")) %>%
  anti_join(tibble(genotype = "cad4xcad5",
                   cell.type = "PMX",
                   replicate = "4",
                   technical = "2")) %>%
  mutate(
    genotype = ordered(genotype,
      levels = c(
        "Col-0",
        "4cl1",
        "4cl2",
        "4cl1x4cl2",
        "ccoaomt1",
        "fah1",
        "omt1",
        "ccr1-3",
        "cad4",
        "cad5",
        "cad4xcad5"
      )
    ),
    cell.type = recode(cell.type, "PMX" = "VB")
  )

# write_csv(rmn_data_corrected, "rmn_data_corrected.csv")
# rmn_data_corrected <- read_csv("rmn_data_corrected.csv", col_types = "ccccnnn") %>%
#   mutate(
#     genotype = ordered(genotype,
#       levels = c(
#         "Col-0",
#         "4cl1",
#         "4cl2",
#         "4cl1x4cl2",
#         "ccoaomt1",
#         "fah1",
#         "omt1",
#         "ccr1-3",
#         "cad4",
#         "cad5",
#         "cad4xcad5"
#       )
#     )
#   )

# lig_peak <- rmn_data_corrected %>%
#   group_by(genotype, cell.type, replicate, technical) %>%
#   filter(wavenumber %in% c(1580:1620)) %>%
#   mutate(
#     peak.pos = wavenumber[which.max(corrected.intensity)],
#     peak.height = corrected.intensity[which(wavenumber == peak.pos)]
#   ) %>%
#   filter(wavenumber == 1580) %>%
#   select(genotype:technical, peak.pos, peak.height)

rmn_data_corrected <- rmn_data_corrected %>%
  # left_join(lig_peak) %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  mutate(
    AUC = MESS::auc(wavenumber, corrected.intensity),
    AUC_1603 = MESS::auc(wavenumber, corrected.intensity, from = 1580, to = 1640),
    AUC_1334 = MESS::auc(wavenumber, corrected.intensity, from = 1320, to = 1358),
    AUC_1099 = MESS::auc(wavenumber, corrected.intensity, from = 1081, to = 1111),
    AUC_381 = MESS::auc(wavenumber, corrected.intensity, from = 376, to = 398),
    scaled = corrected.intensity / AUC,
    scaled_lig = corrected.intensity / (
      corrected.intensity[wavenumber == 1603] + 2 * corrected.intensity[wavenumber == 1334]
    ),
    scaled_max = corrected.intensity / corrected.intensity[wavenumber == 1603],
    scaled_cellu = corrected.intensity / corrected.intensity[wavenumber == 381]
  )

rmn_data_pre <- rmn_data_corrected %>%
  group_by(genotype, cell.type, replicate, wavenumber) %>%
  summarise(
    samples.pre = length(corrected.intensity),
    mean.raw = mean(corrected.intensity, na.rm = TRUE),
    mean.scaled = mean(scaled, na.rm = TRUE),
    mean.scaled_lig = mean(scaled_lig, na.rm = TRUE),
    mean.scaled_max = mean(scaled_max, na.rm = TRUE),
    mean.scaled_cellu = mean(scaled_cellu, na.rm = TRUE)
    # mean.lig_peak = mean(lig_peak, na.rm = TRUE)
  )

rmn_data_avg <- rmn_data_pre %>%
  group_by(genotype, cell.type, wavenumber) %>%
  summarise(
    plants = paste("plants: ", length(mean.scaled)),
    bundles = ifelse(length(mean.scaled) > 1,
      paste("cells/plant: ", min(samples.pre), "—", max(samples.pre), sep = ""),
      paste("cells/plant: ", min(samples.pre))
    ),
    mean.raw = mean(mean.raw, na.rm = TRUE),
    mean.scaled = mean(mean.scaled, na.rm = TRUE),
    mean.scaled_lig = mean(mean.scaled_lig, na.rm = TRUE),
    mean.scaled_max = mean(mean.scaled_max, na.rm = TRUE),
    mean.scaled_cellu = mean(mean.scaled_cellu, na.rm = TRUE)
    # mean.lig_peak = mean(mean.lig_peak, na.rm = TRUE)
  )
```

```{r genotype ridgeline, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
rmn_data_ridge_full <- rmn_data_avg %>%
  ungroup() %>%
  mutate(
    genotype = ordered(genotype, levels = c(
      "Col-0",
      "4cl1",
      "4cl2",
      "4cl1x4cl2",
      "ccoaomt1",
      "fah1",
      "omt1",
      "ccr1-3",
      "cad4",
      "cad5",
      "cad4xcad5"
    )),
    cell.type = recode(cell.type,
      "IF" = "Interfascicular fibre",
      "VB" = "Vascular bundle"
    )
  )

spectra <- function(x) {
  plot <- ggplot(data = filter(rmn_data_ridge_full, cell.type == x)) +
    # geom_vline(xintercept = c(1625, 1334, 1099),
    #            size = 0.2) +
    geom_ridgeline(aes(
      x = wavenumber,
      y = genotype,
      height = rollmean(mean.scaled, 3, na.pad = TRUE),
      fill = genotype,
      group = genotype
    ),
    alpha = 0.75,
    size = 0.2,
    # colour = NA,
    scale = 200,
    min_height = -500
    ) +
    # geom_ridgeline(data = rmn_data_ridge_full_var,
    #                aes(
    #   x = wavenumber,
    #   y = genotype,
    #   height = rollmean(scaled, 3, na.pad = TRUE),
    #   fill = NA,
    #   group = interaction(genotype, replicate, technical)
    # ),
    # alpha = 0.1,
    # size = 0.1,
    # # colour = NA,
    # scale = 200,
    # min_height = -500
    # ) +
    scale_fill_viridis_d() +
    scale_x_reverse() +
    scale_y_discrete(
      labels = c(
        "WT",
        expression(italic("4cl1")),
        expression(italic("4cl2")),
        expression(paste(italic("4cl1"), "x", italic("4cl2"))),
        expression(italic("ccoaomt1")),
        expression(italic("fah1")),
        expression(italic("omt1")),
        expression(italic("ccr1")),
        expression(italic("cad4")),
        expression(italic("cad5")),
        expression(paste(italic("cad4"), "x", italic("cad5")))
      ),
      expand = expand_scale(mult = c(0.05, 0.175))
    ) +
    labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +
    theme_leo() +
    theme(
      panel.spacing = unit(1, "mm"),
      axis.title.y = element_blank(),
      strip.text = element_text(size = 8),
      plot.margin = unit(c(2, 0, 2, 1.5), "mm")
    ) +
    facet_wrap(~cell.type, ncol = 2)

  if (x == "Vascular bundle") {
    plot + theme(
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank()
    )
  } else {
    plot
  }
}

rmn_data_auc <- rmn_data_corrected %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  summarise(AUC = mean(AUC))

auc_boxes <- function(x) {
  mutant_ridge_letters <- letter_groups(filter(rmn_data_auc, cell.type == x),
    AUC,
    genotype,
    "tukey",
    print_position = "above",
    print_adjust = 2
  )

  ggplot(data = filter(rmn_data_auc, cell.type == x), aes(x = genotype, y = AUC / 10000)) +
    geom_quasirandom(aes(fill = genotype),
      shape = 21,
      alpha = 0.75,
      size = 1,
      stroke = 0.2
    ) +
    geom_boxplot(
      alpha = 0.5,
      colour = "black",
      outlier.alpha = 0,
      fatten = 1,
      size = 0.2
    ) +
    scale_fill_viridis_d() +
    theme_leo() +
    # labs(y = expression(paste("AUC per 490 µm"^2))) +
    labs(y = "AUC") +
    scale_y_continuous(limits = c(0, 4.2), breaks = c(0, 2, 4)) +
    scale_x_discrete(expand = expand_scale(mult = c(0.09, 0.135))) +
    theme(
      axis.text.y = element_blank(),
      axis.title.y = element_blank(),
      axis.ticks.y = element_blank(),
      plot.margin = unit(c(2, 0.5, 2, 0), "mm"),
      strip.text = element_blank()
    ) +
    geom_text(
      data = mutant_ridge_letters,
      aes(label = groups),
      family = "Helvetica",
      size = ggtext_size
    ) +
    coord_flip() +
    facet_wrap(~cell.type)
}

segOH <- 11 + 200 * rmn_data_ridge_full$mean.scaled[rmn_data_ridge_full$genotype == "cad4xcad5" & rmn_data_ridge_full$cell.type == "Interfascicular fibre" & rmn_data_ridge_full$wavenumber == 1664]
segCHO <- 11 + 200 * rmn_data_ridge_full$mean.scaled[rmn_data_ridge_full$genotype == "cad4xcad5" & rmn_data_ridge_full$cell.type == "Interfascicular fibre" & rmn_data_ridge_full$wavenumber == 1625]
segS <- 11 + 200 * rmn_data_ridge_full$mean.scaled[rmn_data_ridge_full$genotype == "cad4xcad5" & rmn_data_ridge_full$cell.type == "Interfascicular fibre" & rmn_data_ridge_full$wavenumber == 1334]

segOH_VB <- 11 + 200 * rmn_data_ridge_full$mean.scaled[rmn_data_ridge_full$genotype == "cad4xcad5" & rmn_data_ridge_full$cell.type == "Vascular bundle" & rmn_data_ridge_full$wavenumber == 1664]
segCHO_VB <- 11 + 200 * rmn_data_ridge_full$mean.scaled[rmn_data_ridge_full$genotype == "cad4xcad5" & rmn_data_ridge_full$cell.type == "Vascular bundle" & rmn_data_ridge_full$wavenumber == 1625]
segS_VB <- 11 + 200 * rmn_data_ridge_full$mean.scaled[rmn_data_ridge_full$genotype == "cad4xcad5" & rmn_data_ridge_full$cell.type == "Vascular bundle" & rmn_data_ridge_full$wavenumber == 1334]

spectra_IF <- spectra("Interfascicular fibre") +
  annotate("segment",
    x = c(1664, 1625, 1334),
    xend = c(1664, 1625, 1334),
    y = c(segOH, segCHO, segS),
    yend = c(12, 12, 12)
  ) + geom_text_repel(
    data = tibble(
      wavenumber = c(1664, 1625, 1334),
      cell.type = rep("Interfascicular fibre", 3),
      genotype = rep("cad4xcad5", 3),
      label = c("1664", "1625", "1335")
    ),
    aes(
      label = label,
      x = wavenumber,
      y = 12
    ),
    # angle = 90,
    # hjust = 0.5,
    direction = "x",
    min.segment.length = 0,
    segment.size = 0.2,
    nudge_y = 1,
    segment.colour = "black",
    family = "Helvetica",
    size = ggtext_size
  )

spectra_VB <- spectra("Vascular bundle") +
  annotate("segment",
    x = c(1664, 1625, 1334),
    xend = c(1664, 1625, 1334),
    y = c(segOH_VB, segCHO_VB, segS_VB),
    yend = c(12, 12, 12)
  ) + geom_text_repel(
    data = tibble(
      wavenumber = c(1664, 1625, 1334),
      cell.type = rep("Vascular bundle", 3),
      genotype = rep("cad4xcad5", 3),
      label = c("1664", "1625", "1335")
    ),
    aes(
      label = label,
      x = wavenumber,
      y = 12
    ),
    # angle = 90,
    # hjust = 0.5,
    direction = "x",
    min.segment.length = 0,
    segment.size = 0.2,
    nudge_y = 1,
    segment.colour = "black",
    family = "Helvetica",
    size = ggtext_size
  )

WT_IF <-
  rasterGrob(readPNG(
    "/home/leonard/Documents/Uni/PhD/Raman/Figures/WT_IF.png"
  ))
WT_VB <-
  rasterGrob(readPNG(
    "/home/leonard/Documents/Uni/PhD/Raman/Figures/WT_VB.png"
  ))
cl_IF <-
  rasterGrob(readPNG(
    "/home/leonard/Documents/Uni/PhD/Raman/Figures/4cl1x2_IF.png"
  ))
cl_VB <-
  rasterGrob(readPNG(
    "/home/leonard/Documents/Uni/PhD/Raman/Figures/4cl1x2_VB.png"
  ))

left <- plot_grid(
  WT_IF,
  WT_VB,
  cl_IF,
  cl_VB,
  ncol = 1,
  label_size = 8,
  label_fontfamily = "Helvetica",
  label_fontface = 3,
  label_x = 0.975,
  label_y = 0.95,
  hjust = 1,
  vjust = 1,
  labels = c(
    "WT IF",
    "WT VB",
    "4cl1x4cl2 IF",
    "4cl1x4cl2 VB"
  )
)

right <- plot_grid(
  spectra_IF,
  auc_boxes("IF"),
  spectra_VB,
  auc_boxes("VB"),
  rel_widths = c(0.75, 0.2, 0.8, 0.2),
  ncol = 4,
  align = "h"
)

pdf("Raman_figure3.pdf", width = twocol, height = 4)
plot_grid(left,
  right,
  ncol = 2,
  rel_widths = c(0.175, 1),
  label_size = 10,
  label_fontfamily = "Helvetica",
  labels = c("A", "B")
)
dev.off()
```

\newpage

### Table 1 -- identified bands and correspondence with literature.

```{r peak loading mean, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
options(knitr.kable.NA = "")

selected_peaks <- read_csv("/home/leonard/Documents/Uni/PhD/Raman/raman_peak_detection_2.csv")

kable(selected_peaks,
  "latex",
  caption = "Peaks crucial for mutant distinction.",
  col.names = c(
    "Peak",
    "Wavenumber",
    "Lit. peak",
    "Assigned bond",
    "Assigned polymer",
    "Assigned structure",
    "Reference"
  ),
  booktabs = T,
  escape = F,
  linesep = ""
) %>%
  kable_styling(latex_options = c("striped", "hold_position", "scale_down")) %>%
  save_kable("Raman_table1.pdf")
```

\newpage
### Figure 4 -- OPLS-DA analysis and loading with main influencing bands

#### Figure 4 A -- OPLS-DA clustering

```{r iterative opls-da, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}

rmn_data_spread <- rmn_data_corrected %>%
  pivot_wider(
    id_cols = c(genotype, cell.type, replicate, technical),
    names_from = wavenumber,
    values_from = scaled
  ) %>%
  unite("genocell", genotype, cell.type, remove = F) %>%
  ungroup()

celltype_list <- list(
  "IF",
  "VB"
)
geno_list <- list(
  "Col-0",
  "4cl1",
  "4cl2",
  "4cl1x4cl2",
  "ccoaomt1",
  "fah1",
  "omt1",
  "ccr1-3",
  "cad4",
  "cad5",
  "cad4xcad5"
)

genocell_list <- expand.grid(geno_list, celltype_list) %>%
  unite(genocell_1, Var1, Var2) %>%
  mutate(genocell_2 = genocell_1) %>%
  expand(genocell_1, genocell_2) %>%
  filter(genocell_1 != genocell_2) %>%
  unite("comb", genocell_1, genocell_2, sep = ",") %>%
  lst() %>%
  unlist()

### compute and save OPLS-DA iterations ####
oplsda_iter <- function(x, y) {
  splinter <- str_split(y, fixed(","))
  genocell_1 <- splinter[[1]][[1]]
  genocell_2 <- splinter[[1]][[2]]
  rmn_mat <- data.matrix(x %>%
    filter(genocell %in% c(genocell_1, genocell_2)) %>%
    select(-genotype, -cell.type, -replicate, -technical, -genocell))
  rwnms <- x %>%
    filter(genocell %in% c(genocell_1, genocell_2)) %>%
    select(genotype, cell.type, replicate, technical) %>%
    unite("ID", genotype, cell.type, replicate, technical, sep = "_")
  rownames(rmn_mat) <- rwnms$ID
  rmn_meta <- as.matrix(x %>%
    filter(genocell %in% c(genocell_1, genocell_2)) %>%
    select(genotype, cell.type, replicate, technical, genocell))

  genocell <- rmn_meta[, "genocell"]
  if (nrow(rmn_mat) < 7) {
    rmn_oplsda <- opls(rmn_mat, genocell, predI = 1, orthoI = 1, crossvalI = nrow(rmn_mat))
  } else {
    rmn_oplsda <- opls(rmn_mat, genocell, predI = 1, orthoI = 1, crossvalI = 7)
  }

  loading <- as_tibble(getLoadingMN(rmn_oplsda), rownames = "wavenumber") %>%
    rename(loading = p1) %>%
    mutate(wavenumber = as.numeric(wavenumber))
  return(loading)
}

loadings <- vector("list", 1)
for (i in genocell_list) {
  loadings[[i]] <- oplsda_iter(rmn_data_spread, i)
}

loadings_df <- loadings[-1] %>%
  enframe() %>%
  unnest() %>%
  spread(key = wavenumber, value = loading) %>%
  separate(name, sep = ",", into = c("genocell_1", "genocell_2")) %>%
  separate(genocell_1, sep = "_", into = c("genotype_1", "cell.type_1")) %>%
  separate(genocell_2, sep = "_", into = c("genotype_2", "cell.type_2"))

loadings_df <- loadings_df[!duplicated(t(apply(loadings_df[c("genotype_1", "cell.type_1", "genotype_2", "cell.type_2")], 1, sort))), ]

write_csv(loadings_df, "loadings_df.csv")

loadings_df_mean <- loadings_df %>%
  pivot_longer(cols = -c(cell.type_1, cell.type_2, genotype_1, genotype_2),
               names_to = "wavenumber",
               values_to = "loading", ) %>%
  mutate(wavenumber = as.numeric(wavenumber)) %>%
  group_by(wavenumber) %>%
  summarise(loading.mean = mean(abs(loading)))

write_csv(loadings_df_mean, "loadings_df_mean.csv")

rmn_data_loading <- rmn_data_corrected %>%
  group_by(wavenumber) %>%
  summarise(
    mean.scaled = mean(scaled, na.rm = TRUE)
  ) %>%
  left_join(loadings_df_mean)

write_csv(rmn_data_loading, "rmn_data_loading.csv")

#### read in OPLS-DA iterations if previously computed ####
# loadings_df <- read_csv("loadings_df.csv")
# rmn_data_loading <- read_csv("rmn_data_loading.csv")
# loadings_df_mean <- read_csv("loadings_df_mean.csv")
```

```{r opls-da clustering, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
rmn_data_load_cluster <- loadings_df %>%
  mutate_if(is.numeric, abs) %>%
  unite("ID", c(genotype_1:cell.type_2)) %>%
  column_to_rownames("ID") %>%
  as.matrix()

# Ward Hierarchical Clustering
d <- dist(rmn_data_load_cluster, method = "euclidean") # distance matrix
fit <- hclust(d, method = "ward")

loadings_long <- loadings_df %>%
  pivot_longer(cols = -c(1:4), names_to = "wavenumber", values_to = "loading") %>%
  unite("ID", 1:4) %>%
  mutate(
    loading = abs(loading),
    ID = ordered(ID, levels = unique(ID)[fit$order]),
    wavenumber = as.integer(wavenumber)
  ) %>%
  group_by(ID) %>%
  complete(wavenumber = 300:1700) %>%
  fill(loading)

heatmap <- ggplot(loadings_long) +
  geom_tile(aes(
    x = wavenumber,
    y = ID,
    fill = loading
  )) +
  scale_x_reverse(expand = c(0, 0)) +
  scale_fill_viridis_c() +
  labs(y = "Pairwise OPLS-DAs") +
  guides(fill = guide_legend(title = "Absolute\nloading")) +
  theme_leo() +
  theme(
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 1),
    legend.position = c(0.995, 0.995),
    legend.background = element_rect(
      fill = rgb(1, 1, 1, 0.75),
      colour = NA
    ),
    legend.direction = "horizontal",
    legend.key.width = unit(4, "mm"),
    legend.key.height = unit(4, "mm"),
    plot.margin = unit(c(2, 0.25, 0, 3), "mm")
  )

# pdf("heatmap.pdf")
# heatmap
# dev.off()
```

#### Figure 4 B -- OPLS-DA average

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

rmn_data_loading <- rmn_data_corrected %>%
  group_by(wavenumber) %>%
  summarise(
    mean.scaled = mean(scaled, na.rm = TRUE)
  ) %>%
  left_join(loadings_df_mean) %>%
  left_join(select(selected_peaks, peak, wavenumber) %>%
    mutate(wavenumber = as.numeric(wavenumber)))

loadings_avg <- ggplot(data = rmn_data_loading, aes(
  y = rollmean(mean.scaled, 3, na.pad = TRUE),
  x = wavenumber
)) +
  geom_ridgeline_gradient(aes(
    height = 0.01 - rollmean(mean.scaled, 3, na.pad = TRUE),
    fill = loading.mean
  ),
  colour = NA
  ) +
  geom_line(size = 0.2) +
  scale_x_reverse(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(
    x = expression(paste("Wavenumber [cm"^-1, "]")),
    y = "Normalised intensity"
  ) +
  scale_fill_viridis_c() +
  theme_leo() +
  guides(fill = guide_legend(title = "Mean absolute\nloading")) +
  geom_label_repel(aes(label = peak),
    nudge_y = 0.0025,
    family = "Helvetica",
    segment.colour = "black",
    size = ggtext_size,
    label.size = 0.2,
    label.r = 0,
    alpha = 0.95,
    segment.alpha = 1,
    segment.size = 0.2
  ) +
  theme(
    legend.justification = c(1, 1),
    legend.position = c(0.995, 0.995),
    legend.background = element_rect(
      fill = rgb(1, 1, 1, 0.75),
      colour = NA
    ),
    legend.direction = "horizontal",
    legend.key.width = unit(4, "mm"),
    legend.key.height = unit(4, "mm"),
    # panel.border = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    # axis.title.x = element_blank(),
    plot.margin = unit(c(2, 0.25, 2, 3), "mm")
  )

# pdf("heatmap_avg.pdf")
# loadings_avg
# dev.off()

pdf("Raman_figure4.pdf", width = twocol, height = 3)
plot_grid(heatmap,
  loadings_avg,
  ncol = 1,
  rel_heights = c(0.5, 1),
  labels = c("A", "B"),
  # align = "h",
  # axis = "l",
  label_size = 10,
  label_fontfamily = "Helvetica",
  label_x = -0.005,
  label_y = 1.03
)
dev.off()
```

### Figure 5 -- correlation analysis with pyrolysis/GC-MS

#### Figure 5 A -- normalised to AUC

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

py <- read.csv("/home/leonard/Documents/Uni/PhD/Raman/pyrolysis_2018_amount.csv")

py$`G-OH` <- ifelse(
  py$variable == "mean",
  py$X17 + py$X19 + py$X23,
  sqrt(
    py$X17^2 + py$X19^2 + py$X23^2
  )
)
py$`S-OH` <- py$X33
py$H <-
  ifelse(py$variable == "mean", rowSums(py[, 7:9]), sqrt(rowSums(py[, 7:9]^
    2)))
py$G <-
  ifelse(py$variable == "mean", rowSums(py[, 7:19]), sqrt(rowSums(py[, 7:19]^
    2)))
py$S <-
  ifelse(py$variable == "mean", rowSums(py[, 21:28]), sqrt(rowSums(py[, 21:28]^
    2)))
py$S.G <- py$S / py$G
py$H.G <- py$H / py$G
py$Coniferaldehyde <- py$X22
py$Vanillin <- py$X18
py$Sinapaldehyde <- py$X32
py$Syringaldehyde <- py$X29
py$CHO <-
  ifelse(
    py$variable == "mean",
    py$Coniferaldehyde + py$Sinapaldehyde + py$Vanillin + py$Syringaldehyde,
    sqrt(
      py$Coniferaldehyde^2 + py$Sinapaldehyde^2 + py$Vanillin^2 + py$Syringaldehyde^2
    )
  )
py$Lignin <-
  ifelse(py$variable == "mean", rowSums(py[, 3:28]), sqrt(rowSums(py[, 3:28]^
    2)))

py <- py %>%
  select(genotype, variable, G, H, `G-OH`, Lignin, S, CHO) %>%
  pivot_longer(-c(genotype, variable), names_to = "unit", values_to = "value")

py_rmn <- rmn_data_avg %>%
  filter(wavenumber %in% selected_peaks$wavenumber) %>%
  group_by(genotype, wavenumber) %>%
  summarise(total.mean.scaled = mean(mean.scaled))


# pdf("rmn_covariance.pdf")
# corrplot(cor(spread(py_rmn, key = wavenumber, value = total.mean.scaled)[,-1]))
# dev.off()

py_rmn_corr <- left_join(py, py_rmn) %>%
  ungroup() %>%
  mutate(unit = recode(unit,
    "G-OH" = "G-CHOH",
    "H" = "H-R",
    "G" = "G-R",
    "S" = "S-R",
    "CHO" = "R-CHO"
  )) %>%
  mutate(
    unit = ordered(unit, levels = c("Lignin", "G-R", "G-CHOH", "S-R", "H-R", "R-CHO")),
    units_parsed = factor(unit, labels = c(
      "Lignin",
      "G[R]",
      "G[CHOH]",
      "S[R]",
      "H[R]",
      "R[CHO]"
    ))
  )


py_rmn_corr_mat <- py_rmn_corr %>%
  filter(variable == "mean") %>%
  group_by(units_parsed, wavenumber) %>%
  nest() %>%
  mutate(
    cor = map(data, ~ cor.test(.x$value, .x$total.mean.scaled)),
    tidied = map(cor, tidy)
  ) %>%
  unnest(tidied)

py_rmn_corr <- py_rmn_corr %>%
  filter(variable == "mean") %>%
  ungroup() %>%
  mutate(
    value = scale_range(value),
    total.mean.scaled = scale_range(total.mean.scaled)
  )

total_corr <- ggplot(data = py_rmn_corr) +
  geom_rect(
    data = py_rmn_corr_mat,
    xmin = -Inf,
    xmax = Inf,
    ymin = -Inf,
    ymax = Inf,
    aes(fill = if_else(p.value < 0.05, estimate, NULL))
  ) +
  geom_point(aes(
    x = value,
    y = total.mean.scaled
  ),
  size = 0.5,
  alpha = 0.75,
  shape = 16
  ) +
  scale_fill_distiller(
    palette = "RdYlBu",
    na.value = "white",
    name = "Pearson's r (if p < 0.05)",
    limits = c(-1, 1)
  ) +
  guides(fill = guide_legend(title.position = "top")) +
  labs(
    x = expression(paste("Pyrolysate * total pyrolysate"^-1)),
    y = expression(paste("Raman average (IF:VB 1:1) * AUC"^-1))
  ) +
  theme_leo() +
  theme(
    legend.position = "bottom",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    strip.text = element_text(size = 8),
    legend.key.width = unit(4, "mm")
  ) +
  facet_grid(reorder(wavenumber, as.numeric(wavenumber)) ~ units_parsed, labeller = label_parsed)

pdf("pyro_correlations.pdf", height = 6, width = onecol)
total_corr
dev.off()
```

#### Figure 5 B -- ratios

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

py <- read.csv("/home/leonard/Documents/Uni/PhD/Raman/pyrolysis_2018_amount.csv")

py$Coniferaldehyde <- py$X22
py$Vanillin <- py$X18
py$Sinapaldehyde <- py$X32
py$Syringaldehyde <- py$X29
py$GOH <- ifelse(
  py$variable == "mean",
  py$X17 + py$X19 + py$X23,
  sqrt(py$X17^2 + py$X19^2 + py$X23^2)
)
py$`S-OH` <- py$X33
py$`S-CHO` <- py$X32
py$`S-CHOs` <- ifelse(
  py$variable == "mean",
  py$X32 + py$X30 + py$X29,
  sqrt(py$X32^2 + py$X30^2 + py$X29^2)
)
py$`SnoCHO` <- ifelse(
  py$variable == "mean",
  py$X26 + py$X27 + py$X31 + py$X28 + py$X33,
  sqrt(py$X27^2 + py$X31^2 + py$X28^2 + py$X26^2 + py$X33^2)
)
py$GCHO <- ifelse(
  py$variable == "mean",
  py$X18 + py$X22,
  sqrt(py$X18^2 + py$X22^2)
)
py$Aldehydes <-
  ifelse(
    py$variable == "mean",
    py$Coniferaldehyde + py$Sinapaldehyde + py$Vanillin + py$Syringaldehyde,
    sqrt(
      py$Coniferaldehyde^2 + py$Sinapaldehyde^2 + py$Vanillin^2 + py$Syringaldehyde^2
    )
  )
py$H <-
  ifelse(py$variable == "mean", rowSums(py[, 7:9]), sqrt(rowSums(py[, 7:9]^
    2)))
py$G <-
  ifelse(py$variable == "mean", rowSums(py[, 7:19]), sqrt(rowSums(py[, 7:19]^
    2)))
py$S <-
  ifelse(py$variable == "mean", rowSums(py[, 21:28]), sqrt(rowSums(py[, 21:28]^
    2)))
py$SnoOH <-
  ifelse(py$variable == "mean", rowSums(py[, 21:27]), sqrt(rowSums(py[, 21:27]^
    2)))
py$Lignin <-
  ifelse(py$variable == "mean", rowSums(py[, 3:28]), sqrt(rowSums(py[, 3:28]^
    2)))
py$`GCHO/G` <- py$GCHO / py$G
py$`GOH/G` <- py$GOH / py$G
py$`GCHO/GOH` <- py$Coniferaldehyde / py$GOH
py$`GCHO/lig` <- py$GCHO / py$Lignin
py$`Aldehydes/lig` <- py$Aldehydes / py$Lignin
py$`S/G` <- py$S / py$G
py$`H/G` <- py$H / py$G
py$`H/S` <- py$H / py$S

py <- py %>%
  select(-starts_with("X")) %>%
  pivot_longer(-c(genotype, variable), names_to = "unit", values_to = "value") %>%
  pivot_wider(id_cols = c("genotype", "unit"), names_from = variable, values_from = value)

py_rmn <- rmn_data_corrected %>%
  filter(wavenumber %in% selected_peaks$wavenumber) %>%
  group_by(cell.type, genotype, wavenumber, replicate, technical) %>%
  pivot_wider(
    id_cols = c(genotype, cell.type, replicate, technical), names_from = wavenumber,
    values_from = scaled
  ) %>%
  group_by(cell.type, genotype, replicate, technical) %>%
  transmute(
    "CLB" = (`1603` / 2) + `1334`,
    "1334/1603" = `1334` / `1603`,
    "1664/1603" = `1664` / `1603`,
    "1334/1276" = `1334` / `1276`,
    "1625/1603" = `1625` / `1603`,
    "1625/1664" = `1625` / `1664`,
    "1625/lig" = `1625` / ((`1603` / 2) + `1334`),
    "1625" = `1625`,
    "1334" = `1334`,
    "1603" = `1603`
  ) %>%
  pivot_longer(cols = -c(genotype, cell.type, replicate, technical), names_to = "wavenumber", values_to = "scaled") %>%
  group_by(genotype, wavenumber, cell.type) %>%
  summarise(
    mean.scaled = mean(scaled),
    sd.scaled = sd(scaled) / mean.scaled
  ) %>%
  group_by(genotype, wavenumber) %>%
  summarise(
    total.mean.scaled = mean(mean.scaled),
    total.sd.scaled = total.mean.scaled * sqrt(sum(sd.scaled^2))
  )

py_rmn_corr <- left_join(py, py_rmn) %>%
  mutate(WT = case_when(
    genotype == "Col-0" ~ "yes",
    TRUE ~ "no"
  ))

py_rmn_corr_mat <- py_rmn_corr %>%
  # filter(variable == "mean") %>%
  group_by(unit, wavenumber) %>%
  nest() %>%
  mutate(
    cor = map(data, ~ cor.test(.x$mean, .x$total.mean.scaled)),
    tidied = map(cor, tidy)
  ) %>%
  unnest(tidied)

broom::glance(lm(mean ~ total.mean.scaled, data = filter(py_rmn_corr, unit == "Lignin" &
  wavenumber == "CLB")))

# broom::tidy(lm(Lignin ~ `1603` + `1334`, data = filter(py_rmn_corr, variable == "mean")))





py_plot <- function(x, y, z = "bork", col = "white") {
  tidycor <- broom::tidy(cor.test(
    as.matrix(filter(py_rmn_corr, unit == x &
      wavenumber == y &
      genotype != z)[, "mean"]),
    as.matrix(filter(py_rmn_corr, unit == x &
      wavenumber == y &
      genotype != z)[, "total.mean.scaled"])
  ))
  print(tidycor)

  regr <- broom::glance(lm(mean ~ total.mean.scaled, data = filter(py_rmn_corr, unit == x &
    wavenumber == y &
    genotype != z)))

  ggplot(
    data = filter(py_rmn_corr, unit == x & wavenumber == y & genotype != z),
    aes(x = mean, y = total.mean.scaled)
  ) +
    geom_rect(
      data = tidycor,
      xmax = Inf,
      ymax = Inf,
      xmin = -Inf,
      ymin = -Inf,
      aes(
        fill = estimate,
        x = 0,
        y = 0
      )
    ) +
    geom_errorbar(aes(
      ymin = total.mean.scaled - total.sd.scaled,
      ymax = total.mean.scaled + total.sd.scaled
    ),
    size = 0.2,
    width = 0,
    alpha = 0.75
    ) +
    # geom_errorbarh(aes(xmin = mean - sd,
    #                   xmax = mean + sd),
    #               size = 0.2,
    #               height = 0) +
    geom_point(aes(colour = WT),
      size = 1,
      alpha = 0.75,
      shape = 16
    ) +
    geom_smooth(
      method = "lm",
      fullrange = T,
      size = 0.4,
      se = F,
      linetype = 1,
      colour = col
    ) +
    scale_colour_manual(values = c("yes" = "white", no = "black")) +
    scale_fill_distiller(
      palette = "RdYlBu",
      na.value = "white",
      name = "Pearson's r",
      limits = c(-1, 1)
    ) +
    scale_x_continuous(limits = c(0, NA)) +
    scale_y_continuous(limits = c(0, NA)) +
    annotate("text",
      label = paste("R² = ", round(regr$adj.r.squared, digits = 2)),
      x = 0,
      y = 0,
      size = ggtext_size,
      family = "Helvetica",
      hjust = 0,
      vjust = 0,
      colour = col
    ) +
    theme_leo() +
    theme(
      axis.text.y = element_text(
        angle = 90,
        hjust = 0.5
      ),
      plot.margin = unit(c(4, 2, 4, 4), "mm")
    )
  # geom_label_repel(aes(label = genotype),
  #                  size = 1,
  #                  segment.size = 0.2)
}

py_plot_lig <- py_plot("Lignin", "CLB") +
  labs(
    x = expression(paste("Lignin * total pyrolysate"^-1)),
    y = expression(paste("CLB [AU * AUC"^-1, "]"))
  ) +
  scale_y_continuous(breaks = c(0, 0.005, 0.01), labels = c("0", "0.005", "0.01")) +
  scale_x_continuous(labels = c("0", "0.05", "0.1", "0.15"))

py_plot_sg <- py_plot("S/G", "1334/1276") +
  labs(
    x = expression(paste("S"[R], " * G"[R]^{
      -1
    })),
    y = expression(paste("1334 cm"^-1, "/ 1276 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 1, 2, 3)) +
  scale_x_continuous(labels = c("0", "0.1", "0.2", "0.3", "0.4"))

py_plot_cho <- py_plot("GCHO/lig", "1625/lig") +
  labs(
    x = expression(paste("G"[CHO], " * lignin"^-1)),
    y = expression(paste("1625 cm"^-1, "/ CLB"))
  ) +
  scale_y_continuous(breaks = c(0, 0.4, 0.8), labels = c("0", "0.4", "0.8")) +
  scale_x_continuous(labels = c("0", "0.1", "0.2", "0.3", "0.4")) +
  geom_point(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype == "cad4xcad5"),
    aes(colour = WT),
    size = 1,
    alpha = 0.75,
    shape = 16
  ) +
  geom_errorbar(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype == "cad4xcad5"),
    aes(
      ymin = total.mean.scaled - total.sd.scaled,
      ymax = total.mean.scaled + total.sd.scaled
    ),
    size = 0.2,
    width = 0,
    alpha = 0.75
  ) +
  geom_smooth(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype != "cad4xcad5"),
    method = "lm",
    colour = "black",
    fullrange = T,
    size = 0.4,
    se = F,
    linetype = 2
  )
# annotate("text",
#          label = "R² = −0.12",
#          x = 0,
#          y = 0.1,
#          size = ggtext_size,
#          family = "Helvetica",
#          hjust = 0,
#          vjust = 0,
#             colour = "blue")

py_plot_goh <- py_plot("GOH/G", "1664/1603") +
  labs(
    x = expression(paste("G"^{
      OH
    }, " * total G-lignin"^-1)),
    y = expression(paste("1664 cm"^-1, "/ 1603 cm"^-1))
  )
# scale_y_continuous(breaks = c(0, 1, 2, 3))

py_plot_snooh <- py_plot("SnoOH", "1334") +
  labs(
    x = expression(paste("S-lignin " - " S-OH")),
    y = expression(paste("1334 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
  scale_x_continuous(breaks = c(0, 0.01, 0.02), labels = c("0", "0.01", "0.02"))

py_plot_soh <- py_plot("S-OH", "1334") +
  labs(
    x = expression(paste("S-OH")),
    y = expression(paste("1334 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
  scale_x_continuous(breaks = c(0, 0.005, 0.01), labels = c("0", "0.005", "0.01"))

py_plot_scho <- py_plot("S-CHO", "1334") +
  labs(
    x = expression(paste("S-CHO")),
    y = expression(paste("1334 cm"^-1))
  )
# scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
# scale_x_continuous(breaks = c(0, 0.005, 0.01), labels = c("0", "0.005", "0.01"))

py_plot_snocho <- py_plot("SnoCHO", "1334") +
  labs(
    x = expression(paste("S" - "S-CHO")),
    y = expression(paste("1334 cm"^-1))
  )


pdf("Raman_figure5.pdf", width = onehalfcol, height = 5)
right <- plot_grid(py_plot_lig,
  py_plot_sg,
  py_plot_cho,
  # py_plot_soh,
  # py_plot_snocho,
  # py_plot_snooh,
  ncol = 1,
  labels = c("", "C", "D"),
  label_size = 10,
  label_fontfamily = "Helvetica"
  # label_x = -0.02,
  # label_y = 1.01
)
plot_grid(plot_grid(total_corr),
  right,
  labels = c("A", "B"),
  label_size = 10,
  label_fontfamily = "Helvetica",
  # label_x = -0.005,
  # label_y = 1.01,
  rel_widths = c(1, 0.6),
  ncol = 2,
  align = "hv",
  axis = "t"
)
dev.off()
```

\newpage

### Table 2 -- Raman bands validated by Py-GC/MS

```{r validated peaks, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
options(knitr.kable.NA = "")

validated_peaks <- read_csv("/home/leonard/Documents/Uni/PhD/Raman/validated_peaks.csv", col_types = "cccccc") %>%
  filter(assigned.structure != "H-units")


# kable(validated_peaks,
#   "latex",
#   align = "lllllcccc",
#   caption = "Raman bands validated by Py--GC/MS.",
#   col.names = c(
#     "Band no.",
#     "Band intensity at",
#     "Normalised to",
#     "Assigned polymer",
#     "Assigned structure",
#     "Pearson's r",
#     "P-value",
#     "Pearson's r",
#     "P-value"
#   ),
#   booktabs = TRUE,
#   linesep = ""
# ) %>%
#   kable_styling(latex_options = c("hold_position", "striped", "scale_down")) %>%
#   add_header_above(c(" " = 5, "Total pyrolysate" = 2, "Total lignin" = 2)) %>%
#   save_kable("Raman_table2.pdf")
```

\newpage

### Figure 6 -- mutational impact on different tissues

The values in these last figures are transformed quite a bit. Starting with the baseline corrected absolute peak height (abs.), I divided abs. at each wavelength by the respective spectra's peak height of the lignin peak (abs.~lignin~). I then z-scaled each wavenumber across genotypes and cell types to bring everything on the same scale. After that, the z-score of the WT is subtracted from the Z-score of each mutant and cell type for each wavenumber of interest. In short: 

Normalised Intensity $x =  \frac{abs.}{abs._{Lignin}}$

z-scaled intensity $x_{z} = x - \frac{\overline{x}}{\sigma_{x}}$

Plotted difference from the WT $\Delta x_{z} = x_{z} - x_{z}^{WT}$

#### Relative to AUC

```{r change correlations absolute, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

rmn_data_corr <- rmn_data_corrected %>%
  filter(wavenumber %in% c(1603, 1664, 1334, 381, 1099)) %>%
  mutate(wavenumber = as.character(wavenumber)) %>%
  ungroup() %>%
  pivot_wider(
    id_cols = c(genotype:technical),
    names_from = wavenumber,
    values_from = scaled
  ) %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  mutate("CLB" = `1603` + 4.6 * `1334`) %>%
  # select(-`1603`) %>%
  pivot_longer(
    cols = -c(genotype, cell.type, replicate, technical),
    names_to = "wavenumber",
    values_to = "scaled"
  ) %>%
  ungroup() %>%
  group_by(wavenumber) %>%
  mutate(scaled.z = scale_z(scaled)) %>%
  select(genotype, cell.type, replicate, technical, scaled.z)

rmn_data_corr <- rmn_data_corr %>%
  left_join(filter(rmn_data_corr, genotype == "Col-0") %>%
    ungroup() %>%
    select(wavenumber, cell.type, scaled.z, replicate, technical) %>%
    group_by(wavenumber, cell.type) %>%
    summarise(scaled.WT = mean(scaled.z))) %>%
  mutate(diff = scaled.z - scaled.WT) %>%
  select(-scaled.z, -scaled.WT) %>%
  spread(key = cell.type, value = diff) %>%
  ungroup()

rmn_data_corr <- left_join(rmn_data_corr, (validated_peaks %>%
  mutate(wavenumber = recode(wavenumber, "1603, 1334" = "CLB")) %>%
  rbind(list(13, "381", "AUC", "Cellulose", "Cellulose", 0, 0, 0, 0)) %>%
  rbind(list(10, "1099", "AUC", "Cellulose", "Cellulose", 0, 0, 0, 0)))) %>%
  drop_na() %>%
  group_by(genotype, replicate, technical, assigned.structure) %>%
  summarise(
    IF = mean(IF),
    VB = mean(VB)
  ) %>%
  ungroup()

rmn_data_corr_it <- rmn_data_corr %>%
  ungroup() %>%
  select(genotype, assigned.structure, IF, VB) %>%
  group_by(genotype, assigned.structure) %>%
  expand(IF, VB)


rel_auc <- ggplot(data = filter(rmn_data_corr, genotype != "Col-0")) +
  annotate("rect",
    xmin = -Inf,
    xmax = 0,
    ymin = -Inf,
    ymax = 0,
    fill = "grey95"
  ) +
  annotate("rect",
    xmin = Inf,
    xmax = 0,
    ymin = Inf,
    ymax = 0,
    fill = "grey95"
  ) +
  geom_abline(slope = 1, intercept = 0, linetype = 2, size = 0.2) +
  stat_density2d(
    data = filter(rmn_data_corr_it, genotype != "Col-0"),
    aes(
      x = VB,
      y = IF,
      alpha = stat(nlevel),
      fill = assigned.structure
    ),
    geom = "polygon",
    h = c(2, 2),
    bins = 6
  ) +
  scale_alpha(range = c(0, 0.7)) +
  guides(alpha = "none") +
  # geom_point(aes(
  #   x = VB,
  #   y = IF,
  #   # fill = assigned.structure,
  #   colour = assigned.structure
  # ),
  # size = 1,
  # shape = 16,
  # alpha = 0.5
  # ) +
  # stat_ellipse(aes(
  #   x = VB,
  #   y = IF,
  #   fill = assigned.structure,
  # ), geom = "polygon", alpha = 0.5, type = "t", level = 0.4) +
  # stat_ellipse(aes(
  #   x = VB,
  #   y = IF,
  #   colour = assigned.structure,
  # ), alpha = 0.85, type = "t", level = 0.4) +
  # geom_label_repel(data = filter(rmn_data_corr,
  #                                IF - PMX > 1 | IF -PMX < -1),
  #                  aes(x = PMX,
  #                      y = IF,
  #                      label = wavenumber),
  #   nudge_y = 0.25,
  #   family = "Helvetica",
  #   segment.colour = "red",
  #   size = 2.5
  # ) +
  theme_leo() +
  theme(
    axis.title = element_text(),
    axis.text.x = element_text(angle = 0),
    legend.position = c(1.005, 0),
    legend.justification = c(0, 0),
    legend.text.align = 0,
    legend.direction = "vertical",
    legend.key.width = unit(4, "mm"),
    strip.text = element_text(size = 8),
    # legend.title = element_blank(),
    plot.margin = unit(c(2, 20, 2, 2), "mm")
  ) +
  labs(
    x = "Change in the vascular bundle",
    y = "Change in the interfascicular fibres"
  ) +
  scale_fill_manual(
    values = c(
      "G-units" = "#5DA5DA",
      "Cellulose" = "#FAA43A",
      "G-OH" = "#60BD68",
      "S-units" = "#F17CB0",
      "Total lignin" = "#B2912F"
    ),
    name = "Total\namount",
    labels = c(
      "Cellulose",
      expression("G"[CHOH]),
      expression("G"[R]),
      expression("S"[R]),
      "Lignin"
    )
  ) +
  # scale_colour_manual(values = c(
  #   "G-units" = "#5DA5DA",
  #   "Cellulose" = "#FAA43A",
  #   "G-OH" = "#60BD68",
  #   "S-units" = "#F17CB0",
  #   "Total lignin" = "#B2912F"
  # ),
  # name = "Total\namount") +
  scale_x_continuous(limits = c(-4, 4)) +
  scale_y_continuous(limits = c(-4, 4)) +
  coord_fixed() +
  facet_wrap(~genotype, ncol = 5)

pdf("IF_MX_corr.pdf")
rel_auc
dev.off()
```

\newpage

#### Relative to total lignin

```{r change correlations composition, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

rmn_data_corr <- rmn_data_corrected %>%
  filter(wavenumber %in% c(1664, 1603, 1334)) %>%
  # group_by(genotype, cell.type, replicate, technical) %>%
  mutate(wavenumber = as.character(wavenumber)) %>%
  # ungroup() %>%
  # pivot_wider(
  #   id_cols = c(genotype:technical),
  #   names_from = wavenumber,
  #   values_from = scaled_lig
  # ) %>%
  # group_by(genotype, cell.type, replicate, technical) %>%
  # # mutate("1625 / 1603" = `1625`) %>%
  # # select(-`1603`) %>%
  # pivot_longer(
  #   cols = -c(genotype, cell.type, replicate, technical),
  #   names_to = "wavenumber",
  #   values_to = "scaled_lig"
  # ) %>%
  ungroup() %>%
  group_by(wavenumber) %>%
  mutate(scaled.z = scale_z(scaled_lig)) %>%
  select(genotype, cell.type, replicate, technical, scaled.z)

# %>%
#   ungroup() %>%
#   group_by(genotype, cell.type, wavenumber) %>%
#   summarise(mean.scaled = mean(scaled.z))

rmn_data_corr <- rmn_data_corr %>%
  left_join(filter(rmn_data_corr, genotype == "Col-0") %>%
    ungroup() %>%
    select(wavenumber, cell.type, scaled.z, replicate, technical) %>%
    group_by(wavenumber, cell.type) %>%
    summarise(scaled.WT = mean(scaled.z))) %>%
  mutate(diff = scaled.z - scaled.WT) %>%
  select(-scaled.z, -scaled.WT) %>%
  spread(key = cell.type, value = diff) %>%
  ungroup() %>%
  mutate(wavenumber = as.character(wavenumber))

rmn_data_corr <- left_join(rmn_data_corr, validated_peaks)
# %>%
#   rbind(list(13, "381", "Total lignin", "Cellulose", "Cellulose", 0, 0, 0, 0, 0, 0)) %>%
#   rbind(list(10, "1099", "Total lignin",  "Cellulose", "Cellulose", 0, 0, 0, 0, 0, 0))))

rmn_data_corr_it <- rmn_data_corr %>%
  ungroup() %>%
  select(genotype, assigned.structure, IF, VB) %>%
  group_by(genotype, assigned.structure) %>%
  expand(IF, VB)

# pdf("IF_MX_corr.pdf")
rel_lig <- ggplot(data = filter(rmn_data_corr, genotype != "Col-0")) +
  annotate("rect",
    xmin = -Inf,
    xmax = 0,
    ymin = -Inf,
    ymax = 0,
    fill = "grey95"
  ) +
  annotate("rect",
    xmin = Inf,
    xmax = 0,
    ymin = Inf,
    ymax = 0,
    fill = "grey95"
  ) +
  geom_abline(slope = 1, intercept = 0, linetype = 2, size = 0.2) +
  stat_density2d(
    data = filter(rmn_data_corr_it, genotype != "Col-0"),
    aes(
      x = VB,
      y = IF,
      alpha = stat(nlevel),
      fill = assigned.structure
    ),
    geom = "polygon",
    h = c(2, 2),
    bins = 6
  ) +
  scale_alpha(range = c(0, 0.75)) +
  guides(alpha = "none") +
  # geom_point(aes(
  #   x = VB,
  #   y = IF,
  #   # fill = assigned.structure,
  #   colour = assigned.structure
  # ),
  # size = 1,
  # shape = 16,
  # alpha = 0.5
  # ) +
  # stat_ellipse(
  #   data = filter(rmn_data_corr, genotype != "Col-0" & wavenumber != 1383),
  #   aes(
  #     x = VB,
  #     y = IF,
  #     fill = assigned.structure,
  #   ), geom = "polygon", alpha = 0.5, type = "t", level = 0.4
  # ) +
  # stat_ellipse(
  #   data = filter(rmn_data_corr, genotype != "Col-0" & wavenumber == 1383),
  #   aes(
  #     x = VB,
  #     y = IF,
  #     colour = assigned.structure,
  #   ), alpha = 0.85, type = "t", level = 0.4, linetype = 2, size = 0.25
  # ) +
  # stat_ellipse(
  #   data = filter(rmn_data_corr, genotype != "Col-0" & wavenumber != 1383),
  #   aes(
  #     x = VB,
  #     y = IF,
  #     colour = assigned.structure,
  #   ), alpha = 0.85, type = "t", level = 0.4
  # ) +
  # geom_label_repel(data = filter(rmn_data_corr,
  #                                IF - PMX > 1 | IF -PMX < -1),
  #                  aes(x = PMX,
  #                      y = IF,
  #                      label = wavenumber),
  #   nudge_y = 0.25,
  #   family = "Helvetica",
  #   segment.colour = "red",
  #   size = 2.5
  # ) +
  theme_leo() +
  theme(
    axis.title = element_text(),
    axis.text.x = element_text(angle = 0),
    legend.position = c(1.005, 0),
    legend.justification = c(0, 0),
    legend.text.align = 0,
    strip.text = element_text(size = 8),
    legend.direction = "vertical",
    legend.key.width = unit(4, "mm"),
    # legend.title = element_blank(),
    plot.margin = unit(c(2, 20, 2, 2), "mm")
  ) +
  labs(
    x = "Change in the vascular bundle",
    y = "Change in the interfascicular fibres"
  ) +
  scale_fill_manual(
    values = c(
      "G-units" = "#5DA5DA",
      "G-OH" = "#60BD68",
      "S-units" = "#F17CB0"
    ),
    name = "Relative\namount",
    labels = c(
      expression("G"[CHOH]),
      expression("G"[R]),
      expression("S"[R])
    )
  ) +
  scale_x_continuous(limits = c(-4, 4)) +
  scale_y_continuous(limits = c(-4, 4)) +
  coord_fixed() +
  facet_wrap(~genotype, ncol = 5)
# dev.off()

schemes <-
  rasterGrob(image_read_pdf(
    "/home/leonard/Dropbox/Raman manuscript/Edits/Raman_figure7.pdf"
  ))

pdf("Raman_figure6.pdf", width = twocol, height = 8)
plot_grid(
  rel_auc,
  rel_lig,
  schemes,
  labels = c("A", "B", ""),
  label_size = 10,
  hjust = 0,
  label_fontfamily = "Helvetica",
  # label_x = -0.005,
  # label_y = 1.01,
  # rel_widths = c(0.7, 0.5),
  ncol = 1
  # align = "hv",
  # axis = "l"
)
dev.off()
```

\newpage

### Supplemental figures

#### PCA supplement

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
top <- plot_grid(
  fviz_pca_var(pca_result,
    select.var = list(contrib = 10),
    repel = TRUE,
    title = "",
    font.family = "Helvetica",
    col.var = "black",
    alpha.var = 0.4,
    ggtheme = theme_few()
  ),
  fviz_eig(pca_result,
    main = "",
    font.family = "Helvetica",
    ggtheme = theme_few(),
    barcolor = NA,
    barfill = "#1d91c0"
  ),
  labels = c("A", "B"),
  label_fontfamily = "Helvetica",
  label_size = 10,
  # rel_widths = c(2, 1),
  nrow = 2,
  align = "h"
)

mid <- plot_grid(
  fviz_contrib(pca_result,
    choice = "var",
    axes = 1,
    top = 12,
    title = "",
    font.family = "Helvetica",
    ggtheme = theme_few(),
    color = NA,
    fill = "#1d91c0"
  ),
  fviz_contrib(pca_result,
    choice = "var",
    axes = 2,
    top = 12,
    title = "",
    font.family = "Helvetica",
    ggtheme = theme_few(),
    color = NA,
    fill = "#1d91c0"
  ),
  labels = c("C", "D"),
  label_fontfamily = "Helvetica"
)

pca_load <- as_tibble(pca_result$rotation, rownames = "wavenumber") %>%
  mutate(wavenumber = as.numeric(wavenumber))
bottom_PC1 <- ggplot(pca_load, aes(x = wavenumber, y = PC1)) +
  geom_line() +
  labs(
    title = "PC1",
    x = expression(paste("Wavenumber [cm"^-1, "]"))
  ) +
  # geom_text_repel(data = filter(pca_load, PC1 > 0.07),
  #           aes(label = wavenumber)) +
  # geom_text_repel(data = filter(pca_load, PC1 < - 0.065),
  #           aes(label = wavenumber)) +
  theme_leo() +
  theme(axis.title.y = element_blank())

bottom_PC2 <- ggplot(pca_load, aes(x = wavenumber, y = PC2)) +
  geom_line() +
  labs(
    title = "PC2",
    x = expression(paste("Wavenumber [cm"^-1, "]"))
  ) +
  # geom_text_repel(data = filter(pca_load, PC2 > 0.08),
  #           aes(label = wavenumber)) +
  # geom_text_repel(data = filter(pca_load, PC2 < - 0.07),
  #           aes(label = wavenumber)) +
  theme_leo() +
  theme(axis.title.y = element_blank())

pdf("Raman_figureS1.pdf", width = twocol, height = 3)
plot_grid(
  fviz_pca_var(pca_result,
    select.var = list(name = c(1300, 1119, 1664, 1603, 1276, 1099, 1334)),
    repel = TRUE,
    title = "",
    font.family = "Helvetica",
    col.var = "black",
    alpha.var = 0.4,
    ggtheme = theme_leo()
  ),
  plot_grid(
    bottom_PC1,
    bottom_PC2,
    nrow = 2,
    labels = c("B", "C"),
    label_fontfamily = "Helvetica",
    label_size = 10
  ),
  nrow = 1,
  labels = c("A", ""),
  rel_widths = c(0.75, 1),
  label_fontfamily = "Helvetica",
  label_size = 10
)
dev.off()
```

#### Band contributions to total AUC

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
rmn_auc_contrib <- rmn_data_corrected %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  select(genotype, cell.type, replicate, technical, AUC:AUC_381) %>%
  distinct() %>%
  pivot_longer(cols = c(AUC_1603:AUC_381), names_to = "band", values_to = "proportion") %>%
  group_by(genotype, cell.type, replicate, technical, band) %>%
  mutate(proportion = proportion / AUC) %>%
  ungroup() %>%
  mutate(band = ordered(as.factor(band), levels = rev(c("AUC_381", "AUC_1099", "AUC_1334", "AUC_1603"))))

# pdf("Raman_figureS2.pdf", width = onecol, height = 3)
band_contribs <- ggplot(rmn_auc_contrib, aes(x = band, y = proportion)) +
  geom_quasirandom(
    aes(colour = band),
    shape = 16,
    alpha = 0.5,
    size = 0.5
  ) +
  geom_boxplot(
    alpha = 0.5,
    outlier.alpha = 0,
    fatten = 1,
    size = 0.2,
    colour = "black"
  ) +
  labs(
    x = expression(paste("Raman band [cm"^-1, "]")),
    y = expression(paste("Band AUC * total AUC"^-1))
  ) +
  scale_x_discrete(labels = c("1603", "1334", "1099", "381")) +
  scale_colour_grey() +
  # geom_label(aes(label = paste(mean(proportion)))) +
  theme_leo()
# dev.off()
```

#### Including the 381 peak

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

rmn_auc <- rmn_data_corrected %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  filter(wavenumber %in% c(1603, 1334, 1099, 381)) %>%
  select(genotype:technical, wavenumber, corrected.intensity, AUC) %>%
  pivot_wider(
    id_cols = c(genotype, cell.type, replicate, technical, AUC),
    names_from = wavenumber,
    values_from = corrected.intensity,
    names_prefix = "X"
  )

rmn_auc_lm <- broom::glance(lm(AUC ~ X1603 + X1334, data = rmn_auc))
rmn_auc_lm_full <- broom::tidy(lm(AUC ~ X1603 + X1334, data = rmn_auc))

auc_corr_lig <- ggplot(rmn_auc, aes(
  x = AUC / 1000,
  y = (X1603 + X1334) / 1000
)) +
  geom_point(
    alpha = 0.5,
    shape = 16,
    size = 0.5
  ) +
  geom_smooth(
    method = "lm",
    se = FALSE,
    size = 0.4
  ) +
  labs(
    y = "Sum of lignin bands",
    x = "Total AUC"
  ) +
  geom_text(
    x = 500,
    y = 31,
    aes(label = paste("R² =", round(adj.r.squared, digits = 2))),
    hjust = 0,
    family = "Helvetica",
    size = ggtext_size,
    data = rmn_auc_lm
  ) +
  geom_text_repel(
    data = filter(rmn_auc, ((X1603 + X1334) / 1000) > 30 | (AUC / 1000) > 3000),
    aes(label = genotype),
    size = ggtext_size,
    min.segment.length = 0,
    nudge_x = -500,
    segment.size = 0.2,
    family = "Helvetica",
    fontface = 3
  ) +
  theme_leo()

rmn_auc_lm <- broom::glance(lm(AUC ~ X1099 + X381, data = rmn_auc))
rmn_auc_lm_full <- broom::tidy(lm(AUC ~ X1099 + X381, data = rmn_auc))

auc_corr_cellu <- ggplot(rmn_auc, aes(
  x = AUC / 1000,
  y = (X1099 + X381) / 1000
)) +
  geom_point(
    alpha = 0.5,
    shape = 16,
    size = 0.5
  ) +
  geom_smooth(
    method = "lm",
    se = FALSE,
    size = 0.4
  ) +
  labs(
    y = "Sum of cellulose bands",
    x = "Total AUC"
  ) +
  geom_text(
    x = 500,
    y = 18,
    aes(label = paste("R² =", round(adj.r.squared, digits = 2))),
    hjust = 0,
    family = "Helvetica",
    size = ggtext_size,
    data = rmn_auc_lm
  ) +
  geom_text_repel(
    data = filter(rmn_auc, ((X1099 + X381) / 1000) > 15 | (AUC / 1000) > 3000),
    aes(label = genotype),
    size = ggtext_size,
    min.segment.length = 0,
    segment.size = 0.2,
    family = "Helvetica",
    fontface = 3
  ) +
  theme_leo()

rmn_auc_lm <- broom::glance(lm(AUC ~ X1603 + X1334 + X1099 + X381, data = rmn_auc))
rmn_auc_lm_full <- broom::tidy(lm(AUC ~ X1603 + X1334 + X1099 + X381, data = rmn_auc))

auc_corr <- ggplot(rmn_auc, aes(
  x = AUC / 1000,
  y = (X1603 + X1334 + X1099 + X381) / 1000
)) +
  geom_point(
    alpha = 0.5,
    shape = 16,
    size = 0.5
  ) +
  geom_smooth(
    method = "lm",
    se = FALSE,
    size = 0.4
  ) +
  labs(
    y = "Sum of lignin and cellulose bands",
    x = "Total AUC"
  ) +
  geom_text(
    x = 500,
    y = 38,
    aes(label = paste("R² =", round(adj.r.squared, digits = 2))),
    hjust = 0,
    family = "Helvetica",
    size = ggtext_size,
    data = rmn_auc_lm,
  ) +
  theme_leo()

pdf("Raman_figureS3.pdf", width = onehalfcol, height = onehalfcol)
plot_grid(band_contribs,
  auc_corr_lig,
  auc_corr_cellu,
  auc_corr,
  labels = c("A", "B", "C", "D"),
  nrow = 2,
  label_fontfamily = "Helvetica",
  label_size = 10
)
dev.off()
```

#### Spurious correlations

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
py <- read.csv("/home/leonard/Documents/Uni/PhD/Raman/pyrolysis_2018_amount.csv")

py$Coniferaldehyde <- py$X22
py$Vanillin <- py$X18
py$Sinapaldehyde <- py$X32
py$Syringaldehyde <- py$X29
py$GOH <- ifelse(
  py$variable == "mean",
  py$X17 + py$X19 + py$X23,
  sqrt(py$X17^2 + py$X19^2 + py$X23^2)
)
py$GCHO <- ifelse(
  py$variable == "mean",
  py$X18 + py$X22,
  sqrt(py$X18^2 + py$X22^2)
)
py$Aldehydes <-
  ifelse(
    py$variable == "mean",
    py$Coniferaldehyde + py$Sinapaldehyde + py$Vanillin + py$Syringaldehyde,
    sqrt(
      py$Coniferaldehyde^2 + py$Sinapaldehyde^2 + py$Vanillin^2 + py$Syringaldehyde^2
    )
  )
py$H <-
  ifelse(py$variable == "mean", rowSums(py[, 7:9]), sqrt(rowSums(py[, 7:9]^
    2)))
py$G <-
  ifelse(py$variable == "mean", rowSums(py[, 7:19]), sqrt(rowSums(py[, 7:19]^
    2)))
py$S <-
  ifelse(py$variable == "mean", rowSums(py[, 21:28]), sqrt(rowSums(py[, 21:28]^
    2)))
py$Lignin <-
  ifelse(py$variable == "mean", rowSums(py[, 3:28]), sqrt(rowSums(py[, 3:28]^
    2)))
py$`GCHO/G` <- py$GCHO / py$G
py$`GOH/G` <- py$GOH / py$G
py$`GCHO/GOH` <- py$Coniferaldehyde / py$GOH
py$`GCHO/lig` <- py$GCHO / py$Lignin
py$`Aldehydes/lig` <- py$Aldehydes / py$Lignin
py$`S/G` <- py$S / py$G
py$`H/G` <- py$H / py$G
py$`H/S` <- py$H / py$S

py <- py %>%
  select(-starts_with("X")) %>%
  pivot_longer(-c(genotype, variable), names_to = "unit", values_to = "value") %>%
  pivot_wider(id_cols = c("genotype", "unit"), names_from = variable, values_from = value)

py_rmn <- rmn_data_corrected %>%
  filter(wavenumber %in% selected_peaks$wavenumber) %>%
  group_by(cell.type, genotype, wavenumber, replicate, technical) %>%
  pivot_wider(
    id_cols = c(genotype, cell.type, replicate, technical), names_from = wavenumber,
    values_from = scaled
  ) %>%
  transmute(
    "1383/1276" = `1383` / `1276`,
    "1383/1334" = `1383` / `1334`
  ) %>%
  pivot_longer(cols = -c(genotype, cell.type, replicate, technical), names_to = "wavenumber", values_to = "scaled") %>%
  group_by(genotype, wavenumber, cell.type) %>%
  summarise(
    mean.scaled = mean(scaled),
    sd.scaled = sd(scaled) / mean.scaled
  ) %>%
  group_by(genotype, wavenumber) %>%
  summarise(
    total.mean.scaled = mean(mean.scaled),
    total.sd.scaled = total.mean.scaled * sqrt(sum(sd.scaled^2))
  )

py_rmn_corr <- left_join(py, py_rmn) %>%
  mutate(WT = case_when(
    genotype == "Col-0" ~ "yes",
    TRUE ~ "no"
  ))

py_rmn_corr_mat <- py_rmn_corr %>%
  # filter(variable == "mean") %>%
  group_by(unit, wavenumber) %>%
  nest() %>%
  mutate(
    cor = map(data, ~ cor.test(.x$mean, .x$total.mean.scaled)),
    tidied = map(cor, tidy)
  ) %>%
  unnest(tidied)

py_plot <- function(x, y, z = "bork", colr = "white") {
  tidycor <- broom::tidy(cor.test(
    as.matrix(filter(py_rmn_corr, unit == x &
      wavenumber == y &
      genotype != z)[, "mean"]),
    as.matrix(filter(py_rmn_corr, unit == x &
      wavenumber == y &
      genotype != z)[, "total.mean.scaled"])
  ))
  print(tidycor)

  regr <- broom::glance(lm(mean ~ total.mean.scaled, data = filter(py_rmn_corr, unit == x &
    wavenumber == y &
    genotype != z)))

  ggplot(
    data = filter(py_rmn_corr, unit == x & wavenumber == y & genotype != z),
    aes(x = mean, y = total.mean.scaled)
  ) +
    geom_rect(
      data = tidycor,
      xmax = Inf,
      ymax = Inf,
      xmin = -Inf,
      ymin = -Inf,
      aes(
        fill = estimate,
        x = 0,
        y = 0
      )
    ) +
    geom_errorbar(aes(
      ymin = total.mean.scaled - total.sd.scaled,
      ymax = total.mean.scaled + total.sd.scaled
    ),
    size = 0.2,
    width = 0,
    alpha = 0.75
    ) +
    # geom_errorbarh(aes(xmin = mean - sd,
    #                   xmax = mean + sd),
    #               size = 0.2,
    #               height = 0) +
    geom_point(aes(colour = WT),
      size = 1,
      alpha = 0.75,
      shape = 16
    ) +
    geom_smooth(
      method = "lm",
      fullrange = F,
      size = 0.4,
      se = F,
      linetype = 2,
      colour = colr
    ) +
    scale_colour_manual(values = c("yes" = "white", no = "black"), guide = "none") +
    scale_fill_distiller(
      palette = "RdYlBu",
      na.value = "white",
      name = "Pearson's r",
      limits = c(-1, 1),
      guide = "legend"
    ) +
    scale_x_continuous(limits = c(0, NA)) +
    scale_y_continuous(limits = c(0, NA)) +
    annotate("text",
      label = paste("R² = ", round(regr$adj.r.squared, digits = 2)),
      x = 0,
      y = 0,
      size = ggtext_size,
      family = "Helvetica",
      hjust = 0,
      vjust = 0,
      colour = colr
    ) +
    theme_leo() +
    theme(
      axis.text.y = element_text(
        angle = 90,
        hjust = 0.5
      ),
      plot.margin = unit(c(4, 2, 4, 2), "mm")
    )
  # geom_label_repel(aes(label = genotype),
  #                  size = 1,
  #                  segment.size = 0.2)
}
py_plot_hg <- py_plot("H/G", "1383/1276") +
  labs(
    x = expression(paste("Total H-lignin * total G-lignin"^-1)),
    y = expression(paste("1383 cm"^-1, "/ 1276 cm"^-1))
  ) +
  theme(
    legend.position = c(0.175, 0.8),
    legend.key.size = unit(2, "mm"),
    legend.background = element_rect(fill = rgb(1, 1, 1, 0.5), colour = NA),
    legend.margin = unit(c(0, 0, 0, 0), "mm")
  )

py_plot_hs <- py_plot("H/S", "1383/1334", colr = "black") +
  labs(
    x = expression(paste("Total H-lignin * total S-lignin"^-1)),
    y = expression(paste("1383 cm"^-1, "/ 1334 cm"^-1))
  )
# scale_y_continuous(breaks = c(0, 1, 2, 3))

pdf("Raman_figureS4.pdf", width = onecol, height = 2)
plot_grid(py_plot_hg,
  py_plot_hs,
  labels = c("A", "B"),
  label_size = 10,
  label_fontfamily = "Helvetica",
  ncol = 2
)
dev.off()
```

#### Correlations between peaks

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

py_rmn <- rmn_data_avg %>%
  filter(wavenumber %in% selected_peaks$wavenumber) %>%
  group_by(genotype, wavenumber) %>%
  pivot_wider(
    id_cols = c(genotype, cell.type), names_from = wavenumber,
    values_from = mean.scaled
  ) %>%
  mutate("CLB" = (`1603` / 4.6) + `1334`) %>%
  group_by(genotype) %>%
  summarise_if(is.numeric, mean) %>%
  select(-genotype) %>%
  as.matrix()

pdf("Raman_figureS5.pdf", height = twocol, width = twocol)
chart.Correlation(py_rmn, histogram = T)
dev.off()
```


```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
rmn_data_ridge <- rmn_data_corrected %>%
  filter(
    wavenumber > 1550 &
      wavenumber < 1650 &
      genotype != "ccr1xfah1" &
      cell.type %in% c("IF", "VB")
  ) %>%
  ungroup() %>%
  mutate(genotype = ordered(genotype, levels = c(
    "Col-0",
    "4cl1",
    "4cl2",
    "4cl1x4cl2",
    "ccoaomt1",
    "fah1",
    "omt1",
    "ccr1-3",
    "ccr1xfah1",
    "cad4",
    "cad5",
    "cad4xcad5"
  )))

# pdf("peak1600_ridge.pdf")
s6 <- ggplot(data = rmn_data_ridge) +
  geom_ridgeline(aes(
    x = wavenumber,
    y = genotype,
    height = rollmean(scaled, 10, na.pad = TRUE),
    fill = genotype,
    group = interaction(genotype, replicate, technical)
  ),
  alpha = 0.25,
  size = 0.2,
  # colour = NA,
  scale = 150
  ) +
  scale_fill_viridis_d() +
  scale_y_discrete(
    labels = c(
      "Col-0",
      expression(italic("4cl1")),
      expression(italic("4cl2")),
      expression(paste(italic("4cl1"), "x", italic("4cl2"))),
      expression(italic("ccoaomt1")),
      expression(italic("fah1")),
      expression(italic("omt1")),
      expression(italic("ccr1")),
      expression(italic("cad4")),
      expression(italic("cad5")),
      expression(paste(italic("cad4"), "x", italic("cad5")))
    )
  ) +
  scale_x_reverse() +
  labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +
  theme_leo() +
  theme(
    panel.spacing = unit(5, "mm"),
    strip.text = element_text(size = 8),
    axis.title.y = element_blank()
  ) +
  geom_vline(xintercept = 1603, colour = "black", alpha = 1, size = 0.2, linetype = 2) +
  annotate("text",
    x = 1603,
    y = 0.75,
    label = expression(paste("1603 cm"^-1)),
    hjust = 1,
    family = "Helvetica",
    size = ggtext_size
  ) +
  geom_vline(xintercept = 1597, colour = "black", alpha = 1, size = 0.2, linetype = 2) +
  annotate("text",
    x = 1594,
    y = 0.75,
    label = expression(paste("1594 cm"^-1)),
    hjust = 0,
    family = "Helvetica",
    size = ggtext_size
  ) +
  facet_wrap(~cell.type, ncol = 2)

pdf("Raman_figureS6.pdf", width = onehalfcol, height = onecol)
s6
dev.off()
```

#### CHO to OH modelling

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE, eval=FALSE}
rmn_mod <- rmn_models %>%
  filter(filename %in% c("poly-g-oh", "poly-g-cho") &
    wavenumber %in% c(1565:1700)) %>%
  droplevels() %>%
  select(filename, wavenumber, intensity) %>%
  complete(filename, wavenumber) %>%
  group_by(filename) %>%
  fill(intensity) %>%
  mutate(intensity = scale_range(intensity) * 1000)

ggplot(rmn_mod) +
  geom_line(aes(x = wavenumber, y = intensity, colour = filename)) +
  theme_leo() +
  scale_colour_few() +
  theme(legend.position = "right")

rmn_mod_count <- rmn_mod %>%
  uncount(intensity)
# pivot_wider(id_cols = "filename", names_from = wavenumber, values_from = intensity)

ggplot(rmn_mod_count) +
  geom_histogram(aes(x = wavenumber, fill = filename), binwidth = 1, position = "identity", alpha = 0.5) +
  scale_fill_few()

mod_oh <- rmn_mod_count %>%
  filter(filename == "poly-g-oh")

mod_cho <- rmn_mod_count %>%
  filter(filename == "poly-g-cho")

library(mixtools)

mix_oh <- normalmixEM(mod_oh$wavenumber, k = 3, epsilon = 1e-10, maxit = 10000)

mix_cho <- normalmixEM(mod_cho$wavenumber, k = 3, epsilon = 1e-10, maxit = 10000)

plot(mix_oh, which = 2)

plot(mix_cho, which = 2)

proportional_gauss <- function(x, mean, sd, lambda, n, binwidth) {
  (dnorm(x, mean = mean, sd = sd)) * n * binwidth * lambda
}


proportional_gauss_sum <- function(x, mean, sd, lambda, n, binwidth) {
  apply(
    mapply(proportional_gauss,
      x = x,
      MoreArgs = list(mean, sd, lambda, n, binwidth)
    ),
    2, sum
  )
}

ggplot(mod_oh, aes(x = wavenumber)) +
  geom_histogram(binwidth = 1) +
  stat_function(
    fun = proportional_gauss_sum,
    args = list(
      mean = mix_oh[["mu"]],
      sd = mix_oh[["sigma"]],
      lambda = mix_oh[["lambda"]],
      n = length(mod_oh$wavenumber),
      binwidth = 1
    )
  )

ggplot(mod_cho, aes(x = wavenumber)) +
  geom_histogram(binwidth = 1) +
  stat_function(
    fun = proportional_gauss_sum,
    args = list(
      mean = mix_cho[["mu"]],
      sd = mix_cho[["sigma"]],
      lambda = mix_cho[["lambda"]],
      n = length(mod_cho$wavenumber),
      binwidth = 1
    )
  )
```

#### All spectra

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE, eval=FALSE}

rmn_model_files <-
  list.files(
    path = "/home/leonard/Documents/Uni/PhD/Raman/Zoltan/fluo_to_rmn/",
    pattern = ".txt",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = FALSE,
    skip = 5,
    cols_only(
      X1 = col_number(),
      X2 = col_number()
    )
  ) %>%
    mutate(filename = flnm)
}

rmn_models_fluo <- lapply(rmn_model_files, read_plus) %>%
  bind_rows()

rmn_models_fluo <- rmn_models_fluo %>%
  mutate(filename = str_remove(basename(filename), ".\\.txt$")) %>%
  rename(
    "wavenumber" = "X1",
    "intensity" = "X2"
  )

rmn_fluo_auc <- rmn_models_fluo %>%
  mutate(
    wavenumber = round(as.numeric(wavenumber), digits = 0),
  ) %>%
  left_join(read_csv("/home/leonard/Dropbox/Raman manuscript/R data/monomer_params.csv")) %>%
  filter(wavenumber %in% c(300:1700)) %>%
  group_by(filename) %>%
  mutate(fluo_AUC = MESS::auc(wavenumber, intensity)) %>%
  select(-intensity) %>%
  summarise(fluo_AUC = mean(fluo_AUC),
            pwr = mean(pwr),
            exp_time = mean(exp_time)) %>%
  separate(filename, into = c("state", "unit", "gamma"), remove = TRUE)

rmn_models_fluo <- rmn_models %>%
  left_join(rmn_fluo_auc, by = c("state", "unit", "gamma")) %>%
  filter(wavenumber %in% c(300:1700)) %>%
  group_by(state, unit, gamma) %>%
  mutate(
    fluo_AUC = case_when(is.na(pwr) ~ fluo_AUC,
                         TRUE ~ fluo_AUC / (pwr * exp_time)),
    AUC = case_when(is.na(pwr) ~ MESS::auc(wavenumber, intensity),
                    TRUE ~ (MESS::auc(wavenumber, intensity)) / (pwr * exp_time)),
    fluo_to_rmn = round(AUC / fluo_AUC, digits = 2)
  ) %>%
  summarise(fluo_to_rmn = mean(fluo_to_rmn),
            AUC = mean(AUC))

rmn_model_scoeff <- rmn_models_fluo %>%
  group_by(unit, gamma, state) %>%
  left_join(rmn_models_fluo) %>%
  ungroup() %>%
  mutate(AUC_rel = round(AUC / AUC[unit == "G" & gamma == "oh" & state == "mono"], digits = 2)) %>%
  select(-AUC) %>%
  # filter(unit %in% c("G", "S")) %>%
  mutate(
    unit = recode(unit,
      "5h" = "5H",
      "c" = "C",
      "gsat" = "G\\textsubscript{sat-}",
      "h" = "H"
    ),
    gamma = recode(gamma,
      "oh" = "\\textsubscript{CHOH}",
      "cho" = "\\textsubscript{CHO}",
      "cooh" = "\\textsubscript{COOH}"
    ),
    compound = as.factor(paste0(unit, gamma))
  ) %>%
  select(compound, state, AUC_rel, fluo_to_rmn) %>%
  pivot_wider(id_cols = compound, values_from = c(AUC_rel, fluo_to_rmn), names_from = state) %>%
  mutate(compound = ordered(compound, levels = c(
    "G\\textsubscript{CHOH}",
    "G\\textsubscript{sat-}\\textsubscript{CHOH}",
    "G\\textsubscript{CHO}",
    "G\\textsubscript{COOH}",
    "5H\\textsubscript{COOH}",
    "S\\textsubscript{CHOH}",
    "S\\textsubscript{CHO}",
    "S\\textsubscript{COOH}",
    "C\\textsubscript{COOH}",
    "H\\textsubscript{COOH}"
  ))) %>%
  dplyr::arrange(compound)

coef_table <- kable(rmn_model_scoeff,
  "latex",
  align = "lcc",
  caption = "Relative scattering coefficients from the synthetic monomers.",
  col.names = c(
    "Compound",
    "Monomeric",
    "DHP",
    "Monomeric",
    "DHP"
  ),
  booktabs = TRUE,
  escape = FALSE,
  linesep = ""
) %>%
  add_header_above(c(
    " " = 1, "Relative AUC\\\\textsuperscript{a}" = 2,
    "Signal\\\\textsubscript{Raman} * Signal\\\\textsubscript{fluo}\\\\textsuperscript{-1}" = 2
  ),
  escape = FALSE
  ) %>%
  footnote(alphabet = "Relative to the AUC of monomeric G\\\\textsubscript{CHOH}", escape = FALSE)

coef_table %>%
  save_kable("Raman_tableS1.pdf")

readr::write_file(coef_table, "coef_table.txt")

rmn_model_supp <- rmn_models %>%
  filter(state == "mono") %>%
  mutate(
    filename = recode(filename,
      "mono-5h-cooh" = "5H-COOH",
      "mono-gsat-oh" = "Gsat-OH",
      "mono-c-cooh" = "C-COOH",
      "mono-h-cooh" = "H-COOH",
      "mono-g-cooh" = "G-COOH",
      "mono-g-cho" = "G-CHO",
      "mono-g-oh" = "G-OH",
      "mono-s-cooh" = "S-COOH",
      "mono-s-cho" = "S-CHO",
      "mono-s-oh" = "S-OH"
    ),
    filename = ordered(filename, levels = rev(c(
      "G-OH",
      "Gsat-OH",
      "G-CHO",
      "G-COOH",
      "5H-COOH",
      "S-OH",
      "S-CHO",
      "S-COOH",
      "C-COOH",
      "H-COOH"
    )))
  )

supp_spectra <- ggplot(rmn_model_supp) +
  # geom_vline(xintercept = c(1656, 1620, 1600, 1335, 1276),
  #       size = 0.2,
  #       linetype = 2,
  #       alpha = 0.5,
  #       colour = "black") +
  # geom_line(aes(
  #   x = wavenumber,
  #   y = rollmean(scaled, 3, na.pad = TRUE),
  #   # fill = state,
  #   colour = filename
  # ),
  # # alpha = 0.5,
  # size = 0.2,
  # # colour = NA,
  # # fill = NA,
  # # scale = 100,
  # # min_height = -0.002
  # ) +
  geom_ridgeline(aes(
    x = wavenumber,
    y = filename,
    height = rollmean(scaled, 3, na.pad = TRUE),
    fill = filename,
    # colour = state
  ),
  alpha = 0.5,
  size = 0.2,
  # colour = NA,
  # fill = "#4575b4",
  scale = 3,
  # alpha = 0.75,
  min_height = -0.05
  ) +
  # scale_fill_manual(values = c("poly" = "#d73027", "mono" = "#4575b4")) +
  scale_colour_viridis_d() +
  # scale_colour_manual(values = c("poly" = "#d73027", "mono" = "#4575b4")) +
  scale_x_reverse(
    limits = c(1700, 300),
    # sec.axis = sec_axis(~., breaks = unique(peak_pres$peak))
  ) +
  scale_y_discrete(
    expand = expand_scale(mult = c(0.15, 0.1)),
    labels = rev(c(
      expression(paste("G"[CHOH])),
      expression(paste("G"[sat - CHOH])),
      expression(paste("G"[CHO])),
      expression(paste("G"[COOH])),
      expression(paste("5H"[COOH])),
      expression(paste("S"[CHOH])),
      expression(paste("S"[CHO])),
      expression(paste("S"[COOH])),
      expression(paste("C"[COOH])),
      expression(paste("H"[COOH]))
    ))
  ) +
  labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +
  theme_leo() +
  theme(
    # panel.spacing = unit(5, "mm"),
    axis.title.y = element_blank(),
    # axis.text.y = element_blank(),
    # axis.ticks.y = element_blank(),
    strip.text = element_text(size = 8),
    axis.text.x.top = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
  ) +
  annotate("segment",
    x = c(1656, 1620, 1600, 1335, 1276),
    xend = c(1656, 1620, 1600, 1335, 1276),
    y = Inf,
    yend = 1,
    colour = "black",
    size = 0.2,
    alpha = 0.75
  ) +
  geom_text_repel(
    data = tibble(
      wavenumber = c(1656, 1620, 1600, 1335, 1276),
      # unit = rep(c("G", "S"), each = 5, len = 10),
      gamma = rep("COOH", 5),
      scaled = rep(1, 5)
    ),
    aes(
      label = wavenumber,
      x = wavenumber,
      y = scaled
    ),
    angle = 90,
    hjust = 0.5,
    direction = "x",
    min.segment.length = 0,
    segment.size = 0.2,
    nudge_y = -1,
    segment.colour = "black",
    family = "Helvetica",
    size = ggtext_size
  )

# library(plotly)
pdf("supplemental_spectra.pdf", width = twocol, height = 5)
supp_spectra
dev.off()
```

#### Kappa figure

```{r}
rmn_model_supp <- rmn_models %>%
  filter(filename == "mono-gsat-oh" |
           filename == "mono-g-oh" |
           filename == "poly-g-oh") %>%
mutate(filename = ordered(filename, levels = rev(c("mono-g-oh",
                                               "mono-gsat-oh",
                                               "poly-g-oh"))))

supp_spectra <- ggplot(rmn_model_supp) +
  # geom_vline(xintercept = c(1656, 1620, 1600, 1335, 1276),
  #       size = 0.2,
  #       linetype = 2,
  #       alpha = 0.5,
  #       colour = "black") +
  # geom_line(aes(
  #   x = wavenumber,
  #   y = rollmean(scaled, 3, na.pad = TRUE),
  #   # fill = state,
  #   colour = filename
  # ),
  # # alpha = 0.5,
  # size = 0.2,
  # # colour = NA,
  # # fill = NA,
  # # scale = 100,
  # # min_height = -0.002
  # ) +
  geom_ridgeline(aes(
    x = wavenumber,
    y = filename,
    height = rollmean(scaled, 3, na.pad = TRUE),
    fill = filename,
    # colour = state
  ),
  alpha = 0.5,
  size = 0.2,
  # colour = NA,
  # fill = "#4575b4",
  scale = 4,
  # alpha = 0.75,
  min_height = -0.05
  ) +
  # scale_fill_manual(values = c("poly" = "#d73027", "mono" = "#4575b4")) +
  scale_colour_viridis_d() +
  # scale_colour_manual(values = c("poly" = "#d73027", "mono" = "#4575b4")) +
  scale_x_reverse(
    limits = c(1700, 300),
    # sec.axis = sec_axis(~., breaks = unique(peak_pres$peak))
  ) +
  annotate("text",
           y = c(1, 2, 3),
           x = 1700,
           hjust = 0,
           vjust = 1.1,
    label = rev(c(
      "Coniferyl alcohol monomer",
      "Saturated coniferyl alcohol monomer",
      "Coniferyl alcohol DHP"
    )),
    family = "Helvetica",
    size = ggtext_size
  ) +
  labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +
  theme_leo() +
  theme(
    # panel.spacing = unit(5, "mm"),
    axis.title.y = element_blank(),
    # axis.text.y = element_blank(),
    # axis.ticks.y = element_blank(),
    strip.text = element_text(size = 8),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

pdf("kappa_spectra.pdf", width = onecol * 1.5, height = 2)
supp_spectra
dev.off()
```

#### 785 nm spectra

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE, eval=FALSE}
rmn_model_files <-
  list.files(
    path = "/home/leonard/Documents/Uni/PhD/Raman/Zoltan/785_nm/",
    pattern = ".txt",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = FALSE,
    skip = 5,
    cols_only(
      X1 = col_number(),
      X2 = col_number()
    )
  ) %>%
    mutate(filename = flnm)
}

rmn_models785 <- lapply(rmn_model_files, read_plus) %>%
  bind_rows()

rmn_models785 <- rmn_models785 %>%
  mutate(filename = str_remove(basename(filename), ".txt$")) %>%
  rename(
    "wavenumber" = "X1",
    "intensity" = "X2"
  )

rmn_fluo_auc <- rmn_models785 %>%
  mutate(
    wavenumber = round(as.numeric(wavenumber), digits = 0),
  ) %>%
  filter(wavenumber %in% c(300:1700)) %>%
  group_by(filename) %>%
  mutate(fluo_AUC = MESS::auc(wavenumber, intensity)) %>%
  select(-intensity)

#### baseline correct Raman data ####
rmn_models785_wide <- rmn_models785 %>%
  group_by(filename) %>%
  mutate(group_id = row_number()) %>%
  spread(wavenumber, intensity) %>%
  select(-group_id) %>%
  summarise_all(funs(sum(., na.rm = TRUE)))

rmn_models785_mat <- as.matrix(rmn_models785_wide[, -1])
rownames(rmn_models785_mat) <- rmn_models785_wide$filename

rmn_models785_correction <- baseline.als(rmn_models785_mat,
  lambda = 5,
  p = 0.01,
  maxit = 100
)

rmn_models785_corrected <- as_tibble(rmn_models785_correction$corrected, rownames = NA) %>%
  rownames_to_column(var = "filename") %>%
  pivot_longer(cols = -filename, names_to = "wavenumber", values_to = "intensity") %>%
  mutate(
    wavenumber = round(as.numeric(wavenumber), digits = 0),
  ) %>%
  left_join(rmn_fluo_auc) %>%
  separate(filename, into = c("state", "unit", "gamma"), remove = FALSE) %>%
  filter(wavenumber %in% c(300:1700)) %>%
  group_by(state, unit, gamma) %>%
  mutate(
    AUC = MESS::auc(wavenumber, intensity),
    flou_to_rmn = AUC / fluo_AUC,
    # AUC_1600_prop = MESS::auc(wavenumber, intensity, from = 1580, to = 1615) / AUC,
    # scaled = intensity
    scaled = intensity / AUC
  ) %>%
  ungroup() %>%
  mutate(scaled = scale_max(scaled)) %>%
  filter(!filename %in% c("poly-G-OHa-785", "poly-G-CHOa-785"))

supp_spectra <- ggplot(rmn_models785_corrected) +
  geom_ridgeline(aes(
    x = wavenumber,
    y = filename,
    height = rollmean(scaled, 20, na.pad = TRUE),
    fill = filename,
    # colour = state
  ),
  alpha = 0.5,
  size = 0.2,
  # colour = NA,
  # fill = "#4575b4",
  scale = 2.5,
  # alpha = 0.75,
  min_height = -0.2
  ) +
  # scale_fill_manual(values = c("poly" = "#d73027", "mono" = "#4575b4")) +
  scale_fill_viridis_d() +
  # scale_colour_manual(values = c("poly" = "#d73027", "mono" = "#4575b4")) +
  scale_x_reverse(
    limits = c(1700, 300),
    # sec.axis = sec_axis(~., breaks = unique(peak_pres$peak))
  ) +
  # labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +
  theme_leo() +
  theme(
    # panel.spacing = unit(5, "mm"),
    axis.title.y = element_blank(),
    # axis.text.y = element_blank(),
    # axis.ticks.y = element_blank(),
    strip.text = element_text(size = 8),
    axis.text.x.top = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
  ) +
  annotate("segment",
    x = c(1656, 1620, 1600, 1335, 1276),
    xend = c(1656, 1620, 1600, 1335, 1276),
    y = Inf,
    yend = 1,
    colour = "black",
    size = 0.2,
    alpha = 0.75
  ) +
  geom_text_repel(
    data = tibble(
      wavenumber = c(1656, 1620, 1600, 1335, 1276),
      # unit = rep(c("G", "S"), each = 5, len = 10),
      gamma = rep("COOH", 5),
      scaled = rep(1, 5)
    ),
    aes(
      label = wavenumber,
      x = wavenumber,
      y = scaled
    ),
    angle = 90,
    hjust = 0.5,
    direction = "x",
    min.segment.length = 0,
    segment.size = 0.2,
    nudge_y = -1,
    segment.colour = "black",
    family = "Helvetica",
    size = ggtext_size
  ) +
  scale_y_discrete(
    expand = expand_scale(mult = c(0.2, 0.1)),
    labels = rev(c(
      expression(paste("S"[CHOH] ~ DHP)),
      expression(paste("S"[COOH] ~ DHP)),
      expression(paste("G"[COOH] ~ DHP))
    ))
  ) +
  labs(x = expression(paste("Wavenumber [cm"^-1, "]"))) +

  pdf("supplemental_spectra785.pdf", width = twocol, height = 3)
supp_spectra
dev.off()
```


```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE, eval=FALSE}

# fine (AUC to area of measurement)

IF_areas <- read_csv("/home/leonard/Documents/Uni/PhD/Raman/IF_areas.csv", col_types = "cccnnn") %>%
  group_by(genotype, replicate, technical) %>%
  summarise(
    Area_80 = ((5024 - sum(Area_80)) / 5024) * 100,
    Area_40 = ((1264 - sum(Area_40)) / 1264) * 100,
    Area_20 = ((316 - sum(Area_20)) / 316) * 100
  )

auc_data <- rmn_data_corrected %>%
  filter(cell.type == "IF") %>%
  group_by(genotype, replicate, technical) %>%
  summarise(AUC = mean(AUC)) %>%
  left_join(IF_areas)

auc_data_avg <- auc_data %>%
  drop_na() %>%
  group_by(genotype) %>%
  summarise(
    AUC = mean(AUC),
    Area_20 = mean(Area_20),
    Area_40 = mean(Area_40),
    Area_80 = mean(Area_80)
  )

auc_model <- lm(
  AUC ~ Area_20 + (Area_40 - Area_20) + (Area_80 - Area_40),
  auc_data
)
broom::glance(auc_model)
broom::tidy(auc_model)

auc_mixed_model <- lme4::lmer(AUC ~
Area_20 +
  # (Area_40 - Area_20) +
  # (Area_80 - Area_40) +
  (1 | genotype),
# ((Area_40 - Area_20) | genotype) +
# ((Area_80 - Area_40) | genotype),
data = auc_data
)
MuMIn::r.squaredGLMM(auc_mixed_model)

auc_plot <- function(area) {
  form <- paste("AUC ~", area)
  model <- broom::glance(lm(as.formula(form[2]), auc_data))

  ggplot(auc_data, aes(x = AUC, y = !!area)) +
    geom_point(aes(x = AUC, y = !!area, fill = genotype),
      shape = 21,
      stroke = 0.1,
      size = 1,
      alpha = 0.5
    ) +
    annotate("text",
      x = 19000,
      y = 46,
      label = paste("marginal R² = ", round(MuMIn::r.squaredGLMM(auc_mixed_model)[1], digits = 2)),
      hjust = 1,
      family = "Helvetica",
      size = ggtext_size
    ) +
    annotate("text",
      x = 19000,
      y = 42,
      label = paste("conditional R² = ", round(MuMIn::r.squaredGLMM(auc_mixed_model)[2], digits = 2)),
      hjust = 1,
      family = "Helvetica",
      size = ggtext_size
    ) +
    geom_smooth(
      method = "lm",
      colour = "black",
      se = FALSE,
      size = 0.4,
      linetype = 2,
      fullrange = TRUE
    ) +
    geom_smooth(aes(colour = genotype),
      method = "lm",
      se = FALSE,
      size = 0.2
    ) +
    geom_text_repel(
      data = auc_data_avg,
      aes(label = genotype),
      min.segment.length = 0,
      family = "Helvetica",
      size = ggtext_size,
      fontface = 3
    ) +
    geom_point(
      data = auc_data_avg,
      aes(x = AUC, y = !!area, fill = genotype),
      size = 3,
      stroke = 0.2,
      shape = 21
    ) +
    scale_fill_viridis_d() +
    scale_colour_viridis_d() +
    scale_y_continuous(expand = expand_scale(mult = 0.01)) +
    scale_x_continuous(expand = expand_scale(mult = 0.01)) +
    # expand_limits(y = 0, x = 0) +
    theme_leo() +
    labs(y = "Cell wall in measurement area [%]") +
    theme(plot.margin = unit(c(3, 3, 3, 3), "mm"))
}

p20 <- auc_plot(quo(Area_20))

pdf("AUC_to_width.pdf", width = onehalfcol, height = onehalfcol)
p20
dev.off()
```

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE, eval=FALSE}

rmn_data_auc <- read_csv("rmn_data_corrected.csv", col_types = "ccccnnn") %>%
  ungroup() %>%
  filter(cell.type == "IF") %>%
  left_join(IF_areas) %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  mutate(AUC = MESS::auc(wavenumber, corrected.intensity) / Area_20) %>%
  summarise(
    AUC = mean(AUC),
    Area_20 = mean(Area_20)
  ) %>%
  ungroup() %>%
  mutate(
    genotype = ordered(genotype, levels = c(
      "Col-0",
      "4cl1",
      "4cl2",
      "4cl1x4cl2",
      "ccoaomt1",
      "fah1",
      "omt1",
      "ccr1-3",
      "cad4",
      "cad5",
      "cad4xcad5"
    ))
  ) %>%
  drop_na()
  
mutant_area_letters <- letter_groups(rmn_data_auc,
  Area_20,
  genotype,
  "tukey",
  print_position = "above",
  print_adjust = 1
)

area <- ggplot(rmn_data_auc, aes(x = genotype, y = Area_20)) +
  geom_quasirandom(aes(fill = genotype),
    shape = 21,
    alpha = 0.75,
    size = 1,
    stroke = 0.2
  ) +
  geom_boxplot(
    alpha = 0.5,
    colour = "black",
    outlier.alpha = 0,
    fatten = 1,
    size = 0.2
  ) +
  scale_fill_viridis_d() +
  theme_leo() +
  # labs(y = expression(paste("AUC per 490 µm"^2))) +
  labs(y = "Cell wall in measurement area [%]") +
  # scale_y_continuous(limits = c(0, 500), breaks = c(0, 200, 400)) +
  geom_text(
    data = mutant_area_letters,
    aes(label = groups),
    family = "Helvetica",
    size = ggtext_size
  ) +
  scale_x_discrete(labels = c(
    "WT",
    expression(italic("4cl1")),
    expression(italic("4cl2")),
    expression(paste(italic("4cl1"), "x", italic("4cl2"))),
    expression(italic("ccoaomt1")),
    expression(italic("fah1")),
    expression(italic("omt1")),
    expression(italic("ccr1")),
    expression(italic("cad4")),
    expression(italic("cad5")),
    expression(paste(italic("cad4"), "x", italic("cad5")))
  )) +
  theme(axis.title.y = element_blank()) +
  coord_flip()


mutant_auc_letters <- letter_groups(rmn_data_auc,
  AUC,
  genotype,
  "tukey",
  print_position = "above"
)

area_norm <- ggplot(rmn_data_auc, aes(x = genotype, y = AUC)) +
  geom_quasirandom(aes(fill = genotype),
    shape = 21,
    alpha = 0.75,
    size = 1,
    stroke = 0.2
  ) +
  geom_boxplot(
    alpha = 0.5,
    colour = "black",
    outlier.alpha = 0,
    fatten = 1,
    size = 0.2
  ) +
  scale_fill_viridis_d() +
  theme_leo() +
  # labs(y = expression(paste("AUC per 490 µm"^2))) +
  labs(y = "AUC normalised to CW area") +
  # scale_y_continuous(expand = expand_scale(mult = c(0.5,0.1))) +
  geom_text(
    data = mutant_auc_letters,
    aes(label = groups),
    family = "Helvetica",
    size = ggtext_size
  ) +
  scale_x_discrete(labels = c(
    "WT",
    expression(italic("4cl1")),
    expression(italic("4cl2")),
    expression(paste(italic("4cl1"), "x", italic("4cl2"))),
    expression(italic("ccoaomt1")),
    expression(italic("fah1")),
    expression(italic("omt1")),
    expression(italic("ccr1")),
    expression(italic("cad4")),
    expression(italic("cad5")),
    expression(paste(italic("cad4"), "x", italic("cad5")))
  )) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  coord_flip()

pdf("area_norm.pdf", height = onehalfcol, width = onehalfcol)
bottom <- plot_grid(area,
  area_norm,
  nrow = 1,
  rel_widths = c(1.2, 1),
  labels = c("B", "C"),
  hjust = 0,
  vjust = 0.5,
  label_fontfamily = "Helvetica",
  label_size = 10
)
plot_grid(p20,
  bottom,
  rel_heights = c(1.5, 1),
  nrow = 2,
  hjust = 0,
  vjust = 1,
  labels = c("A", ""),
  label_fontfamily = "Helvetica",
  label_size = 10
)
dev.off()

library(patchwork)
pdf("area_norm.pdf", height = onehalfcol, width = onehalfcol)
p20 / (area + area_norm) + plot_layout(heights=c(1.5,1)) +
  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10, face = "bold"),
        plot.margin = unit(c(2,2,2,2), "mm"))
dev.off()
```

### Correlations with other scaling

#### 1603

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

py <- read.csv("/home/leonard/Documents/Uni/PhD/Raman/pyrolysis_2018_amount.csv")

py$`G-OH` <- ifelse(
  py$variable == "mean",
  py$X17 + py$X19 + py$X23,
  sqrt(
    py$X17^2 + py$X19^2 + py$X23^2
  )
)
py$`S-OH` <- py$X33
py$H <-
  ifelse(py$variable == "mean", rowSums(py[, 7:9]), sqrt(rowSums(py[, 7:9]^
    2)))
py$G <-
  ifelse(py$variable == "mean", rowSums(py[, 7:19]), sqrt(rowSums(py[, 7:19]^
    2)))
py$S <-
  ifelse(py$variable == "mean", rowSums(py[, 21:28]), sqrt(rowSums(py[, 21:28]^
    2)))
py$S.G <- py$S / py$G
py$H.G <- py$H / py$G
py$Coniferaldehyde <- py$X22
py$Vanillin <- py$X18
py$Sinapaldehyde <- py$X32
py$Syringaldehyde <- py$X29
py$CHO <-
  ifelse(
    py$variable == "mean",
    py$Coniferaldehyde + py$Sinapaldehyde + py$Vanillin + py$Syringaldehyde,
    sqrt(
      py$Coniferaldehyde^2 + py$Sinapaldehyde^2 + py$Vanillin^2 + py$Syringaldehyde^2
    )
  )
py$Lignin <-
  ifelse(py$variable == "mean", rowSums(py[, 3:28]), sqrt(rowSums(py[, 3:28]^
    2)))

py <- py %>%
  select(genotype, variable, G, H, `G-OH`, Lignin, S, CHO) %>%
  pivot_longer(-c(genotype, variable), names_to = "unit", values_to = "value")

py_rmn <- rmn_data_avg %>%
  filter(wavenumber %in% selected_peaks$wavenumber) %>%
  group_by(genotype, wavenumber) %>%
  summarise(total.mean.scaled = mean(mean.scaled_max))


# pdf("rmn_covariance.pdf")
# corrplot(cor(spread(py_rmn, key = wavenumber, value = total.mean.scaled)[,-1]))
# dev.off()

py_rmn_corr <- left_join(py, py_rmn) %>%
  ungroup() %>%
  mutate(unit = recode(unit,
    "G-OH" = "G-CHOH",
    "H" = "H-R",
    "G" = "G-R",
    "S" = "S-R",
    "CHO" = "R-CHO"
  )) %>%
  mutate(
    unit = ordered(unit, levels = c("Lignin", "G-R", "G-CHOH", "S-R", "H-R", "R-CHO")),
    units_parsed = factor(unit, labels = c(
      "Lignin",
      "G[R]",
      "G[CHOH]",
      "S[R]",
      "H[R]",
      "R[CHO]"
    ))
  )


py_rmn_corr_mat <- py_rmn_corr %>%
  filter(variable == "mean") %>%
  group_by(units_parsed, wavenumber) %>%
  nest() %>%
  mutate(
    cor = map(data, ~ cor.test(.x$value, .x$total.mean.scaled)),
    tidied = map(cor, tidy)
  ) %>%
  unnest(tidied)

py_rmn_corr <- py_rmn_corr %>%
  filter(variable == "mean") %>%
  ungroup() %>%
  mutate(
    value = scale_range(value),
    total.mean.scaled = scale_range(total.mean.scaled)
  )

total_corr <- ggplot(data = py_rmn_corr) +
  geom_rect(
    data = py_rmn_corr_mat,
    xmin = -Inf,
    xmax = Inf,
    ymin = -Inf,
    ymax = Inf,
    aes(fill = if_else(p.value < 0.05, estimate, NULL))
  ) +
  geom_point(aes(
    x = value,
    y = total.mean.scaled
  ),
  size = 0.5,
  alpha = 0.75,
  shape = 16
  ) +
  scale_fill_distiller(
    palette = "RdYlBu",
    na.value = "white",
    name = "Pearson's r (if p < 0.05)",
    limits = c(-1, 1)
  ) +
  guides(fill = guide_legend(title.position = "top")) +
  labs(
    x = expression(paste("Pyrolysate * total pyrolysate"^-1)),
    y = expression(paste("Raman average (IF:VB 1:1) * AUC"^-1))
  ) +
  theme_leo() +
  theme(
    legend.position = "bottom",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    strip.text = element_text(size = 8),
    legend.key.width = unit(4, "mm")
  ) +
  facet_grid(reorder(wavenumber, as.numeric(wavenumber)) ~ units_parsed, labeller = label_parsed)

pdf("pyro_correlations.pdf", height = 6, width = onecol)
total_corr
dev.off()
```


```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

py <- read.csv("/home/leonard/Documents/Uni/PhD/Raman/pyrolysis_2018_amount.csv")

py$Coniferaldehyde <- py$X22
py$Vanillin <- py$X18
py$Sinapaldehyde <- py$X32
py$Syringaldehyde <- py$X29
py$GOH <- ifelse(
  py$variable == "mean",
  py$X17 + py$X19 + py$X23,
  sqrt(py$X17^2 + py$X19^2 + py$X23^2)
)
py$`S-OH` <- py$X33
py$`S-CHO` <- py$X32
py$`S-CHOs` <- ifelse(
  py$variable == "mean",
  py$X32 + py$X30 + py$X29,
  sqrt(py$X32^2 + py$X30^2 + py$X29^2)
)
py$`SnoCHO` <- ifelse(
  py$variable == "mean",
  py$X26 + py$X27 + py$X31 + py$X28 + py$X33,
  sqrt(py$X27^2 + py$X31^2 + py$X28^2 + py$X26^2 + py$X33^2)
)
py$GCHO <- ifelse(
  py$variable == "mean",
  py$X18 + py$X22,
  sqrt(py$X18^2 + py$X22^2)
)
py$Aldehydes <-
  ifelse(
    py$variable == "mean",
    py$Coniferaldehyde + py$Sinapaldehyde + py$Vanillin + py$Syringaldehyde,
    sqrt(
      py$Coniferaldehyde^2 + py$Sinapaldehyde^2 + py$Vanillin^2 + py$Syringaldehyde^2
    )
  )
py$H <-
  ifelse(py$variable == "mean", rowSums(py[, 7:9]), sqrt(rowSums(py[, 7:9]^
    2)))
py$G <-
  ifelse(py$variable == "mean", rowSums(py[, 7:19]), sqrt(rowSums(py[, 7:19]^
    2)))
py$S <-
  ifelse(py$variable == "mean", rowSums(py[, 21:28]), sqrt(rowSums(py[, 21:28]^
    2)))
py$SnoOH <-
  ifelse(py$variable == "mean", rowSums(py[, 21:27]), sqrt(rowSums(py[, 21:27]^
    2)))
py$Lignin <-
  ifelse(py$variable == "mean", rowSums(py[, 3:28]), sqrt(rowSums(py[, 3:28]^
    2)))
py$`GCHO/G` <- py$GCHO / py$G
py$`GOH/G` <- py$GOH / py$G
py$`GCHO/GOH` <- py$Coniferaldehyde / py$GOH
py$`GCHO/lig` <- py$GCHO / py$Lignin
py$`Aldehydes/lig` <- py$Aldehydes / py$Lignin
py$`S/G` <- py$S / py$G
py$`H/G` <- py$H / py$G
py$`H/S` <- py$H / py$S

py <- py %>%
  select(-starts_with("X")) %>%
  pivot_longer(-c(genotype, variable), names_to = "unit", values_to = "value") %>%
  pivot_wider(id_cols = c("genotype", "unit"), names_from = variable, values_from = value)

py_rmn <- rmn_data_corrected %>%
  filter(wavenumber %in% selected_peaks$wavenumber) %>%
  group_by(cell.type, genotype, wavenumber, replicate, technical) %>%
  pivot_wider(
    id_cols = c(genotype, cell.type, replicate, technical), names_from = wavenumber,
    values_from = scaled_max
  ) %>%
  group_by(cell.type, genotype, replicate, technical) %>%
  transmute(
    "CLB" = (`1603` / 2) + `1334`,
    "1334/1603" = `1334` / `1603`,
    "1664/1603" = `1664` / `1603`,
    "1334/1276" = `1334` / `1276`,
    "1625/1603" = `1625` / `1603`,
    "1625/1664" = `1625` / `1664`,
    "1625/lig" = `1625` / ((`1603` / 2) + `1334`),
    "1625" = `1625`,
    "1334" = `1334`,
    "1603" = `1603`
  ) %>%
  pivot_longer(cols = -c(genotype, cell.type, replicate, technical), names_to = "wavenumber", values_to = "scaled") %>%
  group_by(genotype, wavenumber, cell.type) %>%
  summarise(
    mean.scaled = mean(scaled),
    sd.scaled = sd(scaled) / mean.scaled
  ) %>%
  group_by(genotype, wavenumber) %>%
  summarise(
    total.mean.scaled = mean(mean.scaled),
    total.sd.scaled = total.mean.scaled * sqrt(sum(sd.scaled^2))
  )

py_rmn_corr <- left_join(py, py_rmn) %>%
  mutate(WT = case_when(
    genotype == "Col-0" ~ "yes",
    TRUE ~ "no"
  ))

py_rmn_corr_mat <- py_rmn_corr %>%
  # filter(variable == "mean") %>%
  group_by(unit, wavenumber) %>%
  nest() %>%
  mutate(
    cor = map(data, ~ cor.test(.x$mean, .x$total.mean.scaled)),
    tidied = map(cor, tidy)
  ) %>%
  unnest(tidied)

broom::glance(lm(mean ~ total.mean.scaled, data = filter(py_rmn_corr, unit == "Lignin" &
  wavenumber == "CLB")))

# broom::tidy(lm(Lignin ~ `1603` + `1334`, data = filter(py_rmn_corr, variable == "mean")))





py_plot <- function(x, y, z = "bork", col = "white") {
  tidycor <- broom::tidy(cor.test(
    as.matrix(filter(py_rmn_corr, unit == x &
      wavenumber == y &
      genotype != z)[, "mean"]),
    as.matrix(filter(py_rmn_corr, unit == x &
      wavenumber == y &
      genotype != z)[, "total.mean.scaled"])
  ))
  print(tidycor)

  regr <- broom::glance(lm(mean ~ total.mean.scaled, data = filter(py_rmn_corr, unit == x &
    wavenumber == y &
    genotype != z)))

  ggplot(
    data = filter(py_rmn_corr, unit == x & wavenumber == y & genotype != z),
    aes(x = mean, y = total.mean.scaled)
  ) +
    geom_rect(
      data = tidycor,
      xmax = Inf,
      ymax = Inf,
      xmin = -Inf,
      ymin = -Inf,
      aes(
        fill = estimate,
        x = 0,
        y = 0
      )
    ) +
    geom_errorbar(aes(
      ymin = total.mean.scaled - total.sd.scaled,
      ymax = total.mean.scaled + total.sd.scaled
    ),
    size = 0.2,
    width = 0,
    alpha = 0.75
    ) +
    # geom_errorbarh(aes(xmin = mean - sd,
    #                   xmax = mean + sd),
    #               size = 0.2,
    #               height = 0) +
    geom_point(aes(colour = WT),
      size = 1,
      alpha = 0.75,
      shape = 16
    ) +
    geom_smooth(
      method = "lm",
      fullrange = T,
      size = 0.4,
      se = F,
      linetype = 1,
      colour = col
    ) +
    scale_colour_manual(values = c("yes" = "white", no = "black")) +
    scale_fill_distiller(
      palette = "RdYlBu",
      na.value = "white",
      name = "Pearson's r",
      limits = c(-1, 1)
    ) +
    scale_x_continuous(limits = c(0, NA)) +
    scale_y_continuous(limits = c(0, NA)) +
    annotate("text",
      label = paste("R² = ", round(regr$adj.r.squared, digits = 2)),
      x = 0,
      y = 0,
      size = ggtext_size,
      family = "Helvetica",
      hjust = 0,
      vjust = 0,
      colour = col
    ) +
    theme_leo() +
    theme(
      axis.text.y = element_text(
        angle = 90,
        hjust = 0.5
      ),
      plot.margin = unit(c(4, 2, 4, 4), "mm")
    )
  # geom_label_repel(aes(label = genotype),
  #                  size = 1,
  #                  segment.size = 0.2)
}

py_plot_lig <- py_plot("Lignin", "CLB") +
  labs(
    x = expression(paste("Lignin * total pyrolysate"^-1)),
    y = expression(paste("CLB [AU * AUC"^-1, "]"))
  ) +
  scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6))

py_plot_sg <- py_plot("S/G", "1334/1276") +
  labs(
    x = expression(paste("S"[R], " * G"[R]^{
      -1
    })),
    y = expression(paste("1334 cm"^-1, "/ 1276 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 1, 2, 3))

py_plot_cho <- py_plot("GCHO/lig", "1625/lig") +
  labs(
    x = expression(paste("G"[CHO], " * lignin"^-1)),
    y = expression(paste("1625 cm"^-1, "/ CLB"))
  ) +
  scale_y_continuous(breaks = c(0, 0.4, 0.8), labels = c("0", "0.4", "0.8")) +
  scale_x_continuous(labels = c("0", "0.1", "0.2", "0.3", "0.4")) +
  geom_point(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype == "cad4xcad5"),
    aes(colour = WT),
    size = 1,
    alpha = 0.75,
    shape = 16
  ) +
  geom_errorbar(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype == "cad4xcad5"),
    aes(
      ymin = total.mean.scaled - total.sd.scaled,
      ymax = total.mean.scaled + total.sd.scaled
    ),
    size = 0.2,
    width = 0,
    alpha = 0.75
  ) +
  geom_smooth(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype != "cad4xcad5"),
    method = "lm",
    colour = "black",
    fullrange = T,
    size = 0.4,
    se = F,
    linetype = 2
  )
# annotate("text",
#          label = "R² = −0.12",
#          x = 0,
#          y = 0.1,
#          size = ggtext_size,
#          family = "Helvetica",
#          hjust = 0,
#          vjust = 0,
#             colour = "blue")

py_plot_goh <- py_plot("GOH/G", "1664/1603") +
  labs(
    x = expression(paste("G"^{
      OH
    }, " * total G-lignin"^-1)),
    y = expression(paste("1664 cm"^-1, "/ 1603 cm"^-1))
  )
# scale_y_continuous(breaks = c(0, 1, 2, 3))

py_plot_snooh <- py_plot("SnoOH", "1334") +
  labs(
    x = expression(paste("S-lignin " - " S-OH")),
    y = expression(paste("1334 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
  scale_x_continuous(breaks = c(0, 0.01, 0.02), labels = c("0", "0.01", "0.02"))

py_plot_soh <- py_plot("S-OH", "1334") +
  labs(
    x = expression(paste("S-OH")),
    y = expression(paste("1334 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
  scale_x_continuous(breaks = c(0, 0.005, 0.01), labels = c("0", "0.005", "0.01"))

py_plot_scho <- py_plot("S-CHO", "1334") +
  labs(
    x = expression(paste("S-CHO")),
    y = expression(paste("1334 cm"^-1))
  )
# scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
# scale_x_continuous(breaks = c(0, 0.005, 0.01), labels = c("0", "0.005", "0.01"))

py_plot_snocho <- py_plot("SnoCHO", "1334") +
  labs(
    x = expression(paste("S" - "S-CHO")),
    y = expression(paste("1334 cm"^-1))
  )


pdf("Raman_scaled1603.pdf", width = onehalfcol, height = 5)
right <- plot_grid(py_plot_lig,
  py_plot_sg,
  py_plot_cho,
  # py_plot_soh,
  # py_plot_snocho,
  # py_plot_snooh,
  ncol = 1,
  labels = c("", "C", "D"),
  label_size = 10,
  label_fontfamily = "Helvetica"
  # label_x = -0.02,
  # label_y = 1.01
)
plot_grid(plot_grid(total_corr),
  right,
  labels = c("A", "B"),
  label_size = 10,
  label_fontfamily = "Helvetica",
  # label_x = -0.005,
  # label_y = 1.01,
  rel_widths = c(1, 0.6),
  ncol = 2,
  align = "hv",
  axis = "t"
)
dev.off()
```


#### no scaling

```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

py <- read.csv("/home/leonard/Documents/Uni/PhD/Raman/pyrolysis_2018_amount.csv")

py$`G-OH` <- ifelse(
  py$variable == "mean",
  py$X17 + py$X19 + py$X23,
  sqrt(
    py$X17^2 + py$X19^2 + py$X23^2
  )
)
py$`S-OH` <- py$X33
py$H <-
  ifelse(py$variable == "mean", rowSums(py[, 7:9]), sqrt(rowSums(py[, 7:9]^
    2)))
py$G <-
  ifelse(py$variable == "mean", rowSums(py[, 7:19]), sqrt(rowSums(py[, 7:19]^
    2)))
py$S <-
  ifelse(py$variable == "mean", rowSums(py[, 21:28]), sqrt(rowSums(py[, 21:28]^
    2)))
py$S.G <- py$S / py$G
py$H.G <- py$H / py$G
py$Coniferaldehyde <- py$X22
py$Vanillin <- py$X18
py$Sinapaldehyde <- py$X32
py$Syringaldehyde <- py$X29
py$CHO <-
  ifelse(
    py$variable == "mean",
    py$Coniferaldehyde + py$Sinapaldehyde + py$Vanillin + py$Syringaldehyde,
    sqrt(
      py$Coniferaldehyde^2 + py$Sinapaldehyde^2 + py$Vanillin^2 + py$Syringaldehyde^2
    )
  )
py$Lignin <-
  ifelse(py$variable == "mean", rowSums(py[, 3:28]), sqrt(rowSums(py[, 3:28]^
    2)))

py <- py %>%
  select(genotype, variable, G, H, `G-OH`, Lignin, S, CHO) %>%
  pivot_longer(-c(genotype, variable), names_to = "unit", values_to = "value")

py_rmn <- rmn_data_avg %>%
  filter(wavenumber %in% selected_peaks$wavenumber) %>%
  group_by(genotype, wavenumber) %>%
  summarise(total.mean.scaled = mean(mean.raw))


# pdf("rmn_covariance.pdf")
# corrplot(cor(spread(py_rmn, key = wavenumber, value = total.mean.scaled)[,-1]))
# dev.off()

py_rmn_corr <- left_join(py, py_rmn) %>%
  ungroup() %>%
  mutate(unit = recode(unit,
    "G-OH" = "G-CHOH",
    "H" = "H-R",
    "G" = "G-R",
    "S" = "S-R",
    "CHO" = "R-CHO"
  )) %>%
  mutate(
    unit = ordered(unit, levels = c("Lignin", "G-R", "G-CHOH", "S-R", "H-R", "R-CHO")),
    units_parsed = factor(unit, labels = c(
      "Lignin",
      "G[R]",
      "G[CHOH]",
      "S[R]",
      "H[R]",
      "R[CHO]"
    ))
  )


py_rmn_corr_mat <- py_rmn_corr %>%
  filter(variable == "mean") %>%
  group_by(units_parsed, wavenumber) %>%
  nest() %>%
  mutate(
    cor = map(data, ~ cor.test(.x$value, .x$total.mean.scaled)),
    tidied = map(cor, tidy)
  ) %>%
  unnest(tidied)

py_rmn_corr <- py_rmn_corr %>%
  filter(variable == "mean") %>%
  ungroup() %>%
  mutate(
    value = scale_range(value),
    total.mean.scaled = scale_range(total.mean.scaled)
  )

total_corr <- ggplot(data = py_rmn_corr) +
  geom_rect(
    data = py_rmn_corr_mat,
    xmin = -Inf,
    xmax = Inf,
    ymin = -Inf,
    ymax = Inf,
    aes(fill = if_else(p.value < 0.05, estimate, NULL))
  ) +
  geom_point(aes(
    x = value,
    y = total.mean.scaled
  ),
  size = 0.5,
  alpha = 0.75,
  shape = 16
  ) +
  scale_fill_distiller(
    palette = "RdYlBu",
    na.value = "white",
    name = "Pearson's r (if p < 0.05)",
    limits = c(-1, 1)
  ) +
  guides(fill = guide_legend(title.position = "top")) +
  labs(
    x = expression(paste("Pyrolysate * total pyrolysate"^-1)),
    y = expression(paste("Raman average (IF:VB 1:1) * AUC"^-1))
  ) +
  theme_leo() +
  theme(
    legend.position = "bottom",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    strip.text = element_text(size = 8),
    legend.key.width = unit(4, "mm")
  ) +
  facet_grid(reorder(wavenumber, as.numeric(wavenumber)) ~ units_parsed, labeller = label_parsed)

pdf("pyro_correlations.pdf", height = 6, width = onecol)
total_corr
dev.off()
```


```{r, fig.showtext = TRUE, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}

py <- read.csv("/home/leonard/Documents/Uni/PhD/Raman/pyrolysis_2018_amount.csv")

py$Coniferaldehyde <- py$X22
py$Vanillin <- py$X18
py$Sinapaldehyde <- py$X32
py$Syringaldehyde <- py$X29
py$GOH <- ifelse(
  py$variable == "mean",
  py$X17 + py$X19 + py$X23,
  sqrt(py$X17^2 + py$X19^2 + py$X23^2)
)
py$`S-OH` <- py$X33
py$`S-CHO` <- py$X32
py$`S-CHOs` <- ifelse(
  py$variable == "mean",
  py$X32 + py$X30 + py$X29,
  sqrt(py$X32^2 + py$X30^2 + py$X29^2)
)
py$`SnoCHO` <- ifelse(
  py$variable == "mean",
  py$X26 + py$X27 + py$X31 + py$X28 + py$X33,
  sqrt(py$X27^2 + py$X31^2 + py$X28^2 + py$X26^2 + py$X33^2)
)
py$GCHO <- ifelse(
  py$variable == "mean",
  py$X18 + py$X22,
  sqrt(py$X18^2 + py$X22^2)
)
py$Aldehydes <-
  ifelse(
    py$variable == "mean",
    py$Coniferaldehyde + py$Sinapaldehyde + py$Vanillin + py$Syringaldehyde,
    sqrt(
      py$Coniferaldehyde^2 + py$Sinapaldehyde^2 + py$Vanillin^2 + py$Syringaldehyde^2
    )
  )
py$H <-
  ifelse(py$variable == "mean", rowSums(py[, 7:9]), sqrt(rowSums(py[, 7:9]^
    2)))
py$G <-
  ifelse(py$variable == "mean", rowSums(py[, 7:19]), sqrt(rowSums(py[, 7:19]^
    2)))
py$S <-
  ifelse(py$variable == "mean", rowSums(py[, 21:28]), sqrt(rowSums(py[, 21:28]^
    2)))
py$SnoOH <-
  ifelse(py$variable == "mean", rowSums(py[, 21:27]), sqrt(rowSums(py[, 21:27]^
    2)))
py$Lignin <-
  ifelse(py$variable == "mean", rowSums(py[, 3:28]), sqrt(rowSums(py[, 3:28]^
    2)))
py$`GCHO/G` <- py$GCHO / py$G
py$`GOH/G` <- py$GOH / py$G
py$`GCHO/GOH` <- py$Coniferaldehyde / py$GOH
py$`GCHO/lig` <- py$GCHO / py$Lignin
py$`Aldehydes/lig` <- py$Aldehydes / py$Lignin
py$`S/G` <- py$S / py$G
py$`H/G` <- py$H / py$G
py$`H/S` <- py$H / py$S

py <- py %>%
  select(-starts_with("X")) %>%
  pivot_longer(-c(genotype, variable), names_to = "unit", values_to = "value") %>%
  pivot_wider(id_cols = c("genotype", "unit"), names_from = variable, values_from = value)

py_rmn <- rmn_data_corrected %>%
  filter(wavenumber %in% selected_peaks$wavenumber) %>%
  group_by(cell.type, genotype, wavenumber, replicate, technical) %>%
  pivot_wider(
    id_cols = c(genotype, cell.type, replicate, technical), names_from = wavenumber,
    values_from = corrected.intensity
  ) %>%
  group_by(cell.type, genotype, replicate, technical) %>%
  transmute(
    "CLB" = (`1603` / 2) + `1334`,
    "1334/1603" = `1334` / `1603`,
    "1664/1603" = `1664` / `1603`,
    "1334/1276" = `1334` / `1276`,
    "1625/1603" = `1625` / `1603`,
    "1625/1664" = `1625` / `1664`,
    "1625/lig" = `1625` / ((`1603` / 2) + `1334`),
    "1625" = `1625`,
    "1334" = `1334`,
    "1603" = `1603`
  ) %>%
  pivot_longer(cols = -c(genotype, cell.type, replicate, technical), names_to = "wavenumber", values_to = "scaled") %>%
  group_by(genotype, wavenumber, cell.type) %>%
  summarise(
    mean.scaled = mean(scaled),
    sd.scaled = sd(scaled) / mean.scaled
  ) %>%
  group_by(genotype, wavenumber) %>%
  summarise(
    total.mean.scaled = mean(mean.scaled),
    total.sd.scaled = total.mean.scaled * sqrt(sum(sd.scaled^2))
  )

py_rmn_corr <- left_join(py, py_rmn) %>%
  mutate(WT = case_when(
    genotype == "Col-0" ~ "yes",
    TRUE ~ "no"
  ))

py_rmn_corr_mat <- py_rmn_corr %>%
  # filter(variable == "mean") %>%
  group_by(unit, wavenumber) %>%
  nest() %>%
  mutate(
    cor = map(data, ~ cor.test(.x$mean, .x$total.mean.scaled)),
    tidied = map(cor, tidy)
  ) %>%
  unnest(tidied)

broom::glance(lm(mean ~ total.mean.scaled, data = filter(py_rmn_corr, unit == "Lignin" &
  wavenumber == "CLB")))

# broom::tidy(lm(Lignin ~ `1603` + `1334`, data = filter(py_rmn_corr, variable == "mean")))





py_plot <- function(x, y, z = "bork", col = "white") {
  tidycor <- broom::tidy(cor.test(
    as.matrix(filter(py_rmn_corr, unit == x &
      wavenumber == y &
      genotype != z)[, "mean"]),
    as.matrix(filter(py_rmn_corr, unit == x &
      wavenumber == y &
      genotype != z)[, "total.mean.scaled"])
  ))
  print(tidycor)

  regr <- broom::glance(lm(mean ~ total.mean.scaled, data = filter(py_rmn_corr, unit == x &
    wavenumber == y &
    genotype != z)))

  ggplot(
    data = filter(py_rmn_corr, unit == x & wavenumber == y & genotype != z),
    aes(x = mean, y = total.mean.scaled)
  ) +
    geom_rect(
      data = tidycor,
      xmax = Inf,
      ymax = Inf,
      xmin = -Inf,
      ymin = -Inf,
      aes(
        fill = estimate,
        x = 0,
        y = 0
      )
    ) +
    geom_errorbar(aes(
      ymin = total.mean.scaled - total.sd.scaled,
      ymax = total.mean.scaled + total.sd.scaled
    ),
    size = 0.2,
    width = 0,
    alpha = 0.75
    ) +
    # geom_errorbarh(aes(xmin = mean - sd,
    #                   xmax = mean + sd),
    #               size = 0.2,
    #               height = 0) +
    geom_point(aes(colour = WT),
      size = 1,
      alpha = 0.75,
      shape = 16
    ) +
    geom_smooth(
      method = "lm",
      fullrange = T,
      size = 0.4,
      se = F,
      linetype = 1,
      colour = col
    ) +
    scale_colour_manual(values = c("yes" = "white", no = "black")) +
    scale_fill_distiller(
      palette = "RdYlBu",
      na.value = "white",
      name = "Pearson's r",
      limits = c(-1, 1)
    ) +
    scale_x_continuous(limits = c(0, NA)) +
    scale_y_continuous(limits = c(0, NA)) +
    annotate("text",
      label = paste("R² = ", round(regr$adj.r.squared, digits = 2)),
      x = 0,
      y = 0,
      size = ggtext_size,
      family = "Helvetica",
      hjust = 0,
      vjust = 0,
      colour = col
    ) +
    theme_leo() +
    theme(
      axis.text.y = element_text(
        angle = 90,
        hjust = 0.5
      ),
      plot.margin = unit(c(4, 2, 4, 4), "mm")
    )
  # geom_label_repel(aes(label = genotype),
  #                  size = 1,
  #                  segment.size = 0.2)
}

py_plot_lig <- py_plot("Lignin", "CLB", col = "black") +
  labs(
    x = expression(paste("Lignin * total pyrolysate"^-1)),
    y = expression(paste("CLB [AU * AUC"^-1, "]"))
  )
# scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6))

py_plot_sg <- py_plot("S/G", "1334/1276") +
  labs(
    x = expression(paste("S"[R], " * G"[R]^{
      -1
    })),
    y = expression(paste("1334 cm"^-1, "/ 1276 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 1, 2, 3))

py_plot_cho <- py_plot("GCHO/lig", "1625/lig") +
  labs(
    x = expression(paste("G"[CHO], " * lignin"^-1)),
    y = expression(paste("1625 cm"^-1, "/ CLB"))
  ) +
  scale_y_continuous(breaks = c(0, 0.4, 0.8), labels = c("0", "0.4", "0.8")) +
  scale_x_continuous(labels = c("0", "0.1", "0.2", "0.3", "0.4")) +
  geom_point(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype == "cad4xcad5"),
    aes(colour = WT),
    size = 1,
    alpha = 0.75,
    shape = 16
  ) +
  geom_errorbar(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype == "cad4xcad5"),
    aes(
      ymin = total.mean.scaled - total.sd.scaled,
      ymax = total.mean.scaled + total.sd.scaled
    ),
    size = 0.2,
    width = 0,
    alpha = 0.75
  ) +
  geom_smooth(
    data = filter(py_rmn_corr, unit == "GCHO/lig" & wavenumber == "1625/lig" & genotype != "cad4xcad5"),
    method = "lm",
    colour = "black",
    fullrange = T,
    size = 0.4,
    se = F,
    linetype = 2
  )
# annotate("text",
#          label = "R² = −0.12",
#          x = 0,
#          y = 0.1,
#          size = ggtext_size,
#          family = "Helvetica",
#          hjust = 0,
#          vjust = 0,
#             colour = "blue")

py_plot_goh <- py_plot("GOH/G", "1664/1603") +
  labs(
    x = expression(paste("G"^{
      OH
    }, " * total G-lignin"^-1)),
    y = expression(paste("1664 cm"^-1, "/ 1603 cm"^-1))
  )
# scale_y_continuous(breaks = c(0, 1, 2, 3))

py_plot_snooh <- py_plot("SnoOH", "1334") +
  labs(
    x = expression(paste("S-lignin " - " S-OH")),
    y = expression(paste("1334 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
  scale_x_continuous(breaks = c(0, 0.01, 0.02), labels = c("0", "0.01", "0.02"))

py_plot_soh <- py_plot("S-OH", "1334") +
  labs(
    x = expression(paste("S-OH")),
    y = expression(paste("1334 cm"^-1))
  ) +
  scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
  scale_x_continuous(breaks = c(0, 0.005, 0.01), labels = c("0", "0.005", "0.01"))

py_plot_scho <- py_plot("S-CHO", "1334") +
  labs(
    x = expression(paste("S-CHO")),
    y = expression(paste("1334 cm"^-1))
  )
# scale_y_continuous(breaks = c(0, 0.0015, 0.003), labels = c("0", "0.0015", "0.003")) +
# scale_x_continuous(breaks = c(0, 0.005, 0.01), labels = c("0", "0.005", "0.01"))

py_plot_snocho <- py_plot("SnoCHO", "1334") +
  labs(
    x = expression(paste("S" - "S-CHO")),
    y = expression(paste("1334 cm"^-1))
  )


pdf("Raman_raw.pdf", width = onehalfcol, height = 5)
right <- plot_grid(py_plot_lig,
  py_plot_sg,
  py_plot_cho,
  # py_plot_soh,
  # py_plot_snocho,
  # py_plot_snooh,
  ncol = 1,
  labels = c("", "C", "D"),
  label_size = 10,
  label_fontfamily = "Helvetica"
  # label_x = -0.02,
  # label_y = 1.01
)
plot_grid(plot_grid(total_corr),
  right,
  labels = c("A", "B"),
  label_size = 10,
  label_fontfamily = "Helvetica",
  # label_x = -0.005,
  # label_y = 1.01,
  rel_widths = c(1, 0.6),
  ncol = 2,
  align = "hv",
  axis = "t"
)
dev.off()
```

