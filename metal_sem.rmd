---
title: "Piecewise Structural Equation Modelling for Heavy Metal Uptake"
author: "Leonard Blaschek"
date: "29/05/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Uncomment to install the latest piecewiseSEM package from github
# install.packages("devtools")
# library(devtools)
# install_github("jslefche/piecewiseSEM@devel")

library(piecewiseSEM)
library(nlme)
library(tidyverse)
```

## Basic structure of a piecewiseSEM model

![**Figure 1: Nomenclature of a structural equation model.**](/home/leonard/R/Output/PhD/sem_variables.png)

The pseudo-code below shows how to build the simple model shown in figure 1.

```{r pseudo-code, eval=FALSE}

# build the model
model <- psem(
  lme("Endogenous variable 1" ~
        "Exogeneous variable 1",
      random = ~1|"random effect",
      data = "data"
      ),
  lme("Endogenous variable 2" ~
        "Endogenous variable 1" +
        "Exogeneous variable 1",
      random = ~1|"random effect",
      data = "data"
  ),
  data = "data"
)

# summarise the model
summary(model, .progressBar = FALSE)

# plot the model
plot(model, digits = 2)
```

```{r load data}
data <- read_csv("/home/leonard/R/Output/PhD/All_metals_all times_CSV.csv")
data <- data %>%
  rename(Zn_uptake_30 = "Zn_procent_ 0.5h",
         Blad_g = "Blad (g)",
         Total_vattenforlust = "Total vattenforlust",
         Finrotter_g = "Finrotter (g)") %>%
  filter(Latin != "Control") %>%
  select(Latin, Zn_uptake_30, Blad_g, Total_vattenforlust, Finrotter_g)
data <- as.data.frame(data)
head(data)
```

```{r first model}

first.model <- psem(
  lme(Zn_uptake_30 ~
  Total_vattenforlust +
    Finrotter_g,
  random = ~1|Latin,
  data = drop_na(data)
  ),
  lme(Blad_g ~
  Finrotter_g,
  random = ~1|Latin,
  data = drop_na(data)
  ),
  lme(Total_vattenforlust ~
  Blad_g,
  random = ~1|Latin,
  data = drop_na(data)
  ),
  data = drop_na(data)
)

summary(first.model, .progressBar = FALSE)
plot(first.model)
```

```{r second model}

second.model <- psem(
  lme(Zn_uptake_30 ~
  Total_vattenforlust +
    Blad_g +
    Finrotter_g,
  random = ~1|Latin,
  data = drop_na(data)
  ),
  lme(Blad_g ~
  Finrotter_g,
  random = ~1|Latin,
  data = drop_na(data)
  ),
  lme(Total_vattenforlust ~
  Blad_g,
  random = ~1|Latin,
  data = drop_na(data)
  ),
  data = drop_na(data)
)

summary(second.model, .progressBar = FALSE)
plot(second.model)
```
