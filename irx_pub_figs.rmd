---
title: "IRX publication figures"
author: "Leonard Blaschek"
date: "07/10/2019"
output: 
  pdf_document:
    latex_engine: lualatex
    fig_caption: yes
    fig_height: 6
    includes:
      in_header: rmd_temp.tex
sansfont: IBM Plex Sans
monofont: Inconsolata
mainfont: IBM Plex Sans
bibliography: /home/leonard/Documents/Bibliographics/zotero_lib.bib
link-citations: true
linkcolor: black
urlcolor: blue
citecolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(baseline)
library(interactions)
library(effects)
library(grid)
library(png)
library(magick)
library(agricolae)
library(ggthemes)
library(showtext)
library(zoo)
library(cowplot)
library(tidyverse)
library(ggbeeswarm)
library(ggridges)
library(sf)
library(piecewiseSEM)
library(tukeygrps)
library(scales)


pal_ostwald_cont <- c("#155DA7", 
                      "#0A75B9", 
                      # "#0C89C9", 
                      "#FED32F", 
                      # "#F8A63A", 
                      "#EF663A", 
                      "#ED4137")
pal_ostwald_cont2 <- c("#275d95", 
                       "#286e9b",
                       "#e8c245",
                       "#d37456",
                       "#d25952")
pal_ostwald_disc <- c("#275d95", 
                      "#e8c245", 
                      "#d25952")
pal_ostwald_disc2 <- c("#8fab1d", 
                       "#2d7d73", 
                       "#1d566f")
pal_ostwald_disc3 <- c("#275d95",
                       "#275d95",
                      "#e8c245",
                      "#d25952",
                      "#d25952")
pal_flame <- c("#1F265D", 
               "#203F8F", 
               "#404678", 
               "#897B88", 
               "#E7BBA2", 
               "#FFEDC3", 
               "#FEFEFE")
pal_flame_disc <- c("#ffedc3", 
                    "#897b88", 
                    "#1f265d")
pal_ylgnbu <- c("#c7e9b4",
                "#7fcdbb",
                "#41b6c4",
                "#1d91c0",
                "#225ea8",
                "#253494",
                "#081d58")


#### import CooperHewitt ####
font_add(
  "Helvetica",
  regular = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Lt.otf",
  italic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-LtIt.otf",
  bold = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Bd.otf",
  bolditalic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-BdIt.otf"
)
showtext_auto()

#### generating plot theme ####
theme_leo <- function(base_size = 6,
                      base_family = "Helvetica") {
  theme_minimal(
    base_size = base_size,
    base_family = base_family
  ) %+replace%
    theme(
      strip.text = element_text(hjust = 0, face = "italic"),
      axis.ticks = element_line(
        size = 0.125,
        lineend = "square",
        color = "black"
      ),
      axis.text.x = element_text(
        size = 6,
        colour = "black", # flipped coords
        margin = margin(1, 1, 1, 1)
      ),
      axis.text.y = element_text(
        colour = "black",
        size = 6,
        angle = 0,
        vjust = 0.5,
        hjust = 1,
        margin = margin(1, 1, 1, 1)
      ),
      axis.title = element_text(
        colour = "black",
        size = 6
      ),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black", size = 0.25),
      panel.spacing = unit(1.5, "mm"),
      legend.position = "none",
      legend.text = element_text(size = 6),
      legend.key.height = unit(4, "mm"),
      plot.title = element_text(size = 6,
                                hjust = 0),
      complete = TRUE
    )
}

equal_breaks <- function(n = 3, s = 0.05, ...) {
  function(value) {
    # rescaling
    d <- s * diff(range(value)) / (1 + 2 * s)
    round(seq(0, max(value) - d, length = n), digits = 2)
  }
}

my_breaks <- function(value) {
  if (
    max(value) < 0.005) {
    seq(0, 0.004, length.out = 3)
  } else if (
    max(value) < 0.05) {
    seq(0, 0.02, length.out = 3)
  } else if (
    max(value) < 2) {
    seq(0, 1, length.out = 3)
  } else {
    seq(0, 100, length.out = 3)
  }
}

my_limits <- function(value) {
  if (
    max(value) < 0.005) {
    c(0, 0.0045)
  } else if (
    max(value) < 0.05) {
    c(0, 0.025)
  } else if (
    max(value) < 2) {
    c(-0.25, 1.1)
  } else {
    c(-10, 120)
  }
}

ggtext_size <- 6 / (14 / 5)
twocol <- 18 / 2.54
onehalfcol <- 14 / 2.54
onecol <- 9 / 2.54
```


## EM drying collapse

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
em_data <- read_csv("/home/leonard/Documents/Uni/PhD/IRX/EM/AD_collapse.csv") %>%
  pivot_longer(cols = c(PX, MX), names_to = "cell.type", values_to = "count") %>%
  mutate(state = ordered(state, levels = c("Fully", "Partially", "Intact")),
         cell.type = ordered(cell.type, levels = c("PX", "MX")),
         days = paste(days, "days")) %>%
  group_by(experiment, treatment, days, cell.type) %>%
  mutate(sum = sum(count)) %>%
  group_by(experiment, treatment, days, cell.type, state) %>%
  mutate(proportion = count / sum)

em_data_avg <- em_data %>%
  group_by(treatment, days, cell.type, state) %>%
  summarise(proportion = mean(proportion))

em_data_points <- em_data %>%
  select(-sum, -count) %>%
  group_by(treatment, days, cell.type, state) %>%
  pivot_wider(id_cols = -c(state, proportion), names_from = state, values_from = proportion) %>%
  mutate(Partially = Partially + Intact,
         Fully = Fully + Partially) %>%
  pivot_longer(cols = c(Fully, Partially, Intact), names_to = "state", values_to = "proportion") %>%
  mutate(state2 = case_when(state == "Intact" ~ "Partially",
                            state == "Partially" ~ "Fully",
                            TRUE ~ "none"))

em_collapse <- ggplot(em_data_avg %>% filter(treatment == "AD"), aes(x = cell.type, 
                                   y = proportion, 
                                   # group = experiment, 
                                   fill = state)) +
  geom_col(alpha = 0.85,
           width = 0.6) +
  geom_point(data = em_data_points %>% filter(treatment == "AD" &
                                                state != "Fully"),
    aes(group = experiment,
        y = proportion - 0.01),
    position = position_dodge(width = 0.5),
    shape = 25,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 1,
    stroke = 0.2) +
    geom_point(data = em_data_points %>% filter(treatment == "AD" &
                                                state != "Fully"),
    aes(group = experiment,
        fill = state2,
        y = proportion + 0.01),
    position = position_dodge(width = 0.5),
    shape = 24,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 1,
    stroke = 0.2) +
  scale_fill_manual(values = rev(pal_ostwald_disc), name = "Collapse") +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05))) +
  theme_leo() +
  labs(y = "Proportion") +
  facet_wrap(~ days, nrow = 1) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank(),
        legend.key.size = unit(4, "mm"))

pdf("em_collapse.pdf", width = onecol, height = onecol / 2)
em_collapse
dev.off()
```

## AFM ratios 

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
afm_px <- read_csv("/home/leonard/Documents/Uni/PhD/IRX/AFM/afm_PX.csv") %>%
  mutate(days = as.character(days)) %>%
  pivot_longer(cols = c(modulus, deformation, adhesion), names_to = "variable", values_to = "value") %>%
  group_by(cell.type, days, cell, measurement, variable) %>%
  summarise(ratio = value[layer == "SCW"] / value[layer == "PCW"]) %>%
  filter(!(variable == "adhesion" & 
             cell == "Cell 4" & 
             measurement == 6 & 
             days == "50")) # remove > 20-fold outlier

rmn_violin <- function(x) { 
  afm_px <- afm_px %>%
    unite("ct.time", cell.type, days)
  
  letters <- letter_groups(afm_px %>% filter(variable == x),
                                 ratio,
                                 ct.time,
                                 "tukey",
                                 print_position = "below",
                                 print_adjust = 0.5
  ) %>%
    separate(ct.time, into = c("cell.type", "days"))
  
  afm_px <- afm_px %>%
    separate(ct.time, into = c("cell.type", "days"))
  
  ggplot(
  data = afm_px %>% filter(variable == x),
  aes(x = days, y = ratio)
) +
  # geom_line(aes(group = interaction(cell.type, variable, cell, measurement)),
  #           size = 0.2,
  #           alpha = 0.25) +
  geom_quasirandom(
    aes(fill = cell.type, group = days),
    dodge.width = 0.6,
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 2,
    stroke = 0.2
  ) +
  # geom_boxplot(
  #   aes(group = interaction(cell.type, variable), fill = cell.type),
  #   # fill = "white",
  #   alpha = 0.5,
  #   width = 0.6,
  #   position = position_dodge2(width = 1),
  #   outlier.alpha = 0,
  #   lwd = 0.25,
  #   fatten = 1,
  #   width = 0.25
  # ) +
geom_violin(aes(group = interaction(days, cell.type),
                # fill = cell.type
),
draw_quantiles = 0.5,
fill = "white",
colour = "black",
alpha = 0.85,
width = 0.2,
position = position_dodge(width = 0.6),
size = 0.2,
scale = "width"
) +
  geom_text(
    data = letters,
    aes(label = groups),
    size = ggtext_size,
    family = "Helvetica",
    position = position_dodge(width = 0.6)
  ) +
  # scale_x_discrete(labels = c("PX", "PMX", "SMX")) +
  scale_fill_manual(values = pal_flame_disc) +
  expand_limits(y = 0) +
  scale_y_continuous(expand = expand_scale(mult = c(0.1, 0.05))) +
  theme_leo() +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "none",
  ) 
}

modulus <- rmn_violin("modulus") +
  labs(x = "",
       y = "Relative DMT modulus")

deformation <- rmn_violin("deformation") +
  labs(x = "Days after induction",
       y = "Relative deformation")

adhesion <- rmn_violin("adhesion") +
  labs(x = "",
       y = "Relative adhesion") 

pdf("afm_ratios.pdf", width = onecol, height = onecol / 2)
afm_ratios <- plot_grid(
  modulus,
  deformation,
  adhesion,
  labels = c("A", "B", "C"),
  vjust = 1,
  nrow = 1,
  label_size = 10,
  label_fontfamily = "Helvetica"
)
afm_ratios
dev.off()
  
```

## Plant bending

### Hydration influence

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
medium_data <- read_csv("/home/leonard/Documents/Uni/PhD/IRX/Bending/WT_medium.csv") %>%
  pivot_longer(cols = c(stiffness, strength), values_to = "value", names_to = "variable")

rmn_violin <- function(x) { 

  letters <- letter_groups(medium_data %>% filter(variable == x),
                                 value,
                                 medium,
                                 "tukey",
                                 print_position = "below",
                                 print_adjust = 0.5
  ) 
  
  ggplot(
  data = medium_data %>% filter(variable == x),
  aes(x = medium, y = value)
) +
  # geom_line(aes(group = interaction(cell.type, variable, cell, measurement)),
  #           size = 0.2,
  #           alpha = 0.25) +
  geom_quasirandom(
    aes(fill = medium),
    dodge.width = 0.6,
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 1.5,
    stroke = 0.2
  ) +
  # geom_boxplot(
  #   aes(group = interaction(cell.type, variable), fill = cell.type),
  #   # fill = "white",
  #   alpha = 0.5,
  #   width = 0.6,
  #   position = position_dodge2(width = 1),
  #   outlier.alpha = 0,
  #   lwd = 0.25,
  #   fatten = 1,
  #   width = 0.25
  # ) +
geom_violin(
  # aes(group = interaction(days, cell.type),
                # fill = cell.type
# ),
draw_quantiles = 0.5,
fill = "white",
colour = "black",
alpha = 0.85,
width = 0.2,
position = position_dodge(width = 0.6),
size = 0.2,
scale = "width"
) +
  geom_text(
    data = letters,
    aes(label = groups),
    size = ggtext_size,
    family = "Helvetica",
    position = position_dodge(width = 0.6)
  ) +
  # scale_x_discrete(labels = c("PX", "PMX", "SMX")) +
  # scale_fill_manual(values = pal_flame_disc) +
  scale_fill_grey(start = 0.9, end = 0.1) +
  expand_limits(y = 0) +
  scale_y_continuous(expand = expand_scale(mult = c(0.1, 0.05))) +
  theme_leo() +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "none",
    axis.title.x = element_blank()
  ) 
}

medium_strength <- rmn_violin("strength") +
  labs(y = "Flexural strength [MPa]") 
medium_stiffness <- rmn_violin("stiffness") +
  labs(y = "Flexural stiffness [MPa]")

pdf("bending_medium.pdf", width = onecol / 1.25, height = onecol / 3)
hydration <- plot_grid(
  medium_strength,
  medium_stiffness,
  labels = c("B", "C"),
  # vjust = 1,
  nrow = 1,
  rel_widths = c(1, 1.1),
  label_size = 10,
  label_fontfamily = "Helvetica"
)
hydration
dev.off()
```

### Bending curves

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
curve_data <- read_csv("/home/leonard/Documents/Uni/PhD/IRX/Bending/bending_curve.csv") %>%
  mutate(genotype = ordered(genotype, levels = c("WT", "4cl1x4cl2x4cl3")))

curves <- ggplot(data = curve_data, 
                 aes(x = strain, y = stress)) +
  geom_line(aes(group = interaction(genotype, replicate)),
            size = 0.2,
            alpha = 0.15) +
  geom_smooth(aes(colour = genotype),
              size = 0.4) +
  scale_color_manual(values = pal_ostwald_disc[c(1,3)]) +
  theme_leo() +
  xlim(0, 3) +
  labs(x = "Flexural strain [%]",
       y = "Flexural stress [MPa]") +
  facet_wrap(~ genotype, nrow = 2)

pdf("bending_curves.pdf", width = onecol / 2, height = onecol / 2)
curves
dev.off()
```

### S influence

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
s_data <- read_csv("/home/leonard/Documents/Uni/PhD/IRX/Bending/stiffness_s.csv") %>%
  tidyr::fill(everything()) %>%
  pivot_longer(cols = c(stiffness, strength), values_to = "value", names_to = "variable") %>%
  mutate(genotype = ordered(genotype, levels = c("WT", "fah1")))

s_test <- s_data %>% filter(variable == "stiffness")
p_values <- s_test %>%
  group_by(section) %>%
  transmute(p_value = broom::tidy(
  t.test(value[genotype == "WT"], value[genotype == "fah1"])
  )[["p.value"]]) %>%
  mutate(p_value =  round(p_value, digits = 3))

rmn_violin <- function(x) { 

s_test <- s_data %>% filter(variable == x)
p_value <- broom::tidy(
  t.test(s_test$value[s_test$genotype == "WT"], s_test$value[s_test$genotype == "fah1"])
  )[["p.value"]] %>%
  formatC(., format = "e", digits = 0)
  
  ggplot(
  data = s_data %>% filter(variable == x),
  aes(x = genotype, y = value)
) +
  # geom_line(aes(group = interaction(cell.type, variable, cell, measurement)),
  #           size = 0.2,
  #           alpha = 0.25) +
  geom_quasirandom(
    aes(fill = genotype),
    dodge.width = 0.6,
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 1,
    stroke = 0.2
  ) +
  # geom_boxplot(
  #   aes(group = interaction(cell.type, variable), fill = cell.type),
  #   # fill = "white",
  #   alpha = 0.5,
  #   width = 0.6,
  #   position = position_dodge2(width = 1),
  #   outlier.alpha = 0,
  #   lwd = 0.25,
  #   fatten = 1,
  #   width = 0.25
  # ) +
geom_violin(
  # aes(group = interaction(days, cell.type),
                # fill = cell.type
# ),
draw_quantiles = 0.5,
fill = "white",
colour = "black",
alpha = 0.85,
width = 0.2,
position = position_dodge(width = 0.6),
size = 0.2,
scale = "width"
) +
  annotate("text",
           x = 2.5,
           y =0,
           label=paste("italic(P)==", p_value), 
           parse=TRUE,
           size = ggtext_size,
           family = "Helvetica",
           hjust = 1) +
  scale_x_discrete(labels = c("WT", expression(italic("fah1")))) +
  scale_fill_manual(values = pal_ostwald_disc[c(1,3)]) +
  expand_limits(y = 0) +
  scale_y_continuous(expand = expand_scale(mult = c(0.1, 0.05))) +
  theme_leo() +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "none",
    axis.title.x = element_blank()
  )
}

medium_strength <- rmn_violin("strength") +
  labs(y = "Flexural strength [MPa]")
medium_stiffness <- rmn_violin("stiffness") +
  labs(y = "Flexural stiffness [MPa]")

pdf("s_influence.pdf", width = onecol / 1.25, height = onecol / 3)
s_inf <- plot_grid(
  medium_strength,
  medium_stiffness,
  labels = c("D", "E"),
  # vjust = 1,
  nrow = 1,
  label_size = 10,
  rel_widths = c(1, 1.1),
  label_fontfamily = "Helvetica"
)
s_inf
dev.off()

```
### assemble bending figure

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}

#### Load images ####
WT <-
  rasterGrob(
    readPNG(
      "/home/leonard/Dropbox/IRX manuscript/Edits/cropped_images/WT_plant.png"
      )
  )

#### plot grid ####

top <- plot_grid(
  plot_grid(WT,
            labels = c("A"),
  label_fontfamily = "Helvetica",
  label_colour = "white",
  # vjust = 1,
  label_size = 10),
  hydration,
  ncol = 2,
  labels = c("", "B"),
  label_fontfamily = "Helvetica",
  label_size = 10,
  # vjust = 1,
  rel_widths = c(1, 2)
)

bottom <- plot_grid(
      s_inf,
      curves,
      ncol = 2,
      labels = c("", "F"),
      label_fontfamily = "Helvetica",
      label_size = 10,
      # vjust = 1,
  rel_widths = c(1, 1)
  )


pdf("IRX_figure4.pdf", width = onecol, height = onecol)
plot_grid(top, bottom,
          nrow = 2,
          rel_heights = c(1, 1))
dev.off()
```

## Wild type vessel overview

### Load shape data

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
#### import and tidy shape data of the vessels from the Raman measurements ####
rmn_irx <- read.csv("file:///home/leonard/Documents/Uni/PhD/IRX/raman_IRX_revisited.csv") %>%
  select(genotype:Perim., Circ., Round, Height, Width) %>%
  filter(object == 2) %>%
  select(-object)

rmn_nb <- read.csv("file:///home/leonard/Documents/Uni/PhD/IRX/raman_IRX.csv") %>%
  select(genotype:n_f)
rmn_irx <- left_join(rmn_irx, rmn_nb)
rmn_irx$replicate <- as.character(rmn_irx$replicate)
rmn_irx$technical <- as.character(rmn_irx$technical)

raman_convex <- read.csv("/home/leonard/Documents/Uni/PhD/IRX/raman_irx_convex.csv")

raman_convex$File <-
  str_replace(raman_convex$File, fixed("fah 1"), "fah1")

raman_convex <- raman_convex %>%
  select(-X) %>%
  separate(
    File,
    into = c("genotype", "replicate", "cell.type", "technical"),
    sep = "\\s*#|-|\\s",
    extra = "merge"
  ) %>%
  mutate(
    genotype = recode(
      genotype,
      "4cl1＆2" = "4cl1x4cl2",
      "cad4＆5" = "cad4xcad5",
      "ccoaomt" = "ccoaomt1",
      "ccr1" = "ccr1-3",
      "col.o" = "Col-0",
      "Col.0" = "Col-0",
      "ccr1＆fah1" = "ccr1xfah1"
    ),
    cell.type = recode(cell.type,
      "px" = "PX",
      "SX" = "SMX",
      "MX" = "PMX"
    ),
    replicate = str_extract(
      replicate,
      "\\d"
    ),
    technical = str_extract(
      technical,
      "(\\d)+"
    )
  ) %>%
  filter(cell.type != "？？")

rmn_irx <- left_join(rmn_irx, raman_convex) %>%
  # group_by(genotype, replicate, technical, cell.type) %>%
  mutate(Perim. = Perim. * (5.9 / 3.2), # correct wrong scale while measuring
         Area = Area * (5.9 / 3.2)^2,
         ConvexArea = ConvexArea * (5.9 /3.2)^2
         )
  
  
```

### Load Raman data

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
#### import and tidy Raman data ####
rmn_files <-
  list.files(
    path = "/home/leonard/Documents/Uni/PhD/IRX/RAMAN/nuoendagula/",
    pattern = "*.txt",
    recursive = TRUE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = FALSE,
    skip = 25,
    cols_only(
      X1 = col_number(),
      X2 = col_number()
    )
  ) %>%
    mutate(
      filename = flnm,
      exp_time = readLines(flnm) %>%
        str_split("\t") %>%
        grep("Exposure Time: .* s", ., value = T) %>%
        str_remove_all("#Exposure Time: | s") %>%
        as.numeric(),
      pwr = readLines(flnm) %>%
        str_split("\t") %>%
        grep("Excitation Power: .* mW", ., value = T) %>%
        str_remove_all("#Excitation Power: | mW") %>%
        as.numeric(),
      nd_fltr = 1 - (readLines(flnm) %>%
        str_split("\t") %>%
        grep("% \\([0-9]{3}/255\\)", ., value = T) %>%
        str_remove_all("#ND Filter : | % \\([0-9]{3}/255\\)") %>%
        as.numeric() / 100)
    )
}

rmn_data <- lapply(rmn_files, read_plus) %>%
  bind_rows()

# rmn_data <- rmn_data %>%
#   select(c(1:3))

rmn_data$filename <- basename(rmn_data$filename)

rmn_data$filename <-
  str_replace(rmn_data$filename, fixed("fah 1"), "fah1")

rmn_data <- rmn_data %>%
  distinct(X1, filename, .keep_all = TRUE) %>%
  separate(
    filename,
    into = c("genotype", "replicate", "cell.type", "technical"),
    sep = "\\s*#|-|\\s",
    extra = "merge"
  ) %>%
  rename("wavenumber" = X1, "intensity" = X2) %>%
  mutate(
    genotype = recode(
      genotype,
      "4cl1＆2" = "4cl1x4cl2",
      "cad4＆5" = "cad4xcad5",
      "ccoaomt" = "ccoaomt1",
      "ccr1" = "ccr1-3",
      "col.o" = "Col-0",
      "Col.0" = "Col-0",
      "ccr1＆fah1" = "ccr1xfah1"
    ),
    cell.type = recode(cell.type,
      "px" = "PX",
      "SX" = "SMX",
      "MX" = "PMX"
    ),
    replicate = str_extract(
      replicate,
      "\\d"
    ),
    technical = str_extract(
      technical,
      "(\\d)+"
    ),
    wavenumber = round(wavenumber, digits = 0)
  ) %>%
  filter(cell.type != "？？") %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  mutate(intensity = intensity / (exp_time * pwr * nd_fltr)) %>%
  select(-exp_time, -pwr, -nd_fltr)

#### baseline correct Raman data ####
rmn_data_wide <- rmn_data %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  mutate(group_id = row_number()) %>%
  spread(wavenumber, intensity) %>%
  select(-group_id) %>%
  summarise_all(funs(sum(., na.rm = TRUE)))

rmn_data_mat <- as.matrix(rmn_data_wide[, -c(1:4)])
rownames(rmn_data_mat) <- paste(rmn_data_wide$genotype,
  rmn_data_wide$cell.type,
  rmn_data_wide$replicate,
  rmn_data_wide$technical,
  sep = "_"
)

rmn_data_correction <- baseline.als(rmn_data_mat,
  lambda = 5,
  p = 0.01,
  maxit = 100
)
rmn_data_corrected <- as_tibble(rmn_data_correction$corrected, rownames = NA)

rmn_data_corrected <- rmn_data_corrected %>%
  rownames_to_column() %>%
  separate(rowname, sep = "_", into = c("genotype", "cell.type", "replicate", "technical"), remove = TRUE) %>%
  gather(key = "wavenumber", value = "corrected.intensity", -c(genotype, cell.type, replicate, technical)) %>%
  mutate(wavenumber = str_replace(wavenumber, pattern = fixed("X."), replacement = "-")) %>%
  mutate(wavenumber = str_replace(wavenumber, pattern = fixed("X"), replacement = "")) %>%
  mutate(wavenumber = as.numeric(wavenumber)) %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  inner_join(., rmn_data, by = c("genotype", "cell.type", "replicate", "technical", "wavenumber")) %>%
  ungroup() %>%
  filter(genotype != "ccr1xfah1" &
    wavenumber %in% c(300:1700)) %>%
  mutate(
    genotype = ordered(genotype,
      levels = c(
        "Col-0",
        "4cl1",
        "4cl2",
        "4cl1x4cl2",
        "ccoaomt1",
        "fah1",
        "omt1",
        "ccr1-3",
        "cad4",
        "cad5",
        "cad4xcad5"
      )
    )
    )

write_csv(rmn_data_corrected, "rmn_data_corrected.csv")
# rmn_data_corrected <- read_csv("rmn_data_corrected.csv", col_types = "ccccnnn") %>%
#   mutate(
#     genotype = ordered(genotype,
#       levels = c(
#         "Col-0",
#         "4cl1",
#         "4cl2",
#         "4cl1x4cl2",
#         "ccoaomt1",
#         "fah1",
#         "omt1",
#         "ccr1-3",
#         "cad4",
#         "cad5",
#         "cad4xcad5"
#       )
#     )
#   )

rmn_data_corrected <- rmn_data_corrected %>%
  # left_join(lig_peak) %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  mutate(
    AUC = MESS::auc(wavenumber, corrected.intensity),
    scaled = corrected.intensity / AUC,
    scaled_lig = corrected.intensity / (
      corrected.intensity[wavenumber == 1603] + 2 * corrected.intensity[wavenumber == 1334]
    ))

rmn_data_pre <- rmn_data_corrected %>%
  group_by(genotype, cell.type, replicate, wavenumber) %>%
  summarise(
    samples.pre = length(corrected.intensity),
    mean.scaled = mean(scaled, na.rm = TRUE),
    mean.scaled_lig = mean(scaled_lig, na.rm = TRUE),
    # mean.lig_peak = mean(lig_peak, na.rm = TRUE)
  )

rmn_data_avg <- rmn_data_pre %>%
  group_by(genotype, cell.type, wavenumber) %>%
  summarise(
    mean.scaled = mean(mean.scaled, na.rm = TRUE),
    mean.scaled_lig = mean(mean.scaled_lig, na.rm = TRUE),
    # mean.lig_peak = mean(mean.lig_peak, na.rm = TRUE)
  )

#### average Raman data, calculate integrals and detect peaks ####
rmn_sum <- rmn_data_corrected %>%
  group_by(genotype, cell.type, replicate, technical) %>%
  summarise(
    "total_lignin" = scaled[wavenumber == 1603] + 2 * scaled[wavenumber == 1334],
    "GOH_rel" = scaled_lig[wavenumber == 1664],
    "GOH.G" = scaled_lig[wavenumber == 1664] / scaled_lig[wavenumber == 1603],
    # "GOH_tot" = scaled[wavenumber == 1664],
    # "G_tot" = scaled[wavenumber == 1603],
    "G_rel" = scaled_lig[wavenumber == 1603],
    "S.G" = scaled[wavenumber == 1334] / scaled[wavenumber == 1276],
    "GCHO.lig" = scaled_lig[wavenumber == 1625],
    "S_rel" = scaled_lig[wavenumber == 1334],
    # "S_tot" = scaled[wavenumber == 1334],
    "cellulose" = scaled[wavenumber == 1099] + scaled[wavenumber == 381],
    "AUC" = mean(AUC)
  )
```

### assemble figure

```{r figure 2, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%', fig.width=5, fig.height=4}
rmn_sum_long <- rmn_sum %>%
  filter(cell.type != "IF" & genotype == "Col-0") %>%
  group_by(cell.type, replicate, technical) %>%
  select(-genotype) %>%
  left_join(rmn_irx %>%
              filter(genotype == "Col-0") %>%
              select(
                cell.type,
                replicate,
                technical,
                Area,
                # Perim.,
                n_v,
                n_p,
                n_f
              )) %>%
  pivot_longer(
    cols = -c(cell.type:technical),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ungroup() %>%
  mutate(
    # variable = ordered(recode(variable,
    #                           "n_v" = "Adjacent vessels",
    #                           "n_f" = "Adjacent fibres",
    #                           "n_p" = "Adjacent parenchyma",
    #                           # "Perim." = "Perimeter"
    # ),
    # levels = c(
    #   "Area",
    #   # "Perimeter",
    #   "Adjacent vessels",
    #   "Adjacent fibres",
    #   "Adjacent parenchyma",
    #   "Cellulose band intensity",
    #   "Lignin band intensity",
    #   "Relative G-lignin",
    #   "Relative S-lignin",
    #   "Relative CHO-lignin"
    # )
    # ),
    cell.type = ordered(cell.type, levels = c("PX", "PMX", "SMX"))
  ) 

rmn_adj <- rmn_sum_long %>%
  filter(variable %in% c("n_v", "n_f", "n_p")) %>%
  mutate(variable = ordered(as.factor(variable), levels = c("n_p", "n_f", "n_v")))

rmn_adj_letters <- letter_groups(rmn_adj,
value,
cell.type,
"tukey",
variable,
print_position = "below",
print_adjust = 0.5
) %>%
  mutate(cell.type = ordered(cell.type, levels = c("PX", "PMX", "SMX")))

rmn_adj_box <- ggplot(
  data = rmn_adj,
  aes(x = variable, y = value * 100)
) +
  geom_quasirandom(
    aes(group = interaction(cell.type, variable),
        fill = cell.type),
    dodge.width = 0.6,
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 2,
    stroke = 0.25
  ) +
  # geom_boxplot(
  #   aes(group = interaction(cell.type, variable), fill = cell.type),
  #   # fill = "white",
  #   alpha = 0.5,
  #   width = 0.6,
  #   position = position_dodge2(width = 1),
  #   outlier.alpha = 0,
  #   lwd = 0.25,
  #   fatten = 1,
  #   width = 0.25
  # ) +
  geom_violin(aes(group = interaction(cell.type, variable),
                  # fill = cell.type
                  ),
              draw_quantiles = 0.5,
              fill = "white",
              colour = "black",
              alpha = 0.85,
              width = 0.2,
              position = position_dodge(width = 0.6),
              size = 0.2,
              scale = "width"
              ) +
  geom_text(
    data = rmn_adj_letters,
    aes(group = interaction(cell.type, variable),
        label = groups),
    size = 6 / (14 / 5),
    family = "Helvetica",
    position = position_dodge(width = 0.6)
  ) +
  annotate("text",
           x = c(0.8, 1, 1.2),
           y = c(100, 90, 25),
           label = c("PX", "PMX", "SMX"),
           family = "Helvetica",
           size = ggtext_size) +
  annotate("segment",
    x = c(0.8, 1, 1.2),
    xend = c(0.8, 1, 1.2),
    y = c(95, 85, 20),
    yend = c(85, 75, 5),
    colour = "black",
    size = 0.2
  ) +
  scale_x_discrete(labels = c("Parenchyma", "Fibres", "Vessels")) +
  # scale_fill_grey(start = 1, end = 0) +
  # scale_fill_brewer(palette = "Greys") +
  scale_fill_manual(values = pal_flame_disc) +
  # scale_fill_manual(values = pal_ostwald[c(3, 4, 6)]) +
  # scale_colour_manual(values = pal_ostwald[c(3, 4, 6)]) +
  labs(
    x = "Neighbouring cell type",
    y = "CW adjacent [%]"
  ) +
  theme_leo() +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "none"
  ) 

pdf("rmn_adj_box.pdf", width = 9 / 2.54, height = 1.5)
rmn_adj_box
dev.off()


rmn_violin <- function(x) { 
  letters <- letter_groups(rmn_sum_long %>% filter(variable == x),
                                 value,
                                 cell.type,
                                 "tukey",
                                 print_position = "below",
                                 print_adjust = 1
) %>%
  mutate(cell.type = ordered(cell.type, levels = c("PX", "PMX", "SMX")))
  
  ggplot(
  data = rmn_sum_long %>% filter(variable == x),
  aes(x = cell.type, y = value)
) +
  geom_quasirandom(
    aes(fill = cell.type),
    dodge.width = 0.6,
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 2,
    stroke = 0.2
  ) +
  # geom_boxplot(
  #   aes(group = interaction(cell.type, variable), fill = cell.type),
  #   # fill = "white",
  #   alpha = 0.5,
  #   width = 0.6,
  #   position = position_dodge2(width = 1),
  #   outlier.alpha = 0,
  #   lwd = 0.25,
  #   fatten = 1,
  #   width = 0.25
  # ) +
geom_violin(aes(group = cell.type,
                # fill = cell.type
),
draw_quantiles = 0.5,
fill = "white",
colour = "black",
alpha = 0.85,
width = 0.2,
position = position_dodge(width = 0.6),
size = 0.2,
scale = "width"
) +
  geom_text(
    data = letters,
    aes(label = groups),
    size = ggtext_size,
    family = "Helvetica",
    position = position_dodge(width = 0.6)
  ) +
  scale_x_discrete(labels = c("PX", "PMX", "SMX")) +
  scale_fill_manual(values = pal_flame_disc) +
  expand_limits(y = 0) +
  theme_leo() +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "none",
  ) 
}

rmn_area <- rmn_violin("Area") +
  labs(
    x = "",
    y = expression(paste("Area [µm"^2,"]"))
  )

rmn_lig <- rmn_violin("total_lignin") +
  labs(
    x = "",
    y = expression(paste("Relative lignin"))
  ) +
  expand_limits(y = 0.015)

rmn_s <- rmn_violin("S_rel") +
  labs(
    x = "",
    y = expression(paste("Relative S-lignin"))
  )

rmn_g <- rmn_violin("G_rel") +
  labs(
    x = "",
    y = expression(paste("Relative G-lignin"))
  )

rmn_goh <- rmn_violin("GOH.G") +
  labs(
    x = "",
    y = expression(paste("Relative G"[CHOH]))
  )

rmn_cellu <- rmn_violin("cellulose") +
  labs(
    x = "",
    y = expression(paste("Relative cellulose"))
  )

celltypes_WT <-
  rasterGrob(image_read_pdf(
    "/home/leonard/Dropbox/IRX manuscript/Figures/IRX_WT.pdf",
    density = 600
  ))


top <- plot_grid(celltypes_WT,
  rmn_adj_box,
  labels = c("A", "B"),
  nrow = 1,
  rel_widths = c(1, 2.2),
  vjust = 1,
  label_size = 10,
  label_fontfamily = "Helvetica"
)
bottom <- plot_grid(rmn_area,
  rmn_cellu,
  rmn_lig,
  rmn_g,
  rmn_goh,
  rmn_s,
  labels = c("C", "D", "E", "F", "G", "H"),
  vjust = 1,
  nrow = 2,
  label_size = 10,
  label_fontfamily = "Helvetica",
  align = "hv",
  axis = "lr"
)

pdf("IRX_Figure2.pdf", width = onecol, height = onecol)
plot_grid(top,
          bottom,
          nrow = 2,
          rel_heights = c(1.3,2))
dev.off()
```
## Model figure
### Visual vessel overview

These are all the vessel shapes that I measured in the Wiesner images, just for an idea how the collapse looks.

```{r figure 3, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}
irx_data <-
  read.csv("file:///home/leonard/Documents/Uni/PhD/IRX/irx_measurements.csv", sep = "\t")
# irx_data <- subset(irx_data, replicate == 1 & technical == 3)
irx_ref <- subset(irx_data, object == "ref", select = c(1, 2, 3, 6, 7, 27))
irx_ref$ref.y1 <- irx_ref$Y
irx_ref$ref.y2 <- irx_ref$Y
irx_ref$ref.x1 <- irx_ref$X - (irx_ref$Length / 2)
irx_ref$ref.x2 <- irx_ref$X + (irx_ref$Length / 2)

# irx_data <-
#   merge(subset(irx_data, object != "ref"),
#         irx_ref[, c(1, 2, 3, 7, 8, 9, 10)],
#         by = c("genotype", "replicate", "technical"))

irx_data <- irx_data %>%
  filter(object != "ref") %>%
  left_join(irx_ref[, c(1, 2, 3, 7, 8, 9, 10)],
    by = c("genotype", "replicate", "technical")
  )

irx_data$Distance <-
  apply(
    irx_data[, c("X", "Y", "ref.x1", "ref.x2", "ref.y1", "ref.y2")],
    1,
    function(x) {
      a <- c(x[1], x[2])
      b <- c(x[3], x[5])
      c <- c(x[4], x[6])
      v1 <- b - c
      v2 <- a - b
      m <- cbind(v1, v2)
      d <- abs(det(m)) / sqrt(sum(v1 * v1))
      d
    }
  )

irx_data <- irx_data %>%
  rownames_to_column(var = "number")

irx_x <- irx_data %>%
  select(genotype, replicate, technical, object, number, contains("ROIx")) %>%
  group_by(genotype, replicate, technical, object, number) %>%
  pivot_longer(contains("ROIx"), names_to = "variable", values_to = "ROIx") %>%
  separate(variable, into = c("variable", "point"), sep = "x") %>%
  select(-variable)

irx_y <- irx_data %>%
  select(genotype, replicate, technical, object, number, contains("ROIy")) %>%
  group_by(genotype, replicate, technical, object, number) %>%
  pivot_longer(contains("ROIy"), names_to = "variable", values_to = "ROIy") %>%
  separate(variable, into = c("variable", "point"), sep = "y") %>%
  select(-variable)

irx_roi <- left_join(irx_x, irx_y) %>%
  drop_na() %>%
  filter_at(vars("ROIx", "ROIy"), any_vars(. != 0))

irx_str <- irx_roi %>%
  unite("ID", genotype:number, remove = FALSE, sep = ",") %>%
  group_by(ID) %>%
  mutate(
    number = as.numeric(number),
    ROIx = ROIx - mean(ROIx, na.rm = TRUE),
    ROIy = ROIy - mean(ROIy, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  group_by(ID, point) %>%
  summarise(xy = list(c(ROIx, ROIy))) %>%
  ungroup() %>%
  group_by(ID) %>%
  mutate(
    point = as.numeric(point),
    max_point = max(point)
  ) %>%
  bind_rows(filter(., point == 0) %>%
    group_by(ID) %>%
    mutate(point = max_point + 1)) %>%
  arrange(ID, point) %>%
  summarise(xy = list(c(xy))) %>%
  mutate(geometry = map(
    xy,
    ~ do.call(rbind, .) %>% # make each list a matrix
      list() %>% # st_polygon() requires a list
      st_polygon()
  )) %>%
  st_as_sf()

irx_str <- irx_str %>%
  group_by(ID) %>%
  mutate(
    area = st_area(geometry),
    CH = st_convex_hull(geometry),
    convex_area = st_area(CH),
    convexity = area / convex_area,
    circularity = 4 * pi * (area / (lwgeom::st_perimeter(geometry)^2))
  ) %>%
  separate(ID, into = c("genotype", "replicate", "technical", "cell.type", "number"), sep = ",") %>%
  filter(genotype != "ccr1xfah1") %>%
  mutate(
    genotype = recode(genotype, "col-0" = "Col-0"),
    genotype = ordered(genotype, levels = c(
      "Col-0",
      "4cl1",
      "4cl2",
      "4cl1x4cl2",
      "ccoaomt1",
      "fah1",
      "omt1",
      "ccr1-3",
      "cad4",
      "cad5",
      "cad4xcad5"
    )),
    cell.type = ordered(cell.type, levels = c("PX", "PMX", "SMX"))
  ) 

sf_ROIs <- ggplot() +
  geom_sf(
    data = irx_str,
    aes(colour = circularity),
    # colour = "black",
    fill = NA,
    lwd = 0.1,
    key_glyph = "point"
  ) +
  # geom_quasirandom(data = irx_str,
  #                  aes(x = 2, 
  #                      y = convexity,
  #                      fill = convexity),
  #                  shape = 21, 
  #                  colour = "white") +
  theme_leo() +
  scale_x_continuous(expand = expand_scale(mult = 0)) +
  scale_y_continuous(expand = expand_scale(mult = 0)) +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "right",
    panel.border = element_blank(),
    # panel.background = element_rect(fill = "black"),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    strip.text = element_text(hjust = 0.5, face = "italic")
  ) +
  # scale_colour_distiller(palette = "YlGnBu", direction = -1) +
  # scale_colour_gradientn(colours = pal_wes, trans = "reverse") +
  scale_colour_gradientn(colours = pal_ostwald_cont, trans = "reverse", name = "Circularity") +
  guides(colour = guide_colourbar(barwidth = unit(2, "mm"))) +
  # scale_colour_gradientn(colours = pal_flame, trans = "reverse") +
  # scale_fill_gradientn(colours = pal_flame, trans = "reverse") +
  # scale_colour_viridis_c(direction = 1) +
  facet_grid(cell.type ~ genotype, switch = "y")

pdf("sf_ROIs.pdf", width = twocol, height = onecol)
sf_ROIs
dev.off()


xdens <- ggplot(irx_str) +
  geom_density(aes(x = circularity, fill = cell.type),
               size = 0.1,
               alpha = 0.5) +
  scale_fill_manual(values = pal_flame_disc) +
  theme_void()

ydens <- ggplot(irx_str) +
  geom_density(aes(x = convexity, fill = cell.type),
               size = 0.1,
               alpha = 0.5) +
  scale_fill_manual(values = pal_flame_disc) +
  coord_flip() +
  theme_void()


pdf("shape_distribution.pdf", height = onecol / 2, width = onecol)
scatter <- ggplot(irx_str) +
  geom_point(aes(x = circularity, y = convexity, shape = cell.type, fill = cell.type),
             size = 1,
             alpha = 0.75,
             stroke = 0.2) +
  scale_fill_manual(values = pal_flame_disc) +
  scale_shape_manual(values = c(21, 22, 23)) +
  labs(x = "Circularity",
       y = "Convexity") +
  theme_leo() +
  theme(legend.position = c(0.9, 0.2),
        legend.title = element_blank(),
        # legend.spacing = unit(0, "mm"),
        # legend.key.width = unit(4, "mm"),
        # legend.key.height = unit(4, "mm"),
        # legend.margin = margin(0,0,0,0)
        )
scatter_x <- insert_xaxis_grob(scatter, xdens, height = grid::unit(0.1, "null"),
  position = c("top"))
scatter_xy <- insert_yaxis_grob(scatter_x, ydens, width = grid::unit(0.1, "null"),
  position = c("right"))
ggdraw(scatter_xy)
dev.off()

# irx_sample <- irx_str %>%
#   mutate(circularity = ordered(as.character(round(circularity, digits = 1)),
#                                levels = c("1", "0.9", "0.8", "0.7", "0.6", "0.5", "0.4", "0.3", "0.2")),
#          convexity = round(convexity, digits = 1))
#
# # pdf("sf_ROIs_round.pdf")
# ggplot() +
#   geom_sf(data = irx_sample,
#           aes(colour = area),
#           # colour = "black",
#           fill = NA,
#           lwd = 0.5) +
#   theme_voi() +
#   theme(text = element_text(family = "Helvetica"),
#         legend.position = "none") +
#   scale_colour_viridis_c() +
#   facet_grid(circularity ~ convexity)
# # dev.off()
#
# # pdf("sf_ROIs_all.pdf", width = 20, height = 25)
# ggplot() +
#   geom_sf(data = irx_str,
#           aes(colour = cell.type),
#           # colour = "black",
#           fill = NA,
#           lwd = 0.5) +
#   theme_void() +
#   theme(text = element_text(family = "Helvetica"),
#         legend.position = "bottom",
#         strip.text = element_blank()) +
#   scale_colour_few() +
#   facet_wrap(~ convexity)
# dev.off()
```

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}
#### import and tidy Wiesner test data ####
wiesner.data <-
  read.csv("/home/leonard/Documents/Uni/Phloroglucinol/measurements_revisited.csv",
    skip = 2
  )

wiesner.data$genotype <- recode(wiesner.data$genotype, cad4x5 = "cad4xcad5")

# set cell types according to measurement order
wiesner.data[1:50 + rep(seq(0, (nrow(wiesner.data) - 50), by = 300), each = 50), 4] <-
  "IF"
wiesner.data[51:100 + rep(seq(0, (nrow(wiesner.data) - 50), by = 300), each = 50), 4] <-
  "MX"
wiesner.data[101:150 + rep(seq(0, (nrow(wiesner.data) - 50), by = 300), each = 50), 4] <-
  "XF"
wiesner.data[151:200 + rep(seq(0, (nrow(wiesner.data) - 50), by = 300), each = 50), 4] <-
  "PX"
wiesner.data[201:250 + rep(seq(0, (nrow(wiesner.data) - 50), by = 300), each = 50), 4] <-
  "LP"
wiesner.data[251:300 + rep(seq(0, (nrow(wiesner.data) - 50), by = 300), each = 50), 4] <-
  "PH"

# import SMX measurements
wiesner.data.SMX <- read.csv("file:///home/leonard/Documents/Uni/Phloroglucinol/measurements_SMX.csv",
  skip = 2
)
wiesner.data.SMX$replicate <- as.factor(wiesner.data.SMX$replicate)

wiesner.data <- rbind(select(wiesner.data, -technical), select(wiesner.data.SMX, -technical))

wiesner.data$genotype <-
  ordered(
    wiesner.data$genotype,
    levels = c(
      "col-0",
      "4cl1",
      "4cl2",
      "4cl1x2",
      "ccoaomt1",
      "fah1",
      "omt1",
      "ccr1-3",
      "ccr1xfah1",
      "cad4",
      "cad5",
      "cad4xcad5"
    )
  )

# calculate the correct hue on the 360 point circular scale
wiesner.data$hue <- ((wiesner.data$h.stained + 128) / 255 * 360)

wiesner.data$replicate <-
  as.factor(as.character(wiesner.data$replicate))

# calculate stained - unstained diff. and adjust for bleaching by subtracting the diff. for the unlignified phloem
wiesner.data$diff <-
  wiesner.data$OD.stained - wiesner.data$OD.unstained
# summary(wiesner.data)

wiesner.data.bg <- wiesner.data %>%
  filter(cell.type == "PH") %>%
  select(1:2, 9) %>%
  ungroup() %>%
  group_by(genotype, replicate) %>%
  summarise(OD.bg = mean(diff, na.rm = TRUE))

wiesner.data <-
  full_join(
    wiesner.data,
    wiesner.data.bg,
    all = TRUE,
    by = c("genotype", "replicate")
  )
wiesner.data$diff.adj <- wiesner.data$diff - wiesner.data$OD.bg
wiesner.data <- subset(wiesner.data, cell.type != "PH")

# average per replicate (for boxplots)
wiesner.data.pre <- wiesner.data %>%
  mutate(
    cell.type = recode(cell.type, "MX" = "PMX"),
    genotype = recode(genotype,
      "col-0" = "Col-0",
      "4cl1x2" = "4cl1x4cl2"
    )
  ) %>%
  group_by(genotype, cell.type, replicate) %>%
  summarise(
    mean.hue1 = mean(hue, na.rm = TRUE),
    SD.hue1 = sd(hue, na.rm = TRUE),
    mean.OD1 = mean(diff.adj, na.rm = TRUE),
    SD.OD1 = sd(diff.adj, na.rm = TRUE)
  ) %>%
  select(genotype, cell.type, replicate, mean.OD1)

#### import and tidy shape data of the vessels from the Raman measurements ####
rmn_irx <- read.csv("file:///home/leonard/Documents/Uni/PhD/IRX/raman_IRX_revisited.csv") %>%
  select(genotype:Perim., Circ., Round, Height, Width) %>%
  filter(object == 2) %>%
  select(-object)

raman.nb <- read.csv("file:///home/leonard/Documents/Uni/PhD/IRX/raman_IRX.csv") %>%
  select(genotype:n_f)
rmn_irx <- left_join(rmn_irx, raman.nb)
rmn_irx$replicate <- as.character(rmn_irx$replicate)
rmn_irx$technical <- as.character(rmn_irx$technical)

raman_convex <- read.csv("/home/leonard/Documents/Uni/PhD/IRX/raman_irx_convex.csv")

raman_convex$File <-
  str_replace(raman_convex$File, fixed("fah 1"), "fah1")

raman_convex <- raman_convex %>%
  select(-X) %>%
  separate(
    File,
    into = c("genotype", "replicate", "cell.type", "technical"),
    sep = "\\s*#|-|\\s",
    extra = "merge"
  ) %>%
  mutate(
    genotype = recode(
      genotype,
      "4cl1＆2" = "4cl1x4cl2",
      "cad4＆5" = "cad4xcad5",
      "ccoaomt" = "ccoaomt1",
      "ccr1" = "ccr1-3",
      "col.o" = "Col-0",
      "Col.0" = "Col-0",
      "ccr1＆fah1" = "ccr1xfah1"
    ),
    cell.type = recode(cell.type,
      "px" = "PX",
      "SX" = "SMX",
      "MX" = "PMX"
    ),
    replicate = str_extract(
      replicate,
      "\\d"
    ),
    technical = str_extract(
      technical,
      "(\\d)+"
    )
  ) %>%
  filter(cell.type != "？？")

rmn_irx <- left_join(rmn_irx, raman_convex)

# write_csv(rmn_irx, "raman_irx_shape.csv")

#### import and tidy plant height data ####
raman.heights <- read.csv("file:///home/leonard/Documents/Uni/Master/Summer project 16/phenotyping/phenotyping.csv") %>%
  select(genotype, replicate, height) %>%
  mutate(genotype = recode(genotype, "col-0" = "Col-0")) %>%
  rename("Plant.height" = "height") %>%
  rbind(read.csv("file:///home/leonard/Documents/Uni/PhD/IRX/heights_haris.csv"))
raman.heights$replicate <- as.character(raman.heights$replicate)

#### merge data frames ####
rmn_irx <- left_join(rmn_irx, rmn_sum)
rmn_irx.switch <- left_join(read_tsv("/home/leonard/Documents/Uni/PhD/IRX/PMX_which_SMX.tsv",
  col_types = "cccc"
), rmn_irx) %>%
  mutate(
    technical = str_c(technical, "switched", sep = "_"),
    cell.type = "SMX"
  )
rmn_irx <- rmn_irx %>%
  anti_join(read_tsv("/home/leonard/Documents/Uni/PhD/IRX/PMX_which_SMX.tsv",
    col_types = "cccc"
  )) %>%
  bind_rows(rmn_irx.switch)
rmn_irx <- left_join(rmn_irx, raman.heights)
rmn_irx <- left_join(rmn_irx, wiesner.data.pre) %>%
  mutate(convexity = Area / ConvexArea)
# write.csv(rmn_irx, file = "SEM_data.csv")
```


```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}
TM.multigroup <- function(x) {
  psem(
    lm(Circ. ~
    n_v +
      convexity,
    data = filter(drop_na(rmn_irx), cell.type == x)
    ),
    lm(convexity ~
    # n_v +
      # n_f +
      # mean.OD1 +
      Perim. +
      # S.G +
      # G_tot +
      # GOH_rel +
      GOH.G +
      # G_rel +
      # GOH_tot +
      S_rel +
      # S_tot +
      # GCHO.lig +
      total_lignin,
    data = filter(drop_na(rmn_irx), cell.type == x)
    ),
    # lme(Perim. ~
    #       # n_v,
    #       # n_f +
    #       mean.OD1 +
    #       # cellu.peak +
    #       # lig.peak.pos +
    #       lig.peak,
    #     random = ~1|replicate,
    #     data = filter(drop_na(rmn_irx), cell.type == x)
    # ),
    # lme(HeightByWidth ~
    #       # mean.OD1 +
    #       # lig.peak +
    #       # n_v +
    #       Circ.,
    #     random = ~1|replicate,
    #     data = filter(drop_na(rmn_irx), cell.type == x)
    # ),
    # lme(X1147.1603 ~
    #       Perim.,
    #     random = ~1|replicate,
    #     data = filter(drop_na(rmn_irx), cell.type == x)
    # ),
    # lme(X1603.1099 ~
    #       Perim.,
    #     random = ~1|replicate,
    #     data = filter(drop_na(rmn_irx), cell.type == x)
    # ),
    # lme(mean.OD1 ~
    #       X1664.1603 +
    #       X1603.1099 +
    #       X1621.1603,
    #     random = ~1|replicate,
    #     data = filter(drop_na(rmn_irx), cell.type == x)
    # ),
    data = filter(drop_na(rmn_irx), cell.type == x)
  )
}
```

### SEM for PX

Collapse explained: 40%

Positive (strengthening) factors: 

* Perimeter
* G aldehydes / total G

negative (weakening) factors:
* Relative S-content

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}
# summary(TM.multigroup("PX"), .progressBar = FALSE)
psem_px <- psem(
    lm(Circ. ~
    # n_v +
      convexity,
    data = filter(drop_na(rmn_irx), cell.type == "PX")
    ),
    lm(convexity ~
    # n_v +
      # n_f +
      mean.OD1 +
      Perim. +
      # cellulose +
      # S.G +
      # G_tot +
      # GOH_rel +
      GOH.G +
      # G_rel +
      # GOH_tot +
      S_rel +
      # S_tot +
      # GCHO.lig +
      total_lignin:mean.OD1 +
      total_lignin,
    data = filter(drop_na(rmn_irx), cell.type == "PX")
    ),
    data = filter(drop_na(rmn_irx), cell.type == "PX")
  )
summary(psem_px)
plot(psem_px)
```

### SEM for PMX

Collapse explained: 49%

Positive (strengthening) factors: 

* Total coniferaldehyde (Wiesner)
* Total lignin
* Relative G aldehyde content (Raman)

negative (weakening) factors:

* Relative S-content
* Adjacent vessels

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}
# summary(TM.multigroup("PMX"), .progressBar = FALSE)
psem_pmx <- psem(
    lm(Circ. ~
    n_v +
      convexity,
    data = filter(drop_na(rmn_irx), cell.type == "PMX")
    ),
    lm(convexity ~
    n_v +
      # n_f +
      mean.OD1 +
      # Perim. +
      # S.G +
      # G_tot +
      # GOH_rel +
      # GOH.G +
      # G_rel +
      # GOH_tot +
      S_rel +
      # S_tot +
      # GCHO.lig +
      # total_lignin:mean.OD1 +
      total_lignin,
    data = filter(drop_na(rmn_irx), cell.type == "PMX")
    ),
    data = filter(drop_na(rmn_irx), cell.type == "PMX")
  )
summary(psem_pmx)
plot(psem_pmx)
```

### SEM for SMX

Collapse explained: 26%

Positive (strengthening) factors: 

negative (weakening) factors:

* Relative S-content

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}
# summary(TM.multigroup("SMX"), .progressBar = FALSE)
psem_smx <- psem(
    lm(Circ. ~
    # n_v +
      convexity,
    data = filter(drop_na(rmn_irx), cell.type == "SMX")
    ),
    lm(convexity ~
    # n_v +
      # n_f +
      mean.OD1 +
      # Perim. +
      # S.G +
      # G_tot +
      # GOH_rel +
      GOH.G +
      # G_rel +
      # GOH_tot +
      # S_rel +
      # S_tot +
      # GCHO.lig +
      total_lignin:mean.OD1 +
      total_lignin,
    data = filter(drop_na(rmn_irx), cell.type == "SMX")
    ),
    data = filter(drop_na(rmn_irx), cell.type == "SMX")
  )
summary(psem_smx)
plot(psem_smx)
```

### assemble figure

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}

SEM_PX <-
  rasterGrob(image_read_pdf(
    "/home/leonard/Dropbox/IRX manuscript/Figures/SEM_PX.pdf",
    density = 600
  ))

SEM_PMX <-
  rasterGrob(image_read_pdf(
    "/home/leonard/Dropbox/IRX manuscript/Figures/SEM_PMX.pdf",
    density = 600
  ))

SEM_SMX <-
  rasterGrob(image_read_pdf(
    "/home/leonard/Dropbox/IRX manuscript/Figures/SEM_SMX.pdf",
    density = 600
  ))

bottom <- plot_grid(SEM_PX,
                    SEM_PMX,
                    SEM_SMX,
                    labels = c("B", "C", "D"),
  vjust = 1,
  nrow = 1,
  label_size = 10,
  label_fontfamily = "Helvetica")

pdf("IRX_Figure4.pdf", width = twocol, height = onecol)
plot_grid(sf_ROIs,
          bottom,
          labels = c("A", ""),
  vjust = 1,
  nrow = 2,
  label_size = 10,
  label_fontfamily = "Helvetica",
  rel_heights = c(1.2,1))

dev.off()

```


## Supplemental figures

### Interaction terms

#### interaction within the best models

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}
find_interactions <- function(x) {
  rmn_irx <- filter(rmn_irx, cell.type == x) %>%
  select(
    convexity,
    Perim.,
    # n_f,
    # n_p,
    n_v,
    cellulose,
    mean.OD1,
    total_lignin,
    # AUC,
    # G_rel,
    # GOH_rel,
    GOH.G,
    S_rel,
    # GCHO.lig,
    # S.G
  ) %>%
  drop_na()
  
  model.null <- lm(convexity ~ 1,
  data = rmn_irx
)
model.full <- lm(convexity ~ (.)^2,
  data = rmn_irx
)

best_model <- step(model.null,
  scope = list(upper = model.full),
  direction = "both",
  data = rmn_irx
)

print(tidy(best_model) %>%
  select(term) %>%
  filter(str_detect(term, fixed(":"))))

best_model
}

#### protoxylem ####
best_model <- find_interactions("PX")

mean.OD1_total_lignin <- interact_plot(best_model, pred = mean.OD1, modx = total_lignin, 
                      colors = c("black", "black", "black"),
                      x.label = "Wiesner stain",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = pal_flame_disc[1]))
mean.OD1_total_lignin$layers[[1]]$aes_params$size <- 0.4 


best_model <- find_interactions("PX")

total_lignin_Perim. <- interact_plot(best_model, pred = total_lignin, modx = Perim., 
                      colors = c("black", "black", "black"),
                      x.label = "Total lignin",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = pal_flame_disc[1])) +
  scale_y_continuous(
  labels = scales::number_format(accuracy = 0.01))
total_lignin_Perim.$layers[[1]]$aes_params$size <- 0.4 

S_rel_Perim. <- interact_plot(best_model, pred = S_rel, modx = Perim., 
                      colors = c("black", "black", "black"),
                      x.label = "S-lignin",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = pal_flame_disc[1])) +
  scale_y_continuous(
  labels = scales::number_format(accuracy = 0.01)) +
  scale_x_continuous(
  labels = scales::number_format(accuracy = 0.01))
S_rel_Perim.$layers[[1]]$aes_params$size <- 0.4 

mean.OD1_Perim. <- interact_plot(best_model, pred = mean.OD1, modx = Perim., 
                      colors = c("black", "black", "black"),
                      x.label = "Wiesner stain",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = pal_flame_disc[1]))
mean.OD1_Perim.$layers[[1]]$aes_params$size <- 0.4 

GOH.G_mean.OD1 <- interact_plot(best_model, pred = GOH.G, modx = mean.OD1, 
                      colors = c("black", "black", "black"),
                      x.label = "Coniferyl alcohol",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = pal_flame_disc[1]))
GOH.G_mean.OD1$layers[[1]]$aes_params$size <- 0.4 

pdf("PX_interactions.pdf", height = twocol, width = twocol)
px <- plot_grid(
  total_lignin_Perim. + theme(legend.position="none"),
  S_rel_Perim. + theme(legend.position="none"),
  mean.OD1_Perim. + theme(legend.position="none"),
  mean.OD1_total_lignin + theme(legend.position="none"),
  "",
  GOH.G_mean.OD1 + theme(legend.position="none"),
  "",
  ncol = 1
)
px
dev.off()

#### primary metaxylem ####
best_model <- find_interactions("PMX")

n_v_mean.OD1 <- interact_plot(best_model, pred = n_v, modx = mean.OD1, 
                      colors = c("black", "black", "black"),
                      x.label = "Vessel adjacency",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = alpha(pal_flame_disc[2], 0.5)))
n_v_mean.OD1$layers[[1]]$aes_params$size <- 0.4 

n_v_total_lignin <- interact_plot(best_model, pred = n_v, modx = total_lignin, 
                      colors = c("black", "black", "black"),
                      x.label = "Vessel adjacency",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = alpha(pal_flame_disc[2], 0.5)))
n_v_total_lignin$layers[[1]]$aes_params$size <- 0.4 

pdf("PMX_interactions.pdf", height = onecol, width = onecol / 2)
pmx <- plot_grid(
  "",
  "",
  "",
  "",
  n_v_total_lignin + theme(legend.position="none"),
  "",
  n_v_mean.OD1 + theme(legend.position="none"),
  ncol = 1
)
pmx
dev.off()

#### secondary metaxylem ####
best_model <- find_interactions("SMX")

GOH.G_mean.OD1 <- interact_plot(best_model, pred = GOH.G, modx = mean.OD1, 
                      colors = c("white", "white", "white"),
                      x.label = "Coniferyl alcohol",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = alpha(pal_flame_disc[3], 0.5)))
GOH.G_mean.OD1$layers[[1]]$aes_params$size <- 0.4 

mean.OD1_total_lignin <- interact_plot(best_model, pred = mean.OD1, modx = total_lignin, 
                      colors = c("white", "white", "white"),
                      x.label = "Wiesner stain",
                      y.label = "Convexity") + 
  theme_leo() +
  theme(legend.position = c(0.75, 0.8),
        panel.background = element_rect(fill = alpha(pal_flame_disc[3], 0.5)))
mean.OD1_total_lignin$layers[[1]]$aes_params$size <- 0.4 

pdf("SMX_interactions.pdf", height = onecol, width = onecol / 2)
smx <- plot_grid(
  "",
  "",
  "",
  mean.OD1_total_lignin + theme(legend.position="none"),
  "",
  GOH.G_mean.OD1 + theme(legend.position="none"),
  "",
  ncol = 1
)
smx
dev.off()


legend <-  get_legend(n_v_total_lignin + guides(linetype = guide_legend(title = "Interactor"),
                                       colour = "none",
                                       fill = "none") +
               theme(legend.justification = "top"))

pdf("interactions.pdf", height = twocol * 1.1, width = onecol)
plot_grid(px,
pmx,
smx,
ncol = 3,
labels = c("A", "B", "C"),
  vjust = 1,
  label_size = 10,
  label_fontfamily = "Helvetica")
dev.off()
```

#### independent interactions 

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}
find_interactions <- function(x) {
  rmn_irx <- filter(rmn_irx, cell.type == x) %>%
  select(
    convexity,
    Perim.,
    # n_f,
    # n_p,
    n_v,
    cellulose,
    mean.OD1,
    total_lignin,
    # AUC,
    # G_rel,
    # GOH_rel,
    GOH.G,
    S_rel,
    # GCHO.lig,
    # S.G
  ) %>%
  drop_na()
  
  model.null <- lm(convexity ~ 1,
  data = rmn_irx
)
model.full <- lm(convexity ~ (.)^2,
  data = rmn_irx
)

best_model <- step(model.null,
  scope = list(upper = model.full),
  direction = "both",
  data = rmn_irx
)

print(tidy(best_model) %>%
  select(term) %>%
  filter(str_detect(term, fixed(":"))))

best_model
}

best_model <- find_interactions("PX")

intrct <- paste0("Perim.", ":", "S_rel")
as.data.frame(effect(c(intrct), best_model))


plot_interactions <- function(ct, t1, t2) {
ct <- enquo(ct)
t1 <- enquo(t1)
t2 <- enquo(t2)

  rmn_irx <- filter(rmn_irx, cell.type == quo_name(ct)) %>%
  select(
    convexity,
    Perim.,
    # n_f,
    # n_p,
    n_v,
    cellulose,
    mean.OD1,
    total_lignin,
    # AUC,
    # G_rel,
    # GOH_rel,
    GOH.G,
    S_rel,
    # GCHO.lig,
    # S.G
  ) %>%
  drop_na()
  
  model.null <- lm(convexity ~ 1,
  data = rmn_irx
)
model.full <- lm(convexity ~ (.)^2,
  data = rmn_irx
)

best_model <- step(model.null,
  scope = list(upper = model.full),
  direction = "both",
  data = rmn_irx
)

# intrct <- paste0(quo_name(t1), ":", quo_name(t2))

# interact_fit <- as.data.frame(effect(c(intrct), best_model, xlevels = 3)) %>%
#   mutate(!!t2 := as.character(!!t2))

rmn_irx_bins <- rmn_irx %>%
  select(!!t1, !!t2, convexity) %>%
  drop_na() %>%
  mutate(interactor = ordered(case_when(!!t2 > mean(!!t2)+sd(!!t2) ~ "High",
            !!t2 < mean(!!t2)+sd(!!t2) & !!t2 > mean(!!t2)-sd(!!t2) ~ "Average",
            !!t2 < mean(!!t2)-sd(!!t2) ~ "Low"), levels = c("High", "Average", "Low")))

ggplot(rmn_irx_bins, aes(x = !!t1, y = convexity, colour = interactor)) +
  # scale_colour_manual(values = pal_ostwald_disc, name = term2_group) +
  geom_point() +
  labs(title = quo_name(t2)) +
  # geom_line()
  geom_smooth(method = "lm")
}

# plot_interactions(PX, Perim., S_rel)
# plot_interactions(PX, S_rel, Perim.)

# # plot_interactions(PX, Perim., total_lignin)
# plot_interactions(PX, total_lignin, Perim.)
# 
# plot_interactions(PX, total_lignin, mean.OD1)
plot_interactions(PX, mean.OD1, total_lignin)
#   coord_cartesian(ylim = c(0.90,1))
# 
# # plot_interactions(PX, Perim., mean.OD1)
# plot_interactions(PX, mean.OD1, Perim.)
# 
# # plot_interactions(PX, GOH.G, mean.OD1)
# plot_interactions(PX, mean.OD1, GOH.G)
```

### Overview

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE, echo = FALSE}
rmn_irx_long <- rmn_irx %>%
  select(genotype:cell.type, n_v, Area, Perim., Circ., convexity, total_lignin, G_rel, GOH.G, S_rel, cellulose, mean.OD1) %>%
  pivot_longer(cols = -c(genotype:cell.type), names_to = "variable", values_to = "value") %>%
  mutate(
    variable = recode(variable,
                      "n_v" = "Adj. vessels",
                      "cellulose" = "Cellulose",
                      "Circ." = "Circularity",
                      "convexity" = "Convexity",
                      "G_rel" = "G-lignin",
                      "GOH.G" = "G-CHOH",
                      "mean.OD1" = "Wiesner mean",
                      "Perim." = "Perimeter",
                      "S_rel" = "S-lignin",
                      "total_lignin" = "Lignin"),
    genotype = ordered(genotype,
      levels = c(
        "Col-0",
        "4cl1",
        "4cl2",
        "4cl1x4cl2",
        "ccoaomt1",
        "fah1",
        "omt1",
        "ccr1-3",
        "cad4",
        "cad5",
        "cad4xcad5"
      )
    ),
    cell.type = ordered(cell.type, levels = c("PX", "PMX", "SMX"))
    )

rmn_irx_letters <- letter_groups(rmn_irx_long,
                                 value,
                                 genotype,
                                 "tukey",
                                 cell.type,
                                 variable,
                                 print_position = "above",
                                 print_adjust = 2)

rmn_irx_overview <- ggplot(rmn_irx_long,
                           aes(x = genotype, 
                               y = value)) +
  geom_quasirandom(
    aes(fill = cell.type),
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 1,
    stroke = 0.25
  ) +
  geom_boxplot(
    fill = "white",
    alpha = 0.5,
    width = 0.6,
    outlier.alpha = 0,
    lwd = 0.25,
    fatten = 1,
    width = 0.25
  ) +
  geom_text(
    data = rmn_irx_letters,
    aes(label = groups),
    size = 6 / (14 / 5),
    family = "Helvetica"
  ) +
  scale_fill_manual(values = pal_flame_disc) +
  scale_x_discrete(
    labels = c(
      "Col-0",
      expression(italic("4cl1")),
      expression(italic("4cl2")),
      expression(paste(italic("4cl1"), "x", italic("4cl2"))),
      expression(italic("ccoaomt1")),
      expression(italic("fah1")),
      expression(italic("omt1")),
      expression(italic("ccr1")),
      expression(italic("cad4")),
      expression(italic("cad5")),
      expression(paste(italic("cad4"), "x", italic("cad5")))
    )
  ) +
  theme_leo() +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1),
        axis.title = element_blank()) +
  facet_grid(variable ~ cell.type,
             scales = "free_y")

pdf("IRX_FigureS1.pdf", width = twocol, height = twocol + 1)
rmn_irx_overview
dev.off()
```

### Poplar

#### load data

```{r, fig.showtext = TRUE, out.width = '100%', message = FALSE, eval = TRUE}

pop_irx <- read_csv("/home/leonard/Documents/Uni/PhD/IRX/Poplar/poplar_irx.csv")

#### create reference at the heigth of the cambium for distance calculation ####
pop_irx_ref <- pop_irx %>%
  filter(object == "ref") %>%
  select(c(
    "genotype",
    "replicate",
    "technical",
    "X",
    "Y",
    "Length"
  ))
pop_irx_ref$ref.y1 <- pop_irx_ref$Y
pop_irx_ref$ref.y2 <- pop_irx_ref$Y
pop_irx_ref$ref.x1 <- pop_irx_ref$X - (pop_irx_ref$Length / 2)
pop_irx_ref$ref.x2 <- pop_irx_ref$X + (pop_irx_ref$Length / 2)

#### merge reference into data frame ####
pop_irx <- pop_irx %>%
  filter(object != "ref") %>%
  full_join(select(pop_irx_ref, -X, -Y, -Length),
    by = c("genotype", "replicate", "technical")
  ) %>%
  mutate(genotype = ordered(genotype, levels = c("WT", "c4h", "ccr1")))

#### calculate difference of the centre of each vessel to the cambium ####
pop_irx$Distance <-
  apply(
    pop_irx[, c("X", "Y", "ref.x1", "ref.x2", "ref.y1", "ref.y2")],
    1,
    function(x) {
      a <- c(x[1], x[2])
      b <- c(x[3], x[5])
      c <- c(x[4], x[6])
      v1 <- b - c
      v2 <- a - b
      m <- cbind(v1, v2)
      d <- abs(det(m)) / sqrt(sum(v1 * v1))
      d
    }
  )

pop_irx <- pop_irx %>%
  mutate(bin = cut(
    Distance,
    breaks = c(-Inf, 50, 100, Inf),
    labels = c("I", "II", "III")
  ))

pop_irx <- pop_irx %>%
  mutate(convexity = Area / ConvexArea,
         Mean = Mean / 255)
```

#### overview

```{r}

pop_irx_overview <- pop_irx %>%
  ungroup() %>%
  select(
    genotype = genotype,
    type = type,
    `Adj. vessels` = n_v,
    Area = Area,
    Circularity = Circ.,
    Distance = Distance,
    Convexity = convexity
    ) %>%
  pivot_longer(`Adj. vessels`:Convexity, names_to = "variable", values_to = "value") %>%
  drop_na()

write_csv(pop_irx_overview %>%
            filter(genotype == "WT") %>%
  group_by(genotype, type, variable) %>%
  summarise(value = mean(value)),
  "WT_values.csv")


pop_letters <- letter_groups(pop_irx_overview, 
                             value, 
                             genotype, 
                             "kruskal", 
                             type, 
                             variable, 
                             print_position = "below",
                             print_adjust = 1.25) %>%
  mutate(value = case_when(variable == "Convexity" & type == "S" ~ value - 0.1,
                           TRUE ~ value))

pop_overview <- ggplot(pop_irx_overview,
                       aes(x = genotype,
                           y = value)) +
  geom_quasirandom(
    aes(fill = type),
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 1,
    stroke = 0.25
  ) +
  geom_violin(aes(group = genotype,
                  # fill = cell.type
                  ),
              draw_quantiles = 0.5,
              fill = "white",
              colour = "black",
              alpha = 0.85,
              width = 0.2,
              position = position_dodge(width = 0.6),
              size = 0.2,
              scale = "width"
              ) +
  # geom_boxplot(
  #   fill = "white",
  #   colour = "black",
  #   alpha = 0.5,
  #   width = 0.6,
  #   outlier.alpha = 0,
  #   lwd = 0.25,
  #   fatten = 1,
  #   width = 0.25
  # ) +
  geom_text(
    data = pop_letters,
    aes(label = groups),
    size = 6 / (14 / 5),
    family = "Helvetica"
  ) +
  scale_fill_manual(values = pal_flame_disc[c(1,3)]) +
  scale_x_discrete(
    labels = c(
      "WT",
      expression(paste(italic("C4H"), "-RNAi")),
      expression(paste(italic("CCR"), "-RNAi"))
      )
  ) +
  scale_y_continuous(expand = expand_scale(mult = c(0.1, 0.05))) +
  theme_leo() +
  theme(
    # axis.text.x = element_text(angle = 90,
    #                                hjust = 1),
        axis.title = element_blank()) +
  facet_grid(variable ~ type,
             scales = "free_y")


# pop_neighbourhood <- ggplot(pop_irx, aes(x = n_v, y = convexity)) +
#   geom_point(aes(fill = genotype),
#     shape = 21,
#     size = 2,
#     alpha = 0.75,
#     stroke = 0.2
#   ) +
#   scale_fill_few() +
#   scale_y_continuous(limits = c(0.7,1)) +
#   labs(x = "Fraction of perimeter adjacent to other vessels") +
#   theme_leo() +
#   geom_smooth(
#     method = "loess",
#     span = 1,
#     colour = "black",
#     linetype = 2
#   ) +
#   facet_wrap(~ bin, ncol = 1)
# 
# pop_distance <- ggplot(pop_irx, aes(x = Distance, y = convexity)) +
#   geom_point(aes(fill = genotype),
#     shape = 21,
#     size = 2,
#     alpha = 0.75,
#     stroke = 0.2
#   ) +
#   scale_fill_few() +
#   scale_y_continuous(limits = c(0.7,1)) +
#   labs(x = "Distance from the cambium [µm]") +
#   theme_leo() +
#   geom_smooth(
#     method = "loess",
#     span = 1,
#     colour = "black",
#     linetype = 2
#   ) +
#   facet_wrap(~ bin, ncol = 1)

pdf("pop_overview.pdf", width = onecol * 0.9, height = onecol * 0.9)
pop_overview
dev.off()
```

#### SEMs

```{r}

pop_irx <- as.data.frame(pop_irx)
poplar_psem <- psem(
    lm(Circ. ~
    n_v +
      Distance +
      # n_p +
      convexity,
    data = filter(pop_irx, type == "P")
    ),
    lm(convexity ~
    n_v +
      # n_p +
      Mean +
      Distance +
      Perim.,
    data = filter(pop_irx, type == "P")
    ),
    data = filter(pop_irx, type == "P")
  )

summary(poplar_psem)
plot(poplar_psem)

poplar_psem <- psem(
    lm(Circ. ~
    n_v +
      Distance +
      # n_p +
      convexity,
    data = filter(pop_irx, type == "S")
    ),
    lm(convexity ~
    n_v +
      # n_p +
      Mean +
      Distance +
      Perim.,
    data = filter(pop_irx, type == "S")
    ),
    data = filter(pop_irx, type == "S")
  )

summary(poplar_psem)
plot(poplar_psem)
```

#### interactions 
```{r}
find_interactions <- function(x) {
  pop_irx <- filter(pop_irx, type == x) %>%
  select(
    convexity,
    Perim.,
    Mean,
    # n_f,
    # n_p,
    n_v,
    Distance
  ) %>%
  drop_na()
  
  model.null <- lm(convexity ~ 1,
  data = pop_irx
)
model.full <- lm(convexity ~ (.)^2,
  data = pop_irx
)

best_model <- step(model.null,
  scope = list(upper = model.full),
  direction = "both",
  data = pop_irx
)

print(tidy(best_model) %>%
  select(term) %>%
  filter(str_detect(term, fixed(":"))))

best_model
}

#### protoxylem ####
best_model <- find_interactions("S")

Distance_n_v <- interact_plot(best_model, pred = Distance, modx = n_v, 
                      colors = c("white", "white", "white"),
                      x.label = "Distance [µm]",
                      y.label = "Convexity"
                      ) + 
  theme_leo() +
  theme(legend.position = "none",
        panel.background = element_rect(fill = alpha(pal_flame_disc[3], 0.5)))
Distance_n_v$layers[[1]]$aes_params$size <- 0.2

Mean_n_v <- interact_plot(best_model, pred = n_v, modx = Mean, 
                      colors = c("white", "white", "white"),
                      x.label = "Adjacent vessels",
                      y.label = "Convexity"
                      ) + 
  theme_leo() +
  theme(legend.position = "none",
        panel.background = element_rect(fill = alpha(pal_flame_disc[3], 0.5)))
Mean_n_v$layers[[1]]$aes_params$size <- 0.2

Mean_Distance <- interact_plot(best_model, pred = Distance, modx = Mean, 
                      colors = c("white", "white", "white"),
                      x.label = "Distance [µm]",
                      y.label = "Convexity"
                      ) + 
  theme_leo() +
  theme(legend.position = "none",
        panel.background = element_rect(fill = alpha(pal_flame_disc[3], 0.5)))
Mean_Distance$layers[[1]]$aes_params$size <- 0.2

pdf("pop_interactions.pdf", width = onecol, height = onecol / 3)
plot_grid(Distance_n_v,
          Mean_Distance,
          Mean_n_v,
          nrow = 1)
dev.off()

```

### Bending

#### Hydration influence

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
medium_data <- read_csv("/home/leonard/Documents/Uni/PhD/IRX/Bending/WT_medium.csv") %>%
  pivot_longer(cols = c(stiffness, strength), values_to = "value", names_to = "variable") %>%
  mutate(variable = recode(variable, "stiffness" = "Stiffness",
                           "strength" = "Strength"))

medium_diameter_line <- ggplot(medium_data) +
  geom_point(aes(x = d.microscope, y = value, fill = medium),
    shape = 21,
    alpha = 0.75,
    size = 1.5,
    stroke = 0.2
  ) +
  geom_smooth(aes(x = d.microscope, y = value, fill = medium, linetype = medium),
    method = "lm",
    colour = "black",
    size = 0.2
  ) +
  labs(y = "MPa",
       x = "Stem diameter [mm]") +
  scale_fill_grey(start = 0.9, end = 0.1) +
  theme_leo() +
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  facet_wrap(~ variable, scales = "free_y")

letters <- letter_groups(medium_data %>% filter(variable == "Stiffness"),
                                 d.microscope,
                                 medium,
                                 "tukey",
                                 print_position = "below",
                                 print_adjust = 0.5
  ) 
  
medium_diameter_box <- ggplot(
  data = medium_data %>% filter(variable == "Stiffness"),
  aes(x = medium, y = d.microscope)
) +
  # geom_line(aes(group = interaction(cell.type, variable, cell, measurement)),
  #           size = 0.2,
  #           alpha = 0.25) +
  geom_quasirandom(
    aes(fill = medium),
    dodge.width = 0.6,
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 1.5,
    stroke = 0.2
  ) +
  # geom_boxplot(
  #   aes(group = interaction(cell.type, variable), fill = cell.type),
  #   # fill = "white",
  #   alpha = 0.5,
  #   width = 0.6,
  #   position = position_dodge2(width = 1),
  #   outlier.alpha = 0,
  #   lwd = 0.25,
  #   fatten = 1,
  #   width = 0.25
  # ) +
geom_violin(
  # aes(group = interaction(days, cell.type),
                # fill = cell.type
# ),
draw_quantiles = 0.5,
fill = "white",
colour = "black",
alpha = 0.85,
width = 0.2,
position = position_dodge(width = 0.6),
size = 0.2,
scale = "width"
) +
  geom_text(
    data = letters,
    aes(label = groups),
    size = ggtext_size,
    family = "Helvetica",
    position = position_dodge(width = 0.6)
  ) +
  # scale_x_discrete(labels = c("PX", "PMX", "SMX")) +
  # scale_fill_manual(values = pal_flame_disc) +
  scale_fill_grey(start = 0.9, end = 0.1) +
  expand_limits(y = 0) +
  scale_y_continuous(expand = expand_scale(mult = c(0.1, 0.05))) +
  labs(y = "Stem diameter [mm]") +
  theme_leo() +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "none",
    axis.title.x = element_blank()
  ) 

```

#### S influence

```{r, echo=FALSE, fig.showtext=TRUE, message=FALSE, warning=FALSE, out.width='100%'}
s_data <- read_csv("/home/leonard/Documents/Uni/PhD/IRX/Bending/stiffness_s.csv") %>%
  tidyr::fill(everything()) %>%
  pivot_longer(cols = c(stiffness, strength), values_to = "value", names_to = "variable") %>%
  mutate(genotype = ordered(genotype, levels = c("WT", "fah1")),
         variable = recode(variable, "stiffness" = "Stiffness",
                           "strength" = "Strength"))

s_diameter_line <- ggplot(s_data) +
  geom_point(aes(x = d.microscope, y = value, fill = genotype),
    shape = 21,
    alpha = 0.75,
    size = 1.5,
    stroke = 0.2
  ) +
  geom_smooth(aes(x = d.microscope, y = value, fill = genotype, colour = genotype),
    method = "lm",
    colour = "black",
    size = 0.2
  ) +
  labs(y = "MPa",
       x = "Stem diameter [mm]") +
  scale_fill_manual(values = pal_ostwald_disc[c(1,3)], labels = c("WT", expression(italic("fah1")))) +
  scale_colour_manual(values = pal_ostwald_disc[c(1,3)], labels = c("WT", expression(italic("fah1")))) +
  theme_leo() +
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  facet_wrap(~ variable, scales = "free_y")

s_test <- s_data %>% filter(variable == "Stiffness")
p_value <- broom::tidy(
  t.test(s_test$d.microscope[s_test$genotype == "WT"], s_test$d.microscope[s_test$genotype == "fah1"])
  )[["p.value"]] %>%
  round(., digits = 2)
  # formatC(., format = "e", digits = 0)
  
s_diameter_box <- ggplot(
  data = s_data %>% filter(variable == "Stiffness"),
  aes(x = genotype, y = d.microscope)
) +
  # geom_line(aes(group = interaction(cell.type, variable, cell, measurement)),
  #           size = 0.2,
  #           alpha = 0.25) +
  geom_quasirandom(
    aes(fill = genotype),
    dodge.width = 0.6,
    shape = 21,
    # width = 0.1,
    # colour = NA,
    alpha = 0.75,
    size = 1.5,
    stroke = 0.2
  ) +
  # geom_boxplot(
  #   aes(group = interaction(cell.type, variable), fill = cell.type),
  #   # fill = "white",
  #   alpha = 0.5,
  #   width = 0.6,
  #   position = position_dodge2(width = 1),
  #   outlier.alpha = 0,
  #   lwd = 0.25,
  #   fatten = 1,
  #   width = 0.25
  # ) +
geom_violin(
  # aes(group = interaction(days, cell.type),
                # fill = cell.type
# ),
draw_quantiles = 0.5,
fill = "white",
colour = "black",
alpha = 0.85,
width = 0.2,
position = position_dodge(width = 0.6),
size = 0.2,
scale = "width"
) +
  annotate("text",
           x = 2.5,
           y =0,
           label=paste("italic(P)==", p_value), 
           parse=TRUE,
           size = ggtext_size,
           family = "Helvetica",
           hjust = 1) +
  scale_x_discrete(labels = c("WT", expression(italic("fah1")))) +
  scale_fill_manual(values = pal_ostwald_disc[c(1,3)]) +
  expand_limits(y = 0) +
  scale_y_continuous(expand = expand_scale(mult = c(0.1, 0.05))) +
  labs(y = "Stem diameter [mm]") +
  theme_leo() +
  theme(
    text = element_text(family = "Helvetica"),
    legend.position = "none",
    axis.title.x = element_blank()
  )

pdf("bending_supplemental.pdf", width = onecol, height = onecol)
bending_supp <- plot_grid(
  medium_diameter_line,
  medium_diameter_box,
  s_diameter_line,
  s_diameter_box,
  labels = c("A", "B", "C", "D"),
  # vjust = 1,
  nrow = 2,
  align = "hv",
  axis = "tlr",
  rel_widths = c(1, 0.6),
  label_size = 10,
  label_fontfamily = "Helvetica"
)
bending_supp
dev.off()
```

