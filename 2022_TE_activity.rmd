---
title: "TE activity assays"
author: "Leonard Blaschek"
date: '2022-04-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(baseline)
library(broom)
library(colorspace)
library(gganimate)
library(ggbeeswarm)
library(ggrepel)
library(ggridges)
library(ggtext)
library(glue)
library(jsonlite)
library(lubridate)
library(patchwork)
library(showtext)
library(slider)
library(tidyverse)
library(tukeygrps)
library(vroom)
library(sf)

## import Helvetica ####
font_add(
  "Helvetica",
  regular = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Lt.otf",
  italic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-LtIt.otf",
  bold = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Bd.otf",
  bolditalic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-BdIt.otf"
)
showtext_auto()

#### generating plot theme ####
theme_leo <- function(base_size = 6,
                      base_family = "Helvetica") {
  theme_minimal(
    base_size = base_size,
    base_family = base_family
  ) %+replace%
    theme(
      strip.text = element_text(
        hjust = 0,
        # face = "italic"
      ),
      axis.ticks = element_line(
        size = 0.125,
        lineend = "square",
        color = "black"
      ),
      axis.text.x = element_text(
        size = 6,
        colour = "black",
        margin = margin(1, 1, 1, 1)
      ),
      axis.text.y = element_text(
        colour = "black",
        size = 6,
        angle = 0,
        vjust = 0.5,
        hjust = 1,
        margin = margin(1, 1, 1, 1)
      ),
      axis.title = element_text(
        colour = "black",
        size = 6
      ),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black", size = 0.25),
      panel.spacing = unit(1.5, "mm"),
      legend.position = "none",
      legend.text = element_text(size = 6),
      legend.key.height = unit(4, "mm"),
      plot.title = element_text(
        size = 6,
        hjust = 0
      ),
      complete = TRUE
    )
}

pal_ostwald_disc <- c(
  "#275d95",
  "#e8c245",
  "#d25952"
)

pal_ostwald_disc_long <- c(
  "#8fab1d",
  "#2d7d73",
  "#1d566f",
  "#275d95",
  "#e8c245",
  "#d25952"
)

pal_ostwald_cont <- c(
  "#155DA7",
  "#0A75B9",
  # "#0C89C9",
  "#FED32F",
  # "#F8A63A",
  "#EF663A",
  "#ED4137"
)

pal_ostwald_5 <- c(
  "#155DA7",
  "#929c67",
  "#FED32F",
  "#f79333",
  "#ED4137"
)

pal_pedersen_disc <- c(
  "#264653",
  "#2a9d8f",
  "#e9c46a",
  "#f4a261",
  "#e76f51"
)

pal_dawn <- c(
  "#434c52ff",
  "#46636fff",
  "#6088a0ff",
  "#ab6c82ff",
  "#d8737fff",
  "#eaa05fff",
  "#ffd175ff"
)

pal_zissou <- wesanderson::wes_palette("Zissou1", 6, type = "continuous")

# function to strip html for excel exports
strip_html <- function(s) {
    rvest::html_text(rvest::read_html(charToRaw(as.character(s))))
}

# convenience vectors of mutant types
Q <- "Q"
quad <- c("Q-4", "Q-5", "Q-10", "Q-12", "Q-17")
triple <- c("Q-4/10", "Q-4/12", "Q-4/17", "Q-5/10", "Q-5/12", "Q-5/17", "Q-10/12", "Q-12/17")
WT <- "WT"

Q_it <- "<i>Q</i>"
quad_it <- c("<i>Q-4</i>", "<i>Q-5</i>", "<i>Q-10</i>", "<i>Q-12</i>", "<i>Q-17</i>")
triple_it <- c("<i>Q-4/10</i>", "<i>Q-4/12</i>", "<i>Q-4/17</i>", "<i>Q-5/10</i>", "<i>Q-5/12</i>", "<i>Q-5/17</i>", "<i>Q-10/12</i>", "<i>Q-12/17</i>")

# convenience figure size functions
ggtext_size <- 6 / (14 / 5)
cm_size <- function(x) x / 2.54
twocol <- 18 / 2.54
onehalfcol <- 14 / 2.54
onecol <- 9 / 2.54

#### machine dependent paths ####
datapath <- ifelse(dir.exists("/data/"), "/data/",
  ifelse(dir.exists("/run/media/leonard/data/grsync/data/"), "/run/media/leonard/data/grsync/data/",
    ifelse(dir.exists("/run/media/leonard/data/"), "/run/media/leonard/data/", "/home/leonard/Documents/Uni/")
  )
)
```

## TE activity

### DAF spectrum

```{r}
daf_plate <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-05-24_DAF_analysis/2021-05-24_DAF.csv")
) %>%
  unite("Well", row, column, sep = "")

daf_abs <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-05-24_DAF_analysis/LB_TE-activity_20210524_115625.csv")
)

daf <- left_join(daf_abs, daf_plate) %>%
  separate(Well, into = c("row", "column"), sep = 1) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 1) - 1 # 1 minute between measurements
  )

spectra <- ggplot(
  daf,
  aes(
    x = wavelength,
    y = absorbance,
    group = time
  )
) +
  geom_line() +
  theme_leo() +
  facet_grid(row ~ column)

plotly::ggplotly(spectra)

peaks <- c(290, 360, 610, 800)

daf_peaks <- daf %>%
  filter(wavelength %in% peaks) %>%
  mutate(wavelength = as.character(wavelength))

peak_time <- ggplot(
  daf_peaks,
  aes(
    x = time,
    y = absorbance,
    colour = wavelength
  )
) +
  geom_point() +
  geom_smooth(aes(group = wavelength)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(row ~ column)

peak_time

peak_conc <- ggplot(
  daf_peaks %>% filter(time == 39 & concentration > 0.7),
  aes(
    x = concentration,
    y = absorbance,
    colour = wavelength
  )
) +
  geom_point() +
  geom_smooth(aes(group = wavelength),
    method = "lm",
    se = F,
    linetype = 2
  ) +
  geom_line(aes(group = wavelength)) +
  theme_leo() +
  scale_x_log10() +
  theme(legend.position = "bottom") +
  facet_wrap(~row, ncol = 4)

peak_conc
```

### Viability

#### Load viability and differentiation data

```{r}
growth_estimates <- read_csv(paste0(datapath, "PhD/Cell cultures/2021_timelines/2021_timeline_counts.csv"),
  col_types = "Dccnnnnnc"
) %>%
  select(-comment)

growth_files <-
  list.files(
    path = "/home/leonard/Dropbox/2021-01_inductions/",
    pattern = "*.txt",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = "code",
    col_types = "c",
    # locale = locale(decimal_mark = ",")
  ) %>%
    mutate(filename = basename(flnm)) %>%
    separate(filename, into = c("date", "replicate", "dpi", "treatment"), sep = "_") %>%
    mutate(
      date = ymd(as_date(date)),
      replicate = str_remove(replicate, fixed("R")),
      dpi = as.numeric(str_remove(dpi, fixed("d"))),
      treatment = str_remove(treatment, fixed(".txt"))
    )
}


growth_data <- map(growth_files, read_plus) %>%
  bind_rows() %>%
  mutate(
    code = str_to_lower(code),
    nTEs_alive = str_count(code, "k"),
    nTEs_dead = str_count(code, "l"),
    TEs_alive = str_count(code, "i"),
    TEs_dead = str_count(code, "o")
  ) %>%
  add_row(growth_estimates) %>%
  mutate(
    n = nTEs_alive + nTEs_dead + TEs_alive + TEs_dead,
    nTE_viab = nTEs_alive / (nTEs_alive + nTEs_dead),
    TE_prop = (TEs_alive + TEs_dead) / n,
    TE_viab = TEs_alive / (TEs_alive + TEs_dead),
    TE_viab = case_when(
      is.nan(TE_viab) ~ 1,
      TRUE ~ TE_viab
    )
  )

growth_avg <- growth_data %>%
  group_by(treatment, dpi) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))
```

#### Plot differentiation curves

```{r}

growth <- ggplot(growth_data %>% filter(treatment == "ind")) +
  geom_tile(
    data = growth_avg %>% filter(treatment == "ind"),
    aes(
      x = dpi,
      y = TE_prop,
      fill = nTE_viab
    ),
    width = 1,
    height = Inf,
    alpha = 0.75
  ) +
  geom_smooth(
    aes(
      x = dpi,
      y = TE_prop
    ),
    se = F,
    colour = "black",
    # span = 1
  ) +
  # geom_line(
  #   aes(
  #   x = dpi,
  #   y = TE_prop,
  #   group = replicate
  #   ),
  #   size = 0.2,
  #   alpha = 0.5,
  #   # se = F,
  #   colour = "black",
  #   # span = 1
  # ) +
  geom_point(aes(
    x = dpi,
    y = TE_prop,
    fill = TE_viab
  ),
  size = 3,
  shape = 21,
  stroke = 0.2
  ) +
  scale_fill_gradientn(colours = pal_ostwald_cont, trans = "reverse", name = "Viability", limits = c(1, 0)) +
  scale_x_continuous(limits = c(-0.5, 21.5), expand = expansion(add = 0)) +
  labs(
    x = "Days past induction",
    y = "TE proportion"
  ) +
  theme_leo() +
  theme(legend.position = "bottom")

pdf("TE_growth.pdf", width = onecol, height = onecol * 0.5)
growth
# growth_facet
dev.off()
```

##### Sigmoid fit

```{r}

growth_fine <- tibble(
  dpi = rep(rep(seq(0, 21, 0.1), times = 3), times = 4),
  variable = rep(rep(c("nTE_viab", "TE_prop", "TE_viab"), each = 211, length.out = 633), times = 4),
  replicate = rep(c("1", "2", "3", "4"), each = 633, length.out = 2532)
)

growth_long <- growth_data %>%
  filter(treatment == "ind") %>%
  pivot_longer(
    cols = c(TE_viab, TE_prop),
    names_to = "variable",
    values_to = "value"
  )

growth_sigmoid <- growth_long %>%
  select(replicate, dpi, variable, value) %>%
  full_join(growth_fine) %>%
  filter(variable != "nTE_viab") %>%
  group_by(variable) %>%
  nest(data = c(replicate, dpi, value)) %>%
  mutate(
    model_drc = map(data, ~ drc::drm(value ~ dpi, data = .x, fct = drc::G.3())),
    tidy_drc = map(model_drc, tidy),
    tidy_drc = map(tidy_drc, `[`, c("term", "estimate"))
  ) %>%
  unnest(tidy_drc) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(
    # data = map2(data, b, ~ mutate(.x, b_drc = round(.y, digits = 1))),
    data = map2(data, b, ~ mutate(.x, b_drc = 1)), # set b to 1 to avoid singular gradients (no idea why)
    data = map2(data, d, ~ mutate(.x, d_drc = round(.y, digits = 1))),
    data = map2(data, e, ~ mutate(.x, e_drc = round(.y, digits = 1))),
    model_nls = map(data, ~ nls(
      value ~ b / (1 + exp(-d * (dpi - e))),
      start = c(b = unique(.x$b_drc), d = unique(.x$d_drc), e = unique(.x$e_drc)),
      data = .x
    )),
    tidy_nls = map(model_nls, tidy),
    tidy_nls = map(tidy_nls, `[`, c("term", "estimate")),
    predicted = map2(model_nls, data, ~ predict(.x, newdata = .y))
  ) %>%
  select(-b, -d, -e) %>%
  unnest(tidy_nls) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  unnest(c(data, predicted)) %>%
  mutate(variable = recode(variable,
    nTE_viab = "Non-TE viability",
    TE_prop = "TE proportion",
    TE_viab = "TE viability"
  ))

sigmoid_inflection <- growth_sigmoid %>%
  group_by(variable) %>%
  summarise(
    inflection_x = mean(round(e, digits = 1)),
    inflection_y = mean(predicted[round(dpi, digits = 1) == round(inflection_x, digits = 1)])
  )

growth_facet <- ggplot(
  growth_sigmoid,
  aes(
    x = dpi,
    y = value
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  geom_segment(
    data = sigmoid_inflection,
    aes(
      x = inflection_x,
      xend = inflection_x,
      y = inflection_y,
      yend = Inf
    ),
    size = 0.2,
    linetype = 2,
    # arrow = arrow(ends = "first",
    #               type = "closed",
    #               angle = 10,
    #               length = unit(1.5, "mm"))
  ) +
  geom_point(
    # aes(colour = replicate),
    alpha = 0.5,
    shape = 16,
    size = 0.5
  ) +
  geom_text(
    data = sigmoid_inflection,
    aes(
      x = inflection_x,
      y = 1,
      label = paste(" ", inflection_x, "dpi")
    ),
    family = "Helvetica",
    size = ggtext_size,
    hjust = 0
  ) +
  # stat_smooth(geom = "line",
  #             aes(group = replicate),
  #             size = 0.2,
  #             alpha = 0.5,
  #             span = 0.9) +
  geom_line(aes(y = predicted),
    colour = "#275d95",
    size = 0.2
  ) +
  scale_y_continuous(
    limits = c(0, 1),
    labels = c("0", "25", "50", "75", "100")
  ) +
  labs(
    y = "Proportion [%]",
    x = "Days past induction (dpi)"
  ) +
  theme_leo() +
  facet_wrap(~variable, ncol = 3)

pdf("TE_growth_sigmoid.pdf", width = onecol * 0.8, height = onecol * 0.4)
# growth
growth_facet
dev.off()

# svglite::svglite("TE_growth_sigmoid.svg", width = onecol, height = onecol * 0.5)
# # growth
# growth_facet
# dev.off()
#
# ragg::agg_png("TE_growth_sigmoid.png", width = onecol, height = onecol * 0.5,
#               units = "in", res = 600)
# growth_facet
# dev.off()
```

### Pilots

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "MBTH", 4, 100, 400,
  "MBTH", 5, 100, 400,
  "MBTH", 6, 100, 400,
  "MBTH", 7, 100, 400,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
)

abs_max <- tibble(
  substrate = c("DAF", "PYGL", "SGZ", "ABTS"),
  abs_max = c(610, 360, 525, 420),
  abs_min = c(450, 600, 600, 480)
)

plate <- tibble(
  row = rep(LETTERS[1:4], length.out = 48, each = 12),
  column = rep(1:12, length.out = 48, each = 1),
  sample = c(
    rep(c(
      rep(c("TE", "nTE", "ctrl"),
        length.out = 12, each = 4
      )
    ),
    length.out = 48
    )
  ),
  substrate = ordered(rep(c("DAF", "PYGL", "SGZ", "ABTS"), each = 12),
    levels = c("DAF", "PYGL", "SGZ", "ABTS")
  ),
  pH = rep(rep(c(4:7), length.out = 12), length.out = 48),
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

pilot1 <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-17_pilot.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = `Cycle #` * 20
  ) %>%
  # 20 minutes between measurements
  group_by(sample, substrate, pH, replicate, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance / density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 2]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

pilot1_peaks <- pilot1 %>%
  group_by(sample, substrate, pH, replicate, day, time, lm_start, lm_stop, Well) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>%
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max]
  )

ggplot(
  pilot1_peaks,
  aes(
    x = time,
    y = corrected_absorbance,
    colour = sample
  )
) +
  geom_line() +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(pH ~ substrate, scale = "free")

pilot1_nested <- pilot1_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(
    column = as.numeric(str_remove(Well, "[:alpha:]")),
    row = ordered(str_extract(Well, "[:alpha:]"),
      levels = c("A", "B", "C", "D")
    )
  )

ggplot(
  pilot1_nested,
  aes(x = column, y = row, fill = estimate)
) +
  geom_tile() +
  # scale_x_discrete(limits = rev(levels(pilot1_nested$dilution))) +
  scale_y_discrete(limits = rev(levels(pilot1_nested$row))) +
  # scale_fill_gradientn(colours = rev(pal_ostwald_cont)) +
  scale_fill_viridis_c() +
  geom_label(aes(label = round(estimate, digits = 4))) +
  theme_leo()


# plotly::ggplotly(ggplot(filter(pilot1, sample == "nTE" & substrate == "DAF" & pH == 5),
#        aes(x = wavelength,
#            y = adjusted_absorbance,
#            colour = time,
#            group = time)) +
#   geom_line(size = 0.1))
```

#### Calibration

```{r}
# load data ####
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400
)

abs_max <- tibble(
  substrate = c("DAF", "PYGL", "SGZ", "ABTS"),
  abs_max = c(610, 450, 525, 420),
  abs_min = c(450, 600, 600, 480)
)

plate <- tibble(
  row = rep(LETTERS[1:3], length.out = 18, each = 6),
  column = rep(1:6, length.out = 18, each = 1),
  dilution = rep(c(1, 0.5, 0.25, 0.125, 0.0625, 0.03125), length.out = 18),
  technical = rep(c(1:3), each = 6, length.out = 18),
  sample = "nTE",
  substrate = ordered(c("PYGL"), levels = c("DAF", "PYGL", "SGZ", "ABTS")),
  pH = 6,
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

calibration <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-22_OD_calibration.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  group_by(sample, substrate, pH, replicate, dilution, technical, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance # do not adjust for density
      # TRUE ~ absorbance / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

# validate OD600 for cell density ####
calibration_density <- calibration %>%
  summarise(density = mean(density))

cal_r2 <- round(
  summary(
    lm(density ~ dilution, data = calibration_density)
  )$adj.r.squared,
  digits = 2
)

ggplot(
  calibration_density,
  aes(
    x = dilution,
    y = density
  )
) +
  geom_point() +
  geom_smooth(method = "lm") +
  annotate("text",
    label = paste("R² =", cal_r2),
    x = 0.1,
    y = 1.4
  ) +
  theme_leo()

# plot absorbance over time ####
calibration_peaks <- calibration %>%
  group_by(
    sample, substrate, pH, replicate, dilution, technical, day, time, lm_start, lm_stop, density
  ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>%
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max]
  )

ggplot(
  calibration_peaks,
  aes(
    x = time,
    y = corrected_absorbance,
    colour = sample
  )
) +
  geom_line(aes(group = technical)) +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_wrap(~dilution)

# calculate slopes of linear phase ####
calibration_nested <- calibration_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(dilution = as.character(dilution))

ggplot(
  calibration_nested,
  aes(x = density, y = estimate)
) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "PYGL oxidation rate") +
  expand_limits(y = 0) +
  theme_leo() +
  facet_wrap(~substrate)
```

#### Calibration II

```{r}

lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400
)

abs_max <- tibble(
  substrate = c("DAF", "PYGL", "SGZ", "ABTS"),
  abs_max = c(610, 360, 525, 420),
  abs_min = c(450, 600, 600, 480)
)

plate <- tibble(
  row = rep(LETTERS[1:6], length.out = 48, each = 8),
  column = rep(1:8, length.out = 48, each = 1),
  concentration = rep(c(10, 5, 2.5), each = 8, length.out = 48),
  dilution = rep(c(1, 0.5, 0.25, 0.125, 0.0625, 0.03125, 0.015625, 0), length.out = 48),
  sample = "nTE",
  substrate = ordered(rep(c("PYGL", "ABTS"), each = 24, length.out = 48), levels = c("DAF", "PYGL", "SGZ", "ABTS")),
  pH = rep(c(6, 4), each = 24, length.out = 48),
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

calibration <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-23_OD_calibration.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  group_by(sample, substrate, pH, replicate, dilution, concentration, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance # do not adjust for density
      # TRUE ~ absorbance / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

# validate OD600 for cell density ####
calibration_density <- calibration %>%
  summarise(density = mean(density))

cal_r2 <- round(
  summary(
    lm(density ~ dilution, data = calibration_density)
  )$adj.r.squared,
  digits = 2
)

ggplot(
  calibration_density,
  aes(
    x = dilution,
    y = density
  )
) +
  geom_point(aes(colour = pH)) +
  geom_smooth(method = "lm") +
  annotate("text",
    label = paste("R² =", cal_r2),
    x = 0.1,
    y = 1.4
  ) +
  theme_leo()

# check which wavelength to use for PYGL ####
calibration_wide <- calibration %>%
  select(-measurement, -absorbance, -adjusted_absorbance) %>%
  filter(wavelength %in% c(300, 360, 450)) %>%
  pivot_wider(names_from = wavelength, values_from = zeroed_absorbance)

ggplot(
  filter(calibration_wide, substrate == "PYGL"),
  aes(x = `450`, y = `360`)
) +
  geom_point() +
  geom_smooth(method = "lm")

# plot absorbance over time ####
calibration_peaks <- calibration %>%
  group_by(
    sample, substrate, pH, replicate, dilution, concentration, day, time, lm_start, lm_stop, density
  ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>%
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max]
  )

ggplot(
  calibration_peaks,
  aes(
    x = time,
    y = corrected_absorbance,
    colour = concentration
  )
) +
  geom_line(aes(group = concentration)) +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(substrate ~ dilution)

# calculate slopes of linear phase ####
calibration_nested <- calibration_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(dilution = as.factor(dilution))

ggplot(
  calibration_nested,
  aes(x = density, y = estimate, colour = concentration)
) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "Oxidation rate") +
  expand_limits(y = 0) +
  theme_leo() +
  facet_wrap(~substrate, scales = "free_y")

ggplot(
  calibration_nested,
  aes(x = dilution, y = interaction(concentration, substrate), fill = estimate)
) +
  geom_tile() +
  scale_x_discrete(limits = rev(levels(calibration_nested$dilution))) +
  # scale_fill_gradientn(colours = rev(pal_ostwald_cont)) +
  scale_fill_viridis_c() +
  geom_label(aes(label = round(estimate, digits = 4))) +
  theme_leo()
```

#### Calibration III

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "MBTH", 4, 100, 400,
  "MBTH", 5, 100, 400,
  "MBTH", 6, 100, 400,
  "MBTH", 7, 100, 400,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
)

abs_max <- tibble(
  substrate = c("ABTS", "DAF", "MBTH", "PYGL", "SGZ"),
  abs_max = c(420, 610, 505, 360, 525),
  abs_min = c(480, 450, 700, 600, 600)
)

plate <- tibble(
  row = rep(LETTERS[1:5], length.out = 40, each = 8),
  column = rep(1:8, length.out = 40, each = 1),
  concentration = rep(c(5, 0.07, 5, 0.1, 6), each = 8, length.out = 40),
  dilution = rep(c(1, 0.5, 0.25, 0.125, 0.0625, 0.03125, 0.015625, 0), length.out = 40),
  sample = "TE",
  substrate = ordered(rep(c("ABTS", "DAF", "PYGL", "SGZ", "MBTH"), each = 8, length.out = 40),
    levels = c("ABTS", "DAF", "PYGL", "SGZ", "MBTH")
  ),
  pH = rep(c(4, 5, 6, 5, 5), each = 8, length.out = 40),
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

calibration <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-24_OD_calibration.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    substrate = ordered(substrate, levels = c("ABTS", "DAF", "PYGL", "SGZ", "MBTH")),
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  group_by(sample, substrate, pH, replicate, dilution, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance # do not adjust for density
      # TRUE ~ absorbance / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

# validate OD600 for cell density ####
calibration_density <- calibration %>%
  summarise(density = mean(density))

cal_r2 <- round(
  summary(
    lm(density ~ dilution, data = calibration_density)
  )$adj.r.squared,
  digits = 2
)

ggplot(
  calibration_density,
  aes(
    x = dilution,
    y = density
  )
) +
  geom_point(aes(colour = pH)) +
  geom_smooth(method = "lm") +
  annotate("text",
    label = paste("R² =", cal_r2),
    x = 0.1,
    y = 1.4
  ) +
  theme_leo()

# check which wavelength to use for PYGL ####
calibration_wide <- calibration %>%
  select(-measurement, -absorbance, -adjusted_absorbance) %>%
  filter(wavelength %in% c(300, 360, 450)) %>%
  pivot_wider(names_from = wavelength, values_from = zeroed_absorbance)

ggplot(
  filter(calibration_wide, substrate == "PYGL"),
  aes(x = `450`, y = `360`)
) +
  geom_point() +
  geom_smooth(method = "lm")

# plot absorbance over time ####
calibration_peaks <- calibration %>%
  group_by(
    sample, substrate, pH, replicate, dilution, day, time, lm_start, lm_stop, density
  ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>%
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max]
  )

ggplot(
  calibration_peaks,
  aes(
    x = time,
    y = corrected_absorbance
  )
) +
  geom_line() +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(substrate ~ dilution)

# calculate slopes of linear phase ####
calibration_nested <- calibration_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(dilution = as.factor(dilution))

ggplot(
  calibration_nested,
  aes(x = density, y = estimate)
) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "Oxidation rate") +
  expand_limits(y = 0) +
  theme_leo() +
  facet_wrap(~substrate, scales = "free_y")

ggplot(
  calibration_nested,
  aes(x = dilution, y = substrate, fill = estimate)
) +
  geom_tile() +
  scale_x_discrete(limits = rev(levels(calibration_nested$dilution))) +
  scale_y_discrete(limits = rev(levels(calibration_nested$substrate))) +
  # scale_fill_gradientn(colours = rev(pal_ostwald_cont)) +
  scale_fill_viridis_c() +
  geom_label(aes(label = round(estimate, digits = 4))) +
  theme_leo()
```

#### Calibration IV

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 200, 400,
  "ABTS", 7, 200, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 40, 160,
  "DAF", 7, 40, 160,
  "MBTH", 4, 100, 400,
  "MBTH", 5, 100, 400,
  "MBTH", 6, 100, 400,
  "MBTH", 7, 100, 400,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 400,
  "SGZ", 4, 40, 400,
  "SGZ", 5, 40, 400,
  "SGZ", 6, 40, 400,
  "SGZ", 7, 40, 400,
)

abs_max <- tibble(
  substrate = c("ABTS", "DAF", "MBTH", "PYGL", "SGZ"),
  abs_max = c(420, 610, 505, 450, 525),
  abs_min = c(480, 450, 700, 600, 600)
)

plate <- tibble(
  row = rep(LETTERS[1:6], length.out = 48, each = 8),
  column = rep(1:8, length.out = 48, each = 1),
  concentration = rep(c(5, 0.5, 0.05), each = 16, length.out = 48),
  dilution = rep(c(1, 0.5, 0.25, 0.125, 0.0625, 0.03125, 0.015625, 0), length.out = 48),
  sample = rep(c("TE", "nTE"), each = 8, length.out = 48),
  substrate = ordered("PYGL",
    levels = c("ABTS", "DAF", "PYGL", "SGZ", "MBTH")
  ),
  pH = 6,
  replicate = 4,
  day = 21
) %>%
  unite("Well", row, column, sep = "")

calibration <- read_csv(
  paste0(datapath, "PhD/Laccase_activity/2021-03_TE_activity/2021-03-25_OD_calibration.csv")
) %>%
  left_join(plate) %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  mutate(
    substrate = ordered(substrate, levels = c("ABTS", "DAF", "PYGL", "SGZ", "MBTH")),
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  group_by(sample, substrate, pH, replicate, dilution, concentration, day) %>%
  mutate(
    density = absorbance[wavelength == 600 & `Cycle #` == 1],
    adjusted_absorbance = case_when(
      sample == "ctrl" ~ absorbance,
      TRUE ~ absorbance # do not adjust for density
      # TRUE ~ absorbance / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

# validate OD600 for cell density ####
calibration_density <- calibration %>%
  summarise(density = mean(density))

cal_r2 <- round(
  summary(
    lm(density ~ dilution, data = calibration_density)
  )$adj.r.squared,
  digits = 2
)

ggplot(
  calibration_density,
  aes(
    x = dilution,
    y = density
  )
) +
  geom_point(aes(colour = sample)) +
  geom_smooth(aes(colour = sample),
    method = "lm"
  ) +
  annotate("text",
    label = paste("R² =", cal_r2),
    x = 0.1,
    y = 1.4
  ) +
  theme_leo()

# check which wavelength to use for PYGL ####
calibration_wide <- calibration %>%
  select(-measurement, -absorbance, -adjusted_absorbance) %>%
  filter(wavelength %in% c(300, 360, 450)) %>%
  pivot_wider(names_from = wavelength, values_from = zeroed_absorbance)

ggplot(
  filter(calibration_wide, substrate == "PYGL"),
  aes(x = `450`, y = `360`, colour = concentration)
) +
  geom_point() +
  geom_smooth(method = "lm")

# plot absorbance over time ####
calibration_peaks <- calibration %>%
  group_by(
    sample, substrate, pH, replicate, dilution, concentration, day, time, lm_start, lm_stop, density
  ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>%
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max],
    measurement = measurement[wavelength == abs_max]
  )

ggplot(
  calibration_peaks,
  aes(
    x = time,
    y = corrected_absorbance,
    colour = sample
  )
) +
  geom_line() +
  scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(concentration ~ dilution)

# calculate slopes of linear phase ####
calibration_nested <- calibration_peaks %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -measurement) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(dilution = as.factor(dilution))

ggplot(
  calibration_nested,
  aes(x = density, y = estimate)
) +
  geom_point() +
  geom_smooth(method = "loess") +
  labs(y = "Oxidation rate") +
  expand_limits(y = 0) +
  theme_leo() +
  facet_grid(sample ~ concentration, scales = "free_y")

ggplot(
  calibration_nested,
  aes(x = dilution, y = interaction(sample, concentration), fill = estimate)
) +
  geom_tile() +
  scale_x_discrete(limits = rev(levels(calibration_nested$dilution))) +
  # scale_y_discrete(limits = rev(levels(calibration_nested$substrate))) +
  # scale_fill_gradientn(colours = rev(pal_ostwald_cont)) +
  scale_fill_viridis_c() +
  geom_label(aes(label = round(estimate, digits = 4))) +
  theme_leo()
```

### Full assays

#### Load plate layouts

```{r}
plate_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-04_TE_activity/csv_files/plates/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_csv(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("date", "started"), sep = "_") %>%
    mutate(
      Well = paste0(row, column),
      started = str_remove(started, fixed(".csv")),
      date = ymd(date)
    ) %>%
    select(-row, -column)
}

TE_plates <- map_dfr(plate_files, read_plus)
```

##### Check individual experiments

```{r}
read_vroom <- function(flnm) {
  vroom(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("author", "assay", "date", "time"), sep = "_") %>%
    select(-author, -assay) %>%
    mutate(
      time = str_remove(time, fixed(".csv")),
      date = ymd(date),
      started = ymd_hms(paste(date, time, sep = "_")),
      started = case_when(
        hour(started) < 14 ~ "morning",
        TRUE ~ "evening"
      )
    ) %>%
    select(-time) %>%
    tidyfast::dt_pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement")
}

test_spec <- read_vroom(
  paste0(datapath, "PhD/Laccase_activity/2021-04_TE_activity/csv_files/absorbance/LB_TE-activity_20210512_190857.csv")
) %>%
  left_join(TE_plates, by = c("date", "started", "Well")) %>%
  drop_na()

gc()

test_data <- test_spec %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  filter(time < 390) %>%
  group_by(date, replicate, substrate, pH, wavelength, time) %>%
  mutate("blank" = absorbance[sample == "neg. ctrl."]) %>%
  group_by(date, sample, substrate, pH, replicate, day) %>%
  mutate(
    density = mean(absorbance[wavelength == 600 & `Cycle #` %in% c(1, 2)]),
    adjusted_absorbance = case_when(
      sample == "neg. ctrl." ~ absorbance,
      # TRUE ~ absorbance # do not adjust for density
      TRUE ~ (absorbance - blank) / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

plotly::ggplotly(ggplot(
  test_data %>% filter(Well == "F8"),
  aes(
    x = wavelength,
    y = absorbance,
    group = time
  )
) +
  geom_line(
    size = 0.2,
    alpha = 0.5
  ))
```


#### Load absorbance data

```{r}
abs_max <- tibble(
  substrate = c("ABTS", "DAF", "MBTH", "PYGL", "SGZ"),
  abs_max = c(420, 610, 505, 450, 530), # DAF default: 610
  abs_min = c(480, 930, 700, 600, 600) # DAF default: 515
)

spec_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-04_TE_activity/csv_files/absorbance/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

read_vroom <- function(flnm) {
  vroom(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("author", "assay", "date", "time"), sep = "_") %>%
    select(-author, -assay) %>%
    mutate(
      time = str_remove(time, fixed(".csv")),
      date = ymd(date),
      started = ymd_hms(paste(date, time, sep = "_")),
      started = case_when(
        hour(started) < 14 ~ "morning",
        TRUE ~ "evening"
      )
    ) %>%
    select(-time) %>%
    pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
    filter(wavelength %in% c(abs_max$abs_max, abs_max$abs_min))
}

TE_spec <- map_dfr(spec_files, read_vroom) %>%
  left_join(TE_plates, by = c("date", "started", "Well")) %>%
  drop_na()

gc()

TE_data <- TE_spec %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  filter(time < 390) %>%
  group_by(date, replicate, substrate, pH, wavelength, time) %>%
  mutate("blank" = absorbance[sample == "neg. ctrl."]) %>%
  group_by(date, sample, substrate, pH, replicate, day) %>%
  mutate(
    density = mean(absorbance[wavelength == 600 & `Cycle #` %in% c(1, 2)]),
    adjusted_absorbance = case_when(
      sample == "neg. ctrl." ~ absorbance,
      # TRUE ~ absorbance # do not adjust for density
      TRUE ~ (absorbance - blank) / density # adjust for density
    ),
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)

rm(TE_spec)
gc()
```

#### Plot absorbance over time

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 100, 400,
  "ABTS", 7, 100, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 20, 100,
  "DAF", 7, 100, 300,
  "MBTH", 4, 100, 300,
  "MBTH", 5, 100, 300,
  "MBTH", 6, 100, 300,
  "MBTH", 7, 20, 120,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 300,
  "SGZ", 4, 200, 400,
  "SGZ", 5, 200, 400,
  "SGZ", 6, 200, 400,
  "SGZ", 7, 200, 400,
)

kinetics <- TE_data %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  group_by(
    date, sample, substrate, pH, replicate, day, time, lm_start, lm_stop, density
  ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>%
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    adjusted_absorbance = adjusted_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max]
  )

pdf("TE_kinetics.pdf", height = twocol, width = twocol)
ggplot(
  kinetics %>% filter(sample == "TE"),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = pH,
    linetype = sample
  )
) +
  # geom_line(aes(group = interaction(sample, pH))) +
  stat_smooth(
    geom = "line",
    aes(group = interaction(replicate, pH)),
    alpha = 0.5,
    size = 0.2,
    se = F
  ) +
  geom_smooth(
    data = filter(kinetics, sample == "TE" & time %in% c(lm_start:lm_stop)),
    aes(group = interaction(replicate, pH)),
    method = "lm",
    size = 0.5,
    se = F
  ) +
  # scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(substrate ~ day,
    scales = "free_y"
  )
dev.off()

pdf("TE_kinetics_ABTS_4.pdf", height = onecol * 0.5, width = twocol)
ggplot(
  kinetics %>% filter(sample == "TE" & pH == 4 & substrate == "ABTS"),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = pH,
    linetype = sample
  )
) +
  # geom_line(aes(group = interaction(sample, pH))) +
  stat_smooth(
    geom = "line",
    aes(group = interaction(replicate, pH)),
    alpha = 0.5,
    size = 0.2,
    se = F
  ) +
  geom_smooth(
    data = filter(
      kinetics,
      sample == "TE" &
        pH == 4 &
        substrate == "ABTS" &
        time %in% c(lm_start:lm_stop)
    ),
    aes(group = interaction(replicate, pH)),
    method = "lm",
    size = 0.5,
    se = F
  ) +
  labs(
    y = "Corrected absorbance",
    x = "Time [min]"
  ) +
  scale_x_continuous(limits = c(0, 400), breaks = c(100, 300)) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_grid(substrate ~ day,
    scales = "free_y"
  )
dev.off()

pdf("TE_kinetics_4.pdf", height = onecol * 1.5, width = twocol)
ggplot(
  kinetics %>% filter(sample == "TE" & pH == 4),
  aes(
    x = time,
    y = corrected_absorbance,
    colour = pH,
    linetype = sample
  )
) +
  # geom_line(aes(group = interaction(sample, pH))) +
  stat_smooth(
    geom = "line",
    aes(group = interaction(replicate, pH)),
    alpha = 0.5,
    size = 0.2,
    se = F
  ) +
  geom_smooth(
    data = filter(
      kinetics,
      sample == "TE" &
        pH == 4 &
        time %in% c(lm_start:lm_stop)
    ),
    aes(group = interaction(replicate, pH)),
    method = "lm",
    size = 0.5,
    se = F
  ) +
  labs(
    y = "Corrected absorbance",
    x = "Time [min]"
  ) +
  scale_x_continuous(limits = c(0, 400), breaks = c(100, 300)) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_grid(substrate ~ day,
    scales = "free_y"
  )
dev.off()
```


#### Plot linear phase slope

##### Calculate slopes

```{r}
kinetics_nested <- kinetics %>%
  # filter(substrate != "SGZ") %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -adjusted_absorbance) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(pH = as.factor(pH)) %>%
  # group_by(substrate, pH, replicate, day) %>% # subtract nTE activity (2 lines)
  # mutate(estimate = estimate - estimate[sample == "nTE"]) %>%
  # filter(adj.r.squared > 0.5) %>%
  group_by(substrate, pH, replicate, sample) %>%
  mutate(
    scaled_estimate = estimate / max(estimate),
    scaled_estimate = case_when(
      scaled_estimate < 0 ~ 0,
      TRUE ~ scaled_estimate
    )
  ) %>%
  group_by(pH, replicate) %>%
  mutate(
    pH_scaled = estimate / max(estimate),
    pH_scaled = case_when(
      pH_scaled < 0 ~ 0,
      TRUE ~ pH_scaled
    )
  ) %>%
  group_by(substrate, replicate) %>%
  mutate(
    substrate_scaled = estimate / max(estimate),
    substrate_scaled = case_when(
      substrate_scaled < 0 ~ 0,
      TRUE ~ substrate_scaled
    )
  )
```


##### TE grid with replicates

```{r}
kinetic_max <- kinetics_nested %>%
  filter(day > 3) %>%
  group_by(pH, sample, substrate, day) %>%
  summarise(scaled_estimate = mean(scaled_estimate)) %>%
  group_by(pH, sample, substrate) %>%
  mutate(
    max_estimate = max(scaled_estimate)
  ) %>%
  filter(scaled_estimate == max_estimate)

slope_grid <- ggplot(
  kinetics_nested %>% filter(sample == "TE"),
  aes(
    x = day,
    y = scaled_estimate,
    colour = substrate
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max %>% filter(sample == "TE"),
  #            aes(xintercept = day),
  #            size = 0.2,
  #            linetype = 2) +
  geom_line(aes(group = interaction(replicate, sample)),
    size = 0.2,
    alpha = 0.5
  ) +
  stat_smooth(
    geom = "line",
    size = 0.4,
    se = FALSE
  ) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )
  ) +
  scale_alpha_discrete(range = c(0.3, 1)) +
  labs(y = "Normalised substrate oxidation rate") +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_grid(pH ~ substrate)


pH_facet <- ggplot(
  kinetics_nested %>% filter(sample == "TE"),
  aes(
    x = day,
    y = scaled_estimate
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max,
  #            aes(xintercept = day,
  #                colour = sample),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2,
  #           alpha = 0.5) +
  stat_smooth(
    geom = "line",
    size = 0.4,
    se = FALSE
  ) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )
  ) +
  scale_alpha_discrete(guide = "none", range = c(0.3, 1)) +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  guides(colour = guide_legend(
    label.position = "bottom",
    nrow = 2
  )) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    strip.text = element_blank(),
    legend.position = c(0.5, -0.1),
    legend.title = element_blank(),
    legend.key.width = unit(1.5, "mm"),
    legend.key.height = unit(1.5, "mm"),
    legend.direction = "horizontal"
  ) +
  facet_wrap(~pH, ncol = 1)

substrate_facet <- ggplot(
  kinetics_nested %>% filter(sample == "TE"),
  aes(
    x = day,
    y = substrate_scaled,
    colour = substrate,
    alpha = pH
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max,
  #            aes(xintercept = day,
  #                colour = sample),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2,
  #           alpha = 0.5) +
  stat_smooth(
    geom = "line",
    size = 0.4,
    se = FALSE
  ) +
  # scale_alpha(name = "pH") +
  # scale_colour_brewer(palette = "Set1", guide = "none") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    ), guide = "none"
  ) +
  scale_alpha_discrete(range = c(0.3, 1)) +
  # scale_colour_manual(values = pal_pedersen_disc, name = "pH") +
  theme_leo() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    strip.text = element_blank(),
    # legend.title = element_blank(),
    legend.key.height = unit(2.5, "mm"),
    legend.key.width = unit(1.5, "mm"),
    legend.position = c(1.025, 0.5)
  ) +
  facet_wrap(~substrate, nrow = 1)

layout <- "
AAAAAB
AAAAAB
AAAAAB
AAAAAB
AAAAAB
CCCCC#
"
pdf("TE_activity_slopes.pdf", width = twocol, height = onecol)
slope_grid
# + pH_facet + substrate_facet +
# plot_layout(design = layout)
dev.off()
```

##### TE grid with ribbons

```{r}

kinetics_avg <- kinetics_nested %>%
  filter(sample != "neg. ctrl.") %>%
  group_by(substrate, sample, day, pH) %>%
  summarise(
    mean_slope = mean(estimate),
    sd_slope = sd(estimate)
  )

slope_grid <- ggplot(
  kinetics_avg,
  aes(
    x = day,
    y = mean_slope,
    colour = substrate
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  geom_ribbon(
    aes(
      group = sample,
      fill = substrate,
      ymin = mean_slope - sd_slope,
      ymax = mean_slope + sd_slope
    ),
    colour = NA,
    alpha = 0.25
  ) +
  geom_line(
    aes(linetype = sample),
    size = 0.4,
  ) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    aesthetics = c("colour", "fill"),
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )
  ) +
  scale_linetype_manual(values = c(2, 1)) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE, digits = 1)) +
  expand_limits(y = 0) +
  labs(
    y = "Substrate oxidation rate [AU min<sup>-1</sup>]",
    x = "Days past induction (dpi)"
  ) +
  theme_leo() +
  theme(
    strip.text = element_blank(),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(100, "mm")
    )
  ) +
  facet_wrap(pH ~ substrate, scales = "free_y")

pdf("activity_slopes.pdf", width = twocol, height = onecol)
slope_grid
dev.off()
```

##### pH comparison

```{r}
kinetics_pH <- kinetics_nested %>%
  # filter(substrate != "DAF") %>%
  filter(day == 7) %>%
  # filter(sample == "TE") %>%
  filter(sample != "neg. ctrl.")

asterisks <- kinetics_pH %>% 
  group_by(substrate, pH) %>%
  mutate(max = max(estimate)) %>% 
  select(sample, substrate, estimate, pH, max) %>% 
  nest(data = c(sample, estimate)) %>% 
  mutate(t_test = map(data, ~ t.test(estimate ~ sample, data = .x)),
         p_value = t_test[[1]][["p.value"]],
         sig = case_when(p_value > 0.05 ~ "",
                         p_value > 0.01 ~ "*",
                         p_value > 0.001 ~ "**",
                         TRUE ~ "***"))

max_oxidation <- ggplot(
  kinetics_pH,
  aes(
    x = pH,
    y = estimate,
    group = interaction(pH, sample)
  )
) +
  geom_quasirandom(
    dodge.width = 0.6,
    shape = 16,
    alpha = 0.25,
    size = 0.5,
    width = 0.3
  ) +
  geom_violin(
    aes(fill = substrate,
        linetype = sample),
    draw_quantiles = 0.5,
    position = position_dodge(width = 0.6),
    # fill = "white",
    colour = "black",
    alpha = 0.75,
    width = 0.5,
    size = 0.2,
    adjust = 1,
    scale = "width"
  ) +
  # geom_text(
  #   data = letters,
  #   aes(label = Letters),
  #   position = position_dodge(width = 0.6),
  #   vjust = 0.4,
  #   hjust = 0.5,
  #   size = ggtext_size,
  #   family = "Helvetica"
  # ) +
  geom_text(
    data = asterisks,
    aes(label = sig,
        y = max,
        x = pH,
        group = pH),
    position = position_dodge(width = 0.6),
    vjust = 0.4,
    hjust = 0.5,
    size = ggtext_size * 2,
    family = "Helvetica"
  ) +
  labs(y = "Oxidation rate at 7 dpi [AU min<sup>-1</sup>]") +
  scale_fill_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )
  ) +
  scale_linetype_manual(values = c(2, 1)) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.2)), 
                     labels = function(x) format(x, scientific = TRUE, digits = 1)) +
  theme_leo() +
  theme(axis.title.y = element_textbox_simple(
    orientation = "left-rotated",
    halign = 0.5,
    width = unit(22, "mm")
  )) +
  facet_wrap(~substrate,
    nrow = 1,
    scales = "free_y"
  )

pdf("max_ox.pdf", height = onecol * 0.3, width = twocol)
max_oxidation
dev.off()
```


##### Single pH

```{r}
kinetics_single <- kinetics_nested %>%
  filter(pH == 5) %>%
  mutate(
    pH = paste("pH", pH),
    substrate = recode(substrate,
      "MBTH" = "L-DOPA"
    )
  )
slope_grid <- ggplot(
  kinetics_single %>% filter(sample == "TE"),
  aes(
    x = day,
    y = scaled_estimate,
    colour = substrate
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max %>% filter(sample == "TE"),
  #            aes(xintercept = day),
  #            size = 0.2,
  #            linetype = 2) +
  geom_line(aes(group = interaction(replicate, sample)),
    size = 0.2,
    alpha = 0.5
  ) +
  stat_smooth(
    geom = "line",
    size = 0.4,
    se = FALSE
  ) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )
  ) +
  labs(
    y = "Relative oxidation rate",
    x = "Days past induction"
  ) +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  theme(
    strip.text.y = element_markdown(padding = unit(0.1, "mm")),
    axis.title.y = element_textbox_simple(
      orientation = "left-rotated",
      halign = 0.5,
      width = unit(15, "mm")
    )
  ) +
  facet_grid(pH ~ substrate)

pdf("TE_activity_pH5.pdf", width = onecol, height = onecol * 0.25)
slope_grid
dev.off()
```

##### Supplement with explicit nTE

```{r}
# write_csv(kinetics, "kinetics.csv")

kinetics_nested <- kinetics %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -adjusted_absorbance) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(pH = as.factor(pH)) %>%
  group_by(substrate, pH, replicate, day) %>%
  # mutate(estimate = estimate - estimate[sample == "nTE"]) %>%
  # filter(adj.r.squared > 0.5) %>%
  group_by(substrate, pH, replicate) %>%
  mutate(
    scaled_estimate = estimate / max(estimate),
    scaled_estimate = case_when(
      scaled_estimate < 0 ~ 0,
      TRUE ~ scaled_estimate
    )
  ) %>%
  group_by(pH, replicate) %>%
  mutate(
    pH_scaled = estimate / max(estimate),
    pH_scaled = case_when(
      pH_scaled < 0 ~ 0,
      TRUE ~ pH_scaled
    )
  ) %>%
  group_by(substrate, replicate) %>%
  mutate(
    substrate_scaled = estimate / max(estimate),
    substrate_scaled = case_when(
      substrate_scaled < 0 ~ 0,
      TRUE ~ substrate_scaled
    )
  )

kinetic_max <- kinetics_nested %>%
  filter(day > 3) %>%
  group_by(pH, sample, substrate, day) %>%
  summarise(scaled_estimate = mean(scaled_estimate)) %>%
  group_by(pH, sample, substrate) %>%
  mutate(
    max_estimate = max(scaled_estimate)
  ) %>%
  filter(scaled_estimate == max_estimate)

slope_grid <- ggplot(
  kinetics_nested %>% filter(sample != "neg. ctrl."),
  aes(
    x = day,
    y = scaled_estimate,
    colour = substrate,
    linetype = sample,
    alpha = pH
  )
) +
  # geom_vline(data = kinetic_max %>% filter(sample != "neg. ctrl."),
  #            aes(xintercept = day),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2) +
  stat_smooth(
    geom = "line",
    size = 0.4,
    se = FALSE
  ) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )
  ) +
  scale_alpha_discrete(range = c(0.3, 1)) +
  labs(y = "Normalised substrate oxidation rate") +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  # theme(legend.position = "bottom") +
  facet_grid(pH ~ substrate)


pH_facet <- ggplot(
  kinetics_nested %>% filter(sample != "neg. ctrl."),
  aes(
    x = day,
    y = scaled_estimate,
    colour = substrate,
    linetype = sample,
    alpha = pH
  )
) +
  # geom_vline(data = kinetic_max,
  #            aes(xintercept = day,
  #                colour = sample),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2,
  #           alpha = 0.5) +
  stat_smooth(
    geom = "line",
    size = 0.4,
    se = FALSE
  ) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    )
  ) +
  scale_alpha_discrete(guide = "none", range = c(0.3, 1)) +
  # scale_colour_manual(values = c("grey75", pal_ostwald_disc[1])) +
  theme_leo() +
  guides(colour = guide_legend(
    label.position = "bottom",
    nrow = 2
  )) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    strip.text = element_blank(),
    legend.position = c(0.5, -0.2),
    legend.title = element_blank(),
    legend.key.width = unit(2.5, "mm"),
    legend.key.height = unit(1.5, "mm"),
    legend.direction = "horizontal"
  ) +
  facet_wrap(~pH, ncol = 1)

substrate_facet <- ggplot(
  kinetics_nested %>% filter(sample != "neg. ctrl."),
  aes(
    x = day,
    y = substrate_scaled,
    colour = substrate,
    linetype = sample,
    alpha = pH
  )
) +
  # geom_vline(data = kinetic_max,
  #            aes(xintercept = day,
  #                colour = sample),
  #            size = 0.2,
  #            linetype = 2) +
  # geom_line(aes(group = interaction(replicate, sample)),
  #           size = 0.2,
  #           alpha = 0.5) +
  stat_smooth(
    geom = "line",
    size = 0.4,
    se = FALSE
  ) +
  # scale_alpha(name = "pH") +
  # scale_colour_brewer(palette = "Set1", guide = "none") +
  scale_colour_manual(
    values = c(
      "#66CCCC",
      "#6699FF",
      "#D35877",
      "#FFCC66",
      "#FF99CC"
    ), guide = "none"
  ) +
  scale_alpha_discrete(range = c(0.3, 1)) +
  scale_linetype(guide = "none") +
  # scale_colour_manual(values = pal_pedersen_disc, name = "pH") +
  theme_leo() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    strip.text = element_blank(),
    # legend.title = element_blank(),
    legend.key.height = unit(2.5, "mm"),
    legend.key.width = unit(1.5, "mm"),
    legend.position = c(1.025, 0.5)
  ) +
  facet_wrap(~substrate, nrow = 1)

layout <- "
AAAAAB
AAAAAB
AAAAAB
AAAAAB
AAAAAB
CCCCC#
"
pdf("TE_activity_slopes_supp.pdf", width = onecol * 1.5, height = onecol)
slope_grid + pH_facet + substrate_facet +
  plot_layout(design = layout)
dev.off()
```

#### Main figure

```{r}

pdf("TE_activity_fig.pdf", width = twocol, height = onecol * 1.15)
slope_grid + max_oxidation +
  plot_layout(nrow = 2, heights = c(0.8, 0.2))
dev.off()

```


### PA inductions

#### Viability

```{r}
growth_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-05_PA_inductions/viability/"),
    pattern = "*.txt",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_tsv(flnm,
    comment = "#",
    col_names = "code",
    col_types = "c",
    # locale = locale(decimal_mark = ",")
  ) %>%
    mutate(filename = basename(flnm)) %>%
    separate(filename, into = c("date", "replicate", "dpi", "treatment"), sep = "_") %>%
    mutate(
      date = ymd(as_date(date)),
      replicate = str_remove(replicate, fixed("R")),
      dpi = as.numeric(str_remove(dpi, fixed("d"))),
      treatment = str_remove(treatment, fixed(".txt"))
    )
}


PA_growth_data <- map(growth_files, read_plus) %>%
  bind_rows() %>%
  mutate(
    code = str_to_lower(code),
    nTEs_alive = str_count(code, "k"),
    nTEs_dead = str_count(code, "l"),
    TEs_alive = str_count(code, "i"),
    TEs_dead = str_count(code, "o")
  ) %>%
  mutate(
    n = nTEs_alive + nTEs_dead + TEs_alive + TEs_dead,
    nTE_viab = nTEs_alive / (nTEs_alive + nTEs_dead),
    TE_prop = (TEs_alive + TEs_dead) / n,
    TE_viab = TEs_alive / (TEs_alive + TEs_dead),
    TE_viab = case_when(
      is.nan(TE_viab) ~ 1,
      TRUE ~ TE_viab
    )
  )
```


#### Load plate layouts

```{r}
plate_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-05_PA_inductions/csv_files/plates/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

read_plus <- function(flnm) {
  read_csv(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("date", "started"), sep = "_") %>%
    mutate(
      Well = paste0(row, column),
      started = str_remove(started, fixed(".csv")),
      date = ymd(date)
    ) %>%
    select(-row, -column)
}

PA_plates <- map_dfr(plate_files, read_plus)
```

#### Load absorbance data

```{r}
spec_files <-
  list.files(
    path = paste0(datapath, "PhD/Laccase_activity/2021-05_PA_inductions/csv_files/absorbance/"),
    pattern = "*.csv$",
    recursive = FALSE,
    full.names = TRUE
  )

read_vroom <- function(flnm) {
  vroom(flnm) %>%
    mutate(
      filename = basename(flnm)
    ) %>%
    separate(filename, into = c("author", "assay", "date", "time"), sep = "_") %>%
    select(-author, -assay) %>%
    mutate(
      time = str_remove(time, fixed(".csv")),
      date = ymd(date),
      started = ymd_hms(paste(date, time, sep = "_")),
      started = case_when(
        hour(started) < 14 ~ "morning",
        TRUE ~ "evening"
      )
    ) %>%
    select(-time)
}

PA_spec <- map_dfr(spec_files, read_vroom) %>%
  pivot_longer(c(`220`:`1000`), names_to = "wavelength", values_to = "measurement") %>%
  left_join(PA_plates, by = c("date", "started", "Well")) %>%
  drop_na()

PA_data <- PA_spec %>%
  mutate(
    wavelength = as.numeric(wavelength),
    absorbance = measurement / 0.52, # experimental path length in the plate
    time = (`Cycle #` * 10) - 10 # 10 minutes between measurements
  ) %>%
  filter(time < 390) %>%
  group_by(date, replicate, substrate, pH, wavelength, time) %>%
  group_by(date, sample, substrate, pH, replicate, day) %>%
  mutate(
    density = mean(absorbance[wavelength == 600 & `Cycle #` %in% c(1, 2)]),
    adjusted_absorbance = absorbance, # adjust for density
    zeroed_absorbance = adjusted_absorbance - adjusted_absorbance[`Cycle #` == 3]
  ) %>%
  select(-`Cycle #`, -`Time (s)`)
```

#### Plot absorbance over time

```{r}
lm_bounds <- tribble(
  ~substrate, ~pH, ~lm_start, ~lm_stop,
  "ABTS", 4, 40, 160,
  "ABTS", 5, 40, 160,
  "ABTS", 6, 100, 400,
  "ABTS", 7, 100, 400,
  "DAF", 4, 40, 160,
  "DAF", 5, 40, 160,
  "DAF", 6, 100, 300,
  "DAF", 7, 100, 300,
  "MBTH", 4, 100, 300,
  "MBTH", 5, 100, 300,
  "MBTH", 6, 100, 300,
  "MBTH", 7, 20, 120,
  "PYGL", 4, 100, 400,
  "PYGL", 5, 100, 400,
  "PYGL", 6, 100, 400,
  "PYGL", 7, 100, 300,
  "SGZ", 4, 200, 400,
  "SGZ", 5, 200, 400,
  "SGZ", 6, 200, 400,
  "SGZ", 7, 200, 400,
)

abs_max <- tibble(
  substrate = c("ABTS", "DAF", "MBTH", "PYGL", "SGZ"),
  abs_max = c(420, 610, 505, 450, 530),
  abs_min = c(480, 515, 700, 600, 600)
  # abs_min = 1000
)

PA_kinetics <- PA_data %>%
  left_join(abs_max) %>%
  left_join(lm_bounds) %>%
  group_by(
    date, sample, substrate, pH, replicate, day, time, lm_start, lm_stop, density
  ) %>%
  mutate(corrected_absorbance = zeroed_absorbance - zeroed_absorbance[wavelength == abs_min]) %>%
  summarise(
    corrected_absorbance = corrected_absorbance[wavelength == abs_max],
    adjusted_absorbance = adjusted_absorbance[wavelength == abs_max],
    absorbance = absorbance[wavelength == abs_max]
  )

pdf("PA_kinetics.pdf", height = twocol, width = twocol)
ggplot(
  PA_kinetics,
  aes(
    x = time,
    y = corrected_absorbance,
    colour = pH,
    linetype = sample
  )
) +
  # geom_line(aes(group = interaction(sample, pH))) +
  stat_smooth(
    geom = "line",
    aes(group = interaction(replicate, sample, pH)),
    alpha = 0.5,
    size = 0.2,
    se = F
  ) +
  geom_smooth(
    data = filter(PA_kinetics, time %in% c(lm_start:lm_stop)),
    aes(group = interaction(replicate, sample, pH)),
    method = "lm",
    size = 0.5,
    se = F
  ) +
  # scale_x_continuous(limits = c(0, 400)) +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(substrate ~ day,
    scales = "free_y"
  )
dev.off()
```

#### Plot linear phase slope

```{r}
# write_csv(kinetics, "kinetics.csv")

PA_kinetics_nested <- PA_kinetics %>%
  filter(time >= lm_start & time <= lm_stop) %>%
  select(-absorbance, -adjusted_absorbance) %>%
  nest(data = c(time, corrected_absorbance)) %>%
  mutate(
    fit = map(data, ~ lm(corrected_absorbance ~ time, data = .x)),
    tidied = map(fit, tidy),
    model = map(fit, glance),
    adj.r.squared = unlist(map(model, ~ .x[["adj.r.squared"]]))
  ) %>%
  select(-model) %>%
  unnest(tidied) %>%
  filter(term == "time") %>%
  mutate(pH = as.factor(pH)) %>%
  group_by(substrate, pH, replicate, sample) %>%
  mutate(
    scaled_estimate = estimate / max(estimate),
    scaled_estimate = case_when(
      scaled_estimate < 0 ~ 0,
      TRUE ~ scaled_estimate
    )
  ) %>%
  group_by(pH, replicate) %>%
  mutate(
    pH_scaled = estimate / max(estimate),
    pH_scaled = case_when(
      pH_scaled < 0 ~ 0,
      TRUE ~ pH_scaled
    )
  ) %>%
  group_by(substrate, replicate) %>%
  mutate(
    substrate_scaled = estimate / max(estimate),
    substrate_scaled = case_when(
      substrate_scaled < 0 ~ 0,
      TRUE ~ substrate_scaled
    )
  )

PA_kinetic_max <- PA_kinetics_nested %>%
  group_by(pH, sample, substrate, day) %>%
  summarise(scaled_estimate = mean(scaled_estimate)) %>%
  group_by(pH, sample, substrate) %>%
  mutate(
    max_estimate = max(scaled_estimate)
  ) %>%
  filter(scaled_estimate == max_estimate)

slope_grid <- ggplot(
  PA_kinetics_nested,
  aes(
    x = day,
    y = scaled_estimate,
    colour = sample
  )
) +
  annotate("rect",
    ymin = -Inf,
    ymax = Inf,
    xmin = 3,
    xmax = 7,
    fill = "grey90"
  ) +
  # geom_vline(data = kinetic_max %>% filter(sample == "TE"),
  #            aes(xintercept = day),
  #            size = 0.2,
  #            linetype = 2) +
  geom_line(aes(group = interaction(replicate, sample)),
    size = 0.2
  ) +
  stat_smooth(
    geom = "line",
    size = 0.4,
    se = FALSE
  ) +
  # scale_colour_brewer(palette = "Set1") +
  scale_colour_manual(values = pal_ostwald_disc[c(1, 3)]) +
  labs(y = "Normalised substrate oxidation rate") +
  theme_leo() +
  theme(legend.position = "bottom") +
  facet_grid(pH ~ substrate)

pdf("PA_activity_slopes.pdf", width = onecol, height = onecol)
slope_grid
dev.off()
```

### Table

```{r}
options(knitr.kable.NA = '')
stock_data <- read_csv("/home/leonard/Dropbox/2021_lac_manuscript/Tables/substrates.csv")

stock_tab <- knitr::kable(stock_data,
  "latex",
  # align = "lllllcccc",
  # caption = "Raman bands validated by Py--GC/MS.",
  # col.names = c(
  #   "Band no.",
  #   "Band intensity at",
  #   "Normalised to",
  #   "Assigned polymer",
  #   "Assigned structure",
  #   "Pearson's r",
  #   "P-value",
  #   "Pearson's r",
  #   "P-value"
  # ),
  booktabs = TRUE,
  linesep = ""
) %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "striped", "scale_down")) 
# add_header_above(c(" " = 5, "Total pyrolysate" = 2, "Total lignin" = 2)) %>%
# kableExtra::save_kable("lac_tableS1.pdf")

readr::write_file(stock_tab, "lac_tableS2.txt")
```

