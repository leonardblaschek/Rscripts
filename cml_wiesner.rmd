---
title: "CML Wiesner analysis"
author: "Leonard Blaschek"
date: "17 May 2019"
output: 
  pdf_document:
    latex_engine: lualatex
    fig_caption: yes
    fig_height: 6
    includes:
      in_header: rmd_temp.tex
sansfont: Helvetica Neue LT Std
monofont: Inconsolata
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(showtext)
library(ggthemes)
library(tidyverse)

#### import Helvetica Neue ####
font_add(
  "Helvetica",
  regular = "/prop_fonts/01. Helvetica     [1957 - Max Miedinger]/HelveticaNeueLTStd-Lt.otf",
  italic = "/prop_fonts/01. Helvetica     [1957 - Max Miedinger]/HelveticaNeueLTStd-LtIt.otf",
  bold = "/prop_fonts/01. Helvetica     [1957 - Max Miedinger]/HelveticaNeueLTStd-Bd.otf",
  bolditalic = "/prop_fonts/01. Helvetica     [1957 - Max Miedinger]/HelveticaNeueLTStd-BdIt.otf"
)
showtext_auto()

#### generating plot theme ####
theme_leo <- function(base_size = 14,
                      base_family = "Helvetica"){
  theme_minimal(base_size = base_size,
                base_family = base_family) %+replace%
    theme(
      strip.text = element_text(hjust = 0, face = "italic"),
      axis.ticks = element_line(
        size = 0.25,
        lineend = "square",
        color = "black"
      ),
      axis.text.x = element_text(colour = "black", # flipped coords
                                 margin = margin(1, 1, 1, 1)),
      axis.text.y = element_text(
        colour = "black",
        angle = 0,
        vjust = 0.5,
        hjust = 1,
        margin = margin(1, 1, 1, 1)
      ),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black", size = 0.25),
      panel.spacing = unit(1.5, "mm"),
      legend.position = "none",
      legend.text = element_text(size = rel(0.8)),
      legend.key.height = unit(4, "mm"),
      complete = TRUE
    )
}

#### functions ####
scale_range <- function(x){(x-min(x))/(max(x)-min(x))}
```

## Load measurements

```{r load data, fig.showtext = TRUE, out.width = '100%', message = FALSE}
cml_data <- read_csv(
  "/home/leonard/Documents/Uni/Phloroglucinol/29-05_CML_measurements/cml_profiles.csv"
  ) %>%
  rowid_to_column(var = "distance") %>%
  gather(key = "ROI", 
         value = "absorbance", 
         -genotype, 
         -replicate, 
         -technical, 
         -distance) %>%
  mutate(ROI = str_replace(ROI, "ROI_", ""),
         absorbance = na_if(absorbance, 0)) %>%
  drop_na() %>%
  group_by(genotype, replicate, technical, ROI) %>%
  mutate(
    # distance.scaled = scale(distance, center = TRUE, scale = TRUE),
    distance.scaled = scale_range(distance),
    absorbance.scaled = scale(absorbance, center = FALSE, scale = TRUE),
    # absorbance.scaled = scale_range(absorbance)
    )

head(cml_data)
```

```{r scaled line plots, fig.showtext = TRUE, out.width = '100%', fig.height = 8, fig.width = 6, message = FALSE}

ggplot(data = cml_data, aes(x = distance.scaled, y = absorbance.scaled)) +
  geom_vline(xintercept = 0.5,
             linetype = 2) +
  geom_line(aes(group = interaction(ROI, replicate, genotype)),
            alpha = 0.25) +
  geom_smooth(aes(group = genotype),
              method = "loess",
              span = 0.15,
              colour = NA,
              fill = "blue",
              alpha = 0.5) +
  scale_x_continuous(breaks = c(0, 0.5, 1), labels = c("Lumen", "Middle lamella", "Lumen")) +
  labs(y = "Absorbance") +
  theme_leo() +
  theme(axis.title.x = element_blank()) +
  facet_wrap(~genotype, ncol = 1)
```

```{r unscaled line plots, fig.showtext = TRUE, out.width = '100%', fig.height = 8, fig.width = 6, message = FALSE}

ggplot(data = cml_data, aes(x = distance.scaled, y = absorbance / 255)) +
  geom_vline(xintercept = 0.5,
             linetype = 2) +
  geom_line(aes(group = interaction(ROI, replicate, genotype)),
            alpha = 0.25) +
  geom_smooth(aes(group = genotype),
              method = "loess",
              span = 0.15,
              colour = NA,
              fill = "blue",
              alpha = 0.5) +
  scale_x_continuous(breaks = c(0, 0.5, 1), labels = c("Lumen", "Middle lamella", "Lumen")) +
  labs(y = "Absorbance") +
  theme_leo() +
  theme(axis.title.x = element_blank()) +
  facet_wrap(~genotype, ncol = 1)
```
